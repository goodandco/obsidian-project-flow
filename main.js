/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var xt=Object.defineProperty;var yr=Object.getOwnPropertyDescriptor;var Pr=Object.getOwnPropertyNames;var jr=Object.prototype.hasOwnProperty;var F=(e,t)=>()=>(e&&(t=e(e=0)),t);var V=(e,t)=>{for(var o in t)xt(e,o,{get:t[o],enumerable:!0})},vr=(e,t,o,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Pr(t))!jr.call(e,n)&&n!==o&&xt(e,n,{get:()=>t[n],enumerable:!(r=yr(t,n))||r.enumerable});return e};var wr=e=>vr(xt({},"__esModule",{value:!0}),e);var io={};V(io,{DEFAULT_ENTITY_TYPES:()=>pe,DEFAULT_PROJECT_TYPES:()=>ue});var pe,ue,Se=F(()=>{pe={task:{id:"task",name:"Task",templatePath:"template-task.md",targetFolder:"Work/Tasks",filenameRule:"${PROJECT_ID}-${title}",requiredFields:["title","description"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},"meeting.planning":{id:"meeting.planning",name:"Meeting (Planning)",templatePath:"template-meeting-planning.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.refinement":{id:"meeting.refinement",name:"Meeting (Refinement)",templatePath:"template-meeting-refinement.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.retro":{id:"meeting.retro",name:"Meeting (Retro)",templatePath:"template-meeting-retro.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.demo":{id:"meeting.demo",name:"Meeting (Demo)",templatePath:"template-meeting-demo.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.daily":{id:"meeting.daily",name:"Meeting (Daily)",templatePath:"template-meeting-daily.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.knowledge":{id:"meeting.knowledge",name:"Meeting (Knowledge)",templatePath:"template-meeting-knowledge.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},sprint:{id:"sprint",name:"Sprint",templatePath:"template-sprint.md",targetFolder:"Work",filenameRule:"Sprint ${title}",requiredFields:["title"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},idea:{id:"idea",name:"Idea",templatePath:"template-idea.md",targetFolder:"Knowledge Base",filenameRule:"Idea ${title}",requiredFields:["title"],patchMarkers:["AI:CONTENT"]}},ue={operational:{id:"operational",name:"Operational",description:"Default ProjectFlow structure for active projects.",folderStructure:["Knowledge Base","Meetings","Work","Work/Tasks","People"],initialNotes:[{fileName:"${PROJECT_FULL_NAME}.md",template:"project.md"},{fileName:"${PROJECT_NAME} Meetings.md",template:"meetings.md"},{fileName:"${PROJECT_NAME} People.md",template:"people.md"},{fileName:"${PROJECT_NAME} Work.md",template:"work.md"},{fileName:"${PROJECT_NAME} Knowledge Base.md",template:"knowledge-base.md"}],allowedEntityTypes:Object.keys(pe)}}});var fe={};V(fe,{SafeFileManager:()=>Rt});var Rt,he=F(()=>{Rt=class{constructor(t){this.vault=t.vault}async createBatch(t){let o=[];try{for(let r of t)r.type==="folder"?await this.ensureFolder(r.path):await this.createIfAbsent(r.path,r.data)==="created"&&o.push(r.path);return{ok:!0}}catch(r){for(let n of o.reverse())try{let s=this.vault.getAbstractFileByPath(n);s&&this.vault.delete&&await this.vault.delete(s)}catch(s){}return{ok:!1,error:r}}}async has(t){var o;try{return this.vault.getAbstractFileByPath(t)?!0:(o=this.vault.adapter)!=null&&o.exists?await this.vault.adapter.exists(t):!1}catch(r){return!1}}async ensureFolder(t){var r;if(!this.vault.getAbstractFileByPath(t))try{await this.vault.createFolder(t)}catch(n){if(n&&typeof n=="object"&&((r=n.message)!=null&&r.includes("Parent folder"))){let s=t.split("/").filter(Boolean),i="";for(let a of s)if(i=i?`${i}/${a}`:a,!this.vault.getAbstractFileByPath(i))try{await this.vault.createFolder(i)}catch(p){}}}}async createIfAbsent(t,o){if(await this.has(t))return"skipped";try{return await this.vault.create(t,o),"created"}catch(r){return await this.has(t),"skipped"}}async removeDir(t){let o=this.vault.getAbstractFileByPath(t);if(o&&this.vault)try{await this.vault.trash(o,!0),await new Promise(r=>setTimeout(r,200))}catch(r){console.warn(`removeDir: failed to trash ${t}: ${r}`)}else console.warn(`removeDir: file not found: ${t}. File: ${o==null?void 0:o.path}`)}}});var Ie={};V(Ie,{sanitizeFileName:()=>Ke,sanitizePath:()=>K});function Ke(e){let t=(e!=null?e:"").trim();return Array.from(t).filter(r=>r.charCodeAt(0)>=32).join("").replace(/[\\/:*?"<>|]/g,"-").replace(/\s+/g," ").replace(/\.+$/g,"").substring(0,200)||"untitled"}function K(e){return e?e.split("/").filter(Boolean).map(Ke).join("/"):""}var ye=F(()=>{});var Fe={};V(Fe,{PROJECT_INDEX_VERSION:()=>Et,addToProjectIndex:()=>xr,buildProjectIndex:()=>co,ensureProjectIndex:()=>qe,getProjectIndexCache:()=>ze,removeFromProjectIndex:()=>Rr,setProjectIndexCache:()=>Tr,toIndexEntry:()=>bt});function ze(){return Ye}function Tr(e){Ye=e}function co(e){let t={},o={},r={};if(e&&typeof e=="object"){for(let[n,s]of Object.entries(e))if(!(!s||typeof s!="object")){for(let[i,a]of Object.entries(s))if(!(!a||typeof a!="object"))for(let[p,l]of Object.entries(a)){if(!l||!l.variables||!l.info)continue;let c=bt(l,p,n,i);t[c.fullName]=c,o[c.projectId]=c,r[c.projectTag]=c}}}return{version:1,byFullName:t,byId:o,byTag:r}}function bt(e,t,o,r){var n;return{fullName:e.variables.PROJECT_FULL_NAME,projectId:t,projectTag:e.variables.PROJECT_TAG,path:e.variables.PROJECT_PATH,dimension:o,category:r,projectName:e.info.name,parent:(n=e.info.parent)!=null?n:null}}function qe(e,t){if(!e||e.version!==1){let o=co(t);return Ye=o,{index:o,updated:!0}}return Ye=e,{index:e,updated:!1}}function xr(e,t,o,r,n){let s=bt(t,o,r,n);return e.byFullName[s.fullName]=s,e.byId[s.projectId]=s,e.byTag[s.projectTag]=s,e}function Rr(e,t){return delete e.byFullName[t.fullName],delete e.byId[t.projectId],delete e.byTag[t.projectTag],e}var Et,Ye,Pe=F(()=>{Et=1,Ye=null});var ke={};V(ke,{PROJECT_GRAPH_VERSION:()=>At,addProjectToGraph:()=>Ar,buildProjectGraph:()=>Ct,cleanArchivedGraph:()=>St,ensureProjectGraph:()=>Me,getChildren:()=>It,getParents:()=>Ft,getProjectGraphCache:()=>Er,removeProjectFromGraph:()=>Cr,setProjectGraphCache:()=>br});function Er(){return Xe}function br(e){Xe=e}function Ct(e,t){let o={},r={};return e&&lo(e,o),t&&lo(t,r),{version:1,byFullName:o,archivedByFullName:r}}function Me(e,t,o){if(!e||e.version!==1){let r=Ct(t,o);return Xe=r,{graph:r,updated:!0}}return Xe=e,{graph:e,updated:!1}}function Ar(e,t,o){let r=t.variables.PROJECT_FULL_NAME,n=po(t.info.parent),s=o?e.archivedByFullName:e.byFullName;if(s[r]=s[r]||{parent:n,children:[]},s[r].parent=n!=null?n:null,n){let i=s[n]||{parent:null,children:[]};i.children.includes(r)||i.children.push(r),s[n]=i}return e}function Cr(e,t,o){let r=o?e.archivedByFullName:e.byFullName,n=r[t];return n!=null&&n.parent&&r[n.parent]&&(r[n.parent].children=r[n.parent].children.filter(s=>s!==t)),delete r[t],e}function St(e,t){let o=Ct(void 0,t);return e.archivedByFullName=o.archivedByFullName,e}function It(e,t,o){var n,s;return(s=(n=(o?e.archivedByFullName:e.byFullName)[t])==null?void 0:n.children)!=null?s:[]}function Ft(e,t,o){var i,a,p,l;let r=o?e.archivedByFullName:e.byFullName,n=[],s=(a=(i=r[t])==null?void 0:i.parent)!=null?a:null;for(;s;)n.push(s),s=(l=(p=r[s])==null?void 0:p.parent)!=null?l:null;return n}function lo(e,t){for(let o of Object.values(e))for(let r of Object.values(o))for(let n of Object.values(r)){if(!n||!n.variables)continue;let s=n.variables.PROJECT_FULL_NAME,i=po(n.info.parent);if(t[s]=t[s]||{parent:i,children:[]},t[s].parent=i!=null?i:null,i){let a=t[i]||{parent:null,children:[]};a.children.includes(s)||a.children.push(s),t[i]=a}}}function po(e){let t=e==null?void 0:e.trim();return t&&t.length>0?t:null}var At,Xe,je=F(()=>{At=1,Xe=null});var fo={};V(fo,{ensureValidOrThrow:()=>kr,validateProjectName:()=>Fr,validateTag:()=>Mr});function Fr(e){if(!e||!e.trim())return{ok:!1,reason:"Project name is required"};let t=e.trim();if(t.length>120)return{ok:!1,reason:"Project name too long (max 120)"};for(let o of t)if(o.charCodeAt(0)<32||o==="/"||o==="\\")return{ok:!1,reason:"Project name contains invalid characters"};return{ok:!0}}function Mr(e){if(!e||!e.trim())return{ok:!1,reason:"Tag is required"};let t=e.trim();return Ir.test(t)?{ok:!0}:{ok:!1,reason:"Tag must be 2-63 chars, start with letter/digit; may include -, _, /"}}function kr(e,t){let o=e();if(!o.ok)throw new Error(`${t}: ${o.reason}`)}var Ir,ho=F(()=>{Ir=/^[A-Za-z0-9][A-Za-z0-9_/-]{1,62}$/});var nt={};V(nt,{processTemplate:()=>$r});function Po(e){return e==null?"":String(e)}function $r(e,t){if(!e||typeof e!="string")return"";let o=e;for(let[r,n]of Object.entries(t)){let s=Po(n),i=`$_${r}`;o.includes(i)&&(o=o.split(i).join(s))}for(let[r,n]of Object.entries(t)){let s=Po(n),i=new RegExp(`\\$\\{${Nr(r)}\\}`,"g");o=o.replace(i,s)}return o}function Nr(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var st=F(()=>{});function jo(e,t){let o=new Date,r=o.getFullYear().toString(),n=o.toISOString().split("T")[0],s=t.projectsRoot||"1. Projects",i=e.parent&&e.parent.trim().length>0?`.${e.parent.trim()}`:"",a=`${r}${i}.${e.name}`,p=t.dimensions.find(m=>m.name===e.dimension),l=p?`${p.order}. ${p.name}`:e.dimension,c=`${s}/${l}/${e.category}/${a}`,u=`${c}`;return{PROJECT_NAME:e.name,PROJECT_TAG:e.tag,PROJECT_PARENT:e.parent?e.parent:"",PARENT_TAG:e.parent?e.tag:"",YEAR:r,DATE:n,PROJECT_FULL_NAME:a,PROJECT_RELATIVE_PATH:c,PROJECT_PATH:u,DIMENSION:p?p.name:e.dimension,CATEGORY:e.category,PROJECT_ID:e.id,PROJECT_DIMENSION:p?p.name:e.dimension}}async function it(e,t){try{let{processTemplate:o}=await Promise.resolve().then(()=>(st(),nt));return o(e,t)}catch(o){console.warn("Template processor import failed, using legacy replacement:",o);let r=e;return Object.entries(t).forEach(([n,s])=>{let i=`$_${n}`;r=r.split(i).join(s)}),r}}var vo=F(()=>{});var wo={};V(wo,{mergeEntityTypes:()=>at,mergeProjectTypes:()=>Re});function at(e){let t={...pe};if(e&&typeof e=="object")for(let[o,r]of Object.entries(e))!r||typeof r!="object"||(t[o]={...t[o],...r,id:o});return t}function Re(e){let t={...ue};if(e&&typeof e=="object")for(let[o,r]of Object.entries(e))!r||typeof r!="object"||(t[o]={...t[o],...r,id:o});return t}var De=F(()=>{Se()});var To={};V(To,{resolveProjectType:()=>Dr});function Dr(e,t){let o=Re(e.projectTypes),r=t==null?void 0:t.projectTypeId,n=r&&o[r]?r:"operational",s=o[n]||o.operational;return{projectTypeId:n,projectType:s}}var xo=F(()=>{De()});async function ct(e,t){var o,r;try{let{resolveProjectType:n}=await Promise.resolve().then(()=>(xo(),To)),{projectTypeId:s,projectType:i}=n(e.settings,t);t.projectTypeId=s;let a=jo(t,e.settings),p=e.settings.projectsRoot||"1. Projects",{sanitizePath:l,sanitizeFileName:c}=await Promise.resolve().then(()=>(ye(),Ie)),{SafeFileManager:u}=await Promise.resolve().then(()=>(he(),fe)),m=new u(e.app),f=l(p),y=e.settings.dimensions.find(T=>T.name===t.dimension),j=y?`${y.order}. ${y.name}`:t.dimension,P=c(j),d=c(t.category),g=l(`${f}/${P}/${d}/${a.PROJECT_FULL_NAME}`),v=(o=i==null?void 0:i.folderStructure)!=null?o:["Knowledge Base","Meetings","Work","Work/Tasks","People"],w=[{type:"folder",path:g},...v.map(T=>({type:"folder",path:l(`${g}/${T}`)}))],x=e.app.vault.adapter,M=`.obsidian/plugins/${e.manifest.id}/src/templates`,O=(r=i==null?void 0:i.initialNotes)!=null?r:[{fileName:`${a.PROJECT_FULL_NAME}.md`,template:"project.md"},{fileName:`${t.name} Meetings.md`,template:"meetings.md"},{fileName:`${t.name} People.md`,template:"people.md"},{fileName:`${t.name} Work.md`,template:"work.md"},{fileName:`${t.name} Knowledge Base.md`,template:"knowledge-base.md"}],Y=[];for(let T of O){let k=T.fileName?await it(T.fileName,a):T.fileName,q=`${M}/${T.template}`;if(!await x.exists(q))throw new Error(`Template file not found: ${T.template}`);let me=await x.read(q),ve=await it(me,a),oe=l(`${g}/${c(k)}`);Y.push({type:"file",path:oe,data:ve})}let z=await m.createBatch([...w,...Y]);if(!("ok"in z)||!z.ok)throw new Error(`Batch creation failed: ${z.error||"unknown"}`);return await Gr(e,t.name,a),await Or(e,t,a),[!0,`Project "${t.name}" created successfully!`]}catch(n){return[!1,`Error creating project: ${n}`]}}async function Or(e,t,o){try{let{ensureProjectIndex:r,addToProjectIndex:n}=await Promise.resolve().then(()=>(Pe(),Fe)),{ensureProjectGraph:s,addProjectToGraph:i}=await Promise.resolve().then(()=>(je(),ke)),a={info:t,variables:o,createdAt:new Date().toISOString()},p=t.dimension,l=t.category,c=t.id;if(!e.settings.projectRecords||Array.isArray(e.settings.projectRecords)){let y={},j=Array.isArray(e.settings.projectRecords)?e.settings.projectRecords:[];for(let P of j){let d=P.info.dimension,g=P.info.category,v=P.info.id;y[d]=y[d]||{},y[d][g]=y[d][g]||{},y[d][g][v]=P}e.settings.projectRecords=y}let u=e.settings.projectRecords;if(u[p]=u[p]||{},u[p][l]=u[p][l]||{},u[p][l][c])throw new Error(`Project with id "${c}" already exists in ${p}:${l}`);u[p][l][c]=a;let{index:m}=r(e.settings.projectIndex,u);e.settings.projectIndex=n(m,a,c,p,l);let{graph:f}=s(e.settings.projectGraph,u,e.settings.archivedRecords);e.settings.projectGraph=i(f,a,!1),await e.saveData(e.settings)}catch(r){throw console.warn("Failed to record project creation:",r),r}}async function _r(e,t,o,r,n){try{let s=e.app.vault.adapter,i=`.obsidian/plugins/${e.manifest.id}/src/templates/${r}`;if(!await s.exists(i))throw new Error(`Template file not found: ${r}`);let a=await s.read(i),p=await it(a,n),l=`${t}/${o}`,{SafeFileManager:c}=await Promise.resolve().then(()=>(he(),fe));await new c(e.app).createIfAbsent(l,p)}catch(s){throw console.error(`Failed to create ${o}:`,s),new Error(`Failed to create ${o}: ${s}`)}}async function Gr(e,t,o){let{sanitizePath:r,sanitizeFileName:n}=await Promise.resolve().then(()=>(ye(),Ie)),{SafeFileManager:s}=await Promise.resolve().then(()=>(he(),fe)),i=new s(e.app),a=r(`Templates/${t}_Templates`);await i.ensureFolder(a);let p=[{source:"template-meeting-daily.md",target:`${t}_Meeting_Daily_Template.md`},{source:"template-meeting-discussion.md",target:`${t}_Meeting_Discussion_Template.md`},{source:"template-meeting-knowledge.md",target:`${t}_Meeting_Knowledge_Template.md`},{source:"template-meeting-planning.md",target:`${t}_Meeting_Planning_Template.md`},{source:"template-meeting-refinement.md",target:`${t}_Meeting_Refinement_Template.md`},{source:"template-meeting-retro.md",target:`${t}_Meeting_Retro_Template.md`},{source:"template-meeting-demo.md",target:`${t}_Meeting_Demo_Template.md`},{source:"template-sprint.md",target:`${t}_Sprint_Template.md`},{source:"template-task.md",target:`${t}_Task_Template.md`},{source:"template-idea.md",target:`${t}_Idea_Template.md`},{source:"template-knowledge-base-item.md",target:`${t}_Knowledge_Item_Template.md`},{source:"template-meeting-daily.md",target:"template-meeting-daily.md"},{source:"template-meeting-discussion.md",target:"template-meeting-discussion.md"},{source:"template-meeting-knowledge.md",target:"template-meeting-knowledge.md"},{source:"template-meeting-planning.md",target:"template-meeting-planning.md"},{source:"template-meeting-refinement.md",target:"template-meeting-refinement.md"},{source:"template-meeting-retro.md",target:"template-meeting-retro.md"},{source:"template-meeting-demo.md",target:"template-meeting-demo.md"},{source:"template-sprint.md",target:"template-sprint.md"},{source:"template-task.md",target:"template-task.md"},{source:"template-idea.md",target:"template-idea.md"},{source:"template-knowledge-base-item.md",target:"template-knowledge-base-item.md"}];for(let l of p)try{let c=n(l.target);await _r(e,a,c,l.source,o)}catch(c){console.warn(`Failed to create template ${l.target}: ${c}`)}}var Mt=F(()=>{vo()});var Lo={};V(Lo,{CURRENT_SETTINGS_SCHEMA_VERSION:()=>Ge,migrateSettings:()=>Xr});function Xr(e){var n,s,i,a,p,l,c,u,m,f,y,j;let t={dimensions:(n=e==null?void 0:e.dimensions)!=null?n:[],projectsRoot:(s=e==null?void 0:e.projectsRoot)!=null?s:"1. Projects",archiveRoot:(i=e==null?void 0:e.archiveRoot)!=null?i:"4. Archive",templatesRoot:(a=e==null?void 0:e.templatesRoot)!=null?a:"Templates/ProjectFlow",ai:e==null?void 0:e.ai,schemaVersion:(p=e==null?void 0:e.schemaVersion)!=null?p:0,projectRecords:{},archivedRecords:(l=e==null?void 0:e.archivedRecords)!=null?l:{},entityTypes:(c=e==null?void 0:e.entityTypes)!=null?c:{},projectTypes:(u=e==null?void 0:e.projectTypes)!=null?u:{},projectIndex:e==null?void 0:e.projectIndex,projectGraph:e==null?void 0:e.projectGraph},o=e==null?void 0:e.projectRecords;if(o&&typeof o=="object"&&!Array.isArray(o))t.projectRecords=o;else if(Array.isArray(o)){let P={};for(let d of o){if(!d||!d.info)continue;let g=d.info.dimension,v=d.info.category,w=d.info.id;!g||!v||!w||(P[g]=P[g]||{},P[g][v]=P[g][v]||{},P[g][v][w]=d)}t.projectRecords=P}else t.projectRecords={};if(Array.isArray(t.dimensions)){let P=1;t.dimensions=t.dimensions.map(d=>{var g;if(d&&typeof d=="object"){let v=(g=d.name)!=null?g:"",w=d.order,x=typeof v=="string"?v.match(/^\s*(\d+)\.\s*(.+)$/):null;return x&&(w=parseInt(x[1],10),v=x[2]),(w==null||Number.isNaN(w))&&(w=P++),{name:v,order:w,categories:Array.isArray(d.categories)?d.categories:[]}}return{name:String(d!=null?d:""),order:P++,categories:[]}})}else t.dimensions=[];let r=[...t.dimensions].sort((P,d)=>{var g,v;return((g=P.order)!=null?g:0)-((v=d.order)!=null?v:0)});return r.forEach((P,d)=>{P.order=d+1}),t.dimensions=r,(!t.schemaVersion||t.schemaVersion<Ge)&&((!t.entityTypes||Object.keys(t.entityTypes).length===0)&&(t.entityTypes=pe),(!t.projectTypes||Object.keys(t.projectTypes).length===0)&&(t.projectTypes=ue),t.ai?t.ai={enabled:Boolean(t.ai.enabled),provider:t.ai.provider||"openai",apiKey:(m=t.ai.apiKey)!=null?m:"",model:(f=t.ai.model)!=null?f:"gpt-4o-mini",baseUrl:(y=t.ai.baseUrl)!=null?y:"https://api.openai.com",strictExecution:Boolean(t.ai.strictExecution),memoryLimit:Number.isFinite(t.ai.memoryLimit)?t.ai.memoryLimit:10,mcpServers:Array.isArray(t.ai.mcpServers)?t.ai.mcpServers:[],toolLog:Array.isArray(t.ai.toolLog)?t.ai.toolLog:[],conversation:Array.isArray(t.ai.conversation)?t.ai.conversation:[],pendingPlan:(j=t.ai.pendingPlan)!=null?j:null}:t.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",strictExecution:!1,memoryLimit:10,mcpServers:[],toolLog:[],conversation:[],pendingPlan:null},t.schemaVersion=Ge),t}var Ge,Gt=F(()=>{Se();Ge=7});function Bo(e){return e?e.startsWith("/")||e.includes("\\")?!1:!e.split("/").filter(Boolean).some(o=>o==="."||o===".."):!0}function Le(e,t){let o=K(e),r=K(t);return r?o===r||o.startsWith(`${r}/`):!1}var Jo=F(()=>{ye()});var Vo={};V(Vo,{listProjects:()=>Lt,resolveArchivedProject:()=>jt,resolveProject:()=>Be});function Be(e,t){var i,a,p;let o=ze()||qe(e.settings.projectIndex,e.settings.projectRecords).index,r=Uo(t),n=r.fullName&&o.byFullName[r.fullName]||r.id&&o.byId[r.id]||r.tag&&o.byTag[r.tag];if(!n)return null;let s=(p=(a=(i=e.settings.projectRecords)==null?void 0:i[n.dimension])==null?void 0:a[n.category])==null?void 0:p[n.projectId];return s?{entry:n,record:s}:null}function jt(e,t){var n;let o=Uo(t),r=Zr(e.settings.archivedRecords,o);return r?{entry:{fullName:r.variables.PROJECT_FULL_NAME,projectId:r.info.id,projectTag:r.variables.PROJECT_TAG,path:r.variables.PROJECT_PATH,dimension:r.info.dimension,category:r.info.category,projectName:r.info.name,parent:(n=r.info.parent)!=null?n:null},record:r}:null}function Lt(e){let t=ze()||qe(e.settings.projectIndex,e.settings.projectRecords).index;return Object.values(t.byFullName)}function Uo(e){var t,o,r;if(typeof e=="string"){let n=e.trim();return n.startsWith("project/")?{tag:n}:n.includes(".")?{fullName:n}:{id:n}}return{fullName:(t=e.fullName)==null?void 0:t.trim(),id:(o=e.id)==null?void 0:o.trim(),tag:(r=e.tag)==null?void 0:r.trim()}}function Zr(e,t){if(!e)return null;for(let o of Object.values(e))for(let r of Object.values(o))for(let n of Object.values(r))if(n&&(t.fullName&&n.variables.PROJECT_FULL_NAME===t.fullName||t.id&&n.info.id===t.id||t.tag&&n.variables.PROJECT_TAG===t.tag))return n;return null}var Bt=F(()=>{Pe()});async function Wo(e,t){let{resolveProject:o}=await Promise.resolve().then(()=>(Bt(),Vo)),{mergeEntityTypes:r}=await Promise.resolve().then(()=>(De(),wo)),{processTemplate:n}=await Promise.resolve().then(()=>(st(),nt)),{SafeFileManager:s}=await Promise.resolve().then(()=>(he(),fe)),i=o(e,t.projectRef);if(!i)throw new Error("Project not found for reference.");let p=r(e.settings.entityTypes)[t.entityTypeId];if(!p)throw new Error(`Entity type not found: ${t.entityTypeId}`);let l=en(t.fields);Qr(p,l);let c={...i.record.variables,...l||{}},u=await tn(e,p,i.record,c);if(!u)throw new Error(`Template not found for entity type: ${p.id}`);let f=await e.app.vault.adapter.read(u.path),y=n(f,c),j=n(p.targetFolder,c);if(!Bo(j))throw new Error("Unsafe targetFolder path.");let P=K(i.record.variables.PROJECT_PATH),d=j?K(`${P}/${j}`):P;if(!Le(d,P))throw new Error("Target folder is outside project path.");if(!Ho(d,e.settings))throw new Error("Target folder is outside allowed roots.");let g=p.filenameRule||"Untitled",v=n(g,c),w=v.endsWith(".md")?v.slice(0,-3):v,x=Ke(w),M=K(`${d}/${x}.md`);if(!Le(M,P))throw new Error("Target file is outside project path.");if(!Ho(M,e.settings))throw new Error("Target file is outside allowed roots.");let O=new s(e.app);if(await O.ensureFolder(d),await O.has(M))throw new Error(`File already exists: ${M}`);return await O.createIfAbsent(M,y),{path:M}}function Ho(e,t){let o=t.projectsRoot||"1. Projects",r=t.archiveRoot||"4. Archive";return Le(e,o)||Le(e,r)}function Qr(e,t){if(!e.requiredFields||e.requiredFields.length===0)return;let o=e.requiredFields.filter(r=>t==null||t[r]==null||String(t[r]).trim()==="");if(o.length>0)throw new Error(`Missing required fields: ${o.join(", ")}`)}function en(e){if(!e)return e;let t={...e};for(let[o,r]of Object.entries(e)){if(r==null)continue;let n=o.toUpperCase(),s=o.toLowerCase();n in t||(t[n]=r),s in t||(t[s]=r)}return t}async function tn(e,t,o,r){let{processTemplate:n}=await Promise.resolve().then(()=>(st(),nt)),s=e.app.vault.adapter,i=n(t.templatePath,r),a=K(`Templates/${o.info.name}_Templates`),p=K(e.settings.templatesRoot||"Templates/ProjectFlow"),l=`.obsidian/plugins/${e.manifest.id}/src/templates`,c=m=>m.map(f=>f==="project"?{scope:f,path:K(`${a}/${i}`)}:f==="vault"?{scope:f,path:K(`${p}/${i}`)}:{scope:f,path:`${l}/${i}`}),u=t.templateScope?[t.templateScope,"builtin"].filter((m,f,y)=>y.indexOf(m)===f):["project","vault","builtin"];for(let m of c(u))if(await s.exists(m.path))return m;return null}var Ko=F(()=>{ye();Jo()});function Yo(e){if(e instanceof de)return e;let t=e instanceof Error?e.message:"Unknown error";return new de("validation_error",t)}var de,Jt=F(()=>{de=class extends Error{constructor(o,r,n){super(r);this.code=o,this.details=n}}});function H(e,t){if(typeof e!="string"||e.trim().length===0)throw new de("invalid_request",`${t} is required`,{field:t});return e.trim()}function vt(e){if(e==null)throw new de("invalid_request","projectRef is required",{field:"projectRef"});if(typeof e=="string"){H(e,"projectRef");return}let t=typeof e.fullName=="string"&&e.fullName.trim().length>0,o=typeof e.id=="string"&&e.id.trim().length>0,r=typeof e.tag=="string"&&e.tag.trim().length>0;if(!t&&!o&&!r)throw new de("invalid_request","projectRef must include fullName, id, or tag",{field:"projectRef"})}function zo(e){H(e==null?void 0:e.name,"name"),H(e==null?void 0:e.tag,"tag"),H(e==null?void 0:e.id,"id"),H(e==null?void 0:e.dimension,"dimension"),H(e==null?void 0:e.category,"category")}function qo(e){vt(e==null?void 0:e.projectRef),H(e==null?void 0:e.entityTypeId,"entityTypeId")}function Xo(e){H(e==null?void 0:e.path,"path"),H(e==null?void 0:e.marker,"marker"),H(e==null?void 0:e.content,"content")}function Zo(e){H(e==null?void 0:e.path,"path"),H(e==null?void 0:e.heading,"heading"),H(e==null?void 0:e.content,"content")}var wt=F(()=>{Jt()});function Qo(e){return{listEntityTypes:()=>at(e.settings.entityTypes),describeEntityType:t=>at(e.settings.entityTypes)[t]||null,createEntity:async t=>(qo(t),Wo(e,t))}}var er=F(()=>{De();Ko();wt()});function on(e,t,o,r,n){let s=rn(t),i=e.indexOf(s);if(i>=0){let a=e.indexOf(`
`,i),p=a>=0?a+1:e.length,l=nn(e,p),c=l>=0?l:e.length;return{updated:!0,text:[e.slice(0,p),Ut(o),e.slice(c)].join("")}}if(r==="strict")return{updated:!1,text:e};if(n){let a=tr(e,n,o,r);if(a.updated)return a}return{updated:!0,text:sr(e,n||"AI Notes",o)}}function tr(e,t,o,r){let n=nr(t),i=new RegExp(`^#{1,6}\\s+${an(n)}\\s*$`,"m").exec(e);if(!i||i.index==null)return r==="strict"?{updated:!1,text:e}:{updated:!0,text:sr(e,n,o)};let a=i.index,p=e.indexOf(`
`,a),l=p>=0?p+1:e.length,c=sn(e,l);return{updated:!0,text:[e.slice(0,l),Ut(o),e.slice(c)].join("")}}async function or(e,t){var i;let o=e.vault.adapter,r=(i=t.patchMode)!=null?i:"lenient";if(!await o.exists(t.path))return{ok:!1,error:`File not found: ${t.path}`};let n=await o.read(t.path),s=on(n,t.marker,t.content,r,t.fallbackHeading);return s.updated?(await o.write(t.path,s.text),{ok:!0}):{ok:!1,error:"Marker or heading not found in strict mode."}}async function rr(e,t){var i;let o=e.vault.adapter,r=(i=t.patchMode)!=null?i:"lenient";if(!await o.exists(t.path))return{ok:!1,error:`File not found: ${t.path}`};let n=await o.read(t.path),s=tr(n,t.heading,t.content,r);return s.updated?(await o.write(t.path,s.text),{ok:!0}):{ok:!1,error:"Heading not found in strict mode."}}function rn(e){let t=e.trim();return t.startsWith("<!--")&&t.endsWith("-->")?t:`<!-- ${t} -->`}function nr(e){return e.replace(/^#+\s*/,"").trim()}function nn(e,t){let o=/<!--\s*AI:[A-Z_]+\s*-->/g;o.lastIndex=t;let r=o.exec(e);return r&&r.index!=null?r.index:-1}function sn(e,t){let o=/^#{1,6}\s+/gm;o.lastIndex=t;let r=o.exec(e);return r&&r.index!=null?r.index:e.length}function Ut(e){let t=e!=null?e:"";return t.endsWith(`
`)?t:`${t}
`}function sr(e,t,o){let r=nr(t);return`${e.endsWith(`
`)?e:`${e}
`}
## ${r}
${Ut(o)}`}function an(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var ir=F(()=>{});function ar(e){return{patchMarker:async t=>(Xo(t),or(e.app,t)),patchSection:async t=>(Zo(t),rr(e.app,t))}}var cr=F(()=>{ir();wt()});function lr(e){return{resolveProject:t=>(vt(t),Be(e,t)),listProjects:()=>Lt(e),listProjectTypes:()=>Re(e.settings.projectTypes),describeProjectType:t=>Re(e.settings.projectTypes)[t]||null,createProject:async t=>(zo(t),ct(e,t)),getChildren:(t,o)=>{vt(t);let r=o?jt(e,t):Be(e,t);if(!r)return[];let{graph:n}=Me(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return It(n,r.entry.fullName,Boolean(o))},getParents:(t,o)=>{let r=o?jt(e,t):Be(e,t);if(!r)return[];let{graph:n}=Me(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return Ft(n,r.entry.fullName,Boolean(o))},clearArchivedProjectGraph:async()=>{let{graph:t}=Me(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return e.settings.projectGraph=St(t,e.settings.archivedRecords),await e.saveData(e.settings),{ok:!0}}}}var pr=F(()=>{De();Mt();Bt();je();wt()});var dr={};V(dr,{createCoreApi:()=>cn});function cn(e){let t="1.0.0",o=lr(e),r=Qo(e),n=ar(e);return{version:t,capabilities:{resolveProject:!0,listProjects:!0,entityTypes:!0,projectTypes:!0,createProject:!0,createEntity:!0,patching:!0,projectGraph:!0,errorHandling:"throws"},compatibility:{settingsSchemaVersion:Ge,projectIndexVersion:1,projectGraphVersion:1},...o,...r,...n,wrapError:s=>{let i=Yo(s);return{ok:!1,error:{code:i.code,message:i.message,details:i.details}}}}}var mr=F(()=>{er();cr();pr();Jt();Gt();Pe();je()});var pn={};V(pn,{default:()=>ln});module.exports=wr(pn);var gr=require("obsidian");var b=require("obsidian");Se();var ao=require("obsidian"),We=class extends ao.Modal{constructor(o,r){super(o);this.onResult=r}onOpen(){let{contentEl:o}=this;o.empty(),o.addClass("project-flow-settings"),o.createEl("p",{text:"Do you want skip settings to defaults? This will override all custom settings."});let r=o.createDiv({cls:"gc-row"});r.createDiv({cls:"gc-spacer"});let n=r.createEl("button",{text:"Yes, use defaults"}),s=r.createEl("button",{text:"Go back"});n.onclick=()=>{this.close(),this.onResult(!0)},s.onclick=()=>{this.close(),this.onResult(!1)}}onClose(){this.contentEl.empty()}};async function Ze(e,t,o,r){let n="",s=e.settings.projectRecords,i=s[t][o][r],{SafeFileManager:a}=await Promise.resolve().then(()=>(he(),fe)),p=new a(e.app),{sanitizePath:l}=await Promise.resolve().then(()=>(ye(),Ie)),c=l(i.variables.PROJECT_PATH),u=l(`Templates/${i.info.name}_Templates`);try{await p.removeDir(c),await p.removeDir(u);try{s[t][o][r]&&(delete s[t][o][r],Object.keys(s[t][o]).length===0&&delete s[t][o],Object.keys(s[t]).length===0&&delete s[t]);try{let{ensureProjectIndex:m,removeFromProjectIndex:f,toIndexEntry:y}=await Promise.resolve().then(()=>(Pe(),Fe)),{ensureProjectGraph:j,removeProjectFromGraph:P}=await Promise.resolve().then(()=>(je(),ke)),{index:d}=m(e.settings.projectIndex,s);e.settings.projectIndex=f(d,y(i,r,t,o));let{graph:g}=j(e.settings.projectGraph,s,e.settings.archivedRecords);e.settings.projectGraph=P(g,i.variables.PROJECT_FULL_NAME,!1)}catch(m){console.warn("Failed to update projectIndex after delete:",m)}await e.saveData(e.settings),n="Project deleted successfully."}catch(m){n="Failed to update projectRecords after delete",console.warn(n,m)}return[!0,n]}catch(m){n="Error removing project: "+m.message,console.error("Error removing project:",m)}return[!1,n]}async function Qe(e,t,o,r){var n,s,i,a,p;try{let l=e.settings.projectRecords,c=(s=(n=l==null?void 0:l[t])==null?void 0:n[o])==null?void 0:s[r];if(!c)return[!1,"Project not found."];let{sanitizePath:u}=await Promise.resolve().then(()=>(ye(),Ie)),{SafeFileManager:m}=await Promise.resolve().then(()=>(he(),fe)),f=new m(e.app),y=e.app.vault.adapter,j=u(c.variables.PROJECT_PATH),P=u(`Templates/${c.info.name}_Templates`),d=e.settings.archiveRoot||"4. Archive",g=c.variables.YEAR,v=c.variables.DIMENSION||c.info.dimension,w=c.info.category,x=c.info.parent&&c.info.parent.trim().length>0?c.info.parent.trim():null,M=c.info.name,O=x?`${g}.${v}.${w}.${x}.${M}`:`${g}.${v}.${w}.${M}`,Y=u(`${d}/${O}`),z=T=>{let k=T.split("/").filter(Boolean);return k.pop(),k.join("/")};if(await f.ensureFolder(z(Y)),!await y.exists(j))return[!1,`Project directory not found: ${j}`];if(await y.exists(Y))return[!1,`Archive destination already exists: ${Y}`];await y.rename(j,Y);try{if(await y.exists(P)){let T=u(`${Y}/Templates`);await f.ensureFolder(T);let k=u(`${T}/${c.info.name}_Templates`);if(await y.exists(k)){let q=u(`${T}/${c.info.name}_Templates_archived`);await y.rename(P,q)}else await y.rename(P,k)}}catch(T){console.warn("Archiving templates failed:",T)}try{let T=e.settings.projectRecords;(!e.settings.archivedRecords||Array.isArray(e.settings.archivedRecords))&&(e.settings.archivedRecords=e.settings.archivedRecords&&Array.isArray(e.settings.archivedRecords)?{}:e.settings.archivedRecords||{});let k=e.settings.archivedRecords;k[t]=k[t]||{},k[t][o]=k[t][o]||{},k[t][o][r]=c,(a=(i=T==null?void 0:T[t])==null?void 0:i[o])!=null&&a[r]&&(delete T[t][o][r],Object.keys(T[t][o]).length===0&&delete T[t][o],Object.keys(T[t]||{}).length===0&&delete T[t]);try{let{ensureProjectIndex:q,removeFromProjectIndex:me,toIndexEntry:ve}=await Promise.resolve().then(()=>(Pe(),Fe)),{ensureProjectGraph:oe,removeProjectFromGraph:Je,addProjectToGraph:we}=await Promise.resolve().then(()=>(je(),ke)),{index:Ee}=q(e.settings.projectIndex,T);e.settings.projectIndex=me(Ee,ve(c,r,t,o));let{graph:Ue}=oe(e.settings.projectGraph,T,k);e.settings.projectGraph=Je(Ue,c.variables.PROJECT_FULL_NAME,!1),e.settings.projectGraph=we(e.settings.projectGraph,c,!0)}catch(q){console.warn("Failed to update projectIndex after archive:",q)}await e.saveData(e.settings)}catch(T){console.warn("Failed to move project record to archive in settings:",T)}return[!0,"Project archived successfully."]}catch(l){return console.error("Archive failed:",l),[!1,(p=l==null?void 0:l.message)!=null?p:"Failed to archive project."]}}var Sr=[{name:"Business",order:1,categories:["R&D","Jobs","OpenSource","Education"]},{name:"Family",order:2,categories:["Vacations","Parenting","Common"]},{name:"Friends",order:3,categories:[]},{name:"Health",order:4,categories:["Clinics","Issues","R&D"]},{name:"Personal",order:5,categories:["R&D","Languages","SelfManagement","Writing","Reading","Music","Sports"]},{name:"Residence",order:6,categories:[]}],tt={dimensions:JSON.parse(JSON.stringify(Sr)),projectsRoot:"1. Projects",archiveRoot:"4. Archive",templatesRoot:"Templates/ProjectFlow",ai:{enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",strictExecution:!1,memoryLimit:10,mcpServers:[],toolLog:[],conversation:[],pendingPlan:null},projectRecords:{},archivedRecords:{},projectGraph:{version:1,byFullName:{},archivedByFullName:{}},entityTypes:pe,projectTypes:ue};function mo(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o),t|=0;return t}var et=class extends b.PluginSettingTab{constructor(o,r){super(o,r);this.plugin=r}display(){var Wt,Kt,Yt,zt,qt,Xt,Zt,Qt,eo,to,oo,ro,no,so;let{containerEl:o}=this;o.empty(),o.addClass("project-flow-settings");let r=o.createDiv({cls:"gc-row"});r.createDiv({cls:"gc-spacer"});let n=r.createEl("button",{cls:["gc-icon-button","clickable-icon"],attr:{"aria-label":"Reset to defaults",title:"Reset to defaults"}});try{(0,b.setIcon)(n,"rotate-ccw")}catch(h){n.setText("Reset to defaults")}n.onclick=()=>{new We(this.app,async A=>{A&&(this.plugin.settings=JSON.parse(JSON.stringify(tt)),await this.plugin.saveSettings(),new b.Notice("Settings were reset to defaults."),this.display())}).open()},o.createEl("h2",{text:"Folders"});let s=o.createDiv({cls:"gc-column"}),i=s.createDiv({cls:"setting-item"});i.createEl("label",{text:"Projects root"});let a=i.createEl("input",{type:"text"});a.value=this.plugin.settings.projectsRoot||"1. Projects",a.placeholder="e.g. 1. Projects",a.onchange=async()=>{this.plugin.settings.projectsRoot=a.value.trim()||"1. Projects",await this.plugin.saveSettings()};let p=s.createDiv({cls:"setting-item"});p.createEl("label",{text:"Archive root"});let l=p.createEl("input",{type:"text"});l.value=this.plugin.settings.archiveRoot||"4. Archive",l.placeholder="e.g. 4. Archive",l.onchange=async()=>{this.plugin.settings.archiveRoot=l.value.trim()||"4. Archive",await this.plugin.saveSettings()};let c=s.createDiv({cls:"setting-item"});c.createEl("label",{text:"Templates root"});let u=c.createEl("input",{type:"text"});u.value=this.plugin.settings.templatesRoot||"Templates/ProjectFlow",u.placeholder="e.g. Templates/ProjectFlow",u.onchange=async()=>{this.plugin.settings.templatesRoot=u.value.trim()||"Templates/ProjectFlow",await this.plugin.saveSettings()},o.createEl("h2",{text:"Dimensions"}),[...this.plugin.settings.dimensions].sort((h,A)=>{var _,D;return((_=h.order)!=null?_:0)-((D=A.order)!=null?D:0)}).forEach((h,A)=>{let _=o.createDiv({cls:"dimension-setting"}),D=_.createDiv({cls:"dimension-header"});D.addClass("gc-row"),D.createSpan({text:`${h.order}. `});let W=D.createEl("b",{text:h.name});D.createDiv({cls:"gc-spacer"});let B=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});B.setAttr("aria-label","Move up"),B.setAttr("title","Move up");try{(0,b.setIcon)(B,"arrow-up")}catch(C){B.setText("Up")}B.onclick=async()=>{let S=[...this.plugin.settings.dimensions].filter($=>{var I,E;return((I=$.order)!=null?I:0)<((E=h.order)!=null?E:0)}).sort(($,I)=>{var E,N;return((E=I.order)!=null?E:0)-((N=$.order)!=null?N:0)})[0];if(!S)return;let R=S.order;S.order=h.order,h.order=R,await this.plugin.saveSettings(),this.display()};let se=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});se.setAttr("aria-label","Move down"),se.setAttr("title","Move down");try{(0,b.setIcon)(se,"arrow-down")}catch(C){se.setText("Down")}se.onclick=async()=>{let S=[...this.plugin.settings.dimensions].filter($=>{var I,E;return((I=$.order)!=null?I:0)>((E=h.order)!=null?E:0)}).sort(($,I)=>{var E,N;return((E=$.order)!=null?E:0)-((N=I.order)!=null?N:0)})[0];if(!S)return;let R=S.order;S.order=h.order,h.order=R,await this.plugin.saveSettings(),this.display()};let ie=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ie.setAttr("aria-label",`Delete ${h.name}`),ie.setAttr("title",`Delete ${h.name}`);try{(0,b.setIcon)(ie,"trash")}catch(C){ie.setText("Remove")}ie.onclick=async()=>{let C=this.plugin.settings.dimensions.findIndex(S=>S===h);C>=0&&this.plugin.settings.dimensions.splice(C,1),await this.plugin.saveSettings(),this.display()};let L=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});L.setAttr("aria-label",`Rename ${h.name}`),L.setAttr("title",`Rename ${h.name}`);try{(0,b.setIcon)(L,"pencil")}catch(C){L.setText("Edit")}if(L.onclick=async()=>{var ae;let C=h.name,S=W.parentElement;(ae=W.detach)==null||ae.call(W),L.style.display="none",ie.style.display="none";let R=S.createEl("input",{type:"text"});R.value=C,R.addClass("gc-rename");let $=S.createDiv({cls:"gc-row"});$.createDiv({cls:"gc-spacer"});let I=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});I.setAttr("aria-label","Apply"),I.setAttr("title","Apply");try{(0,b.setIcon)(I,"check")}catch(J){I.setText("Apply")}let E=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});E.setAttr("aria-label","Discard"),E.setAttr("title","Discard");try{(0,b.setIcon)(E,"x")}catch(J){E.setText("Discard")}let N=()=>{this.display()},X=async J=>{let Z=J.trim();if(!Z||Z===C){N();return}if(this.plugin.settings.dimensions.some(Ce=>Ce!==h&&Ce.name===Z)){new b.Notice("A dimension with this name already exists.");return}h.name=Z,await this.plugin.saveSettings(),N()};I.onclick=async()=>{await X(R.value)},E.onclick=()=>N(),R.focus(),R.select(),R.onkeydown=async J=>{J.key==="Enter"&&await X(R.value),J.key==="Escape"&&N()},R.onblur=async()=>{await X(R.value)}},h.categories.length>0){let C=_.createDiv({cls:"categories-list gc-list"});h.categories.forEach((S,R)=>{var Ce;let $=C.createDiv({cls:"gc-list-item gc-row"}),I=this.plugin.settings.projectRecords||{},E=h.name,N=Object.keys(((Ce=I==null?void 0:I[E])==null?void 0:Ce[S])||{}),X=$.createEl("b",{text:S}),ae=$.createDiv({cls:"gc-id-wrap"});N.length>0&&(ae.createSpan({text:" "}),N.forEach((U,Ve)=>{let G=ae.createSpan({cls:"gc-id-chip"});G.style.display="inline-flex",G.style.alignItems="center",G.style.gap="4px";let Te=G.createSpan({cls:"gc-id-tag",text:U}),ce=Math.abs(mo(U))%360;Te.style.backgroundColor=`hsl(${ce}, 70%, 90%)`,Te.style.color=`hsl(${ce}, 70%, 25%)`;let Q=G.createSpan({cls:"gc-id-actions"});Q.style.display="none";let ee=Q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ee.setAttr("aria-label",`Delete ${U}`),ee.setAttr("title",`Delete ${U}`);try{(0,b.setIcon)(ee,"trash")}catch(le){ee.setText("Del")}ee.onclick=async le=>{le.stopPropagation();let[,te]=await Ze(this.plugin,E,S,U);new b.Notice(te),this.display()};let re=Q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});re.setAttr("aria-label",`Archive ${U}`),re.setAttr("title",`Archive ${U}`);try{(0,b.setIcon)(re,"archive")}catch(le){re.setText("Arc")}re.onclick=async le=>{le.stopPropagation();let[,te]=await Qe(this.plugin,E,S,U);new b.Notice(te),this.display()},G.onmouseenter=()=>{Q.style.display="inline-flex"},G.onmouseleave=()=>{Q.style.display="none"},Ve<N.length-1&&ae.createSpan({text:" "})})),$.createDiv({cls:"gc-spacer"});let J=$.createEl("button",{cls:["remove-category","gc-icon-button","clickable-icon"]});J.setAttr("aria-label",`Delete ${S}`),J.setAttr("title",`Delete ${S}`);try{(0,b.setIcon)(J,"trash")}catch(U){J.setText("Remove")}J.onclick=async()=>{h.categories.splice(R,1),await this.plugin.saveSettings(),this.display()};let Z=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Z.setAttr("aria-label",`Rename ${S}`),Z.setAttr("title",`Rename ${S}`);try{(0,b.setIcon)(Z,"pencil")}catch(U){Z.setText("Edit")}Z.onclick=async()=>{var le;let U=h.categories[R],Ve=X.parentElement;(le=X.detach)==null||le.call(X),Z.style.display="none",J.style.display="none";let G=Ve.createEl("input",{type:"text"});G.value=U,G.addClass("gc-rename");let Te=Ve.createDiv({cls:"gc-row"});Te.createDiv({cls:"gc-spacer"});let ce=Te.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ce.setAttr("aria-label","Apply"),ce.setAttr("title","Apply");try{(0,b.setIcon)(ce,"check")}catch(te){ce.setText("Apply")}let Q=Te.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Q.setAttr("aria-label","Discard"),Q.setAttr("title","Discard");try{(0,b.setIcon)(Q,"x")}catch(te){Q.setText("Discard")}let ee=()=>{this.display()},re=async te=>{let He=te.trim();if(!He||He===U){ee();return}if(h.categories.some((fr,hr)=>hr!==R&&fr===He)){new b.Notice("This category already exists in the dimension.");return}h.categories[R]=He,await this.plugin.saveSettings(),ee()};ce.onclick=async()=>{await re(G.value)},Q.onclick=()=>ee(),G.focus(),G.select(),G.onkeydown=async te=>{te.key==="Enter"&&await re(G.value),te.key==="Escape"&&ee()},G.onblur=async()=>{await re(G.value)}}})}let ge=_.createDiv({cls:"add-category gc-row"}),be=ge.createEl("input",{type:"text",placeholder:"New category"});ge.createDiv({cls:"gc-spacer"});let Ae=ge.createEl("button",{text:"Add Category"});Ae.onclick=async()=>{let C=be.value.trim();C&&!h.categories.includes(C)&&(h.categories.push(C),await this.plugin.saveSettings(),this.display())}});let f=o.createDiv({cls:"add-dimension"});f.createEl("h3",{text:"Add new dimension"});let y=f.createDiv({cls:"gc-row"}),j=y.createEl("input",{type:"text",placeholder:"Dimension name"});y.createDiv({cls:"gc-spacer"});let P=y.createEl("button",{text:"Add Dimension"});P.onclick=async()=>{let h=j.value.trim();if(h&&!this.plugin.settings.dimensions.some(A=>A.name===h)){{let A=this.plugin.settings.dimensions.reduce((_,D)=>{var W;return Math.max(_,(W=D.order)!=null?W:0)},0);this.plugin.settings.dimensions.push({name:h,order:A+1,categories:[]})}await this.plugin.saveSettings(),this.display()}},o.createEl("h2",{text:"AI Module"});let d=o.createDiv({cls:"gc-column"}),g=d.createDiv({cls:"setting-item"});g.createEl("label",{text:"Enable AI module"});let v=g.createEl("input",{type:"checkbox"});v.checked=Boolean((Wt=this.plugin.settings.ai)==null?void 0:Wt.enabled),v.onchange=async()=>{var h,A;this.plugin.settings.ai||(this.plugin.settings.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com"}),this.plugin.settings.ai.enabled=v.checked,await this.plugin.saveSettings(),await((A=(h=this.plugin).toggleAiView)==null?void 0:A.call(h,v.checked))};let w=d.createDiv({cls:"setting-item"});w.createEl("label",{text:"Provider"});let x=w.createEl("select");["openai","anthropic","ollama"].forEach(h=>{let A=x.createEl("option",{text:h});A.value=h}),x.value=((Kt=this.plugin.settings.ai)==null?void 0:Kt.provider)||"openai",x.onchange=async()=>{if(!this.plugin.settings.ai)return;let h={openai:{baseUrl:"https://api.openai.com",model:"gpt-4o-mini"},anthropic:{baseUrl:"https://api.anthropic.com",model:"claude-3-5-sonnet-latest"},ollama:{baseUrl:"http://localhost:11434",model:"llama3.1"}};this.plugin.settings.ai.provider=x.value;let A=this.plugin.settings.ai.baseUrl||"",_=this.plugin.settings.ai.model||"",D=Object.values(h).map(B=>B.baseUrl),W=Object.values(h).map(B=>B.model);(!A||D.includes(A))&&(this.plugin.settings.ai.baseUrl=h[x.value].baseUrl),(!_||W.includes(_))&&(this.plugin.settings.ai.model=h[x.value].model),await this.plugin.saveSettings(),this.display()};let M=d.createDiv({cls:"setting-item"});M.createEl("label",{text:"API key (not required for local providers)"});let O=M.createEl("input",{type:"password"});O.placeholder="sk-...",O.value=((Yt=this.plugin.settings.ai)==null?void 0:Yt.apiKey)||"",O.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.apiKey=O.value.trim(),await this.plugin.saveSettings())};let Y=d.createDiv({cls:"setting-item"});Y.createEl("label",{text:"Model"});let z=Y.createEl("input",{type:"text"});z.placeholder=((zt=this.plugin.settings.ai)==null?void 0:zt.provider)==="anthropic"?"claude-3-5-sonnet-latest":((qt=this.plugin.settings.ai)==null?void 0:qt.provider)==="ollama"?"llama3.1":"gpt-4o-mini",z.value=((Xt=this.plugin.settings.ai)==null?void 0:Xt.model)||z.placeholder,z.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.model=z.value.trim()||"gpt-4o-mini",await this.plugin.saveSettings())};let T=d.createDiv({cls:"setting-item"});T.createEl("label",{text:"Base URL"});let k=T.createEl("input",{type:"text"});k.placeholder=((Zt=this.plugin.settings.ai)==null?void 0:Zt.provider)==="anthropic"?"https://api.anthropic.com":((Qt=this.plugin.settings.ai)==null?void 0:Qt.provider)==="ollama"?"http://localhost:11434":"https://api.openai.com",k.value=((eo=this.plugin.settings.ai)==null?void 0:eo.baseUrl)||k.placeholder,k.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.baseUrl=k.value.trim()||"https://api.openai.com",await this.plugin.saveSettings())};let q=d.createDiv({cls:"setting-item"});q.createEl("label",{text:"Strict execution mode"});let me=q.createEl("input",{type:"checkbox"});me.checked=Boolean((to=this.plugin.settings.ai)==null?void 0:to.strictExecution),me.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.strictExecution=me.checked,await this.plugin.saveSettings())};let ve=d.createDiv({cls:"setting-item"});ve.createEl("label",{text:"Conversation memory (messages)"});let oe=ve.createEl("input",{type:"number"});oe.min="0",oe.max="50",oe.value=String((ro=(oo=this.plugin.settings.ai)==null?void 0:oo.memoryLimit)!=null?ro:10),oe.onchange=async()=>{if(!this.plugin.settings.ai)return;let h=Number(oe.value);this.plugin.settings.ai.memoryLimit=Number.isFinite(h)?Math.max(0,Math.min(50,h)):10,await this.plugin.saveSettings()};let Je=d.createDiv({cls:"setting-item"});Je.createEl("label",{text:"MCP servers (JSON array)"});let we=Je.createEl("textarea");we.placeholder='[{"name":"calendar","url":"http://localhost:3000","apiKey":""}]',we.value=JSON.stringify(((no=this.plugin.settings.ai)==null?void 0:no.mcpServers)||[]),we.onchange=async()=>{if(this.plugin.settings.ai)try{let h=JSON.parse(we.value||"[]");this.plugin.settings.ai.mcpServers=Array.isArray(h)?h:[],await this.plugin.saveSettings()}catch(h){new b.Notice("Invalid MCP servers JSON")}},o.createEl("h2",{text:"Archive"});let Ee=this.plugin.settings.archivedRecords||{},Ue=Ee&&!Array.isArray(Ee)?Ee:{},Vt={};for(let h of this.plugin.settings.dimensions)Vt[h.name]=(so=h.order)!=null?so:Number.MAX_SAFE_INTEGER;let ur=Object.keys(Ue).map(h=>{var A;return{name:h,order:(A=Vt[h])!=null?A:Number.MAX_SAFE_INTEGER}}).sort((h,A)=>h.order-A.order||h.name.localeCompare(A.name)),Ht=!1;ur.forEach(({name:h,order:A})=>{let _=Ue[h]||{},D=Object.keys(_).filter(L=>Object.keys(_[L]||{}).length>0).sort();if(D.length===0)return;Ht=!0;let W=o.createDiv({cls:"dimension-setting"}),B=W.createDiv({cls:"dimension-header gc-row"}),se=this.plugin.settings.dimensions.find(L=>L.name===h);se&&B.createSpan({text:`${se.order}. `}),B.createEl("b",{text:h}),B.createDiv({cls:"gc-spacer"});let ie=W.createDiv({cls:"categories-list gc-list"});D.forEach(L=>{let ge=ie.createDiv({cls:"gc-list-item gc-row"}),be=Object.keys((_==null?void 0:_[L])||{}).sort();ge.createEl("b",{text:L});let Ae=ge.createDiv({cls:"gc-id-wrap"});be.length>0&&(Ae.createSpan({text:" "}),be.forEach((C,S)=>{let R=Ae.createSpan({cls:"gc-id-chip"});R.style.display="inline-flex",R.style.alignItems="center",R.style.gap="4px";let $=R.createSpan({cls:"gc-id-tag",text:C}),I=Math.abs(mo(C))%360;$.style.backgroundColor=`hsl(${I}, 70%, 90%)`,$.style.color=`hsl(${I}, 70%, 25%)`;let E=R.createSpan({cls:"gc-id-actions"});E.style.display="none";let N=E.createEl("button",{cls:["gc-icon-button","clickable-icon"]});N.setAttr("aria-label",`Delete ${C}`),N.setAttr("title",`Delete ${C}`);try{(0,b.setIcon)(N,"trash")}catch(X){N.setText("Del")}N.onclick=async X=>{X.stopPropagation();let[,ae]=await this.plugin.deleteArchivedProject(h,L,C);new b.Notice(ae),this.display()},R.onmouseenter=()=>{E.style.display="inline-flex"},R.onmouseleave=()=>{E.style.display="none"},S<be.length-1&&Ae.createSpan({text:" "})})),ge.createDiv({cls:"gc-spacer"})})}),Ht||o.createDiv({cls:"setting-item"}).createSpan({text:"No archived projects yet."})}};var kt=require("obsidian");var go=require("obsidian"),ot=class extends go.Modal{constructor(o,r,n){super(o);this.prompt=r,this.callback=n}onOpen(){let{contentEl:o}=this;o.createEl("h2",{text:this.prompt});let r=o.createEl("input",{type:"text"});r.focus();let n=o.createEl("button",{text:"Submit"});n.onclick=()=>{let s=r.value.trim();this.close(),this.callback(s||null)}}onClose(){let{contentEl:o}=this;o.empty()}};var uo=require("obsidian"),$e=class extends uo.Modal{constructor(o,r,n,s){super(o);this.prompt=r,this.choices=n,this.callback=s}onOpen(){let{contentEl:o}=this;o.createEl("h2",{text:this.prompt}),this.choices.forEach(r=>{let n=o.createEl("button",{text:r});n.onclick=()=>{this.close(),this.callback(r)}})}onClose(){let{contentEl:o}=this;o.empty()}};async function Ne(e,t){return new Promise(o=>{new ot(e,t,o).open()})}async function xe(e,t,o){return new Promise(r=>{new $e(e,t,o,r).open()})}async function yo(e,t){var f,y;let o=await Ne(e,"Enter project name:");if(!o)return[null,"Project creation cancelled. No project name provided."];let r=await Ne(e,"Enter project tag:");if(!r)return[null,"Project creation cancelled. No project tag provided."];let n=await Ne(e,"Enter Project ID (used for task prefixes):");if(!n)return[null,"Project creation cancelled. No Project ID provided."];let s=await Ne(e,"Enter parent name (optional):"),i=s&&s.trim().length>0?s.trim():null,a=[...t.dimensions].sort((j,P)=>{var d,g;return((d=j.order)!=null?d:0)-((g=P.order)!=null?g:0)}).map(j=>j.name),p=await xe(e,"Select dimension:",a);if(!p)return[null,"Project creation cancelled. No dimension selected."];let l=t.dimensions.find(j=>j.name===p);if(!l||l.categories.length===0)return[null,"Selected dimension has no categories. Please add categories in settings first."];let c=l.categories,u=await xe(e,"Select category:",c);if(!u)return[null,"Project creation cancelled. No category selected."];let m={name:o,tag:r,id:n,parent:i,dimension:p,category:u};try{let j=t.projectRecords;if(j&&!Array.isArray(j)&&((y=(f=j[p])==null?void 0:f[u])==null?void 0:y[n]))return[null,`Project with ID "${n}" already exists in ${p}:${u}. Choose a different ID.`]}catch(j){}try{let{validateProjectName:j,validateTag:P,ensureValidOrThrow:d}=await Promise.resolve().then(()=>(ho(),fo));d(()=>j(m.name),"Invalid project name"),d(()=>P(m.tag),"Invalid tag"),d(()=>P(m.id),"Invalid Project ID")}catch(j){let P=j.message||"Invalid input";return console.error("Validation error:",j),[null,P]}return[m,"Project details collected."]}async function rt(e,t){var c;if(!t.projectRecords)return[null,"You don't have any projects yet."];let o=t.projectRecords,r=[...t.dimensions].sort((u,m)=>{var f,y;return((f=u.order)!=null?f:0)-((y=m.order)!=null?y:0)}).map(u=>u.name),n=await xe(e,"Select dimension of your project:",r);if(!n)return[null,"Project action cancelled. No dimension selected."];let s=t.dimensions.find(u=>u.name===n);if(!s||s.categories.length===0)return[null,"Selected dimension has no categories. No project found."];let i=s.categories,a=await xe(e,"Select category:",i);if(!a)return[null,"Project action cancelled. No category selected."];let p=(c=o[n])==null?void 0:c[a];if(!p||Object.keys(p).length===0)return[null,"No projects found in this category."];let l=await xe(e,"Select Project:",Object.keys(p));return l?[{dimension:n,category:a,projectId:l},"Project details collected."]:[null,"Project action cancelled. No project selected."]}Mt();async function Ro(e){let[t,o]=await yo(e.app,e.settings);if(t===null){new kt.Notice(o);return}let[,r]=await ct(e,t);new kt.Notice(r),console.log(r)}var $t=require("obsidian");async function Eo(e){let[t,o]=await rt(e.app,e.settings);if(t===null){new $t.Notice(o);return}let{dimension:r,category:n,projectId:s}=t,[,i]=await Ze(e,r,n,s);new $t.Notice(i),console.log(i)}var Nt=require("obsidian");async function bo(e){let[t,o]=await rt(e.app,e.settings);if(t===null){new Nt.Notice(o);return}let{dimension:r,category:n,projectId:s}=t,[,i]=await Qe(e,r,n,s);new Nt.Notice(i),console.log(i)}var Go=require("obsidian");async function Ao(e){let t=[];for(let o of e)try{let r=`${o.url.replace(/\/$/,"")}/tools`,n=await fetch(r,{method:"GET",headers:o.apiKey?{"x-api-key":o.apiKey}:void 0});if(!n.ok)continue;let s=await n.json(),i=Array.isArray(s==null?void 0:s.tools)?s.tools:[];t.push({server:o,tools:i})}catch(r){}return t}function Co(e,t){return t.map(o=>({name:`${e.name}:${o.name}`,description:o.description||"MCP tool",schema:o.inputSchema||{type:"object",properties:{},additionalProperties:!0},handler:async r=>Lr(e,o.name,r)}))}async function Lr(e,t,o){let r=`${e.url.replace(/\/$/,"")}/call`,n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",...e.apiKey?{"x-api-key":e.apiKey}:{}},body:JSON.stringify({name:t,args:o})});if(!n.ok){let s=await n.text().catch(()=>"");throw new Error(`MCP call failed: ${n.status} ${s||n.statusText}`)}return await n.json().catch(()=>({}))}var lt={type:"object",description:"Reference to a project by tag, id, or full name.",properties:{tag:{type:"string"},id:{type:"string"},fullName:{type:"string"}},additionalProperties:!1},Br={type:"object",description:"Fields to set on the entity (camelCase, e.g. title, description).",properties:{title:{type:"string"},description:{type:"string"}},additionalProperties:!0};function pt(e){let t=e.getApi();return t?[{name:"resolveProject",description:"Resolve a project by tag, id, or full name.",schema:{type:"object",properties:{projectRef:lt},required:["projectRef"],additionalProperties:!1},handler:async o=>t.resolveProject(o.projectRef)},{name:"listEntityTypes",description:"List available entity types.",schema:{type:"object",properties:{},additionalProperties:!1},handler:async()=>t.listEntityTypes()},{name:"createProject",description:"Create a project with the required metadata.",schema:{type:"object",properties:{name:{type:"string"},tag:{type:"string"},id:{type:"string"},dimension:{type:"string"},category:{type:"string"},parent:{type:"string"},projectTypeId:{type:"string"}},required:["name","tag","id","dimension","category"],additionalProperties:!1},handler:async o=>t.createProject(o)},{name:"createEntity",description:"Create an entity inside a project using a template.",schema:{type:"object",properties:{projectRef:lt,entityTypeId:{type:"string"},fields:Br},required:["projectRef","entityTypeId"],additionalProperties:!1},handler:async o=>t.createEntity(o)},{name:"patchMarker",description:"Patch content into a file at an AI marker.",schema:{type:"object",properties:{path:{type:"string"},marker:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","marker","content"],additionalProperties:!1},handler:async o=>t.patchMarker(o)},{name:"patchSection",description:"Patch content into a file by heading.",schema:{type:"object",properties:{path:{type:"string"},heading:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","heading","content"],additionalProperties:!1},handler:async o=>t.patchSection(o)},{name:"getChildren",description:"Get child projects for a given project.",schema:{type:"object",properties:{projectRef:lt,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async o=>t.getChildren(o.projectRef,o.archived)},{name:"getParents",description:"Get parent projects for a given project.",schema:{type:"object",properties:{projectRef:lt,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async o=>t.getParents(o.projectRef,o.archived)}]:[]}async function dt(e){var n;let t=((n=e.settings.ai)==null?void 0:n.mcpServers)||[];if(t.length===0)return[];let o=await Ao(t),r=[];for(let s of o)r.push(...Co(s.server,s.tools));return r}async function*So(e,t,o){var c,u;let r=`${e.baseUrl.replace(/\/$/,"")}/v1/chat/completions`,n={model:e.model,messages:t.map(m=>{let f={role:m.role,content:m.content};return m.role==="tool"&&m.toolCallId&&(f.tool_call_id=m.toolCallId),m.role==="assistant"&&m.toolCalls&&m.toolCalls.length>0&&(f.tool_calls=m.toolCalls.map(y=>{var j;return{id:y.id,type:"function",function:{name:y.name,arguments:JSON.stringify((j=y.arguments)!=null?j:{})}}})),f}),tools:o.map(m=>({type:"function",function:{name:m.name,description:m.description,parameters:m.schema}})),tool_choice:"auto",stream:!0},s={"Content-Type":"application/json"};e.apiKey&&(s.Authorization=`Bearer ${e.apiKey}`);let i=await fetch(r,{method:"POST",headers:s,body:JSON.stringify(n)});if(!i.ok||!i.body){let m=await Jr(i);throw new Error(`OpenAI request failed: ${i.status} ${m||i.statusText}`)}let a=i.body.getReader(),p=new TextDecoder,l="";for(;;){let{value:m,done:f}=await a.read();if(f)break;l+=p.decode(m,{stream:!0});let y=l.split(`
`);l=y.pop()||"";for(let j of y){let P=j.trim();if(!P.startsWith("data:"))continue;let d=P.replace(/^data:\s*/,"");if(d==="[DONE]"){yield{type:"done"};return}let g;try{g=JSON.parse(d)}catch(w){continue}let v=(u=(c=g==null?void 0:g.choices)==null?void 0:c[0])==null?void 0:u.delta;v&&(v.content&&(yield{type:"content",delta:v.content}),v.tool_calls&&(yield{type:"tool_call_delta",toolCalls:v.tool_calls.map(x=>{var M,O;return{index:x.index,id:x.id,name:(M=x.function)==null?void 0:M.name,arguments:(O=x.function)==null?void 0:O.arguments}})}))}}yield{type:"done"}}async function Jr(e){try{return await e.text()}catch(t){return""}}async function*Io(e,t,o){let r=`${e.baseUrl.replace(/\/$/,"")}/v1/messages`,{system:n,anthropicMessages:s}=Ur(t),i={model:e.model,max_tokens:1024,system:n,messages:s,tools:o.map(m=>({name:m.name,description:m.description,input_schema:m.schema})),stream:!0},a=await fetch(r,{method:"POST",headers:{"x-api-key":e.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify(i)});if(!a.ok||!a.body){let m=await Vr(a);throw new Error(`Anthropic request failed: ${a.status} ${m||a.statusText}`)}let p=a.body.getReader(),l=new TextDecoder,c="",u=new Set;for(;;){let{value:m,done:f}=await p.read();if(f)break;c+=l.decode(m,{stream:!0});let y=c.split(`
`);c=y.pop()||"";for(let j of y){let P=j.trim();if(!P.startsWith("data:"))continue;let d=P.replace(/^data:\s*/,"");if(!d||d==="[DONE]"){yield{type:"done"};return}let g;try{g=JSON.parse(d)}catch(w){continue}let v=g==null?void 0:g.type;if(v==="content_block_delta"){let w=g.delta;if((w==null?void 0:w.type)==="text_delta"&&(yield{type:"content",delta:w.text}),(w==null?void 0:w.type)==="input_json_delta"){if(u.has(g.index))continue;yield{type:"tool_call_delta",toolCalls:[{index:g.index,arguments:w.partial_json}]}}}if(v==="content_block_start"){let w=g.content_block;if((w==null?void 0:w.type)==="tool_use"){let x=w.input&&Object.keys(w.input).length>0;x&&u.add(g.index),yield{type:"tool_call_delta",toolCalls:[{index:g.index,id:w.id,name:w.name,arguments:x?JSON.stringify(w.input):""}]}}}if(v==="message_stop"){yield{type:"done"};return}}}yield{type:"done"}}function Ur(e){let t="",o=[];for(let r of e){if(r.role==="system"){t=[t,r.content].filter(Boolean).join(`
`);continue}if(r.role==="user"){o.push({role:"user",content:[{type:"text",text:r.content}]});continue}if(r.role==="assistant"){let n=[];if(r.content&&n.push({type:"text",text:r.content}),r.toolCalls&&r.toolCalls.length>0)for(let s of r.toolCalls)n.push({type:"tool_use",id:s.id||`tool-${s.name}`,name:s.name,input:s.arguments||{}});n.length>0&&o.push({role:"assistant",content:n});continue}r.role==="tool"&&o.push({role:"user",content:[{type:"tool_result",tool_use_id:r.toolCallId||r.name||"tool",content:r.content}]})}return{system:t,anthropicMessages:o}}async function Vr(e){try{return await e.text()}catch(t){return""}}async function*mt(e,t,o){if(e.provider==="anthropic"){if(!e.apiKey)throw new Error("Anthropic API key is missing");yield*Io({apiKey:e.apiKey,model:e.model||"claude-3-5-sonnet-latest",baseUrl:e.baseUrl||"https://api.anthropic.com"},t,o);return}let r=e.provider==="ollama"?e.baseUrl||"http://localhost:11434":e.baseUrl||"https://api.openai.com";if(!e.apiKey&&e.provider!=="ollama")throw new Error("OpenAI API key is missing");yield*So({apiKey:e.apiKey||"",model:e.model||(e.provider==="ollama"?"llama3.1":"gpt-4o-mini"),baseUrl:r},t,o)}function gt(e,t){for(let o of e){let r=t.get(o.index)||{name:"",arguments:{}};if(o.id&&(r.id=o.id),o.name&&(r.name=o.name),typeof o.arguments=="string"){let n=r._rawArgs||"";r._rawArgs=n+o.arguments}t.set(o.index,r)}}function ut(e){let t=[];for(let[,o]of e){let r=o._rawArgs;if(r)try{o.arguments=JSON.parse(r)}catch(n){o.arguments={}}delete o._rawArgs,t.push(o)}return t}function Dt(e){let t=new Set(["resolveProject","listProjects","listEntityTypes","describeEntityType","listProjectTypes","describeProjectType","getChildren","getParents"]);return e.filter(o=>t.has(o.name)||o.name.includes(":"))}function Fo(e){var o;let t=[];for(let r of e)!r.ok&&((o=r.error)!=null&&o.startsWith("Missing required fields:"))&&r.error.split(":").slice(1).join(":").split(",").forEach(s=>{let i=s.trim();i&&t.push(i)});return t}function Mo(e){let t=e.trim().toLowerCase();return["yes","y","confirm","ok","okay","proceed"].includes(t)}function ko(e){let t=e.trim().toLowerCase();return["no","n","cancel","stop"].includes(t)}function ft(e,t,o="$",r=[]){if(!e)return r;let n=e.type?Array.isArray(e.type)?e.type:[e.type]:[];if(n.length>0&&!n.some(i=>Hr(i,t)))return r.push({path:o,message:`Expected ${n.join("|")}`}),r;if(e.enum&&!e.enum.includes(t)&&r.push({path:o,message:"Value not in enum"}),e.type==="object"&&t&&typeof t=="object"&&!Array.isArray(t)){let s=t;if((e.required||[]).forEach(a=>{a in s||r.push({path:`${o}.${a}`,message:"Missing required field"})}),e.properties)for(let[a,p]of Object.entries(e.properties))a in s&&ft(p,s[a],`${o}.${a}`,r)}return e.type==="array"&&Array.isArray(t)&&e.items&&t.forEach((s,i)=>{ft(e.items,s,`${o}[${i}]`,r)}),r}function Hr(e,t){return e==="array"?Array.isArray(t):e==="integer"?Number.isInteger(t):e==="number"?typeof t=="number":e==="boolean"?typeof t=="boolean":e==="string"?typeof t=="string":e==="object"?t!=null&&typeof t=="object"&&!Array.isArray(t):!0}async function ht(e,t){let o=[],r=new Map(t.map(n=>[n.name,n]));for(let n of e){let s=r.get(n.name);if(!s){o.push({toolName:n.name,ok:!1,error:"Tool not found"});continue}let i=ft(s.schema,n.arguments);if(i.length>0){o.push({toolName:n.name,ok:!1,error:`Schema validation failed: ${i.map(a=>`${a.path}: ${a.message}`).join(", ")}`});continue}try{let a=await s.handler(n.arguments);o.push({toolName:n.name,ok:!0,result:a})}catch(a){o.push({toolName:n.name,ok:!1,error:(a==null?void 0:a.message)||"Tool execution failed"})}}return o}function Ot(e){if(e==null)return"(no result)";if(typeof e=="string")return e;try{return JSON.stringify(e)}catch(t){return String(e)}}function $o(e){return new Promise(t=>setTimeout(t,e))}async function No(e){var o,r,n,s;let t=(o=e.maxSteps)!=null?o:6;for(let i=0;i<t;i+=1){let a=e.ui.appendMessage("assistant",""),p=new Map,l=new Map,c=Boolean((r=e.plugin.settings.ai)==null?void 0:r.strictExecution),u=2,m=0;for(;;)try{for await(let d of mt(e.plugin.settings.ai,e.messages,e.tools)){if(d.type==="content"&&d.delta){let g=(a==null?void 0:a.textContent)||"";e.ui.updateMessage(a,g+d.delta)}if(d.type==="tool_call_delta"&&d.toolCalls){gt(d.toolCalls,l);for(let g of d.toolCalls)if(g.name&&!p.has(g.name)){let v=e.ui.appendMessage("tool",`Using tool: ${g.name}`);v&&p.set(g.name,v)}}}break}catch(d){if(m+=1,m>u)throw d;e.ui.appendMessage("tool",`Retrying LLM request (${m}/${u})...`),await $o(300*m)}let f=ut(l),y=(a==null?void 0:a.textContent)||"";if(e.messages.push({role:"assistant",content:y,toolCalls:f}),e.state.appendMessage({role:"assistant",content:y}),f.length===0)return;for(let d of f)e.ui.appendMessage("tool",`Tool call: ${d.name} ${Ot(d.arguments)}`);let j=await ht(f,e.tools),P=Fo(j);for(let d=0;d<j.length;d+=1){let g=j[d],v=g.ok?{ok:!0,result:g.result}:{ok:!1,error:g.error},w=g.ok?`Tool result (${g.toolName}): ${Ot(g.result)}`:`Tool error (${g.toolName}): ${g.error}`;e.ui.appendMessage("tool",w),e.state.appendMessage({role:"tool",name:g.toolName,toolCallId:(n=f[d])==null?void 0:n.id,content:JSON.stringify(v)}),e.state.recordToolLog(g.toolName,g.ok,g.error),e.messages.push({role:"tool",name:g.toolName,toolCallId:(s=f[d])==null?void 0:s.id,content:JSON.stringify(v)})}if(c&&j.some(d=>!d.ok)){e.ui.appendMessage("assistant","Strict mode: tool execution failed. Please adjust input and try again.");return}if(P.length>0){let d=Array.from(new Set(P));e.ui.appendMessage("assistant",`Missing required fields: ${d.join(", ")}. Please provide them and try again.`);return}}e.ui.appendMessage("assistant","Stopped after reaching max tool steps.")}var Wr=["You are a planner for ProjectFlow AI.","Return ONLY valid JSON with keys: needsFollowup (boolean), question (string), plan (string), context (string), fields (object).","fields must include required values for createEntity/createProject when applicable (e.g., TITLE, DESCRIPTION).","If you need more info, set needsFollowup=true and ask a concise question.","If you have enough info, set needsFollowup=false and provide a short plan, context summary, and fields.","Do NOT call tools in this stage."].join(`
`);async function _t(e){var n;let t=[{role:"system",content:Wr},...e.messages.filter(s=>s.role!=="tool")],o=await Kr({plugin:e.plugin,messages:t,tools:e.tools,allowToolCalls:(n=e.allowToolCalls)!=null?n:!1}),r=Yr(o);return r||{needsFollowup:!1,plan:"",context:"",fields:{}}}async function Kr(e){var n;let t="",r=e.allowToolCalls?e.tools:[];for(let s=0;s<6;s+=1){let i=new Map;t="";for await(let l of mt(e.plugin.settings.ai,e.messages,r))l.type==="content"&&l.delta&&(t+=l.delta),l.type==="tool_call_delta"&&l.toolCalls&&gt(l.toolCalls,i);let a=ut(i);if(e.messages.push({role:"assistant",content:t,toolCalls:a}),a.length===0||!e.allowToolCalls)return t.trim();let p=await ht(a,e.tools);for(let l=0;l<p.length;l+=1){let c=p[l],u=c.ok?{ok:!0,result:c.result}:{ok:!1,error:c.error};e.messages.push({role:"tool",name:c.toolName,toolCallId:(n=a[l])==null?void 0:n.id,content:JSON.stringify(u)})}}return t.trim()}function Yr(e){let t=e.indexOf("{"),o=e.lastIndexOf("}");if(t===-1||o===-1||o<=t)return null;let r=e.slice(t,o+1);try{let n=JSON.parse(r),s=n.fields&&typeof n.fields=="object"?n.fields:{};return{needsFollowup:Boolean(n.needsFollowup),question:typeof n.question=="string"?n.question:"",plan:typeof n.plan=="string"?n.plan:"",context:typeof n.context=="string"?n.context:"",fields:s}}catch(n){return null}}function Do(e){let t=e.app.workspace.getActiveFile();if(!t)return null;let o=e.settings.projectIndex;if(!o)return null;let r=t.path,n=Object.values(o.byFullName||{}),s=null;for(let i of n)i.path&&r.startsWith(i.path)&&(!s||i.path.length>s.path.length)&&(s=i);return s}function Oo(e,t,o=5){let r=e.settings.projectIndex;if(!r)return[];let n=t.trim().toLowerCase();return n?Object.values(r.byFullName||{}).map(a=>{var u,m;let p=((u=a.projectTag)==null?void 0:u.toLowerCase())||"",l=((m=a.projectName)==null?void 0:m.toLowerCase())||"",c=0;return p===n&&(c+=100),l===n&&(c+=90),p.startsWith(n)&&(c+=60),l.startsWith(n)&&(c+=50),p.includes(n)&&(c+=30),l.includes(n)&&(c+=20),{entry:a,score:c}}).filter(a=>a.score>0).sort((a,p)=>p.score-a.score).slice(0,o).map(a=>a.entry):[]}async function yt(e){let t=zr(e),o=e.app.workspace.getActiveFile(),r="";if(o)try{r=(await e.app.vault.cachedRead(o)).slice(0,1e3)}catch(a){r=""}let n=e.settings.projectIndex,s=Do(e),i=qr(e);return["You are ProjectFlow AI. You must use tools to perform any actions.","Never edit markdown directly; use tools only.","Respond with tool calls when an action is required.","If required fields are missing, ask the user for them instead of calling tools.","Use camelCase fields in createEntity (e.g., fields.title, fields.description).",'Example tool call: createEntity { projectRef:{tag:"my-tag"}, entityTypeId:"task", fields:{ title:"...", description:"..." } }',"Context:",`Selected text: ${t||"(none)"}`,`Active file: ${(o==null?void 0:o.path)||"(none)"}`,`Active file content (truncated): ${r||"(none)"}`,`Active project: ${s?`${s.projectTag} (${s.fullName})`:"(none)"}`,`Entity required fields: ${i}`,`Project index snapshot: ${n?JSON.stringify(n):"(none)"}`].join(`
`)}function _o(e){return`I'm going to create a project with tag ${e}
${e}`}function zr(e){var o;let t=(o=e.app.workspace.activeEditor)==null?void 0:o.editor;return t?t.getSelection():""}function qr(e){let t=e.settings.entityTypes||{},o={};for(let[r,n]of Object.entries(t))n!=null&&n.requiredFields&&n.requiredFields.length>0&&(o[r]=n.requiredFields);try{return JSON.stringify(o)}catch(r){return"(unavailable)"}}var Oe=class{constructor(t,o,r){this.plugin=t;this.ui=o;this.state=r;this.busy=!1;this.pendingPlan=null;this.pendingPlan=this.state.getPendingPlan()}async handleSend(t){if(this.busy)return;let o=t.trim();if(!o)return;this.ui.appendMessage("user",o);let r=this.plugin.settings.ai;if(!(r!=null&&r.enabled)){this.ui.appendMessage("assistant","AI module is disabled in settings.");return}if(!r.apiKey&&r.provider!=="ollama"){await this.handleTagLookup(o);return}await this.handleLLM(o)}onClose(){this.state.flushConversation()}clearConversation(){this.pendingPlan=null,this.state.clearConversation(),this.state.setPendingPlan(null),this.ui.clearMessages(),this.ui.appendMessage("assistant","Conversation cleared.")}async handleFollowup(t){let o=this.pendingPlan;if(!o)return;let r=t.trim();if(!r)return;this.state.appendMessage({role:"user",content:r});let n=pt(this.plugin),s=await dt(this.plugin),i=[...n,...s];if(o.status==="awaiting_confirmation"){if(Mo(r)){let v=await yt(this.plugin),w=this.state.getConversationWindow().filter(O=>O.role!=="tool"),x=[`Original request: ${o.originalInput}`,o.plan?`Plan: ${o.plan}`:"",o.context?`Context: ${o.context}`:"",o.fields?`Fields: ${JSON.stringify(o.fields)}`:"",o.clarifications&&o.clarifications.length>0?`Clarifications: ${o.clarifications.join(" | ")}`:"","User confirmed to proceed."].filter(Boolean).join(`
`),M=[{role:"system",content:v},...w,{role:"user",content:x}];this.setPendingPlan(null),await No({plugin:this.plugin,ui:this.ui,state:this.state,messages:M,tools:i});return}if(ko(r)){this.setPendingPlan(null),this.ui.appendMessage("assistant","Cancelled. Tell me if you want to try a different action."),this.state.appendMessage({role:"assistant",content:"Cancelled. Tell me if you want to try a different action."});return}this.ui.appendConfirmationActions(),this.ui.appendMessage("assistant","Please confirm to proceed with these actions."),this.state.appendMessage({role:"assistant",content:"Please confirm to proceed with these actions."});return}let a=Dt(i),p=await yt(this.plugin),l=this.state.getConversationWindow().filter(v=>v.role!=="tool"),c=o.clarifications||[];c.push(r),o.clarifications=c;let u=[`Original request: ${o.originalInput}`,o.plan?`Plan so far: ${o.plan}`:"",o.context?`Context so far: ${o.context}`:"",`User clarification: ${r}`].filter(Boolean).join(`
`),m=[{role:"system",content:p},...l,{role:"user",content:u}],f=await _t({plugin:this.plugin,messages:m,tools:a,allowToolCalls:!1});if(f.needsFollowup&&f.question){o.plan=f.plan,o.context=f.context,o.question=f.question,o.fields=f.fields,o.status="clarifying",this.setPendingPlan(o),this.ui.appendMessage("assistant",f.question),this.state.appendMessage({role:"assistant",content:f.question});return}o.plan=f.plan,o.context=f.context,o.fields=f.fields,o.status="awaiting_confirmation",this.setPendingPlan(o);let y=f.plan?`Planned steps: ${f.plan}`:"",j=f.context?`Planner context: ${f.context}`:"",P=f.fields&&Object.keys(f.fields).length>0?`Fields: ${JSON.stringify(f.fields)}`:"",d=[y,j,P].filter(Boolean).join(`
`);d&&(this.ui.appendMessage("assistant",d),this.state.appendMessage({role:"assistant",content:d})),this.ui.appendConfirmationActions();let g="Please confirm to proceed with these actions.";this.ui.appendMessage("assistant",g),this.state.appendMessage({role:"assistant",content:g})}async handleTagLookup(t){let o=this.plugin.getApi();if(!o){this.ui.appendMessage("assistant","Core API is not available.");return}try{let r=o.resolveProject({tag:t});if(!r){let n=Oo(this.plugin,t);if(n.length===0)this.ui.appendMessage("assistant","Project not found.");else if(n.length===1)this.ui.appendMessage("assistant",`Resolved project: ${n[0].fullName} (${n[0].projectTag})`);else{let s=n.map(i=>`- ${i.projectTag} (${i.fullName})`).join(`
`);this.ui.appendMessage("assistant",`Multiple matches found:
${s}`)}return}this.ui.appendMessage("assistant",`Resolved project: ${r.entry.fullName} (${r.entry.projectTag})`)}catch(r){this.ui.appendMessage("assistant",(r==null?void 0:r.message)||"Failed to resolve project.")}}async handleLLM(t){if(!this.busy){this.busy=!0,this.ui.setBusy(!0);try{this.pendingPlan?await this.handleFollowup(t):await this.handleNewRequest(t)}catch(o){this.ui.appendMessage("assistant",(o==null?void 0:o.message)||"LLM request failed.")}finally{this.busy=!1,this.ui.setBusy(!1)}}}async handleNewRequest(t){let o=pt(this.plugin),r=await dt(this.plugin),n=[...o,...r],s=Dt(n),i=await yt(this.plugin),a=_o(t),p=this.state.getConversationWindow().filter(P=>P.role!=="tool"),l=[{role:"system",content:i},...p,{role:"user",content:a}];this.state.appendMessage({role:"user",content:t});let c=await _t({plugin:this.plugin,messages:l,tools:s,allowToolCalls:!1});if(c.needsFollowup&&c.question){this.setPendingPlan({originalInput:t,plan:c.plan,context:c.context,question:c.question,fields:c.fields,createdAt:new Date().toISOString(),status:"clarifying",clarifications:[]}),this.ui.appendMessage("assistant",c.question),this.state.appendMessage({role:"assistant",content:c.question});return}let u=c.plan?`Planned steps: ${c.plan}`:"",m=c.context?`Planner context: ${c.context}`:"",f=c.fields&&Object.keys(c.fields).length>0?`Fields: ${JSON.stringify(c.fields)}`:"",y=[u,m,f].filter(Boolean).join(`
`);y&&(this.ui.appendMessage("assistant",y),this.state.appendMessage({role:"assistant",content:y})),this.setPendingPlan({originalInput:t,plan:c.plan,context:c.context,fields:c.fields,createdAt:new Date().toISOString(),status:"awaiting_confirmation",clarifications:[]}),this.ui.appendConfirmationActions();let j="Please confirm to proceed with these actions.";this.ui.appendMessage("assistant",j),this.state.appendMessage({role:"assistant",content:j})}setPendingPlan(t){this.pendingPlan=t,this.state.setPendingPlan(t)}};var Pt=class{constructor(t){this.plugin=t;this.conversation=[];this.persistTimer=null;var o;this.conversation=((o=this.plugin.settings.ai)==null?void 0:o.conversation)||[]}getConversationWindow(){var o,r;let t=Math.max(0,(r=(o=this.plugin.settings.ai)==null?void 0:o.memoryLimit)!=null?r:10);return t===0?[]:this.conversation.slice(-t)}appendMessage(t){var r,n;this.conversation.push({role:t.role,content:t.content,name:t.name,toolCallId:t.toolCallId});let o=Math.max(0,(n=(r=this.plugin.settings.ai)==null?void 0:r.memoryLimit)!=null?n:10);o>0&&this.conversation.length>o&&(this.conversation=this.conversation.slice(-o)),this.persistConversation()}clearConversation(){this.conversation=[],this.plugin.settings.ai&&(this.plugin.settings.ai.conversation=[],this.plugin.saveSettings())}flushConversation(){this.persistTimer&&(window.clearTimeout(this.persistTimer),this.persistTimer=null),this.plugin.settings.ai&&(this.plugin.settings.ai.conversation=this.conversation.map(t=>({role:t.role,content:t.content,name:t.name,toolCallId:t.toolCallId})),this.plugin.saveSettings())}recordToolLog(t,o,r){if(!this.plugin.settings.ai)return;let n=this.plugin.settings.ai.toolLog||[];n.push({ts:new Date().toISOString(),toolName:t,ok:o,error:r});let s=n.slice(-200);this.plugin.settings.ai.toolLog=s,this.plugin.saveSettings()}getPendingPlan(){var t;return((t=this.plugin.settings.ai)==null?void 0:t.pendingPlan)||null}setPendingPlan(t){this.plugin.settings.ai&&(this.plugin.settings.ai.pendingPlan=t,this.plugin.saveSettings())}persistConversation(){this.persistTimer&&window.clearTimeout(this.persistTimer),this.persistTimer=window.setTimeout(async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.conversation=this.conversation.map(t=>({role:t.role,content:t.content,name:t.name,toolCallId:t.toolCallId})),await this.plugin.saveSettings())},400)}};var ne="projectflow-ai-chat",_e=class extends Go.ItemView{constructor(o,r){super(o);this.messageContainer=null;this.inputEl=null;this.sendBtn=null;this.controller=null;this.plugin=r}getViewType(){return ne}getDisplayText(){return"ProjectFlow AI"}getIcon(){return"brain-circuit"}async onOpen(){let o=this.containerEl.children[1];o.empty(),o.addClass("pf-ai-view");let r=o.createDiv({cls:"pf-ai-header"});r.createEl("h3",{text:"ProjectFlow AI"});let n=r.createEl("button",{text:"Clear"});n.addClass("pf-ai-clear"),n.onclick=()=>{var c;return(c=this.controller)==null?void 0:c.clearConversation()};let s=o.createDiv({cls:"pf-ai-messages"});this.messageContainer=s;let i=o.createDiv({cls:"pf-ai-input"}),a=i.createEl("textarea");a.placeholder="Ask ProjectFlow...";let p=i.createEl("button",{text:"Send"});this.inputEl=a,this.sendBtn=p;let l=new Pt(this.plugin);this.controller=new Oe(this.plugin,this,l),p.onclick=()=>this.handleSend(),a.onkeydown=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),this.handleSend())}}async onClose(){var o;(o=this.controller)==null||o.onClose(),this.messageContainer=null,this.inputEl=null,this.sendBtn=null,this.controller=null}appendMessage(o,r){if(!this.messageContainer)return null;let n=this.messageContainer.createDiv({cls:`pf-ai-message ${o}`});return n.setText(r),this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}),n}updateMessage(o,r){var n;o&&(o.setText(r),(n=this.messageContainer)==null||n.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}))}appendConfirmationActions(){if(!this.messageContainer)return;let o=this.messageContainer.createDiv({cls:"pf-ai-confirmation"}),r=o.createEl("button",{text:"Proceed"});r.addClass("pf-ai-confirm");let n=o.createEl("button",{text:"Reject"});n.addClass("pf-ai-reject"),r.onclick=()=>{var s;return(s=this.controller)==null?void 0:s.handleFollowup("yes")},n.onclick=()=>{var s;return(s=this.controller)==null?void 0:s.handleFollowup("no")},this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"})}clearMessages(){var o;(o=this.messageContainer)==null||o.empty()}setBusy(o){this.sendBtn&&(this.sendBtn.disabled=o)}async handleSend(){var r,n;let o=(((r=this.inputEl)==null?void 0:r.value)||"").trim();o&&(this.inputEl&&(this.inputEl.value=""),await((n=this.controller)==null?void 0:n.handleSend(o)))}};var Tt=class extends gr.Plugin{async onload(){var o;console.log("ProjectFlow plugin loaded"),await this.loadSettings(),this.addSettingTab(new et(this.app,this)),this.registerView(ne,r=>new _e(r,this)),this.addCommand({id:"add-project-info",name:"Add Project Info",callback:()=>Ro(this)}),this.addCommand({id:"remove-project-by-id",name:"Remove Project",callback:()=>Eo(this)}),this.addCommand({id:"archive-project-by-id",name:"Archive Project",callback:()=>bo(this)}),await this.exposeCoreApi(),(o=this.settings.ai)!=null&&o.enabled&&this.app.workspace.onLayoutReady(()=>{this.toggleAiView(!0)})}async loadSettings(){let o=await this.loadData();try{let{migrateSettings:r,CURRENT_SETTINGS_SCHEMA_VERSION:n}=await Promise.resolve().then(()=>(Gt(),Lo)),{DEFAULT_ENTITY_TYPES:s,DEFAULT_PROJECT_TYPES:i}=await Promise.resolve().then(()=>(Se(),io)),{ensureProjectIndex:a}=await Promise.resolve().then(()=>(Pe(),Fe)),{ensureProjectGraph:p}=await Promise.resolve().then(()=>(je(),ke));this.settings=Object.assign({},tt,r(o));let l=!1;this.settings.templatesRoot||(this.settings.templatesRoot="Templates/ProjectFlow",l=!0),(!this.settings.entityTypes||Object.keys(this.settings.entityTypes).length===0)&&(this.settings.entityTypes=s,l=!0),(!this.settings.projectTypes||Object.keys(this.settings.projectTypes).length===0)&&(this.settings.projectTypes=i,l=!0),(!this.settings.schemaVersion||this.settings.schemaVersion<n)&&(this.settings.schemaVersion=n,l=!0);let{index:c,updated:u}=a(this.settings.projectIndex,this.settings.projectRecords);u&&(this.settings.projectIndex=c,l=!0);let{graph:m,updated:f}=p(this.settings.projectGraph,this.settings.projectRecords,this.settings.archivedRecords);f&&(this.settings.projectGraph=m,l=!0),l&&await this.saveData(this.settings)}catch(r){this.settings=Object.assign({},tt,o)}}async saveSettings(){await this.saveData(this.settings)}getApi(){return this.coreApi}async toggleAiView(o){if(o){let r=this.app.workspace.getLeavesOfType(ne);if(r.length>0){await r[0].setViewState({type:ne,active:!0});return}let n=this.app.workspace.getRightLeaf(!1);if(!n)return;await n.setViewState({type:ne,active:!0})}else this.app.workspace.detachLeavesOfType(ne)}onunload(){this.app.workspace.detachLeavesOfType(ne)}async exposeCoreApi(){let{createCoreApi:o}=await Promise.resolve().then(()=>(mr(),dr));this.coreApi=o(this);let r=window;r.PluginApi=r.PluginApi||{},r.PluginApi["@projectflow/core"]=this.coreApi}};var ln=Tt;
