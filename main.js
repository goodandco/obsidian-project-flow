/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var gt=Object.defineProperty;var $r=Object.getOwnPropertyDescriptor;var Nr=Object.getOwnPropertyNames;var Fr=Object.prototype.hasOwnProperty;var F=(e,t)=>()=>(e&&(t=e(e=0)),t);var V=(e,t)=>{for(var r in t)gt(e,r,{get:t[r],enumerable:!0})},Cr=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Nr(t))!Fr.call(e,n)&&n!==r&&gt(e,n,{get:()=>t[n],enumerable:!(o=$r(t,n))||o.enumerable});return e};var Dr=e=>Cr(gt({},"__esModule",{value:!0}),e);var Ct={};V(Ct,{DEFAULT_ENTITY_TYPES:()=>ce,DEFAULT_PROJECT_TYPES:()=>me});var ce,me,Ae=F(()=>{ce={task:{id:"task",name:"Task",templatePath:"template-task.md",targetFolder:"Work/Tasks",filenameRule:"${PROJECT_ID}-${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},"meeting.planning":{id:"meeting.planning",name:"Meeting (Planning)",templatePath:"template-meeting-planning.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.refinement":{id:"meeting.refinement",name:"Meeting (Refinement)",templatePath:"template-meeting-refinement.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.retro":{id:"meeting.retro",name:"Meeting (Retro)",templatePath:"template-meeting-retro.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.demo":{id:"meeting.demo",name:"Meeting (Demo)",templatePath:"template-meeting-demo.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.daily":{id:"meeting.daily",name:"Meeting (Daily)",templatePath:"template-meeting-daily.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.knowledge":{id:"meeting.knowledge",name:"Meeting (Knowledge)",templatePath:"template-meeting-knowledge.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},sprint:{id:"sprint",name:"Sprint",templatePath:"template-sprint.md",targetFolder:"Work",filenameRule:"Sprint ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},idea:{id:"idea",name:"Idea",templatePath:"template-idea.md",targetFolder:"Knowledge Base",filenameRule:"Idea ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:CONTENT"]}},me={operational:{id:"operational",name:"Operational",description:"Default ProjectFlow structure for active projects.",folderStructure:["Knowledge Base","Meetings","Work","Work/Tasks","People"],initialNotes:[{fileName:"${PROJECT_FULL_NAME}.md",template:"project.md"},{fileName:"${PROJECT_NAME} Meetings.md",template:"meetings.md"},{fileName:"${PROJECT_NAME} People.md",template:"people.md"},{fileName:"${PROJECT_NAME} Work.md",template:"work.md"},{fileName:"${PROJECT_NAME} Knowledge Base.md",template:"knowledge-base.md"}],allowedEntityTypes:Object.keys(ce)}}});var ge={};V(ge,{SafeFileManager:()=>ut});var ut,ue=F(()=>{ut=class{constructor(t){this.vault=t.vault}async createBatch(t){let r=[];try{for(let o of t)o.type==="folder"?await this.ensureFolder(o.path):await this.createIfAbsent(o.path,o.data)==="created"&&r.push(o.path);return{ok:!0}}catch(o){for(let n of r.reverse())try{let s=this.vault.getAbstractFileByPath(n);s&&this.vault.delete&&await this.vault.delete(s)}catch(s){}return{ok:!1,error:o}}}async has(t){var r;try{return this.vault.getAbstractFileByPath(t)?!0:(r=this.vault.adapter)!=null&&r.exists?await this.vault.adapter.exists(t):!1}catch(o){return!1}}async ensureFolder(t){var o;if(!this.vault.getAbstractFileByPath(t))try{await this.vault.createFolder(t)}catch(n){if(n&&typeof n=="object"&&((o=n.message)!=null&&o.includes("Parent folder"))){let s=t.split("/").filter(Boolean),i="";for(let a of s)if(i=i?`${i}/${a}`:a,!this.vault.getAbstractFileByPath(i))try{await this.vault.createFolder(i)}catch(l){}}}}async createIfAbsent(t,r){if(await this.has(t))return"skipped";try{return await this.vault.create(t,r),"created"}catch(o){return await this.has(t),"skipped"}}async removeDir(t){let r=this.vault.getAbstractFileByPath(t);if(r&&this.vault)try{await this.vault.trash(r,!0),await new Promise(o=>setTimeout(o,200))}catch(o){console.warn(`removeDir: failed to trash ${t}: ${o}`)}else console.warn(`removeDir: file not found: ${t}. File: ${r==null?void 0:r.path}`)}}});var Ie={};V(Ie,{sanitizeFileName:()=>Ue,sanitizePath:()=>W});function Ue(e){let t=(e!=null?e:"").trim();return Array.from(t).filter(o=>o.charCodeAt(0)>=32).join("").replace(/[\\/:*?"<>|]/g,"-").replace(/\s+/g," ").replace(/\.+$/g,"").substring(0,200)||"untitled"}function W(e){return e?e.split("/").filter(Boolean).map(Ue).join("/"):""}var fe=F(()=>{});var ke={};V(ke,{PROJECT_INDEX_VERSION:()=>ft,addToProjectIndex:()=>Or,buildProjectIndex:()=>_t,ensureProjectIndex:()=>Ke,getProjectIndexCache:()=>He,removeFromProjectIndex:()=>Mr,setProjectIndexCache:()=>_r,toIndexEntry:()=>ht});function He(){return We}function _r(e){We=e}function _t(e){let t={},r={},o={};if(e&&typeof e=="object"){for(let[n,s]of Object.entries(e))if(!(!s||typeof s!="object")){for(let[i,a]of Object.entries(s))if(!(!a||typeof a!="object"))for(let[l,c]of Object.entries(a)){if(!c||!c.variables||!c.info)continue;let p=ht(c,l,n,i);t[p.fullName]=p,r[p.projectId]=p,o[p.projectTag]=p}}}return{version:1,byFullName:t,byId:r,byTag:o}}function ht(e,t,r,o){var n;return{fullName:e.variables.PROJECT_FULL_NAME,projectId:t,projectTag:e.variables.PROJECT_TAG,path:e.variables.PROJECT_PATH,dimension:r,category:o,projectName:e.info.name,parent:(n=e.info.parent)!=null?n:null}}function Ke(e,t){if(!e||e.version!==1){let r=_t(t);return We=r,{index:r,updated:!0}}return We=e,{index:e,updated:!1}}function Or(e,t,r,o,n){let s=ht(t,r,o,n);return e.byFullName[s.fullName]=s,e.byId[s.projectId]=s,e.byTag[s.projectTag]=s,e}function Mr(e,t){return delete e.byFullName[t.fullName],delete e.byId[t.projectId],delete e.byTag[t.projectTag],e}var ft,We,he=F(()=>{ft=1,We=null});var $e={};V($e,{PROJECT_GRAPH_VERSION:()=>yt,addProjectToGraph:()=>Br,buildProjectGraph:()=>Pt,cleanArchivedGraph:()=>jt,ensureProjectGraph:()=>Se,getChildren:()=>wt,getParents:()=>vt,getProjectGraphCache:()=>Gr,removeProjectFromGraph:()=>Vr,setProjectGraphCache:()=>Lr});function Gr(){return Ye}function Lr(e){Ye=e}function Pt(e,t){let r={},o={};return e&&Ot(e,r),t&&Ot(t,o),{version:1,byFullName:r,archivedByFullName:o}}function Se(e,t,r){if(!e||e.version!==1){let o=Pt(t,r);return Ye=o,{graph:o,updated:!0}}return Ye=e,{graph:e,updated:!1}}function Br(e,t,r){let o=t.variables.PROJECT_FULL_NAME,n=Mt(t.info.parent),s=r?e.archivedByFullName:e.byFullName;if(s[o]=s[o]||{parent:n,children:[]},s[o].parent=n!=null?n:null,n){let i=s[n]||{parent:null,children:[]};i.children.includes(o)||i.children.push(o),s[n]=i}return e}function Vr(e,t,r){let o=r?e.archivedByFullName:e.byFullName,n=o[t];return n!=null&&n.parent&&o[n.parent]&&(o[n.parent].children=o[n.parent].children.filter(s=>s!==t)),delete o[t],e}function jt(e,t){let r=Pt(void 0,t);return e.archivedByFullName=r.archivedByFullName,e}function wt(e,t,r){var n,s;return(s=(n=(r?e.archivedByFullName:e.byFullName)[t])==null?void 0:n.children)!=null?s:[]}function vt(e,t,r){var i,a,l,c;let o=r?e.archivedByFullName:e.byFullName,n=[],s=(a=(i=o[t])==null?void 0:i.parent)!=null?a:null;for(;s;)n.push(s),s=(c=(l=o[s])==null?void 0:l.parent)!=null?c:null;return n}function Ot(e,t){for(let r of Object.values(e))for(let o of Object.values(r))for(let n of Object.values(o)){if(!n||!n.variables)continue;let s=n.variables.PROJECT_FULL_NAME,i=Mt(n.info.parent);if(t[s]=t[s]||{parent:i,children:[]},t[s].parent=i!=null?i:null,i){let a=t[i]||{parent:null,children:[]};a.children.includes(s)||a.children.push(s),t[i]=a}}}function Mt(e){let t=e==null?void 0:e.trim();return t&&t.length>0?t:null}var yt,Ye,ye=F(()=>{yt=1,Ye=null});var Vt={};V(Vt,{ensureValidOrThrow:()=>Kr,validateProjectName:()=>Wr,validateTag:()=>Hr});function Wr(e){if(!e||!e.trim())return{ok:!1,reason:"Project name is required"};let t=e.trim();if(t.length>120)return{ok:!1,reason:"Project name too long (max 120)"};for(let r of t)if(r.charCodeAt(0)<32||r==="/"||r==="\\")return{ok:!1,reason:"Project name contains invalid characters"};return{ok:!0}}function Hr(e){if(!e||!e.trim())return{ok:!1,reason:"Tag is required"};let t=e.trim();return Ur.test(t)?{ok:!0}:{ok:!1,reason:"Tag must be 2-63 chars, start with letter/digit; may include -, _, /"}}function Kr(e,t){let r=e();if(!r.ok)throw new Error(`${t}: ${r.reason}`)}var Ur,Jt=F(()=>{Ur=/^[A-Za-z0-9][A-Za-z0-9_/-]{1,62}$/});var tt={};V(tt,{processTemplate:()=>Yr});function Wt(e){return e==null?"":String(e)}function Yr(e,t){if(!e||typeof e!="string")return"";let r=e;for(let[o,n]of Object.entries(t)){let s=Wt(n),i=`$_${o}`;r.includes(i)&&(r=r.split(i).join(s))}for(let[o,n]of Object.entries(t)){let s=Wt(n),i=new RegExp(`\\$\\{${zr(o)}\\}`,"g");r=r.replace(i,s)}return r}function zr(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var rt=F(()=>{});function Ht(e,t){let r=new Date,o=r.getFullYear().toString(),n=r.toISOString().split("T")[0],s=t.projectsRoot||"1. Projects",i=e.parent&&e.parent.trim().length>0?`.${e.parent.trim()}`:"",a=`${o}${i}.${e.name}`,l=t.dimensions.find(y=>y.name===e.dimension),c=l?`${l.order}. ${l.name}`:e.dimension,p=`${s}/${c}/${e.category}/${a}`,m=`${p}`;return{PROJECT_NAME:e.name,PROJECT_TAG:e.tag,PROJECT_PARENT:e.parent?e.parent:"",PARENT_TAG:e.parent?e.tag:"",YEAR:o,DATE:n,PROJECT_FULL_NAME:a,PROJECT_RELATIVE_PATH:p,PROJECT_PATH:m,DIMENSION:l?l.name:e.dimension,CATEGORY:e.category,PROJECT_ID:e.id,PROJECT_DIMENSION:l?l.name:e.dimension}}async function ot(e,t){try{let{processTemplate:r}=await Promise.resolve().then(()=>(rt(),tt));return r(e,t)}catch(r){console.warn("Template processor import failed, using legacy replacement:",r);let o=e;return Object.entries(t).forEach(([n,s])=>{let i=`$_${n}`;o=o.split(i).join(s)}),o}}var Kt=F(()=>{});var Yt={};V(Yt,{mergeEntityTypes:()=>nt,mergeProjectTypes:()=>Te});function nt(e){let t={...ce};if(e&&typeof e=="object")for(let[r,o]of Object.entries(e))!o||typeof o!="object"||(t[r]={...t[r],...o,id:r});return t}function Te(e){let t={...me};if(e&&typeof e=="object")for(let[r,o]of Object.entries(e))!o||typeof o!="object"||(t[r]={...t[r],...o,id:r});return t}var st=F(()=>{Ae()});var zt={};V(zt,{resolveProjectType:()=>Xr});function Xr(e,t){let r=Te(e.projectTypes),o=t==null?void 0:t.projectTypeId,n=o&&r[o]?o:"operational",s=r[n]||r.operational;return{projectTypeId:n,projectType:s}}var Xt=F(()=>{st()});async function it(e,t){var r,o;try{let{resolveProjectType:n}=await Promise.resolve().then(()=>(Xt(),zt)),{projectTypeId:s,projectType:i}=n(e.settings,t);t.projectTypeId=s;let a=Ht(t,e.settings),l=e.settings.projectsRoot||"1. Projects",{sanitizePath:c,sanitizeFileName:p}=await Promise.resolve().then(()=>(fe(),Ie)),{SafeFileManager:m}=await Promise.resolve().then(()=>(ue(),ge)),y=new m(e.app),j=c(l),f=e.settings.dimensions.find(w=>w.name===t.dimension),d=f?`${f.order}. ${f.name}`:t.dimension,g=p(d),h=p(t.category),P=c(`${j}/${g}/${h}/${a.PROJECT_FULL_NAME}`),R=(r=i==null?void 0:i.folderStructure)!=null?r:["Knowledge Base","Meetings","Work","Work/Tasks","People"],C=[{type:"folder",path:P},...R.map(w=>({type:"folder",path:c(`${P}/${w}`)}))],I=e.app.vault.adapter,O=`.obsidian/plugins/${e.manifest.id}/src/templates`,re=(o=i==null?void 0:i.initialNotes)!=null?o:[{fileName:`${a.PROJECT_FULL_NAME}.md`,template:"project.md"},{fileName:`${t.name} Meetings.md`,template:"meetings.md"},{fileName:`${t.name} People.md`,template:"people.md"},{fileName:`${t.name} Work.md`,template:"work.md"},{fileName:`${t.name} Knowledge Base.md`,template:"knowledge-base.md"}],H=[];for(let w of re){let N=w.fileName?await ot(w.fileName,a):w.fileName,U=`${O}/${w.template}`;if(!await I.exists(U))throw new Error(`Template file not found: ${w.template}`);let Pe=await I.read(U),je=await ot(Pe,a),Re=c(`${P}/${p(N)}`);H.push({type:"file",path:Re,data:je})}let X=await y.createBatch([...C,...H]);if(!("ok"in X)||!X.ok)throw new Error(`Batch creation failed: ${X.error||"unknown"}`);return await qr(e,t.name,a),await Zr(e,t,a),[!0,`Project "${t.name}" created successfully!`]}catch(n){return[!1,`Error creating project: ${n}`]}}async function Zr(e,t,r){try{let{ensureProjectIndex:o,addToProjectIndex:n}=await Promise.resolve().then(()=>(he(),ke)),{ensureProjectGraph:s,addProjectToGraph:i}=await Promise.resolve().then(()=>(ye(),$e)),a={info:t,variables:r,createdAt:new Date().toISOString()},l=t.dimension,c=t.category,p=t.id;if(!e.settings.projectRecords||Array.isArray(e.settings.projectRecords)){let f={},d=Array.isArray(e.settings.projectRecords)?e.settings.projectRecords:[];for(let g of d){let h=g.info.dimension,P=g.info.category,R=g.info.id;f[h]=f[h]||{},f[h][P]=f[h][P]||{},f[h][P][R]=g}e.settings.projectRecords=f}let m=e.settings.projectRecords;if(m[l]=m[l]||{},m[l][c]=m[l][c]||{},m[l][c][p])throw new Error(`Project with id "${p}" already exists in ${l}:${c}`);m[l][c][p]=a;let{index:y}=o(e.settings.projectIndex,m);e.settings.projectIndex=n(y,a,p,l,c);let{graph:j}=s(e.settings.projectGraph,m,e.settings.archivedRecords);e.settings.projectGraph=i(j,a,!1),await e.saveData(e.settings)}catch(o){throw console.warn("Failed to record project creation:",o),o}}async function Qr(e,t,r,o,n){try{let s=e.app.vault.adapter,i=`.obsidian/plugins/${e.manifest.id}/src/templates/${o}`;if(!await s.exists(i))throw new Error(`Template file not found: ${o}`);let a=await s.read(i),l=await ot(a,n),c=`${t}/${r}`,{SafeFileManager:p}=await Promise.resolve().then(()=>(ue(),ge));await new p(e.app).createIfAbsent(c,l)}catch(s){throw console.error(`Failed to create ${r}:`,s),new Error(`Failed to create ${r}: ${s}`)}}async function qr(e,t,r){let{sanitizePath:o,sanitizeFileName:n}=await Promise.resolve().then(()=>(fe(),Ie)),{SafeFileManager:s}=await Promise.resolve().then(()=>(ue(),ge)),i=new s(e.app),a=o(`Templates/${t}_Templates`);await i.ensureFolder(a);let l=[{source:"template-meeting-daily.md",target:`${t}_Meeting_Daily_Template.md`},{source:"template-meeting-discussion.md",target:`${t}_Meeting_Discussion_Template.md`},{source:"template-meeting-knowledge.md",target:`${t}_Meeting_Knowledge_Template.md`},{source:"template-meeting-planning.md",target:`${t}_Meeting_Planning_Template.md`},{source:"template-meeting-refinement.md",target:`${t}_Meeting_Refinement_Template.md`},{source:"template-meeting-retro.md",target:`${t}_Meeting_Retro_Template.md`},{source:"template-meeting-demo.md",target:`${t}_Meeting_Demo_Template.md`},{source:"template-sprint.md",target:`${t}_Sprint_Template.md`},{source:"template-task.md",target:`${t}_Task_Template.md`},{source:"template-idea.md",target:`${t}_Idea_Template.md`},{source:"template-knowledge-base-item.md",target:`${t}_Knowledge_Item_Template.md`},{source:"template-meeting-daily.md",target:"template-meeting-daily.md"},{source:"template-meeting-discussion.md",target:"template-meeting-discussion.md"},{source:"template-meeting-knowledge.md",target:"template-meeting-knowledge.md"},{source:"template-meeting-planning.md",target:"template-meeting-planning.md"},{source:"template-meeting-refinement.md",target:"template-meeting-refinement.md"},{source:"template-meeting-retro.md",target:"template-meeting-retro.md"},{source:"template-meeting-demo.md",target:"template-meeting-demo.md"},{source:"template-sprint.md",target:"template-sprint.md"},{source:"template-task.md",target:"template-task.md"},{source:"template-idea.md",target:"template-idea.md"},{source:"template-knowledge-base-item.md",target:"template-knowledge-base-item.md"}];for(let c of l)try{let p=n(c.target);await Qr(e,a,p,c.source,r)}catch(p){console.warn(`Failed to create template ${c.target}: ${p}`)}}var Tt=F(()=>{Kt()});var ir={};V(ir,{CURRENT_SETTINGS_SCHEMA_VERSION:()=>Ce,migrateSettings:()=>oo});function oo(e){var n,s,i,a,l,c,p,m,y,j,f;let t={dimensions:(n=e==null?void 0:e.dimensions)!=null?n:[],projectsRoot:(s=e==null?void 0:e.projectsRoot)!=null?s:"1. Projects",archiveRoot:(i=e==null?void 0:e.archiveRoot)!=null?i:"4. Archive",templatesRoot:(a=e==null?void 0:e.templatesRoot)!=null?a:"Templates/ProjectFlow",ai:e==null?void 0:e.ai,schemaVersion:(l=e==null?void 0:e.schemaVersion)!=null?l:0,projectRecords:{},archivedRecords:(c=e==null?void 0:e.archivedRecords)!=null?c:{},entityTypes:(p=e==null?void 0:e.entityTypes)!=null?p:{},projectTypes:(m=e==null?void 0:e.projectTypes)!=null?m:{},projectIndex:e==null?void 0:e.projectIndex,projectGraph:e==null?void 0:e.projectGraph},r=e==null?void 0:e.projectRecords;if(r&&typeof r=="object"&&!Array.isArray(r))t.projectRecords=r;else if(Array.isArray(r)){let d={};for(let g of r){if(!g||!g.info)continue;let h=g.info.dimension,P=g.info.category,R=g.info.id;!h||!P||!R||(d[h]=d[h]||{},d[h][P]=d[h][P]||{},d[h][P][R]=g)}t.projectRecords=d}else t.projectRecords={};if(Array.isArray(t.dimensions)){let d=1;t.dimensions=t.dimensions.map(g=>{var h;if(g&&typeof g=="object"){let P=(h=g.name)!=null?h:"",R=g.order,C=typeof P=="string"?P.match(/^\s*(\d+)\.\s*(.+)$/):null;return C&&(R=parseInt(C[1],10),P=C[2]),(R==null||Number.isNaN(R))&&(R=d++),{name:P,order:R,categories:Array.isArray(g.categories)?g.categories:[]}}return{name:String(g!=null?g:""),order:d++,categories:[]}})}else t.dimensions=[];let o=[...t.dimensions].sort((d,g)=>{var h,P;return((h=d.order)!=null?h:0)-((P=g.order)!=null?P:0)});return o.forEach((d,g)=>{d.order=g+1}),t.dimensions=o,(!t.schemaVersion||t.schemaVersion<Ce)&&((!t.entityTypes||Object.keys(t.entityTypes).length===0)&&(t.entityTypes=ce),(!t.projectTypes||Object.keys(t.projectTypes).length===0)&&(t.projectTypes=me),t.ai?t.ai={enabled:Boolean(t.ai.enabled),provider:t.ai.provider||"openai",apiKey:(y=t.ai.apiKey)!=null?y:"",model:(j=t.ai.model)!=null?j:"gpt-4o-mini",baseUrl:(f=t.ai.baseUrl)!=null?f:"https://api.openai.com"}:t.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com"},t.schemaVersion=Ce),t}var Ce,xt=F(()=>{Ae();Ce=4});function ar(e){return e?e.startsWith("/")||e.includes("\\")?!1:!e.split("/").filter(Boolean).some(r=>r==="."||r===".."):!0}function De(e,t){let r=W(e),o=W(t);return o?r===o||r.startsWith(`${o}/`):!1}var cr=F(()=>{fe()});var pr={};V(pr,{listProjects:()=>At,resolveArchivedProject:()=>pt,resolveProject:()=>_e});function _e(e,t){var i,a,l;let r=He()||Ke(e.settings.projectIndex,e.settings.projectRecords).index,o=lr(t),n=o.fullName&&r.byFullName[o.fullName]||o.id&&r.byId[o.id]||o.tag&&r.byTag[o.tag];if(!n)return null;let s=(l=(a=(i=e.settings.projectRecords)==null?void 0:i[n.dimension])==null?void 0:a[n.category])==null?void 0:l[n.projectId];return s?{entry:n,record:s}:null}function pt(e,t){var n;let r=lr(t),o=no(e.settings.archivedRecords,r);return o?{entry:{fullName:o.variables.PROJECT_FULL_NAME,projectId:o.info.id,projectTag:o.variables.PROJECT_TAG,path:o.variables.PROJECT_PATH,dimension:o.info.dimension,category:o.info.category,projectName:o.info.name,parent:(n=o.info.parent)!=null?n:null},record:o}:null}function At(e){let t=He()||Ke(e.settings.projectIndex,e.settings.projectRecords).index;return Object.values(t.byFullName)}function lr(e){var t,r,o;if(typeof e=="string"){let n=e.trim();return n.startsWith("project/")?{tag:n}:n.includes(".")?{fullName:n}:{id:n}}return{fullName:(t=e.fullName)==null?void 0:t.trim(),id:(r=e.id)==null?void 0:r.trim(),tag:(o=e.tag)==null?void 0:o.trim()}}function no(e,t){if(!e)return null;for(let r of Object.values(e))for(let o of Object.values(r))for(let n of Object.values(o))if(n&&(t.fullName&&n.variables.PROJECT_FULL_NAME===t.fullName||t.id&&n.info.id===t.id||t.tag&&n.variables.PROJECT_TAG===t.tag))return n;return null}var It=F(()=>{he()});async function mr(e,t){let{resolveProject:r}=await Promise.resolve().then(()=>(It(),pr)),{mergeEntityTypes:o}=await Promise.resolve().then(()=>(st(),Yt)),{processTemplate:n}=await Promise.resolve().then(()=>(rt(),tt)),{SafeFileManager:s}=await Promise.resolve().then(()=>(ue(),ge)),i=r(e,t.projectRef);if(!i)throw new Error("Project not found for reference.");let l=o(e.settings.entityTypes)[t.entityTypeId];if(!l)throw new Error(`Entity type not found: ${t.entityTypeId}`);so(l,t.fields);let c={...i.record.variables,...t.fields||{}},p=await io(e,l,i.record,c);if(!p)throw new Error(`Template not found for entity type: ${l.id}`);let y=await e.app.vault.adapter.read(p.path),j=n(y,c),f=n(l.targetFolder,c);if(!ar(f))throw new Error("Unsafe targetFolder path.");let d=W(i.record.variables.PROJECT_PATH),g=f?W(`${d}/${f}`):d;if(!De(g,d))throw new Error("Target folder is outside project path.");if(!dr(g,e.settings))throw new Error("Target folder is outside allowed roots.");let h=l.filenameRule||"Untitled",P=n(h,c),R=P.endsWith(".md")?P.slice(0,-3):P,C=Ue(R),I=W(`${g}/${C}.md`);if(!De(I,d))throw new Error("Target file is outside project path.");if(!dr(I,e.settings))throw new Error("Target file is outside allowed roots.");let O=new s(e.app);if(await O.ensureFolder(g),await O.has(I))throw new Error(`File already exists: ${I}`);return await O.createIfAbsent(I,j),{path:I}}function dr(e,t){let r=t.projectsRoot||"1. Projects",o=t.archiveRoot||"4. Archive";return De(e,r)||De(e,o)}function so(e,t){if(!e.requiredFields||e.requiredFields.length===0)return;let r=e.requiredFields.filter(o=>t==null||t[o]==null||String(t[o]).trim()==="");if(r.length>0)throw new Error(`Missing required fields: ${r.join(", ")}`)}async function io(e,t,r,o){let{processTemplate:n}=await Promise.resolve().then(()=>(rt(),tt)),s=e.app.vault.adapter,i=n(t.templatePath,o),a=W(`Templates/${r.info.name}_Templates`),l=W(e.settings.templatesRoot||"Templates/ProjectFlow"),c=`.obsidian/plugins/${e.manifest.id}/src/templates`,p=y=>y.map(j=>j==="project"?{scope:j,path:W(`${a}/${i}`)}:j==="vault"?{scope:j,path:W(`${l}/${i}`)}:{scope:j,path:`${c}/${i}`}),m=t.templateScope?[t.templateScope,"builtin"].filter((y,j,f)=>f.indexOf(y)===j):["project","vault","builtin"];for(let y of p(m))if(await s.exists(y.path))return y;return null}var gr=F(()=>{fe();cr()});function ao(e,t,r,o,n){let s=co(t),i=e.indexOf(s);if(i>=0){let a=e.indexOf(`
`,i),l=a>=0?a+1:e.length,c=lo(e,l),p=c>=0?c:e.length;return{updated:!0,text:[e.slice(0,l),kt(r),e.slice(p)].join("")}}if(o==="strict")return{updated:!1,text:e};if(n){let a=ur(e,n,r,o);if(a.updated)return a}return{updated:!0,text:Pr(e,n||"AI Notes",r)}}function ur(e,t,r,o){let n=yr(t),i=new RegExp(`^#{1,6}\\s+${mo(n)}\\s*$`,"m").exec(e);if(!i||i.index==null)return o==="strict"?{updated:!1,text:e}:{updated:!0,text:Pr(e,n,r)};let a=i.index,l=e.indexOf(`
`,a),c=l>=0?l+1:e.length,p=po(e,c);return{updated:!0,text:[e.slice(0,c),kt(r),e.slice(p)].join("")}}async function fr(e,t){var i;let r=e.vault.adapter,o=(i=t.patchMode)!=null?i:"lenient";if(!await r.exists(t.path))return{ok:!1,error:`File not found: ${t.path}`};let n=await r.read(t.path),s=ao(n,t.marker,t.content,o,t.fallbackHeading);return s.updated?(await r.write(t.path,s.text),{ok:!0}):{ok:!1,error:"Marker or heading not found in strict mode."}}async function hr(e,t){var i;let r=e.vault.adapter,o=(i=t.patchMode)!=null?i:"lenient";if(!await r.exists(t.path))return{ok:!1,error:`File not found: ${t.path}`};let n=await r.read(t.path),s=ur(n,t.heading,t.content,o);return s.updated?(await r.write(t.path,s.text),{ok:!0}):{ok:!1,error:"Heading not found in strict mode."}}function co(e){let t=e.trim();return t.startsWith("<!--")&&t.endsWith("-->")?t:`<!-- ${t} -->`}function yr(e){return e.replace(/^#+\s*/,"").trim()}function lo(e,t){let r=/<!--\s*AI:[A-Z_]+\s*-->/g;r.lastIndex=t;let o=r.exec(e);return o&&o.index!=null?o.index:-1}function po(e,t){let r=/^#{1,6}\s+/gm;r.lastIndex=t;let o=r.exec(e);return o&&o.index!=null?o.index:e.length}function kt(e){let t=e!=null?e:"";return t.endsWith(`
`)?t:`${t}
`}function Pr(e,t,r){let o=yr(t);return`${e.endsWith(`
`)?e:`${e}
`}
## ${o}
${kt(r)}`}function mo(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var jr=F(()=>{});function wr(e){if(e instanceof pe)return e;let t=e instanceof Error?e.message:"Unknown error";return new pe("validation_error",t)}var pe,St=F(()=>{pe=class extends Error{constructor(r,o,n){super(o);this.code=r,this.details=n}}});function J(e,t){if(typeof e!="string"||e.trim().length===0)throw new pe("invalid_request",`${t} is required`,{field:t});return e.trim()}function dt(e){if(e==null)throw new pe("invalid_request","projectRef is required",{field:"projectRef"});if(typeof e=="string"){J(e,"projectRef");return}let t=typeof e.fullName=="string"&&e.fullName.trim().length>0,r=typeof e.id=="string"&&e.id.trim().length>0,o=typeof e.tag=="string"&&e.tag.trim().length>0;if(!t&&!r&&!o)throw new pe("invalid_request","projectRef must include fullName, id, or tag",{field:"projectRef"})}function vr(e){J(e==null?void 0:e.name,"name"),J(e==null?void 0:e.tag,"tag"),J(e==null?void 0:e.id,"id"),J(e==null?void 0:e.dimension,"dimension"),J(e==null?void 0:e.category,"category")}function Tr(e){dt(e==null?void 0:e.projectRef),J(e==null?void 0:e.entityTypeId,"entityTypeId")}function Rr(e){J(e==null?void 0:e.path,"path"),J(e==null?void 0:e.marker,"marker"),J(e==null?void 0:e.content,"content")}function Er(e){J(e==null?void 0:e.path,"path"),J(e==null?void 0:e.heading,"heading"),J(e==null?void 0:e.content,"content")}var br=F(()=>{St()});var xr={};V(xr,{createCoreApi:()=>go});function go(e){return{version:"1.0.0",capabilities:{resolveProject:!0,listProjects:!0,entityTypes:!0,projectTypes:!0,createProject:!0,createEntity:!0,patching:!0,projectGraph:!0,errorHandling:"throws"},compatibility:{settingsSchemaVersion:Ce,projectIndexVersion:1,projectGraphVersion:1},resolveProject:r=>(dt(r),_e(e,r)),listProjects:()=>At(e),listProjectTypes:()=>Te(e.settings.projectTypes),describeProjectType:r=>Te(e.settings.projectTypes)[r]||null,listEntityTypes:()=>nt(e.settings.entityTypes),describeEntityType:r=>nt(e.settings.entityTypes)[r]||null,createProject:async r=>(vr(r),it(e,r)),createEntity:async r=>(Tr(r),mr(e,r)),patchMarker:async r=>(Rr(r),fr(e.app,r)),patchSection:async r=>(Er(r),hr(e.app,r)),getChildren:(r,o)=>{dt(r);let n=o?pt(e,r):_e(e,r);if(!n)return[];let{graph:s}=Se(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return wt(s,n.entry.fullName,Boolean(o))},getParents:(r,o)=>{let n=o?pt(e,r):_e(e,r);if(!n)return[];let{graph:s}=Se(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return vt(s,n.entry.fullName,Boolean(o))},clearArchivedProjectGraph:async()=>{let{graph:r}=Se(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return e.settings.projectGraph=jt(r,e.settings.archivedRecords),await e.saveData(e.settings),{ok:!0}},wrapError:r=>{let o=wr(r);return{ok:!1,error:{code:o.code,message:o.message,details:o.details}}}}}var Ar=F(()=>{st();Tt();gr();jr();It();ye();br();St();xt();he();ye()});var fo={};V(fo,{default:()=>uo});module.exports=Dr(fo);var Ir=require("obsidian");var E=require("obsidian");Ae();var Dt=require("obsidian"),Je=class extends Dt.Modal{constructor(r,o){super(r);this.onResult=o}onOpen(){let{contentEl:r}=this;r.empty(),r.addClass("project-flow-settings"),r.createEl("p",{text:"Do you want skip settings to defaults? This will override all custom settings."});let o=r.createDiv({cls:"gc-row"});o.createDiv({cls:"gc-spacer"});let n=o.createEl("button",{text:"Yes, use defaults"}),s=o.createEl("button",{text:"Go back"});n.onclick=()=>{this.close(),this.onResult(!0)},s.onclick=()=>{this.close(),this.onResult(!1)}}onClose(){this.contentEl.empty()}};async function ze(e,t,r,o){let n="",s=e.settings.projectRecords,i=s[t][r][o],{SafeFileManager:a}=await Promise.resolve().then(()=>(ue(),ge)),l=new a(e.app),{sanitizePath:c}=await Promise.resolve().then(()=>(fe(),Ie)),p=c(i.variables.PROJECT_PATH),m=c(`Templates/${i.info.name}_Templates`);try{await l.removeDir(p),await l.removeDir(m);try{s[t][r][o]&&(delete s[t][r][o],Object.keys(s[t][r]).length===0&&delete s[t][r],Object.keys(s[t]).length===0&&delete s[t]);try{let{ensureProjectIndex:y,removeFromProjectIndex:j,toIndexEntry:f}=await Promise.resolve().then(()=>(he(),ke)),{ensureProjectGraph:d,removeProjectFromGraph:g}=await Promise.resolve().then(()=>(ye(),$e)),{index:h}=y(e.settings.projectIndex,s);e.settings.projectIndex=j(h,f(i,o,t,r));let{graph:P}=d(e.settings.projectGraph,s,e.settings.archivedRecords);e.settings.projectGraph=g(P,i.variables.PROJECT_FULL_NAME,!1)}catch(y){console.warn("Failed to update projectIndex after delete:",y)}await e.saveData(e.settings),n="Project deleted successfully."}catch(y){n="Failed to update projectRecords after delete",console.warn(n,y)}return[!0,n]}catch(y){n="Error removing project: "+y.message,console.error("Error removing project:",y)}return[!1,n]}async function Xe(e,t,r,o){var n,s,i,a,l;try{let c=e.settings.projectRecords,p=(s=(n=c==null?void 0:c[t])==null?void 0:n[r])==null?void 0:s[o];if(!p)return[!1,"Project not found."];let{sanitizePath:m}=await Promise.resolve().then(()=>(fe(),Ie)),{SafeFileManager:y}=await Promise.resolve().then(()=>(ue(),ge)),j=new y(e.app),f=e.app.vault.adapter,d=m(p.variables.PROJECT_PATH),g=m(`Templates/${p.info.name}_Templates`),h=e.settings.archiveRoot||"4. Archive",P=p.variables.YEAR,R=p.variables.DIMENSION||p.info.dimension,C=p.info.category,I=p.info.parent&&p.info.parent.trim().length>0?p.info.parent.trim():null,O=p.info.name,re=I?`${P}.${R}.${C}.${I}.${O}`:`${P}.${R}.${C}.${O}`,H=m(`${h}/${re}`),X=w=>{let N=w.split("/").filter(Boolean);return N.pop(),N.join("/")};if(await j.ensureFolder(X(H)),!await f.exists(d))return[!1,`Project directory not found: ${d}`];if(await f.exists(H))return[!1,`Archive destination already exists: ${H}`];await f.rename(d,H);try{if(await f.exists(g)){let w=m(`${H}/Templates`);await j.ensureFolder(w);let N=m(`${w}/${p.info.name}_Templates`);if(await f.exists(N)){let U=m(`${w}/${p.info.name}_Templates_archived`);await f.rename(g,U)}else await f.rename(g,N)}}catch(w){console.warn("Archiving templates failed:",w)}try{let w=e.settings.projectRecords;(!e.settings.archivedRecords||Array.isArray(e.settings.archivedRecords))&&(e.settings.archivedRecords=e.settings.archivedRecords&&Array.isArray(e.settings.archivedRecords)?{}:e.settings.archivedRecords||{});let N=e.settings.archivedRecords;N[t]=N[t]||{},N[t][r]=N[t][r]||{},N[t][r][o]=p,(a=(i=w==null?void 0:w[t])==null?void 0:i[r])!=null&&a[o]&&(delete w[t][r][o],Object.keys(w[t][r]).length===0&&delete w[t][r],Object.keys(w[t]||{}).length===0&&delete w[t]);try{let{ensureProjectIndex:U,removeFromProjectIndex:Pe,toIndexEntry:je}=await Promise.resolve().then(()=>(he(),ke)),{ensureProjectGraph:Re,removeProjectFromGraph:Oe,addProjectToGraph:Me}=await Promise.resolve().then(()=>(ye(),$e)),{index:Ge}=U(e.settings.projectIndex,w);e.settings.projectIndex=Pe(Ge,je(p,o,t,r));let{graph:Le}=Re(e.settings.projectGraph,w,N);e.settings.projectGraph=Oe(Le,p.variables.PROJECT_FULL_NAME,!1),e.settings.projectGraph=Me(e.settings.projectGraph,p,!0)}catch(U){console.warn("Failed to update projectIndex after archive:",U)}await e.saveData(e.settings)}catch(w){console.warn("Failed to move project record to archive in settings:",w)}return[!0,"Project archived successfully."]}catch(c){return console.error("Archive failed:",c),[!1,(l=c==null?void 0:c.message)!=null?l:"Failed to archive project."]}}var Jr=[{name:"Business",order:1,categories:["R&D","Jobs","OpenSource","Education"]},{name:"Family",order:2,categories:["Vacations","Parenting","Common"]},{name:"Friends",order:3,categories:[]},{name:"Health",order:4,categories:["Clinics","Issues","R&D"]},{name:"Personal",order:5,categories:["R&D","Languages","SelfManagement","Writing","Reading","Music","Sports"]},{name:"Residence",order:6,categories:[]}],Qe={dimensions:JSON.parse(JSON.stringify(Jr)),projectsRoot:"1. Projects",archiveRoot:"4. Archive",templatesRoot:"Templates/ProjectFlow",ai:{enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com"},projectRecords:{},archivedRecords:{},projectGraph:{version:1,byFullName:{},archivedByFullName:{}},entityTypes:ce,projectTypes:me};function Gt(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return t}var Ze=class extends E.PluginSettingTab{constructor(r,o){super(r,o);this.plugin=o}display(){var Me,Ge,Le,$t,Nt,Ft;let{containerEl:r}=this;r.empty(),r.addClass("project-flow-settings");let o=r.createDiv({cls:"gc-row"});o.createDiv({cls:"gc-spacer"});let n=o.createEl("button",{cls:["gc-icon-button","clickable-icon"],attr:{"aria-label":"Reset to defaults",title:"Reset to defaults"}});try{(0,E.setIcon)(n,"rotate-ccw")}catch(u){n.setText("Reset to defaults")}n.onclick=()=>{new Je(this.app,async k=>{k&&(this.plugin.settings=JSON.parse(JSON.stringify(Qe)),await this.plugin.saveSettings(),new E.Notice("Settings were reset to defaults."),this.display())}).open()},r.createEl("h2",{text:"Folders"});let s=r.createDiv({cls:"gc-column"}),i=s.createDiv({cls:"setting-item"});i.createEl("label",{text:"Projects root"});let a=i.createEl("input",{type:"text"});a.value=this.plugin.settings.projectsRoot||"1. Projects",a.placeholder="e.g. 1. Projects",a.onchange=async()=>{this.plugin.settings.projectsRoot=a.value.trim()||"1. Projects",await this.plugin.saveSettings()};let l=s.createDiv({cls:"setting-item"});l.createEl("label",{text:"Archive root"});let c=l.createEl("input",{type:"text"});c.value=this.plugin.settings.archiveRoot||"4. Archive",c.placeholder="e.g. 4. Archive",c.onchange=async()=>{this.plugin.settings.archiveRoot=c.value.trim()||"4. Archive",await this.plugin.saveSettings()};let p=s.createDiv({cls:"setting-item"});p.createEl("label",{text:"Templates root"});let m=p.createEl("input",{type:"text"});m.value=this.plugin.settings.templatesRoot||"Templates/ProjectFlow",m.placeholder="e.g. Templates/ProjectFlow",m.onchange=async()=>{this.plugin.settings.templatesRoot=m.value.trim()||"Templates/ProjectFlow",await this.plugin.saveSettings()},r.createEl("h2",{text:"Dimensions"}),[...this.plugin.settings.dimensions].sort((u,k)=>{var M,_;return((M=u.order)!=null?M:0)-((_=k.order)!=null?_:0)}).forEach((u,k)=>{let M=r.createDiv({cls:"dimension-setting"}),_=M.createDiv({cls:"dimension-header"});_.addClass("gc-row"),_.createSpan({text:`${u.order}. `});let Z=_.createEl("b",{text:u.name});_.createDiv({cls:"gc-spacer"});let ee=_.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ee.setAttr("aria-label","Move up"),ee.setAttr("title","Move up");try{(0,E.setIcon)(ee,"arrow-up")}catch(b){ee.setText("Up")}ee.onclick=async()=>{let x=[...this.plugin.settings.dimensions].filter(S=>{var A,T;return((A=S.order)!=null?A:0)<((T=u.order)!=null?T:0)}).sort((S,A)=>{var T,$;return((T=A.order)!=null?T:0)-(($=S.order)!=null?$:0)})[0];if(!x)return;let v=x.order;x.order=u.order,u.order=v,await this.plugin.saveSettings(),this.display()};let oe=_.createEl("button",{cls:["gc-icon-button","clickable-icon"]});oe.setAttr("aria-label","Move down"),oe.setAttr("title","Move down");try{(0,E.setIcon)(oe,"arrow-down")}catch(b){oe.setText("Down")}oe.onclick=async()=>{let x=[...this.plugin.settings.dimensions].filter(S=>{var A,T;return((A=S.order)!=null?A:0)>((T=u.order)!=null?T:0)}).sort((S,A)=>{var T,$;return((T=S.order)!=null?T:0)-(($=A.order)!=null?$:0)})[0];if(!x)return;let v=x.order;x.order=u.order,u.order=v,await this.plugin.saveSettings(),this.display()};let ne=_.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ne.setAttr("aria-label",`Delete ${u.name}`),ne.setAttr("title",`Delete ${u.name}`);try{(0,E.setIcon)(ne,"trash")}catch(b){ne.setText("Remove")}ne.onclick=async()=>{let b=this.plugin.settings.dimensions.findIndex(x=>x===u);b>=0&&this.plugin.settings.dimensions.splice(b,1),await this.plugin.saveSettings(),this.display()};let G=_.createEl("button",{cls:["gc-icon-button","clickable-icon"]});G.setAttr("aria-label",`Rename ${u.name}`),G.setAttr("title",`Rename ${u.name}`);try{(0,E.setIcon)(G,"pencil")}catch(b){G.setText("Edit")}if(G.onclick=async()=>{var se;let b=u.name,x=Z.parentElement;(se=Z.detach)==null||se.call(Z),G.style.display="none",ne.style.display="none";let v=x.createEl("input",{type:"text"});v.value=b,v.addClass("gc-rename");let S=x.createDiv({cls:"gc-row"});S.createDiv({cls:"gc-spacer"});let A=S.createEl("button",{cls:["gc-icon-button","clickable-icon"]});A.setAttr("aria-label","Apply"),A.setAttr("title","Apply");try{(0,E.setIcon)(A,"check")}catch(L){A.setText("Apply")}let T=S.createEl("button",{cls:["gc-icon-button","clickable-icon"]});T.setAttr("aria-label","Discard"),T.setAttr("title","Discard");try{(0,E.setIcon)(T,"x")}catch(L){T.setText("Discard")}let $=()=>{this.display()},K=async L=>{let Y=L.trim();if(!Y||Y===b){$();return}if(this.plugin.settings.dimensions.some(xe=>xe!==u&&xe.name===Y)){new E.Notice("A dimension with this name already exists.");return}u.name=Y,await this.plugin.saveSettings(),$()};A.onclick=async()=>{await K(v.value)},T.onclick=()=>$(),v.focus(),v.select(),v.onkeydown=async L=>{L.key==="Enter"&&await K(v.value),L.key==="Escape"&&$()},v.onblur=async()=>{await K(v.value)}},u.categories.length>0){let b=M.createDiv({cls:"categories-list gc-list"});u.categories.forEach((x,v)=>{var xe;let S=b.createDiv({cls:"gc-list-item gc-row"}),A=this.plugin.settings.projectRecords||{},T=u.name,$=Object.keys(((xe=A==null?void 0:A[T])==null?void 0:xe[x])||{}),K=S.createEl("b",{text:x}),se=S.createDiv({cls:"gc-id-wrap"});$.length>0&&(se.createSpan({text:" "}),$.forEach((B,Be)=>{let D=se.createSpan({cls:"gc-id-chip"});D.style.display="inline-flex",D.style.alignItems="center",D.style.gap="4px";let we=D.createSpan({cls:"gc-id-tag",text:B}),ie=Math.abs(Gt(B))%360;we.style.backgroundColor=`hsl(${ie}, 70%, 90%)`,we.style.color=`hsl(${ie}, 70%, 25%)`;let z=D.createSpan({cls:"gc-id-actions"});z.style.display="none";let Q=z.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Q.setAttr("aria-label",`Delete ${B}`),Q.setAttr("title",`Delete ${B}`);try{(0,E.setIcon)(Q,"trash")}catch(ae){Q.setText("Del")}Q.onclick=async ae=>{ae.stopPropagation();let[,q]=await ze(this.plugin,T,x,B);new E.Notice(q),this.display()};let te=z.createEl("button",{cls:["gc-icon-button","clickable-icon"]});te.setAttr("aria-label",`Archive ${B}`),te.setAttr("title",`Archive ${B}`);try{(0,E.setIcon)(te,"archive")}catch(ae){te.setText("Arc")}te.onclick=async ae=>{ae.stopPropagation();let[,q]=await Xe(this.plugin,T,x,B);new E.Notice(q),this.display()},D.onmouseenter=()=>{z.style.display="inline-flex"},D.onmouseleave=()=>{z.style.display="none"},Be<$.length-1&&se.createSpan({text:" "})})),S.createDiv({cls:"gc-spacer"});let L=S.createEl("button",{cls:["remove-category","gc-icon-button","clickable-icon"]});L.setAttr("aria-label",`Delete ${x}`),L.setAttr("title",`Delete ${x}`);try{(0,E.setIcon)(L,"trash")}catch(B){L.setText("Remove")}L.onclick=async()=>{u.categories.splice(v,1),await this.plugin.saveSettings(),this.display()};let Y=S.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Y.setAttr("aria-label",`Rename ${x}`),Y.setAttr("title",`Rename ${x}`);try{(0,E.setIcon)(Y,"pencil")}catch(B){Y.setText("Edit")}Y.onclick=async()=>{var ae;let B=u.categories[v],Be=K.parentElement;(ae=K.detach)==null||ae.call(K),Y.style.display="none",L.style.display="none";let D=Be.createEl("input",{type:"text"});D.value=B,D.addClass("gc-rename");let we=Be.createDiv({cls:"gc-row"});we.createDiv({cls:"gc-spacer"});let ie=we.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ie.setAttr("aria-label","Apply"),ie.setAttr("title","Apply");try{(0,E.setIcon)(ie,"check")}catch(q){ie.setText("Apply")}let z=we.createEl("button",{cls:["gc-icon-button","clickable-icon"]});z.setAttr("aria-label","Discard"),z.setAttr("title","Discard");try{(0,E.setIcon)(z,"x")}catch(q){z.setText("Discard")}let Q=()=>{this.display()},te=async q=>{let Ve=q.trim();if(!Ve||Ve===B){Q();return}if(u.categories.some((kr,Sr)=>Sr!==v&&kr===Ve)){new E.Notice("This category already exists in the dimension.");return}u.categories[v]=Ve,await this.plugin.saveSettings(),Q()};ie.onclick=async()=>{await te(D.value)},z.onclick=()=>Q(),D.focus(),D.select(),D.onkeydown=async q=>{q.key==="Enter"&&await te(D.value),q.key==="Escape"&&Q()},D.onblur=async()=>{await te(D.value)}}})}let de=M.createDiv({cls:"add-category gc-row"}),Ee=de.createEl("input",{type:"text",placeholder:"New category"});de.createDiv({cls:"gc-spacer"});let be=de.createEl("button",{text:"Add Category"});be.onclick=async()=>{let b=Ee.value.trim();b&&!u.categories.includes(b)&&(u.categories.push(b),await this.plugin.saveSettings(),this.display())}});let j=r.createDiv({cls:"add-dimension"});j.createEl("h3",{text:"Add new dimension"});let f=j.createDiv({cls:"gc-row"}),d=f.createEl("input",{type:"text",placeholder:"Dimension name"});f.createDiv({cls:"gc-spacer"});let g=f.createEl("button",{text:"Add Dimension"});g.onclick=async()=>{let u=d.value.trim();if(u&&!this.plugin.settings.dimensions.some(k=>k.name===u)){{let k=this.plugin.settings.dimensions.reduce((M,_)=>{var Z;return Math.max(M,(Z=_.order)!=null?Z:0)},0);this.plugin.settings.dimensions.push({name:u,order:k+1,categories:[]})}await this.plugin.saveSettings(),this.display()}},r.createEl("h2",{text:"AI Module"});let h=r.createDiv({cls:"gc-column"}),P=h.createDiv({cls:"setting-item"});P.createEl("label",{text:"Enable AI module"});let R=P.createEl("input",{type:"checkbox"});R.checked=Boolean((Me=this.plugin.settings.ai)==null?void 0:Me.enabled),R.onchange=async()=>{var u,k;this.plugin.settings.ai||(this.plugin.settings.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com"}),this.plugin.settings.ai.enabled=R.checked,await this.plugin.saveSettings(),await((k=(u=this.plugin).toggleAiView)==null?void 0:k.call(u,R.checked))};let C=h.createDiv({cls:"setting-item"});C.createEl("label",{text:"Provider"});let I=C.createEl("select");["openai"].forEach(u=>{let k=I.createEl("option",{text:u});k.value=u}),I.value=((Ge=this.plugin.settings.ai)==null?void 0:Ge.provider)||"openai",I.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.provider=I.value,await this.plugin.saveSettings())};let O=h.createDiv({cls:"setting-item"});O.createEl("label",{text:"API key"});let re=O.createEl("input",{type:"password"});re.placeholder="sk-...",re.value=((Le=this.plugin.settings.ai)==null?void 0:Le.apiKey)||"",re.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.apiKey=re.value.trim(),await this.plugin.saveSettings())};let H=h.createDiv({cls:"setting-item"});H.createEl("label",{text:"Model"});let X=H.createEl("input",{type:"text"});X.placeholder="gpt-4o-mini",X.value=(($t=this.plugin.settings.ai)==null?void 0:$t.model)||"gpt-4o-mini",X.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.model=X.value.trim()||"gpt-4o-mini",await this.plugin.saveSettings())};let w=h.createDiv({cls:"setting-item"});w.createEl("label",{text:"Base URL"});let N=w.createEl("input",{type:"text"});N.placeholder="https://api.openai.com",N.value=((Nt=this.plugin.settings.ai)==null?void 0:Nt.baseUrl)||"https://api.openai.com",N.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.baseUrl=N.value.trim()||"https://api.openai.com",await this.plugin.saveSettings())},r.createEl("h2",{text:"Archive"});let U=this.plugin.settings.archivedRecords||{},Pe=U&&!Array.isArray(U)?U:{},je={};for(let u of this.plugin.settings.dimensions)je[u.name]=(Ft=u.order)!=null?Ft:Number.MAX_SAFE_INTEGER;let Re=Object.keys(Pe).map(u=>{var k;return{name:u,order:(k=je[u])!=null?k:Number.MAX_SAFE_INTEGER}}).sort((u,k)=>u.order-k.order||u.name.localeCompare(k.name)),Oe=!1;Re.forEach(({name:u,order:k})=>{let M=Pe[u]||{},_=Object.keys(M).filter(G=>Object.keys(M[G]||{}).length>0).sort();if(_.length===0)return;Oe=!0;let Z=r.createDiv({cls:"dimension-setting"}),ee=Z.createDiv({cls:"dimension-header gc-row"}),oe=this.plugin.settings.dimensions.find(G=>G.name===u);oe&&ee.createSpan({text:`${oe.order}. `}),ee.createEl("b",{text:u}),ee.createDiv({cls:"gc-spacer"});let ne=Z.createDiv({cls:"categories-list gc-list"});_.forEach(G=>{let de=ne.createDiv({cls:"gc-list-item gc-row"}),Ee=Object.keys((M==null?void 0:M[G])||{}).sort();de.createEl("b",{text:G});let be=de.createDiv({cls:"gc-id-wrap"});Ee.length>0&&(be.createSpan({text:" "}),Ee.forEach((b,x)=>{let v=be.createSpan({cls:"gc-id-chip"});v.style.display="inline-flex",v.style.alignItems="center",v.style.gap="4px";let S=v.createSpan({cls:"gc-id-tag",text:b}),A=Math.abs(Gt(b))%360;S.style.backgroundColor=`hsl(${A}, 70%, 90%)`,S.style.color=`hsl(${A}, 70%, 25%)`;let T=v.createSpan({cls:"gc-id-actions"});T.style.display="none";let $=T.createEl("button",{cls:["gc-icon-button","clickable-icon"]});$.setAttr("aria-label",`Delete ${b}`),$.setAttr("title",`Delete ${b}`);try{(0,E.setIcon)($,"trash")}catch(K){$.setText("Del")}$.onclick=async K=>{K.stopPropagation();let[,se]=await this.plugin.deleteArchivedProject(u,G,b);new E.Notice(se),this.display()},v.onmouseenter=()=>{T.style.display="inline-flex"},v.onmouseleave=()=>{T.style.display="none"},x<Ee.length-1&&be.createSpan({text:" "})})),de.createDiv({cls:"gc-spacer"})})}),Oe||r.createDiv({cls:"setting-item"}).createSpan({text:"No archived projects yet."})}};var Rt=require("obsidian");var Lt=require("obsidian"),qe=class extends Lt.Modal{constructor(r,o,n){super(r);this.prompt=o,this.callback=n}onOpen(){let{contentEl:r}=this;r.createEl("h2",{text:this.prompt});let o=r.createEl("input",{type:"text"});o.focus();let n=r.createEl("button",{text:"Submit"});n.onclick=()=>{let s=o.value.trim();this.close(),this.callback(s||null)}}onClose(){let{contentEl:r}=this;r.empty()}};var Bt=require("obsidian"),Ne=class extends Bt.Modal{constructor(r,o,n,s){super(r);this.prompt=o,this.choices=n,this.callback=s}onOpen(){let{contentEl:r}=this;r.createEl("h2",{text:this.prompt}),this.choices.forEach(o=>{let n=r.createEl("button",{text:o});n.onclick=()=>{this.close(),this.callback(o)}})}onClose(){let{contentEl:r}=this;r.empty()}};async function Fe(e,t){return new Promise(r=>{new qe(e,t,r).open()})}async function ve(e,t,r){return new Promise(o=>{new Ne(e,t,r,o).open()})}async function Ut(e,t){var j,f;let r=await Fe(e,"Enter project name:");if(!r)return[null,"Project creation cancelled. No project name provided."];let o=await Fe(e,"Enter project tag:");if(!o)return[null,"Project creation cancelled. No project tag provided."];let n=await Fe(e,"Enter Project ID (used for task prefixes):");if(!n)return[null,"Project creation cancelled. No Project ID provided."];let s=await Fe(e,"Enter parent name (optional):"),i=s&&s.trim().length>0?s.trim():null,a=[...t.dimensions].sort((d,g)=>{var h,P;return((h=d.order)!=null?h:0)-((P=g.order)!=null?P:0)}).map(d=>d.name),l=await ve(e,"Select dimension:",a);if(!l)return[null,"Project creation cancelled. No dimension selected."];let c=t.dimensions.find(d=>d.name===l);if(!c||c.categories.length===0)return[null,"Selected dimension has no categories. Please add categories in settings first."];let p=c.categories,m=await ve(e,"Select category:",p);if(!m)return[null,"Project creation cancelled. No category selected."];let y={name:r,tag:o,id:n,parent:i,dimension:l,category:m};try{let d=t.projectRecords;if(d&&!Array.isArray(d)&&((f=(j=d[l])==null?void 0:j[m])==null?void 0:f[n]))return[null,`Project with ID "${n}" already exists in ${l}:${m}. Choose a different ID.`]}catch(d){}try{let{validateProjectName:d,validateTag:g,ensureValidOrThrow:h}=await Promise.resolve().then(()=>(Jt(),Vt));h(()=>d(y.name),"Invalid project name"),h(()=>g(y.tag),"Invalid tag"),h(()=>g(y.id),"Invalid Project ID")}catch(d){let g=d.message||"Invalid input";return console.error("Validation error:",d),[null,g]}return[y,"Project details collected."]}async function et(e,t){var p;if(!t.projectRecords)return[null,"You don't have any projects yet."];let r=t.projectRecords,o=[...t.dimensions].sort((m,y)=>{var j,f;return((j=m.order)!=null?j:0)-((f=y.order)!=null?f:0)}).map(m=>m.name),n=await ve(e,"Select dimension of your project:",o);if(!n)return[null,"Project action cancelled. No dimension selected."];let s=t.dimensions.find(m=>m.name===n);if(!s||s.categories.length===0)return[null,"Selected dimension has no categories. No project found."];let i=s.categories,a=await ve(e,"Select category:",i);if(!a)return[null,"Project action cancelled. No category selected."];let l=(p=r[n])==null?void 0:p[a];if(!l||Object.keys(l).length===0)return[null,"No projects found in this category."];let c=await ve(e,"Select Project:",Object.keys(l));return c?[{dimension:n,category:a,projectId:c},"Project details collected."]:[null,"Project action cancelled. No project selected."]}Tt();async function Zt(e){let[t,r]=await Ut(e.app,e.settings);if(t===null){new Rt.Notice(r);return}let[,o]=await it(e,t);new Rt.Notice(o),console.log(o)}var Et=require("obsidian");async function Qt(e){let[t,r]=await et(e.app,e.settings);if(t===null){new Et.Notice(r);return}let{dimension:o,category:n,projectId:s}=t,[,i]=await ze(e,o,n,s);new Et.Notice(i),console.log(i)}var bt=require("obsidian");async function qt(e){let[t,r]=await et(e.app,e.settings);if(t===null){new bt.Notice(r);return}let{dimension:o,category:n,projectId:s}=t,[,i]=await Xe(e,o,n,s);new bt.Notice(i),console.log(i)}var sr=require("obsidian");var at={type:"object",description:"Reference to a project by tag, id, or full name.",properties:{tag:{type:"string"},id:{type:"string"},fullName:{type:"string"}},additionalProperties:!1};function er(e){let t=e.getApi();return t?[{name:"resolveProject",description:"Resolve a project by tag, id, or full name.",schema:{type:"object",properties:{projectRef:at},required:["projectRef"],additionalProperties:!1},handler:async r=>t.resolveProject(r.projectRef)},{name:"listEntityTypes",description:"List available entity types.",schema:{type:"object",properties:{},additionalProperties:!1},handler:async()=>t.listEntityTypes()},{name:"createProject",description:"Create a project with the required metadata.",schema:{type:"object",properties:{name:{type:"string"},tag:{type:"string"},id:{type:"string"},dimension:{type:"string"},category:{type:"string"},parent:{type:"string"},projectTypeId:{type:"string"}},required:["name","tag","id","dimension","category"],additionalProperties:!1},handler:async r=>t.createProject(r)},{name:"createEntity",description:"Create an entity inside a project using a template.",schema:{type:"object",properties:{projectRef:at,entityTypeId:{type:"string"},fields:{type:"object"}},required:["projectRef","entityTypeId"],additionalProperties:!1},handler:async r=>t.createEntity(r)},{name:"patchMarker",description:"Patch content into a file at an AI marker.",schema:{type:"object",properties:{path:{type:"string"},marker:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","marker","content"],additionalProperties:!1},handler:async r=>t.patchMarker(r)},{name:"patchSection",description:"Patch content into a file by heading.",schema:{type:"object",properties:{path:{type:"string"},heading:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","heading","content"],additionalProperties:!1},handler:async r=>t.patchSection(r)},{name:"getChildren",description:"Get child projects for a given project.",schema:{type:"object",properties:{projectRef:at,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async r=>t.getChildren(r.projectRef,r.archived)},{name:"getParents",description:"Get parent projects for a given project.",schema:{type:"object",properties:{projectRef:at,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async r=>t.getParents(r.projectRef,r.archived)}]:[]}function ct(e,t,r="$",o=[]){if(!e)return o;let n=e.type?Array.isArray(e.type)?e.type:[e.type]:[];if(n.length>0&&!n.some(i=>eo(i,t)))return o.push({path:r,message:`Expected ${n.join("|")}`}),o;if(e.enum&&!e.enum.includes(t)&&o.push({path:r,message:"Value not in enum"}),e.type==="object"&&t&&typeof t=="object"&&!Array.isArray(t)){let s=t;if((e.required||[]).forEach(a=>{a in s||o.push({path:`${r}.${a}`,message:"Missing required field"})}),e.properties)for(let[a,l]of Object.entries(e.properties))a in s&&ct(l,s[a],`${r}.${a}`,o)}return e.type==="array"&&Array.isArray(t)&&e.items&&t.forEach((s,i)=>{ct(e.items,s,`${r}[${i}]`,o)}),o}function eo(e,t){return e==="array"?Array.isArray(t):e==="integer"?Number.isInteger(t):e==="number"?typeof t=="number":e==="boolean"?typeof t=="boolean":e==="string"?typeof t=="string":e==="object"?t!=null&&typeof t=="object"&&!Array.isArray(t):!0}async function tr(e,t){let r=[],o=new Map(t.map(n=>[n.name,n]));for(let n of e){let s=o.get(n.name);if(!s){r.push({toolName:n.name,ok:!1,error:"Tool not found"});continue}let i=ct(s.schema,n.arguments);if(i.length>0){r.push({toolName:n.name,ok:!1,error:`Schema validation failed: ${i.map(a=>`${a.path}: ${a.message}`).join(", ")}`});continue}try{let a=await s.handler(n.arguments);r.push({toolName:n.name,ok:!0,result:a})}catch(a){r.push({toolName:n.name,ok:!1,error:(a==null?void 0:a.message)||"Tool execution failed"})}}return r}async function*rr(e,t,r){var c,p;let o=`${e.baseUrl.replace(/\/$/,"")}/v1/chat/completions`,n={model:e.model,messages:t.map(m=>({role:m.role,content:m.content})),tools:r.map(m=>({type:"function",function:{name:m.name,description:m.description,parameters:m.schema}})),tool_choice:"auto",stream:!0},s=await fetch(o,{method:"POST",headers:{Authorization:`Bearer ${e.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(n)});if(!s.ok||!s.body){let m=await to(s);throw new Error(`OpenAI request failed: ${s.status} ${m||s.statusText}`)}let i=s.body.getReader(),a=new TextDecoder,l="";for(;;){let{value:m,done:y}=await i.read();if(y)break;l+=a.decode(m,{stream:!0});let j=l.split(`
`);l=j.pop()||"";for(let f of j){let d=f.trim();if(!d.startsWith("data:"))continue;let g=d.replace(/^data:\s*/,"");if(g==="[DONE]"){yield{type:"done"};return}let h;try{h=JSON.parse(g)}catch(R){continue}let P=(p=(c=h==null?void 0:h.choices)==null?void 0:c[0])==null?void 0:p.delta;P&&(P.content&&(yield{type:"content",delta:P.content}),P.tool_calls&&(yield{type:"tool_call_delta",toolCalls:P.tool_calls.map(C=>{var I,O;return{index:C.index,id:C.id,name:(I=C.function)==null?void 0:I.name,arguments:(O=C.function)==null?void 0:O.arguments}})}))}}yield{type:"done"}}function or(e,t){for(let r of e){let o=t.get(r.index)||{name:"",arguments:{}};if(r.id&&(o.id=r.id),r.name&&(o.name=r.name),typeof r.arguments=="string"){let n=o._rawArgs||"";o._rawArgs=n+r.arguments}t.set(r.index,o)}}function nr(e){let t=[];for(let[,r]of e){let o=r._rawArgs;if(o)try{r.arguments=JSON.parse(o)}catch(n){r.arguments={}}delete r._rawArgs,t.push(r)}return t}async function to(e){try{return await e.text()}catch(t){return""}}var le="projectflow-ai-chat",lt=class extends sr.ItemView{constructor(r,o){super(r);this.messageContainer=null;this.inputEl=null;this.sendBtn=null;this.busy=!1;this.plugin=o}getViewType(){return le}getDisplayText(){return"ProjectFlow AI"}getIcon(){return"brain-circuit"}async onOpen(){let r=this.containerEl.children[1];r.empty(),r.addClass("pf-ai-view"),r.createDiv({cls:"pf-ai-header"}).createEl("h3",{text:"ProjectFlow AI"});let n=r.createDiv({cls:"pf-ai-messages"});this.messageContainer=n;let s=r.createDiv({cls:"pf-ai-input"}),i=s.createEl("textarea");i.placeholder="Ask ProjectFlow...";let a=s.createEl("button",{text:"Send"});this.inputEl=i,this.sendBtn=a,a.onclick=()=>this.handleSend(),i.onkeydown=l=>{l.key==="Enter"&&!l.shiftKey&&(l.preventDefault(),this.handleSend())}}async onClose(){this.messageContainer=null,this.inputEl=null,this.sendBtn=null}appendMessage(r,o){if(!this.messageContainer)return null;let n=this.messageContainer.createDiv({cls:`pf-ai-message ${r}`});return n.setText(o),this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}),n}updateMessage(r,o){var n;r&&(r.setText(o),(n=this.messageContainer)==null||n.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}))}async handleSend(){var n;if(this.busy)return;let r=(((n=this.inputEl)==null?void 0:n.value)||"").trim();if(!r)return;this.inputEl.value="",this.appendMessage("user",r);let o=this.plugin.settings.ai;if(!(o!=null&&o.enabled)){this.appendMessage("assistant","AI module is disabled in settings.");return}if(!o.apiKey){await this.handleTagLookup(r);return}await this.handleLLM(r)}async handleTagLookup(r){let o=this.plugin.getApi();if(!o){this.appendMessage("assistant","Core API is not available.");return}try{let n=o.resolveProject({tag:r});if(!n){this.appendMessage("assistant","Project not found.");return}this.appendMessage("assistant",`Resolved project: ${n.entry.fullName} (${n.entry.projectTag})`)}catch(n){this.appendMessage("assistant",(n==null?void 0:n.message)||"Failed to resolve project.")}}async handleLLM(r){var i,a,l;if(this.busy)return;this.busy=!0,this.sendBtn&&(this.sendBtn.disabled=!0);let o=this.appendMessage("assistant",""),n=new Map,s=new Map;try{let c=er(this.plugin),p=await this.buildSystemPrompt(),m=this.buildUserMessage(r),y=[{role:"system",content:p},{role:"user",content:m}];for await(let f of rr({apiKey:((i=this.plugin.settings.ai)==null?void 0:i.apiKey)||"",model:((a=this.plugin.settings.ai)==null?void 0:a.model)||"gpt-4o-mini",baseUrl:((l=this.plugin.settings.ai)==null?void 0:l.baseUrl)||"https://api.openai.com"},y,c)){if(f.type==="content"&&f.delta){let d=(o==null?void 0:o.textContent)||"";this.updateMessage(o,d+f.delta)}if(f.type==="tool_call_delta"&&f.toolCalls){or(f.toolCalls,s);for(let d of f.toolCalls)if(d.name&&!n.has(d.name)){let g=this.appendMessage("tool",`Using tool: ${d.name}`);g&&n.set(d.name,g)}}}let j=nr(s);if(j.length>0){let f=await tr(j,c);for(let d of f){let g=d.ok?`Tool result (${d.toolName}): ${ro(d.result)}`:`Tool error (${d.toolName}): ${d.error}`;this.appendMessage("tool",g)}}}catch(c){this.appendMessage("assistant",(c==null?void 0:c.message)||"LLM request failed.")}finally{this.busy=!1,this.sendBtn&&(this.sendBtn.disabled=!1)}}async buildSystemPrompt(){let r=this.getSelection(),o=this.app.workspace.getActiveFile(),n="";if(o)try{n=(await this.app.vault.cachedRead(o)).slice(0,1e3)}catch(i){n=""}let s=this.plugin.settings.projectIndex;return["You are ProjectFlow AI. You must use tools to perform any actions.","Never edit markdown directly; use tools only.","Respond with tool calls when an action is required.","Context:",`Selected text: ${r||"(none)"}`,`Active file: ${(o==null?void 0:o.path)||"(none)"}`,`Active file content (truncated): ${n||"(none)"}`,`Project index snapshot: ${s?JSON.stringify(s):"(none)"}`].join(`
`)}buildUserMessage(r){return`I'm going to create a project with tag ${r}
${r}`}getSelection(){var o;let r=(o=this.app.workspace.activeEditor)==null?void 0:o.editor;return r?r.getSelection():""}};function ro(e){if(e==null)return"(no result)";if(typeof e=="string")return e;try{return JSON.stringify(e)}catch(t){return String(e)}}var mt=class extends Ir.Plugin{async onload(){var r;console.log("ProjectFlow plugin loaded"),await this.loadSettings(),this.addSettingTab(new Ze(this.app,this)),this.registerView(le,o=>new lt(o,this)),this.addCommand({id:"add-project-info",name:"Add Project Info",callback:()=>Zt(this)}),this.addCommand({id:"remove-project-by-id",name:"Remove Project",callback:()=>Qt(this)}),this.addCommand({id:"archive-project-by-id",name:"Archive Project",callback:()=>qt(this)}),await this.exposeCoreApi(),(r=this.settings.ai)!=null&&r.enabled&&this.app.workspace.onLayoutReady(()=>{this.toggleAiView(!0)})}async loadSettings(){let r=await this.loadData();try{let{migrateSettings:o,CURRENT_SETTINGS_SCHEMA_VERSION:n}=await Promise.resolve().then(()=>(xt(),ir)),{DEFAULT_ENTITY_TYPES:s,DEFAULT_PROJECT_TYPES:i}=await Promise.resolve().then(()=>(Ae(),Ct)),{ensureProjectIndex:a}=await Promise.resolve().then(()=>(he(),ke)),{ensureProjectGraph:l}=await Promise.resolve().then(()=>(ye(),$e));this.settings=Object.assign({},Qe,o(r));let c=!1;this.settings.templatesRoot||(this.settings.templatesRoot="Templates/ProjectFlow",c=!0),(!this.settings.entityTypes||Object.keys(this.settings.entityTypes).length===0)&&(this.settings.entityTypes=s,c=!0),(!this.settings.projectTypes||Object.keys(this.settings.projectTypes).length===0)&&(this.settings.projectTypes=i,c=!0),(!this.settings.schemaVersion||this.settings.schemaVersion<n)&&(this.settings.schemaVersion=n,c=!0);let{index:p,updated:m}=a(this.settings.projectIndex,this.settings.projectRecords);m&&(this.settings.projectIndex=p,c=!0);let{graph:y,updated:j}=l(this.settings.projectGraph,this.settings.projectRecords,this.settings.archivedRecords);j&&(this.settings.projectGraph=y,c=!0),c&&await this.saveData(this.settings)}catch(o){this.settings=Object.assign({},Qe,r)}}async saveSettings(){await this.saveData(this.settings)}getApi(){return this.coreApi}async toggleAiView(r){if(r){let o=this.app.workspace.getLeavesOfType(le);if(o.length>0){await o[0].setViewState({type:le,active:!0});return}let n=this.app.workspace.getRightLeaf(!1);if(!n)return;await n.setViewState({type:le,active:!0})}else this.app.workspace.detachLeavesOfType(le)}onunload(){this.app.workspace.detachLeavesOfType(le)}async exposeCoreApi(){let{createCoreApi:r}=await Promise.resolve().then(()=>(Ar(),xr));this.coreApi=r(this);let o=window;o.PluginApi=o.PluginApi||{},o.PluginApi["@projectflow/core"]=this.coreApi}};var uo=mt;
