/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var bt=Object.defineProperty;var Eo=Object.getOwnPropertyDescriptor;var bo=Object.getOwnPropertyNames;var Ao=Object.prototype.hasOwnProperty;var k=(e,t)=>()=>(e&&(t=e(e=0)),t);var V=(e,t)=>{for(var n in t)bt(e,n,{get:t[n],enumerable:!0})},Co=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of bo(t))!Ao.call(e,r)&&r!==n&&bt(e,r,{get:()=>t[r],enumerable:!(o=Eo(t,r))||o.enumerable});return e};var So=e=>Co(bt({},"__esModule",{value:!0}),e);var gn={};V(gn,{DEFAULT_ENTITY_TYPES:()=>pe,DEFAULT_PROJECT_TYPES:()=>fe});var pe,fe,Se=k(()=>{pe={task:{id:"task",name:"Task",templatePath:"template-task.md",targetFolder:"Work/Tasks",filenameRule:"${PROJECT_ID}-${title}",requiredFields:["title","description"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},"meeting.planning":{id:"meeting.planning",name:"Meeting (Planning)",templatePath:"template-meeting-planning.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.refinement":{id:"meeting.refinement",name:"Meeting (Refinement)",templatePath:"template-meeting-refinement.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.retro":{id:"meeting.retro",name:"Meeting (Retro)",templatePath:"template-meeting-retro.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.demo":{id:"meeting.demo",name:"Meeting (Demo)",templatePath:"template-meeting-demo.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.daily":{id:"meeting.daily",name:"Meeting (Daily)",templatePath:"template-meeting-daily.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.knowledge":{id:"meeting.knowledge",name:"Meeting (Knowledge)",templatePath:"template-meeting-knowledge.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},sprint:{id:"sprint",name:"Sprint",templatePath:"template-sprint.md",targetFolder:"Work",filenameRule:"Sprint ${title}",requiredFields:["title"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},idea:{id:"idea",name:"Idea",templatePath:"template-idea.md",targetFolder:"Knowledge Base",filenameRule:"Idea ${title}",requiredFields:["title"],patchMarkers:["AI:CONTENT"]}},fe={operational:{id:"operational",name:"Operational",description:"Default ProjectFlow structure for active projects.",folderStructure:["Knowledge Base","Meetings","Work","Work/Tasks","People"],initialNotes:[{fileName:"${PROJECT_FULL_NAME}.md",template:"project.md"},{fileName:"${PROJECT_NAME} Meetings.md",template:"meetings.md"},{fileName:"${PROJECT_NAME} People.md",template:"people.md"},{fileName:"${PROJECT_NAME} Work.md",template:"work.md"},{fileName:"${PROJECT_NAME} Knowledge Base.md",template:"knowledge-base.md"}],allowedEntityTypes:Object.keys(pe)}}});var he={};V(he,{SafeFileManager:()=>At});var At,ye=k(()=>{At=class{constructor(t){this.vault=t.vault}async createBatch(t){let n=[];try{for(let o of t)o.type==="folder"?await this.ensureFolder(o.path):await this.createIfAbsent(o.path,o.data)==="created"&&n.push(o.path);return{ok:!0}}catch(o){for(let r of n.reverse())try{let s=this.vault.getAbstractFileByPath(r);s&&this.vault.delete&&await this.vault.delete(s)}catch(s){}return{ok:!1,error:o}}}async has(t){var n;try{return this.vault.getAbstractFileByPath(t)?!0:(n=this.vault.adapter)!=null&&n.exists?await this.vault.adapter.exists(t):!1}catch(o){return!1}}async ensureFolder(t){var o;if(!this.vault.getAbstractFileByPath(t))try{await this.vault.createFolder(t)}catch(r){if(r&&typeof r=="object"&&((o=r.message)!=null&&o.includes("Parent folder"))){let s=t.split("/").filter(Boolean),i="";for(let a of s)if(i=i?`${i}/${a}`:a,!this.vault.getAbstractFileByPath(i))try{await this.vault.createFolder(i)}catch(p){}}}}async createIfAbsent(t,n){if(await this.has(t))return"skipped";try{return await this.vault.create(t,n),"created"}catch(o){return await this.has(t),"skipped"}}async removeDir(t){let n=this.vault.getAbstractFileByPath(t);if(n&&this.vault)try{await this.vault.trash(n,!0),await new Promise(o=>setTimeout(o,200))}catch(o){console.warn(`removeDir: failed to trash ${t}: ${o}`)}else console.warn(`removeDir: file not found: ${t}. File: ${n==null?void 0:n.path}`)}}});var Ie={};V(Ie,{sanitizeFileName:()=>Ye,sanitizePath:()=>K});function Ye(e){let t=(e!=null?e:"").trim();return Array.from(t).filter(o=>o.charCodeAt(0)>=32).join("").replace(/[\\/:*?"<>|]/g,"-").replace(/\s+/g," ").replace(/\.+$/g,"").substring(0,200)||"untitled"}function K(e){return e?e.split("/").filter(Boolean).map(Ye).join("/"):""}var Pe=k(()=>{});var Me={};V(Me,{PROJECT_INDEX_VERSION:()=>Ct,addToProjectIndex:()=>Mo,buildProjectIndex:()=>hn,ensureProjectIndex:()=>Xe,getProjectIndexCache:()=>qe,removeFromProjectIndex:()=>ko,setProjectIndexCache:()=>Io,toIndexEntry:()=>St});function qe(){return ze}function Io(e){ze=e}function hn(e){let t={},n={},o={};if(e&&typeof e=="object"){for(let[r,s]of Object.entries(e))if(!(!s||typeof s!="object")){for(let[i,a]of Object.entries(s))if(!(!a||typeof a!="object"))for(let[p,l]of Object.entries(a)){if(!l||!l.variables||!l.info)continue;let c=St(l,p,r,i);t[c.fullName]=c,n[c.projectId]=c,o[c.projectTag]=c}}}return{version:1,byFullName:t,byId:n,byTag:o}}function St(e,t,n,o){var r;return{fullName:e.variables.PROJECT_FULL_NAME,projectId:t,projectTag:e.variables.PROJECT_TAG,path:e.variables.PROJECT_PATH,dimension:n,category:o,projectName:e.info.name,parent:(r=e.info.parent)!=null?r:null}}function Xe(e,t){if(!e||e.version!==1){let n=hn(t);return ze=n,{index:n,updated:!0}}return ze=e,{index:e,updated:!1}}function Mo(e,t,n,o,r){let s=St(t,n,o,r);return e.byFullName[s.fullName]=s,e.byId[s.projectId]=s,e.byTag[s.projectTag]=s,e}function ko(e,t){return delete e.byFullName[t.fullName],delete e.byId[t.projectId],delete e.byTag[t.projectTag],e}var Ct,ze,je=k(()=>{Ct=1,ze=null});var Fe={};V(Fe,{PROJECT_GRAPH_VERSION:()=>It,addProjectToGraph:()=>$o,buildProjectGraph:()=>Mt,cleanArchivedGraph:()=>kt,ensureProjectGraph:()=>ke,getChildren:()=>Ft,getParents:()=>Nt,getProjectGraphCache:()=>Fo,removeProjectFromGraph:()=>Do,setProjectGraphCache:()=>No});function Fo(){return Ze}function No(e){Ze=e}function Mt(e,t){let n={},o={};return e&&yn(e,n),t&&yn(t,o),{version:1,byFullName:n,archivedByFullName:o}}function ke(e,t,n){if(!e||e.version!==1){let o=Mt(t,n);return Ze=o,{graph:o,updated:!0}}return Ze=e,{graph:e,updated:!1}}function $o(e,t,n){let o=t.variables.PROJECT_FULL_NAME,r=Pn(t.info.parent),s=n?e.archivedByFullName:e.byFullName;if(s[o]=s[o]||{parent:r,children:[]},s[o].parent=r!=null?r:null,r){let i=s[r]||{parent:null,children:[]};i.children.includes(o)||i.children.push(o),s[r]=i}return e}function Do(e,t,n){let o=n?e.archivedByFullName:e.byFullName,r=o[t];return r!=null&&r.parent&&o[r.parent]&&(o[r.parent].children=o[r.parent].children.filter(s=>s!==t)),delete o[t],e}function kt(e,t){let n=Mt(void 0,t);return e.archivedByFullName=n.archivedByFullName,e}function Ft(e,t,n){var r,s;return(s=(r=(n?e.archivedByFullName:e.byFullName)[t])==null?void 0:r.children)!=null?s:[]}function Nt(e,t,n){var i,a,p,l;let o=n?e.archivedByFullName:e.byFullName,r=[],s=(a=(i=o[t])==null?void 0:i.parent)!=null?a:null;for(;s;)r.push(s),s=(l=(p=o[s])==null?void 0:p.parent)!=null?l:null;return r}function yn(e,t){for(let n of Object.values(e))for(let o of Object.values(n))for(let r of Object.values(o)){if(!r||!r.variables)continue;let s=r.variables.PROJECT_FULL_NAME,i=Pn(r.info.parent);if(t[s]=t[s]||{parent:i,children:[]},t[s].parent=i!=null?i:null,i){let a=t[i]||{parent:null,children:[]};a.children.includes(s)||a.children.push(s),t[i]=a}}}function Pn(e){let t=e==null?void 0:e.trim();return t&&t.length>0?t:null}var It,Ze,ve=k(()=>{It=1,Ze=null});var Tn={};V(Tn,{ensureValidOrThrow:()=>Jo,validateProjectName:()=>Lo,validateTag:()=>Go});function Lo(e){if(!e||!e.trim())return{ok:!1,reason:"Project name is required"};let t=e.trim();if(t.length>120)return{ok:!1,reason:"Project name too long (max 120)"};for(let n of t)if(n.charCodeAt(0)<32||n==="/"||n==="\\")return{ok:!1,reason:"Project name contains invalid characters"};return{ok:!0}}function Go(e){if(!e||!e.trim())return{ok:!1,reason:"Tag is required"};let t=e.trim();return _o.test(t)?{ok:!0}:{ok:!1,reason:"Tag must be 2-63 chars, start with letter/digit; may include -, _, /"}}function Jo(e,t){let n=e();if(!n.ok)throw new Error(`${t}: ${n.reason}`)}var _o,xn=k(()=>{_o=/^[A-Za-z0-9][A-Za-z0-9_/-]{1,62}$/});var st={};V(st,{processTemplate:()=>Bo});function En(e){return e==null?"":String(e)}function Bo(e,t){if(!e||typeof e!="string")return"";let n=e;for(let[o,r]of Object.entries(t)){let s=En(r),i=`$_${o}`;n.includes(i)&&(n=n.split(i).join(s))}for(let[o,r]of Object.entries(t)){let s=En(r),i=new RegExp(`\\$\\{${Uo(o)}\\}`,"g");n=n.replace(i,s)}return n}function Uo(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var it=k(()=>{});function bn(e,t){let n=new Date,o=n.getFullYear().toString(),r=n.toISOString().split("T")[0],s=t.projectsRoot||"1. Projects",i=e.parent&&e.parent.trim().length>0?`.${e.parent.trim()}`:"",a=`${o}${i}.${e.name}`,p=t.dimensions.find(g=>g.name===e.dimension),l=p?`${p.order}. ${p.name}`:e.dimension,c=`${s}/${l}/${e.category}/${a}`,u=`${c}`;return{PROJECT_NAME:e.name,PROJECT_TAG:e.tag,PROJECT_PARENT:e.parent?e.parent:"",PARENT_TAG:e.parent?e.tag:"",YEAR:o,DATE:r,PROJECT_FULL_NAME:a,PROJECT_RELATIVE_PATH:c,PROJECT_PATH:u,DIMENSION:p?p.name:e.dimension,CATEGORY:e.category,PROJECT_ID:e.id,PROJECT_DIMENSION:p?p.name:e.dimension}}async function at(e,t){try{let{processTemplate:n}=await Promise.resolve().then(()=>(it(),st));return n(e,t)}catch(n){console.warn("Template processor import failed, using legacy replacement:",n);let o=e;return Object.entries(t).forEach(([r,s])=>{let i=`$_${r}`;o=o.split(i).join(s)}),o}}var An=k(()=>{});var Cn={};V(Cn,{mergeEntityTypes:()=>ct,mergeProjectTypes:()=>Ee});function ct(e){let t={...pe};if(e&&typeof e=="object")for(let[n,o]of Object.entries(e))!o||typeof o!="object"||(t[n]={...t[n],...o,id:n});return t}function Ee(e){let t={...fe};if(e&&typeof e=="object")for(let[n,o]of Object.entries(e))!o||typeof o!="object"||(t[n]={...t[n],...o,id:n});return t}var De=k(()=>{Se()});var Sn={};V(Sn,{resolveProjectType:()=>Vo});function Vo(e,t){let n=Ee(e.projectTypes),o=t==null?void 0:t.projectTypeId,r=o&&n[o]?o:"operational",s=n[r]||n.operational;return{projectTypeId:r,projectType:s}}var In=k(()=>{De()});async function lt(e,t){var n,o;try{let{resolveProjectType:r}=await Promise.resolve().then(()=>(In(),Sn)),{projectTypeId:s,projectType:i}=r(e.settings,t);t.projectTypeId=s;let a=bn(t,e.settings),p=e.settings.projectsRoot||"1. Projects",{sanitizePath:l,sanitizeFileName:c}=await Promise.resolve().then(()=>(Pe(),Ie)),{SafeFileManager:u}=await Promise.resolve().then(()=>(ye(),he)),g=new u(e.app),f=l(p),y=e.settings.dimensions.find(x=>x.name===t.dimension),P=y?`${y.order}. ${y.name}`:t.dimension,w=c(P),d=c(t.category),m=l(`${f}/${w}/${d}/${a.PROJECT_FULL_NAME}`),j=(n=i==null?void 0:i.folderStructure)!=null?n:["Knowledge Base","Meetings","Work","Work/Tasks","People"],v=[{type:"folder",path:m},...j.map(x=>({type:"folder",path:l(`${m}/${x}`)}))],T=e.app.vault.adapter,A=`.obsidian/plugins/${e.manifest.id}/src/templates`,O=(o=i==null?void 0:i.initialNotes)!=null?o:[{fileName:`${a.PROJECT_FULL_NAME}.md`,template:"project.md"},{fileName:`${t.name} Meetings.md`,template:"meetings.md"},{fileName:`${t.name} People.md`,template:"people.md"},{fileName:`${t.name} Work.md`,template:"work.md"},{fileName:`${t.name} Knowledge Base.md`,template:"knowledge-base.md"}],Y=[];for(let x of O){let F=x.fileName?await at(x.fileName,a):x.fileName,q=`${A}/${x.template}`;if(!await T.exists(q))throw new Error(`Template file not found: ${x.template}`);let ue=await T.read(q),we=await at(ue,a),ne=l(`${m}/${c(F)}`);Y.push({type:"file",path:ne,data:we})}let z=await g.createBatch([...v,...Y]);if(!("ok"in z)||!z.ok)throw new Error(`Batch creation failed: ${z.error||"unknown"}`);return await Ko(e,t.name,a),await Ho(e,t,a),[!0,`Project "${t.name}" created successfully!`]}catch(r){return[!1,`Error creating project: ${r}`]}}async function Ho(e,t,n){try{let{ensureProjectIndex:o,addToProjectIndex:r}=await Promise.resolve().then(()=>(je(),Me)),{ensureProjectGraph:s,addProjectToGraph:i}=await Promise.resolve().then(()=>(ve(),Fe)),a={info:t,variables:n,createdAt:new Date().toISOString()},p=t.dimension,l=t.category,c=t.id;if(!e.settings.projectRecords||Array.isArray(e.settings.projectRecords)){let y={},P=Array.isArray(e.settings.projectRecords)?e.settings.projectRecords:[];for(let w of P){let d=w.info.dimension,m=w.info.category,j=w.info.id;y[d]=y[d]||{},y[d][m]=y[d][m]||{},y[d][m][j]=w}e.settings.projectRecords=y}let u=e.settings.projectRecords;if(u[p]=u[p]||{},u[p][l]=u[p][l]||{},u[p][l][c])throw new Error(`Project with id "${c}" already exists in ${p}:${l}`);u[p][l][c]=a;let{index:g}=o(e.settings.projectIndex,u);e.settings.projectIndex=r(g,a,c,p,l);let{graph:f}=s(e.settings.projectGraph,u,e.settings.archivedRecords);e.settings.projectGraph=i(f,a,!1),await e.saveData(e.settings)}catch(o){throw console.warn("Failed to record project creation:",o),o}}async function Wo(e,t,n,o,r){try{let s=e.app.vault.adapter,i=`.obsidian/plugins/${e.manifest.id}/src/templates/${o}`;if(!await s.exists(i))throw new Error(`Template file not found: ${o}`);let a=await s.read(i),p=await at(a,r),l=`${t}/${n}`,{SafeFileManager:c}=await Promise.resolve().then(()=>(ye(),he));await new c(e.app).createIfAbsent(l,p)}catch(s){throw console.error(`Failed to create ${n}:`,s),new Error(`Failed to create ${n}: ${s}`)}}async function Ko(e,t,n){let{sanitizePath:o,sanitizeFileName:r}=await Promise.resolve().then(()=>(Pe(),Ie)),{SafeFileManager:s}=await Promise.resolve().then(()=>(ye(),he)),i=new s(e.app),a=o(`Templates/${t}_Templates`);await i.ensureFolder(a);let p=[{source:"template-meeting-daily.md",target:`${t}_Meeting_Daily_Template.md`},{source:"template-meeting-discussion.md",target:`${t}_Meeting_Discussion_Template.md`},{source:"template-meeting-knowledge.md",target:`${t}_Meeting_Knowledge_Template.md`},{source:"template-meeting-planning.md",target:`${t}_Meeting_Planning_Template.md`},{source:"template-meeting-refinement.md",target:`${t}_Meeting_Refinement_Template.md`},{source:"template-meeting-retro.md",target:`${t}_Meeting_Retro_Template.md`},{source:"template-meeting-demo.md",target:`${t}_Meeting_Demo_Template.md`},{source:"template-sprint.md",target:`${t}_Sprint_Template.md`},{source:"template-task.md",target:`${t}_Task_Template.md`},{source:"template-idea.md",target:`${t}_Idea_Template.md`},{source:"template-knowledge-base-item.md",target:`${t}_Knowledge_Item_Template.md`},{source:"template-meeting-daily.md",target:"template-meeting-daily.md"},{source:"template-meeting-discussion.md",target:"template-meeting-discussion.md"},{source:"template-meeting-knowledge.md",target:"template-meeting-knowledge.md"},{source:"template-meeting-planning.md",target:"template-meeting-planning.md"},{source:"template-meeting-refinement.md",target:"template-meeting-refinement.md"},{source:"template-meeting-retro.md",target:"template-meeting-retro.md"},{source:"template-meeting-demo.md",target:"template-meeting-demo.md"},{source:"template-sprint.md",target:"template-sprint.md"},{source:"template-task.md",target:"template-task.md"},{source:"template-idea.md",target:"template-idea.md"},{source:"template-knowledge-base-item.md",target:"template-knowledge-base-item.md"}];for(let l of p)try{let c=r(l.target);await Wo(e,a,c,l.source,n)}catch(c){console.warn(`Failed to create template ${l.target}: ${c}`)}}var $t=k(()=>{An()});var Kn={};V(Kn,{CURRENT_SETTINGS_SCHEMA_VERSION:()=>Le,migrateSettings:()=>pr});function pr(e){var r,s,i,a,p,l,c,u,g,f,y,P,w;let t={dimensions:(r=e==null?void 0:e.dimensions)!=null?r:[],projectsRoot:(s=e==null?void 0:e.projectsRoot)!=null?s:"1. Projects",archiveRoot:(i=e==null?void 0:e.archiveRoot)!=null?i:"4. Archive",templatesRoot:(a=e==null?void 0:e.templatesRoot)!=null?a:"Templates/ProjectFlow",ai:e==null?void 0:e.ai,schemaVersion:(p=e==null?void 0:e.schemaVersion)!=null?p:0,projectRecords:{},archivedRecords:(l=e==null?void 0:e.archivedRecords)!=null?l:{},entityTypes:(c=e==null?void 0:e.entityTypes)!=null?c:{},projectTypes:(u=e==null?void 0:e.projectTypes)!=null?u:{},projectIndex:e==null?void 0:e.projectIndex,projectGraph:e==null?void 0:e.projectGraph},n=e==null?void 0:e.projectRecords;if(n&&typeof n=="object"&&!Array.isArray(n))t.projectRecords=n;else if(Array.isArray(n)){let d={};for(let m of n){if(!m||!m.info)continue;let j=m.info.dimension,v=m.info.category,T=m.info.id;!j||!v||!T||(d[j]=d[j]||{},d[j][v]=d[j][v]||{},d[j][v][T]=m)}t.projectRecords=d}else t.projectRecords={};if(Array.isArray(t.dimensions)){let d=1;t.dimensions=t.dimensions.map(m=>{var j;if(m&&typeof m=="object"){let v=(j=m.name)!=null?j:"",T=m.order,A=typeof v=="string"?v.match(/^\s*(\d+)\.\s*(.+)$/):null;return A&&(T=parseInt(A[1],10),v=A[2]),(T==null||Number.isNaN(T))&&(T=d++),{name:v,order:T,categories:Array.isArray(m.categories)?m.categories:[]}}return{name:String(m!=null?m:""),order:d++,categories:[]}})}else t.dimensions=[];let o=[...t.dimensions].sort((d,m)=>{var j,v;return((j=d.order)!=null?j:0)-((v=m.order)!=null?v:0)});return o.forEach((d,m)=>{d.order=m+1}),t.dimensions=o,(!t.schemaVersion||t.schemaVersion<Le)&&((!t.entityTypes||Object.keys(t.entityTypes).length===0)&&(t.entityTypes=pe),(!t.projectTypes||Object.keys(t.projectTypes).length===0)&&(t.projectTypes=fe),t.ai?t.ai={enabled:Boolean(t.ai.enabled),provider:t.ai.provider||"openai",apiKey:(g=t.ai.apiKey)!=null?g:"",model:(f=t.ai.model)!=null?f:"gpt-4o-mini",baseUrl:(y=t.ai.baseUrl)!=null?y:"https://api.openai.com",strictExecution:Boolean(t.ai.strictExecution),memoryLimit:Number.isFinite(t.ai.memoryLimit)?t.ai.memoryLimit:10,mixedOfferText:(P=t.ai.mixedOfferText)!=null?P:Wn,mcpServers:Array.isArray(t.ai.mcpServers)?t.ai.mcpServers:[],toolLog:Array.isArray(t.ai.toolLog)?t.ai.toolLog:[],conversation:Array.isArray(t.ai.conversation)?t.ai.conversation:[],pendingPlan:(w=t.ai.pendingPlan)!=null?w:null}:t.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",strictExecution:!1,memoryLimit:10,mixedOfferText:Wn,mcpServers:[],toolLog:[],conversation:[],pendingPlan:null},t.schemaVersion=Le),t}var Le,Wn,Vt=k(()=>{Se();Le=8,Wn="I can also set this up for you. Shall I proceed?"});function Yn(e){return e?e.startsWith("/")||e.includes("\\")?!1:!e.split("/").filter(Boolean).some(n=>n==="."||n===".."):!0}function Ge(e,t){let n=K(e),o=K(t);return o?n===o||n.startsWith(`${o}/`):!1}var zn=k(()=>{Pe()});var Xn={};V(Xn,{listProjects:()=>Ht,resolveArchivedProject:()=>vt,resolveProject:()=>Je});function Je(e,t){var i,a,p;let n=qe()||Xe(e.settings.projectIndex,e.settings.projectRecords).index,o=qn(t),r=o.fullName&&n.byFullName[o.fullName]||o.id&&n.byId[o.id]||o.tag&&n.byTag[o.tag];if(!r)return null;let s=(p=(a=(i=e.settings.projectRecords)==null?void 0:i[r.dimension])==null?void 0:a[r.category])==null?void 0:p[r.projectId];return s?{entry:r,record:s}:null}function vt(e,t){var r;let n=qn(t),o=dr(e.settings.archivedRecords,n);return o?{entry:{fullName:o.variables.PROJECT_FULL_NAME,projectId:o.info.id,projectTag:o.variables.PROJECT_TAG,path:o.variables.PROJECT_PATH,dimension:o.info.dimension,category:o.info.category,projectName:o.info.name,parent:(r=o.info.parent)!=null?r:null},record:o}:null}function Ht(e){let t=qe()||Xe(e.settings.projectIndex,e.settings.projectRecords).index;return Object.values(t.byFullName)}function qn(e){var t,n,o;if(typeof e=="string"){let r=e.trim();return r.startsWith("project/")?{tag:r}:r.includes(".")?{fullName:r}:{id:r}}return{fullName:(t=e.fullName)==null?void 0:t.trim(),id:(n=e.id)==null?void 0:n.trim(),tag:(o=e.tag)==null?void 0:o.trim()}}function dr(e,t){if(!e)return null;for(let n of Object.values(e))for(let o of Object.values(n))for(let r of Object.values(o))if(r&&(t.fullName&&r.variables.PROJECT_FULL_NAME===t.fullName||t.id&&r.info.id===t.id||t.tag&&r.variables.PROJECT_TAG===t.tag))return r;return null}var Wt=k(()=>{je()});async function Qn(e,t){let{resolveProject:n}=await Promise.resolve().then(()=>(Wt(),Xn)),{mergeEntityTypes:o}=await Promise.resolve().then(()=>(De(),Cn)),{processTemplate:r}=await Promise.resolve().then(()=>(it(),st)),{SafeFileManager:s}=await Promise.resolve().then(()=>(ye(),he)),i=n(e,t.projectRef);if(!i)throw new Error("Project not found for reference.");let p=o(e.settings.entityTypes)[t.entityTypeId];if(!p)throw new Error(`Entity type not found: ${t.entityTypeId}`);let l=ur(t.fields);mr(p,l);let c={...i.record.variables,...l||{}},u=await gr(e,p,i.record,c);if(!u)throw new Error(`Template not found for entity type: ${p.id}`);let f=await e.app.vault.adapter.read(u.path),y=r(f,c),P=r(p.targetFolder,c);if(!Yn(P))throw new Error("Unsafe targetFolder path.");let w=K(i.record.variables.PROJECT_PATH),d=P?K(`${w}/${P}`):w;if(!Ge(d,w))throw new Error("Target folder is outside project path.");if(!Zn(d,e.settings))throw new Error("Target folder is outside allowed roots.");let m=p.filenameRule||"Untitled",j=r(m,c),v=j.endsWith(".md")?j.slice(0,-3):j,T=Ye(v),A=K(`${d}/${T}.md`);if(!Ge(A,w))throw new Error("Target file is outside project path.");if(!Zn(A,e.settings))throw new Error("Target file is outside allowed roots.");let O=new s(e.app);if(await O.ensureFolder(d),await O.has(A))throw new Error(`File already exists: ${A}`);return await O.createIfAbsent(A,y),{path:A}}function Zn(e,t){let n=t.projectsRoot||"1. Projects",o=t.archiveRoot||"4. Archive";return Ge(e,n)||Ge(e,o)}function mr(e,t){if(!e.requiredFields||e.requiredFields.length===0)return;let n=e.requiredFields.filter(o=>t==null||t[o]==null||String(t[o]).trim()==="");if(n.length>0)throw new Error(`Missing required fields: ${n.join(", ")}`)}function ur(e){if(!e)return e;let t={...e};for(let[n,o]of Object.entries(e)){if(o==null)continue;let r=n.toUpperCase(),s=n.toLowerCase();r in t||(t[r]=o),s in t||(t[s]=o)}return t}async function gr(e,t,n,o){let{processTemplate:r}=await Promise.resolve().then(()=>(it(),st)),s=e.app.vault.adapter,i=r(t.templatePath,o),a=K(`Templates/${n.info.name}_Templates`),p=K(e.settings.templatesRoot||"Templates/ProjectFlow"),l=`.obsidian/plugins/${e.manifest.id}/src/templates`,c=g=>g.map(f=>f==="project"?{scope:f,path:K(`${a}/${i}`)}:f==="vault"?{scope:f,path:K(`${p}/${i}`)}:{scope:f,path:`${l}/${i}`}),u=t.templateScope?[t.templateScope,"builtin"].filter((g,f,y)=>y.indexOf(g)===f):["project","vault","builtin"];for(let g of c(u))if(await s.exists(g.path))return g;return null}var eo=k(()=>{Pe();zn()});function to(e){if(e instanceof me)return e;let t=e instanceof Error?e.message:"Unknown error";return new me("validation_error",t)}var me,Kt=k(()=>{me=class extends Error{constructor(n,o,r){super(o);this.code=n,this.details=r}}});function H(e,t){if(typeof e!="string"||e.trim().length===0)throw new me("invalid_request",`${t} is required`,{field:t});return e.trim()}function wt(e){if(e==null)throw new me("invalid_request","projectRef is required",{field:"projectRef"});if(typeof e=="string"){H(e,"projectRef");return}let t=typeof e.fullName=="string"&&e.fullName.trim().length>0,n=typeof e.id=="string"&&e.id.trim().length>0,o=typeof e.tag=="string"&&e.tag.trim().length>0;if(!t&&!n&&!o)throw new me("invalid_request","projectRef must include fullName, id, or tag",{field:"projectRef"})}function no(e){H(e==null?void 0:e.name,"name"),H(e==null?void 0:e.tag,"tag"),H(e==null?void 0:e.id,"id"),H(e==null?void 0:e.dimension,"dimension"),H(e==null?void 0:e.category,"category")}function oo(e){wt(e==null?void 0:e.projectRef),H(e==null?void 0:e.entityTypeId,"entityTypeId")}function ro(e){H(e==null?void 0:e.path,"path"),H(e==null?void 0:e.marker,"marker"),H(e==null?void 0:e.content,"content")}function so(e){H(e==null?void 0:e.path,"path"),H(e==null?void 0:e.heading,"heading"),H(e==null?void 0:e.content,"content")}var Tt=k(()=>{Kt()});function io(e){return{listEntityTypes:()=>ct(e.settings.entityTypes),describeEntityType:t=>ct(e.settings.entityTypes)[t]||null,createEntity:async t=>(oo(t),Qn(e,t))}}var ao=k(()=>{De();eo();Tt()});function fr(e,t,n,o,r){let s=hr(t),i=e.indexOf(s);if(i>=0){let a=e.indexOf(`
`,i),p=a>=0?a+1:e.length,l=yr(e,p),c=l>=0?l:e.length;return{updated:!0,text:[e.slice(0,p),Yt(n),e.slice(c)].join("")}}if(o==="strict")return{updated:!1,text:e};if(r){let a=co(e,r,n,o);if(a.updated)return a}return{updated:!0,text:uo(e,r||"AI Notes",n)}}function co(e,t,n,o){let r=mo(t),i=new RegExp(`^#{1,6}\\s+${jr(r)}\\s*$`,"m").exec(e);if(!i||i.index==null)return o==="strict"?{updated:!1,text:e}:{updated:!0,text:uo(e,r,n)};let a=i.index,p=e.indexOf(`
`,a),l=p>=0?p+1:e.length,c=Pr(e,l);return{updated:!0,text:[e.slice(0,l),Yt(n),e.slice(c)].join("")}}async function lo(e,t){var i;let n=e.vault.adapter,o=(i=t.patchMode)!=null?i:"lenient";if(!await n.exists(t.path))return{ok:!1,error:`File not found: ${t.path}`};let r=await n.read(t.path),s=fr(r,t.marker,t.content,o,t.fallbackHeading);return s.updated?(await n.write(t.path,s.text),{ok:!0}):{ok:!1,error:"Marker or heading not found in strict mode."}}async function po(e,t){var i;let n=e.vault.adapter,o=(i=t.patchMode)!=null?i:"lenient";if(!await n.exists(t.path))return{ok:!1,error:`File not found: ${t.path}`};let r=await n.read(t.path),s=co(r,t.heading,t.content,o);return s.updated?(await n.write(t.path,s.text),{ok:!0}):{ok:!1,error:"Heading not found in strict mode."}}function hr(e){let t=e.trim();return t.startsWith("<!--")&&t.endsWith("-->")?t:`<!-- ${t} -->`}function mo(e){return e.replace(/^#+\s*/,"").trim()}function yr(e,t){let n=/<!--\s*AI:[A-Z_]+\s*-->/g;n.lastIndex=t;let o=n.exec(e);return o&&o.index!=null?o.index:-1}function Pr(e,t){let n=/^#{1,6}\s+/gm;n.lastIndex=t;let o=n.exec(e);return o&&o.index!=null?o.index:e.length}function Yt(e){let t=e!=null?e:"";return t.endsWith(`
`)?t:`${t}
`}function uo(e,t,n){let o=mo(t);return`${e.endsWith(`
`)?e:`${e}
`}
## ${o}
${Yt(n)}`}function jr(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var go=k(()=>{});function fo(e){return{patchMarker:async t=>(ro(t),lo(e.app,t)),patchSection:async t=>(so(t),po(e.app,t))}}var ho=k(()=>{go();Tt()});function yo(e){return{resolveProject:t=>(wt(t),Je(e,t)),listProjects:()=>Ht(e),listProjectTypes:()=>Ee(e.settings.projectTypes),describeProjectType:t=>Ee(e.settings.projectTypes)[t]||null,createProject:async t=>(no(t),lt(e,t)),getChildren:(t,n)=>{wt(t);let o=n?vt(e,t):Je(e,t);if(!o)return[];let{graph:r}=ke(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return Ft(r,o.entry.fullName,Boolean(n))},getParents:(t,n)=>{let o=n?vt(e,t):Je(e,t);if(!o)return[];let{graph:r}=ke(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return Nt(r,o.entry.fullName,Boolean(n))},clearArchivedProjectGraph:async()=>{let{graph:t}=ke(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return e.settings.projectGraph=kt(t,e.settings.archivedRecords),await e.saveData(e.settings),{ok:!0}}}}var Po=k(()=>{De();$t();Wt();ve();Tt()});var jo={};V(jo,{createCoreApi:()=>vr});function vr(e){let t="1.0.0",n=yo(e),o=io(e),r=fo(e);return{version:t,capabilities:{resolveProject:!0,listProjects:!0,entityTypes:!0,projectTypes:!0,createProject:!0,createEntity:!0,patching:!0,projectGraph:!0,errorHandling:"throws"},compatibility:{settingsSchemaVersion:Le,projectIndexVersion:1,projectGraphVersion:1},...n,...o,...r,wrapError:s=>{let i=to(s);return{ok:!1,error:{code:i.code,message:i.message,details:i.details}}}}}var vo=k(()=>{ao();ho();Po();Kt();Vt();je();ve()});var Tr={};V(Tr,{default:()=>wr});module.exports=So(Tr);var wo=require("obsidian");var b=require("obsidian");Se();var fn=require("obsidian"),Ke=class extends fn.Modal{constructor(n,o){super(n);this.onResult=o}onOpen(){let{contentEl:n}=this;n.empty(),n.addClass("project-flow-settings"),n.createEl("p",{text:"Do you want skip settings to defaults? This will override all custom settings."});let o=n.createDiv({cls:"gc-row"});o.createDiv({cls:"gc-spacer"});let r=o.createEl("button",{text:"Yes, use defaults"}),s=o.createEl("button",{text:"Go back"});r.onclick=()=>{this.close(),this.onResult(!0)},s.onclick=()=>{this.close(),this.onResult(!1)}}onClose(){this.contentEl.empty()}};async function Qe(e,t,n,o){let r="",s=e.settings.projectRecords,i=s[t][n][o],{SafeFileManager:a}=await Promise.resolve().then(()=>(ye(),he)),p=new a(e.app),{sanitizePath:l}=await Promise.resolve().then(()=>(Pe(),Ie)),c=l(i.variables.PROJECT_PATH),u=l(`Templates/${i.info.name}_Templates`);try{await p.removeDir(c),await p.removeDir(u);try{s[t][n][o]&&(delete s[t][n][o],Object.keys(s[t][n]).length===0&&delete s[t][n],Object.keys(s[t]).length===0&&delete s[t]);try{let{ensureProjectIndex:g,removeFromProjectIndex:f,toIndexEntry:y}=await Promise.resolve().then(()=>(je(),Me)),{ensureProjectGraph:P,removeProjectFromGraph:w}=await Promise.resolve().then(()=>(ve(),Fe)),{index:d}=g(e.settings.projectIndex,s);e.settings.projectIndex=f(d,y(i,o,t,n));let{graph:m}=P(e.settings.projectGraph,s,e.settings.archivedRecords);e.settings.projectGraph=w(m,i.variables.PROJECT_FULL_NAME,!1)}catch(g){console.warn("Failed to update projectIndex after delete:",g)}await e.saveData(e.settings),r="Project deleted successfully."}catch(g){r="Failed to update projectRecords after delete",console.warn(r,g)}return[!0,r]}catch(g){r="Error removing project: "+g.message,console.error("Error removing project:",g)}return[!1,r]}async function et(e,t,n,o){var r,s,i,a,p;try{let l=e.settings.projectRecords,c=(s=(r=l==null?void 0:l[t])==null?void 0:r[n])==null?void 0:s[o];if(!c)return[!1,"Project not found."];let{sanitizePath:u}=await Promise.resolve().then(()=>(Pe(),Ie)),{SafeFileManager:g}=await Promise.resolve().then(()=>(ye(),he)),f=new g(e.app),y=e.app.vault.adapter,P=u(c.variables.PROJECT_PATH),w=u(`Templates/${c.info.name}_Templates`),d=e.settings.archiveRoot||"4. Archive",m=c.variables.YEAR,j=c.variables.DIMENSION||c.info.dimension,v=c.info.category,T=c.info.parent&&c.info.parent.trim().length>0?c.info.parent.trim():null,A=c.info.name,O=T?`${m}.${j}.${v}.${T}.${A}`:`${m}.${j}.${v}.${A}`,Y=u(`${d}/${O}`),z=x=>{let F=x.split("/").filter(Boolean);return F.pop(),F.join("/")};if(await f.ensureFolder(z(Y)),!await y.exists(P))return[!1,`Project directory not found: ${P}`];if(await y.exists(Y))return[!1,`Archive destination already exists: ${Y}`];await y.rename(P,Y);try{if(await y.exists(w)){let x=u(`${Y}/Templates`);await f.ensureFolder(x);let F=u(`${x}/${c.info.name}_Templates`);if(await y.exists(F)){let q=u(`${x}/${c.info.name}_Templates_archived`);await y.rename(w,q)}else await y.rename(w,F)}}catch(x){console.warn("Archiving templates failed:",x)}try{let x=e.settings.projectRecords;(!e.settings.archivedRecords||Array.isArray(e.settings.archivedRecords))&&(e.settings.archivedRecords=e.settings.archivedRecords&&Array.isArray(e.settings.archivedRecords)?{}:e.settings.archivedRecords||{});let F=e.settings.archivedRecords;F[t]=F[t]||{},F[t][n]=F[t][n]||{},F[t][n][o]=c,(a=(i=x==null?void 0:x[t])==null?void 0:i[n])!=null&&a[o]&&(delete x[t][n][o],Object.keys(x[t][n]).length===0&&delete x[t][n],Object.keys(x[t]||{}).length===0&&delete x[t]);try{let{ensureProjectIndex:q,removeFromProjectIndex:ue,toIndexEntry:we}=await Promise.resolve().then(()=>(je(),Me)),{ensureProjectGraph:ne,removeProjectFromGraph:Be,addProjectToGraph:Te}=await Promise.resolve().then(()=>(ve(),Fe)),{index:Rt}=q(e.settings.projectIndex,x);e.settings.projectIndex=ue(Rt,we(c,o,t,n));let{graph:Ue}=ne(e.settings.projectGraph,x,F);e.settings.projectGraph=Be(Ue,c.variables.PROJECT_FULL_NAME,!1),e.settings.projectGraph=Te(e.settings.projectGraph,c,!0)}catch(q){console.warn("Failed to update projectIndex after archive:",q)}await e.saveData(e.settings)}catch(x){console.warn("Failed to move project record to archive in settings:",x)}return[!0,"Project archived successfully."]}catch(l){return console.error("Archive failed:",l),[!1,(p=l==null?void 0:l.message)!=null?p:"Failed to archive project."]}}var Oo=[{name:"Business",order:1,categories:["R&D","Jobs","OpenSource","Education"]},{name:"Family",order:2,categories:["Vacations","Parenting","Common"]},{name:"Friends",order:3,categories:[]},{name:"Health",order:4,categories:["Clinics","Issues","R&D"]},{name:"Personal",order:5,categories:["R&D","Languages","SelfManagement","Writing","Reading","Music","Sports"]},{name:"Residence",order:6,categories:[]}],nt={dimensions:JSON.parse(JSON.stringify(Oo)),projectsRoot:"1. Projects",archiveRoot:"4. Archive",templatesRoot:"Templates/ProjectFlow",ai:{enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",strictExecution:!1,memoryLimit:10,mcpServers:[],toolLog:[],conversation:[],pendingPlan:null},projectRecords:{},archivedRecords:{},projectGraph:{version:1,byFullName:{},archivedByFullName:{}},entityTypes:pe,projectTypes:fe};function jn(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}var tt=class extends b.PluginSettingTab{constructor(n,o){super(n,o);this.plugin=o}display(){var Zt,Qt,en,tn,nn,on,rn,sn,an,cn,ln,pn,dn,mn,un;let{containerEl:n}=this;n.empty(),n.addClass("project-flow-settings");let o=n.createDiv({cls:"gc-row"});o.createDiv({cls:"gc-spacer"});let r=o.createEl("button",{cls:["gc-icon-button","clickable-icon"],attr:{"aria-label":"Reset to defaults",title:"Reset to defaults"}});try{(0,b.setIcon)(r,"rotate-ccw")}catch(h){r.setText("Reset to defaults")}r.onclick=()=>{new Ke(this.app,async C=>{C&&(this.plugin.settings=JSON.parse(JSON.stringify(nt)),await this.plugin.saveSettings(),new b.Notice("Settings were reset to defaults."),this.display())}).open()},n.createEl("h2",{text:"Folders"});let s=n.createDiv({cls:"gc-column"}),i=s.createDiv({cls:"setting-item"});i.createEl("label",{text:"Projects root"});let a=i.createEl("input",{type:"text"});a.value=this.plugin.settings.projectsRoot||"1. Projects",a.placeholder="e.g. 1. Projects",a.onchange=async()=>{this.plugin.settings.projectsRoot=a.value.trim()||"1. Projects",await this.plugin.saveSettings()};let p=s.createDiv({cls:"setting-item"});p.createEl("label",{text:"Archive root"});let l=p.createEl("input",{type:"text"});l.value=this.plugin.settings.archiveRoot||"4. Archive",l.placeholder="e.g. 4. Archive",l.onchange=async()=>{this.plugin.settings.archiveRoot=l.value.trim()||"4. Archive",await this.plugin.saveSettings()};let c=s.createDiv({cls:"setting-item"});c.createEl("label",{text:"Templates root"});let u=c.createEl("input",{type:"text"});u.value=this.plugin.settings.templatesRoot||"Templates/ProjectFlow",u.placeholder="e.g. Templates/ProjectFlow",u.onchange=async()=>{this.plugin.settings.templatesRoot=u.value.trim()||"Templates/ProjectFlow",await this.plugin.saveSettings()},n.createEl("h2",{text:"Dimensions"}),[...this.plugin.settings.dimensions].sort((h,C)=>{var _,D;return((_=h.order)!=null?_:0)-((D=C.order)!=null?D:0)}).forEach((h,C)=>{let _=n.createDiv({cls:"dimension-setting"}),D=_.createDiv({cls:"dimension-header"});D.addClass("gc-row"),D.createSpan({text:`${h.order}. `});let W=D.createEl("b",{text:h.name});D.createDiv({cls:"gc-spacer"});let J=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});J.setAttr("aria-label","Move up"),J.setAttr("title","Move up");try{(0,b.setIcon)(J,"arrow-up")}catch(S){J.setText("Up")}J.onclick=async()=>{let I=[...this.plugin.settings.dimensions].filter(N=>{var M,E;return((M=N.order)!=null?M:0)<((E=h.order)!=null?E:0)}).sort((N,M)=>{var E,$;return((E=M.order)!=null?E:0)-(($=N.order)!=null?$:0)})[0];if(!I)return;let R=I.order;I.order=h.order,h.order=R,await this.plugin.saveSettings(),this.display()};let se=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});se.setAttr("aria-label","Move down"),se.setAttr("title","Move down");try{(0,b.setIcon)(se,"arrow-down")}catch(S){se.setText("Down")}se.onclick=async()=>{let I=[...this.plugin.settings.dimensions].filter(N=>{var M,E;return((M=N.order)!=null?M:0)>((E=h.order)!=null?E:0)}).sort((N,M)=>{var E,$;return((E=N.order)!=null?E:0)-(($=M.order)!=null?$:0)})[0];if(!I)return;let R=I.order;I.order=h.order,h.order=R,await this.plugin.saveSettings(),this.display()};let ie=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ie.setAttr("aria-label",`Delete ${h.name}`),ie.setAttr("title",`Delete ${h.name}`);try{(0,b.setIcon)(ie,"trash")}catch(S){ie.setText("Remove")}ie.onclick=async()=>{let S=this.plugin.settings.dimensions.findIndex(I=>I===h);S>=0&&this.plugin.settings.dimensions.splice(S,1),await this.plugin.saveSettings(),this.display()};let G=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});G.setAttr("aria-label",`Rename ${h.name}`),G.setAttr("title",`Rename ${h.name}`);try{(0,b.setIcon)(G,"pencil")}catch(S){G.setText("Edit")}if(G.onclick=async()=>{var ae;let S=h.name,I=W.parentElement;(ae=W.detach)==null||ae.call(W),G.style.display="none",ie.style.display="none";let R=I.createEl("input",{type:"text"});R.value=S,R.addClass("gc-rename");let N=I.createDiv({cls:"gc-row"});N.createDiv({cls:"gc-spacer"});let M=N.createEl("button",{cls:["gc-icon-button","clickable-icon"]});M.setAttr("aria-label","Apply"),M.setAttr("title","Apply");try{(0,b.setIcon)(M,"check")}catch(B){M.setText("Apply")}let E=N.createEl("button",{cls:["gc-icon-button","clickable-icon"]});E.setAttr("aria-label","Discard"),E.setAttr("title","Discard");try{(0,b.setIcon)(E,"x")}catch(B){E.setText("Discard")}let $=()=>{this.display()},X=async B=>{let Z=B.trim();if(!Z||Z===S){$();return}if(this.plugin.settings.dimensions.some(Ce=>Ce!==h&&Ce.name===Z)){new b.Notice("A dimension with this name already exists.");return}h.name=Z,await this.plugin.saveSettings(),$()};M.onclick=async()=>{await X(R.value)},E.onclick=()=>$(),R.focus(),R.select(),R.onkeydown=async B=>{B.key==="Enter"&&await X(R.value),B.key==="Escape"&&$()},R.onblur=async()=>{await X(R.value)}},h.categories.length>0){let S=_.createDiv({cls:"categories-list gc-list"});h.categories.forEach((I,R)=>{var Ce;let N=S.createDiv({cls:"gc-list-item gc-row"}),M=this.plugin.settings.projectRecords||{},E=h.name,$=Object.keys(((Ce=M==null?void 0:M[E])==null?void 0:Ce[I])||{}),X=N.createEl("b",{text:I}),ae=N.createDiv({cls:"gc-id-wrap"});$.length>0&&(ae.createSpan({text:" "}),$.forEach((U,He)=>{let L=ae.createSpan({cls:"gc-id-chip"});L.style.display="inline-flex",L.style.alignItems="center",L.style.gap="4px";let xe=L.createSpan({cls:"gc-id-tag",text:U}),ce=Math.abs(jn(U))%360;xe.style.backgroundColor=`hsl(${ce}, 70%, 90%)`,xe.style.color=`hsl(${ce}, 70%, 25%)`;let Q=L.createSpan({cls:"gc-id-actions"});Q.style.display="none";let ee=Q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ee.setAttr("aria-label",`Delete ${U}`),ee.setAttr("title",`Delete ${U}`);try{(0,b.setIcon)(ee,"trash")}catch(le){ee.setText("Del")}ee.onclick=async le=>{le.stopPropagation();let[,te]=await Qe(this.plugin,E,I,U);new b.Notice(te),this.display()};let oe=Q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});oe.setAttr("aria-label",`Archive ${U}`),oe.setAttr("title",`Archive ${U}`);try{(0,b.setIcon)(oe,"archive")}catch(le){oe.setText("Arc")}oe.onclick=async le=>{le.stopPropagation();let[,te]=await et(this.plugin,E,I,U);new b.Notice(te),this.display()},L.onmouseenter=()=>{Q.style.display="inline-flex"},L.onmouseleave=()=>{Q.style.display="none"},He<$.length-1&&ae.createSpan({text:" "})})),N.createDiv({cls:"gc-spacer"});let B=N.createEl("button",{cls:["remove-category","gc-icon-button","clickable-icon"]});B.setAttr("aria-label",`Delete ${I}`),B.setAttr("title",`Delete ${I}`);try{(0,b.setIcon)(B,"trash")}catch(U){B.setText("Remove")}B.onclick=async()=>{h.categories.splice(R,1),await this.plugin.saveSettings(),this.display()};let Z=N.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Z.setAttr("aria-label",`Rename ${I}`),Z.setAttr("title",`Rename ${I}`);try{(0,b.setIcon)(Z,"pencil")}catch(U){Z.setText("Edit")}Z.onclick=async()=>{var le;let U=h.categories[R],He=X.parentElement;(le=X.detach)==null||le.call(X),Z.style.display="none",B.style.display="none";let L=He.createEl("input",{type:"text"});L.value=U,L.addClass("gc-rename");let xe=He.createDiv({cls:"gc-row"});xe.createDiv({cls:"gc-spacer"});let ce=xe.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ce.setAttr("aria-label","Apply"),ce.setAttr("title","Apply");try{(0,b.setIcon)(ce,"check")}catch(te){ce.setText("Apply")}let Q=xe.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Q.setAttr("aria-label","Discard"),Q.setAttr("title","Discard");try{(0,b.setIcon)(Q,"x")}catch(te){Q.setText("Discard")}let ee=()=>{this.display()},oe=async te=>{let We=te.trim();if(!We||We===U){ee();return}if(h.categories.some((xo,Ro)=>Ro!==R&&xo===We)){new b.Notice("This category already exists in the dimension.");return}h.categories[R]=We,await this.plugin.saveSettings(),ee()};ce.onclick=async()=>{await oe(L.value)},Q.onclick=()=>ee(),L.focus(),L.select(),L.onkeydown=async te=>{te.key==="Enter"&&await oe(L.value),te.key==="Escape"&&ee()},L.onblur=async()=>{await oe(L.value)}}})}let ge=_.createDiv({cls:"add-category gc-row"}),be=ge.createEl("input",{type:"text",placeholder:"New category"});ge.createDiv({cls:"gc-spacer"});let Ae=ge.createEl("button",{text:"Add Category"});Ae.onclick=async()=>{let S=be.value.trim();S&&!h.categories.includes(S)&&(h.categories.push(S),await this.plugin.saveSettings(),this.display())}});let f=n.createDiv({cls:"add-dimension"});f.createEl("h3",{text:"Add new dimension"});let y=f.createDiv({cls:"gc-row"}),P=y.createEl("input",{type:"text",placeholder:"Dimension name"});y.createDiv({cls:"gc-spacer"});let w=y.createEl("button",{text:"Add Dimension"});w.onclick=async()=>{let h=P.value.trim();if(h&&!this.plugin.settings.dimensions.some(C=>C.name===h)){{let C=this.plugin.settings.dimensions.reduce((_,D)=>{var W;return Math.max(_,(W=D.order)!=null?W:0)},0);this.plugin.settings.dimensions.push({name:h,order:C+1,categories:[]})}await this.plugin.saveSettings(),this.display()}},n.createEl("h2",{text:"AI Module"});let d=n.createDiv({cls:"gc-column"}),m=d.createDiv({cls:"setting-item"});m.createEl("label",{text:"Enable AI module"});let j=m.createEl("input",{type:"checkbox"});j.checked=Boolean((Zt=this.plugin.settings.ai)==null?void 0:Zt.enabled),j.onchange=async()=>{var h,C;this.plugin.settings.ai||(this.plugin.settings.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",mixedOfferText:"I can also set this up for you. Shall I proceed?"}),this.plugin.settings.ai.enabled=j.checked,await this.plugin.saveSettings(),await((C=(h=this.plugin).toggleAiView)==null?void 0:C.call(h,j.checked))};let v=d.createDiv({cls:"setting-item"});v.createEl("label",{text:"Provider"});let T=v.createEl("select");["openai","anthropic","ollama"].forEach(h=>{let C=T.createEl("option",{text:h});C.value=h}),T.value=((Qt=this.plugin.settings.ai)==null?void 0:Qt.provider)||"openai",T.onchange=async()=>{if(!this.plugin.settings.ai)return;let h={openai:{baseUrl:"https://api.openai.com",model:"gpt-4o-mini"},anthropic:{baseUrl:"https://api.anthropic.com",model:"claude-3-5-sonnet-latest"},ollama:{baseUrl:"http://localhost:11434",model:"llama3.1"}};this.plugin.settings.ai.provider=T.value;let C=this.plugin.settings.ai.baseUrl||"",_=this.plugin.settings.ai.model||"",D=Object.values(h).map(J=>J.baseUrl),W=Object.values(h).map(J=>J.model);(!C||D.includes(C))&&(this.plugin.settings.ai.baseUrl=h[T.value].baseUrl),(!_||W.includes(_))&&(this.plugin.settings.ai.model=h[T.value].model),await this.plugin.saveSettings(),this.display()};let A=d.createDiv({cls:"setting-item"});A.createEl("label",{text:"API key (not required for local providers)"});let O=A.createEl("input",{type:"password"});O.placeholder="sk-...",O.value=((en=this.plugin.settings.ai)==null?void 0:en.apiKey)||"",O.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.apiKey=O.value.trim(),await this.plugin.saveSettings())};let Y=d.createDiv({cls:"setting-item"});Y.createEl("label",{text:"Model"});let z=Y.createEl("input",{type:"text"});z.placeholder=((tn=this.plugin.settings.ai)==null?void 0:tn.provider)==="anthropic"?"claude-3-5-sonnet-latest":((nn=this.plugin.settings.ai)==null?void 0:nn.provider)==="ollama"?"llama3.1":"gpt-4o-mini",z.value=((on=this.plugin.settings.ai)==null?void 0:on.model)||z.placeholder,z.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.model=z.value.trim()||"gpt-4o-mini",await this.plugin.saveSettings())};let x=d.createDiv({cls:"setting-item"});x.createEl("label",{text:"Base URL"});let F=x.createEl("input",{type:"text"});F.placeholder=((rn=this.plugin.settings.ai)==null?void 0:rn.provider)==="anthropic"?"https://api.anthropic.com":((sn=this.plugin.settings.ai)==null?void 0:sn.provider)==="ollama"?"http://localhost:11434":"https://api.openai.com",F.value=((an=this.plugin.settings.ai)==null?void 0:an.baseUrl)||F.placeholder,F.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.baseUrl=F.value.trim()||"https://api.openai.com",await this.plugin.saveSettings())};let q=d.createDiv({cls:"setting-item"});q.createEl("label",{text:"Strict execution mode"});let ue=q.createEl("input",{type:"checkbox"});ue.checked=Boolean((cn=this.plugin.settings.ai)==null?void 0:cn.strictExecution),ue.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.strictExecution=ue.checked,await this.plugin.saveSettings())};let we=d.createDiv({cls:"setting-item"});we.createEl("label",{text:"Conversation memory (messages)"});let ne=we.createEl("input",{type:"number"});ne.min="0",ne.max="50",ne.value=String((pn=(ln=this.plugin.settings.ai)==null?void 0:ln.memoryLimit)!=null?pn:10),ne.onchange=async()=>{if(!this.plugin.settings.ai)return;let h=Number(ne.value);this.plugin.settings.ai.memoryLimit=Number.isFinite(h)?Math.max(0,Math.min(50,h)):10,await this.plugin.saveSettings()};let Be=d.createDiv({cls:"setting-item"});Be.createEl("label",{text:"Mixed intent offer text"});let Te=Be.createEl("textarea"),Rt="I can also set this up for you. Shall I proceed?";Te.placeholder=Rt,Te.value=((dn=this.plugin.settings.ai)==null?void 0:dn.mixedOfferText)||"",Te.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.mixedOfferText=Te.value.trim(),await this.plugin.saveSettings())};let Ue=d.createDiv({cls:"setting-item"});Ue.createEl("label",{text:"MCP servers (JSON array)"});let Ve=Ue.createEl("textarea");Ve.placeholder='[{"name":"calendar","url":"http://localhost:3000","apiKey":""}]',Ve.value=JSON.stringify(((mn=this.plugin.settings.ai)==null?void 0:mn.mcpServers)||[]),Ve.onchange=async()=>{if(this.plugin.settings.ai)try{let h=JSON.parse(Ve.value||"[]");this.plugin.settings.ai.mcpServers=Array.isArray(h)?h:[],await this.plugin.saveSettings()}catch(h){new b.Notice("Invalid MCP servers JSON")}},n.createEl("h2",{text:"Archive"});let Et=this.plugin.settings.archivedRecords||{},zt=Et&&!Array.isArray(Et)?Et:{},qt={};for(let h of this.plugin.settings.dimensions)qt[h.name]=(un=h.order)!=null?un:Number.MAX_SAFE_INTEGER;let To=Object.keys(zt).map(h=>{var C;return{name:h,order:(C=qt[h])!=null?C:Number.MAX_SAFE_INTEGER}}).sort((h,C)=>h.order-C.order||h.name.localeCompare(C.name)),Xt=!1;To.forEach(({name:h,order:C})=>{let _=zt[h]||{},D=Object.keys(_).filter(G=>Object.keys(_[G]||{}).length>0).sort();if(D.length===0)return;Xt=!0;let W=n.createDiv({cls:"dimension-setting"}),J=W.createDiv({cls:"dimension-header gc-row"}),se=this.plugin.settings.dimensions.find(G=>G.name===h);se&&J.createSpan({text:`${se.order}. `}),J.createEl("b",{text:h}),J.createDiv({cls:"gc-spacer"});let ie=W.createDiv({cls:"categories-list gc-list"});D.forEach(G=>{let ge=ie.createDiv({cls:"gc-list-item gc-row"}),be=Object.keys((_==null?void 0:_[G])||{}).sort();ge.createEl("b",{text:G});let Ae=ge.createDiv({cls:"gc-id-wrap"});be.length>0&&(Ae.createSpan({text:" "}),be.forEach((S,I)=>{let R=Ae.createSpan({cls:"gc-id-chip"});R.style.display="inline-flex",R.style.alignItems="center",R.style.gap="4px";let N=R.createSpan({cls:"gc-id-tag",text:S}),M=Math.abs(jn(S))%360;N.style.backgroundColor=`hsl(${M}, 70%, 90%)`,N.style.color=`hsl(${M}, 70%, 25%)`;let E=R.createSpan({cls:"gc-id-actions"});E.style.display="none";let $=E.createEl("button",{cls:["gc-icon-button","clickable-icon"]});$.setAttr("aria-label",`Delete ${S}`),$.setAttr("title",`Delete ${S}`);try{(0,b.setIcon)($,"trash")}catch(X){$.setText("Del")}$.onclick=async X=>{X.stopPropagation();let[,ae]=await this.plugin.deleteArchivedProject(h,G,S);new b.Notice(ae),this.display()},R.onmouseenter=()=>{E.style.display="inline-flex"},R.onmouseleave=()=>{E.style.display="none"},I<be.length-1&&Ae.createSpan({text:" "})})),ge.createDiv({cls:"gc-spacer"})})}),Xt||n.createDiv({cls:"setting-item"}).createSpan({text:"No archived projects yet."})}};var Dt=require("obsidian");var vn=require("obsidian"),ot=class extends vn.Modal{constructor(n,o,r){super(n);this.prompt=o,this.callback=r}onOpen(){let{contentEl:n}=this;n.createEl("h2",{text:this.prompt});let o=n.createEl("input",{type:"text"});o.focus();let r=n.createEl("button",{text:"Submit"});r.onclick=()=>{let s=o.value.trim();this.close(),this.callback(s||null)}}onClose(){let{contentEl:n}=this;n.empty()}};var wn=require("obsidian"),Ne=class extends wn.Modal{constructor(n,o,r,s){super(n);this.prompt=o,this.choices=r,this.callback=s}onOpen(){let{contentEl:n}=this;n.createEl("h2",{text:this.prompt}),this.choices.forEach(o=>{let r=n.createEl("button",{text:o});r.onclick=()=>{this.close(),this.callback(o)}})}onClose(){let{contentEl:n}=this;n.empty()}};async function $e(e,t){return new Promise(n=>{new ot(e,t,n).open()})}async function Re(e,t,n){return new Promise(o=>{new Ne(e,t,n,o).open()})}async function Rn(e,t){var f,y;let n=await $e(e,"Enter project name:");if(!n)return[null,"Project creation cancelled. No project name provided."];let o=await $e(e,"Enter project tag:");if(!o)return[null,"Project creation cancelled. No project tag provided."];let r=await $e(e,"Enter Project ID (used for task prefixes):");if(!r)return[null,"Project creation cancelled. No Project ID provided."];let s=await $e(e,"Enter parent name (optional):"),i=s&&s.trim().length>0?s.trim():null,a=[...t.dimensions].sort((P,w)=>{var d,m;return((d=P.order)!=null?d:0)-((m=w.order)!=null?m:0)}).map(P=>P.name),p=await Re(e,"Select dimension:",a);if(!p)return[null,"Project creation cancelled. No dimension selected."];let l=t.dimensions.find(P=>P.name===p);if(!l||l.categories.length===0)return[null,"Selected dimension has no categories. Please add categories in settings first."];let c=l.categories,u=await Re(e,"Select category:",c);if(!u)return[null,"Project creation cancelled. No category selected."];let g={name:n,tag:o,id:r,parent:i,dimension:p,category:u};try{let P=t.projectRecords;if(P&&!Array.isArray(P)&&((y=(f=P[p])==null?void 0:f[u])==null?void 0:y[r]))return[null,`Project with ID "${r}" already exists in ${p}:${u}. Choose a different ID.`]}catch(P){}try{let{validateProjectName:P,validateTag:w,ensureValidOrThrow:d}=await Promise.resolve().then(()=>(xn(),Tn));d(()=>P(g.name),"Invalid project name"),d(()=>w(g.tag),"Invalid tag"),d(()=>w(g.id),"Invalid Project ID")}catch(P){let w=P.message||"Invalid input";return console.error("Validation error:",P),[null,w]}return[g,"Project details collected."]}async function rt(e,t){var c;if(!t.projectRecords)return[null,"You don't have any projects yet."];let n=t.projectRecords,o=[...t.dimensions].sort((u,g)=>{var f,y;return((f=u.order)!=null?f:0)-((y=g.order)!=null?y:0)}).map(u=>u.name),r=await Re(e,"Select dimension of your project:",o);if(!r)return[null,"Project action cancelled. No dimension selected."];let s=t.dimensions.find(u=>u.name===r);if(!s||s.categories.length===0)return[null,"Selected dimension has no categories. No project found."];let i=s.categories,a=await Re(e,"Select category:",i);if(!a)return[null,"Project action cancelled. No category selected."];let p=(c=n[r])==null?void 0:c[a];if(!p||Object.keys(p).length===0)return[null,"No projects found in this category."];let l=await Re(e,"Select Project:",Object.keys(p));return l?[{dimension:r,category:a,projectId:l},"Project details collected."]:[null,"Project action cancelled. No project selected."]}$t();async function Mn(e){let[t,n]=await Rn(e.app,e.settings);if(t===null){new Dt.Notice(n);return}let[,o]=await lt(e,t);new Dt.Notice(o),console.log(o)}var Ot=require("obsidian");async function kn(e){let[t,n]=await rt(e.app,e.settings);if(t===null){new Ot.Notice(n);return}let{dimension:o,category:r,projectId:s}=t,[,i]=await Qe(e,o,r,s);new Ot.Notice(i),console.log(i)}var _t=require("obsidian");async function Fn(e){let[t,n]=await rt(e.app,e.settings);if(t===null){new _t.Notice(n);return}let{dimension:o,category:r,projectId:s}=t,[,i]=await et(e,o,r,s);new _t.Notice(i),console.log(i)}var jt=require("obsidian");async function Nn(e){let t=[];for(let n of e)try{let o=`${n.url.replace(/\/$/,"")}/tools`,r=await fetch(o,{method:"GET",headers:n.apiKey?{"x-api-key":n.apiKey}:void 0});if(!r.ok)continue;let s=await r.json(),i=Array.isArray(s==null?void 0:s.tools)?s.tools:[];t.push({server:n,tools:i})}catch(o){}return t}function $n(e,t){return t.map(n=>({name:`${e.name}:${n.name}`,description:n.description||"MCP tool",schema:n.inputSchema||{type:"object",properties:{},additionalProperties:!0},handler:async o=>Yo(e,n.name,o)}))}async function Yo(e,t,n){let o=`${e.url.replace(/\/$/,"")}/call`,r=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",...e.apiKey?{"x-api-key":e.apiKey}:{}},body:JSON.stringify({name:t,args:n})});if(!r.ok){let s=await r.text().catch(()=>"");throw new Error(`MCP call failed: ${r.status} ${s||r.statusText}`)}return await r.json().catch(()=>({}))}var pt={type:"object",description:"Reference to a project by tag, id, or full name.",properties:{tag:{type:"string"},id:{type:"string"},fullName:{type:"string"}},additionalProperties:!1},zo={type:"object",description:"Fields to set on the entity (camelCase, e.g. title, description).",properties:{title:{type:"string"},description:{type:"string"}},additionalProperties:!0};function dt(e){let t=e.getApi();return t?[{name:"resolveProject",description:"Resolve a project by tag, id, or full name.",schema:{type:"object",properties:{projectRef:pt},required:["projectRef"],additionalProperties:!1},handler:async n=>t.resolveProject(n.projectRef)},{name:"listEntityTypes",description:"List available entity types.",schema:{type:"object",properties:{},additionalProperties:!1},handler:async()=>t.listEntityTypes()},{name:"createProject",description:"Create a project with the required metadata.",schema:{type:"object",properties:{name:{type:"string"},tag:{type:"string"},id:{type:"string"},dimension:{type:"string"},category:{type:"string"},parent:{type:"string"},projectTypeId:{type:"string"}},required:["name","tag","id","dimension","category"],additionalProperties:!1},handler:async n=>t.createProject(n)},{name:"createEntity",description:"Create an entity inside a project using a template.",schema:{type:"object",properties:{projectRef:pt,entityTypeId:{type:"string"},fields:zo},required:["projectRef","entityTypeId"],additionalProperties:!1},handler:async n=>t.createEntity(n)},{name:"patchMarker",description:"Patch content into a file at an AI marker.",schema:{type:"object",properties:{path:{type:"string"},marker:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","marker","content"],additionalProperties:!1},handler:async n=>t.patchMarker(n)},{name:"patchSection",description:"Patch content into a file by heading.",schema:{type:"object",properties:{path:{type:"string"},heading:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","heading","content"],additionalProperties:!1},handler:async n=>t.patchSection(n)},{name:"getChildren",description:"Get child projects for a given project.",schema:{type:"object",properties:{projectRef:pt,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async n=>t.getChildren(n.projectRef,n.archived)},{name:"getParents",description:"Get parent projects for a given project.",schema:{type:"object",properties:{projectRef:pt,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async n=>t.getParents(n.projectRef,n.archived)}]:[]}async function mt(e){var r;let t=((r=e.settings.ai)==null?void 0:r.mcpServers)||[];if(t.length===0)return[];let n=await Nn(t),o=[];for(let s of n)o.push(...$n(s.server,s.tools));return o}async function*Dn(e,t,n){var c,u;let o=`${e.baseUrl.replace(/\/$/,"")}/v1/chat/completions`,r={model:e.model,messages:t.map(g=>{let f={role:g.role,content:g.content};return g.role==="tool"&&g.toolCallId&&(f.tool_call_id=g.toolCallId),g.role==="assistant"&&g.toolCalls&&g.toolCalls.length>0&&(f.tool_calls=g.toolCalls.map(y=>{var P;return{id:y.id,type:"function",function:{name:y.name,arguments:JSON.stringify((P=y.arguments)!=null?P:{})}}})),f}),tools:n.map(g=>({type:"function",function:{name:g.name,description:g.description,parameters:g.schema}})),tool_choice:"auto",stream:!0},s={"Content-Type":"application/json"};e.apiKey&&(s.Authorization=`Bearer ${e.apiKey}`);let i=await fetch(o,{method:"POST",headers:s,body:JSON.stringify(r)});if(!i.ok||!i.body){let g=await qo(i);throw new Error(`OpenAI request failed: ${i.status} ${g||i.statusText}`)}let a=i.body.getReader(),p=new TextDecoder,l="";for(;;){let{value:g,done:f}=await a.read();if(f)break;l+=p.decode(g,{stream:!0});let y=l.split(`
`);l=y.pop()||"";for(let P of y){let w=P.trim();if(!w.startsWith("data:"))continue;let d=w.replace(/^data:\s*/,"");if(d==="[DONE]"){yield{type:"done"};return}let m;try{m=JSON.parse(d)}catch(v){continue}let j=(u=(c=m==null?void 0:m.choices)==null?void 0:c[0])==null?void 0:u.delta;j&&(j.content&&(yield{type:"content",delta:j.content}),j.tool_calls&&(yield{type:"tool_call_delta",toolCalls:j.tool_calls.map(T=>{var A,O;return{index:T.index,id:T.id,name:(A=T.function)==null?void 0:A.name,arguments:(O=T.function)==null?void 0:O.arguments}})}))}}yield{type:"done"}}async function qo(e){try{return await e.text()}catch(t){return""}}async function*On(e,t,n){let o=`${e.baseUrl.replace(/\/$/,"")}/v1/messages`,{system:r,anthropicMessages:s}=Xo(t),i={model:e.model,max_tokens:1024,system:r,messages:s,tools:n.map(g=>({name:g.name,description:g.description,input_schema:g.schema})),stream:!0},a=await fetch(o,{method:"POST",headers:{"x-api-key":e.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify(i)});if(!a.ok||!a.body){let g=await Zo(a);throw new Error(`Anthropic request failed: ${a.status} ${g||a.statusText}`)}let p=a.body.getReader(),l=new TextDecoder,c="",u=new Set;for(;;){let{value:g,done:f}=await p.read();if(f)break;c+=l.decode(g,{stream:!0});let y=c.split(`
`);c=y.pop()||"";for(let P of y){let w=P.trim();if(!w.startsWith("data:"))continue;let d=w.replace(/^data:\s*/,"");if(!d||d==="[DONE]"){yield{type:"done"};return}let m;try{m=JSON.parse(d)}catch(v){continue}let j=m==null?void 0:m.type;if(j==="content_block_delta"){let v=m.delta;if((v==null?void 0:v.type)==="text_delta"&&(yield{type:"content",delta:v.text}),(v==null?void 0:v.type)==="input_json_delta"){if(u.has(m.index))continue;yield{type:"tool_call_delta",toolCalls:[{index:m.index,arguments:v.partial_json}]}}}if(j==="content_block_start"){let v=m.content_block;if((v==null?void 0:v.type)==="tool_use"){let T=v.input&&Object.keys(v.input).length>0;T&&u.add(m.index),yield{type:"tool_call_delta",toolCalls:[{index:m.index,id:v.id,name:v.name,arguments:T?JSON.stringify(v.input):""}]}}}if(j==="message_stop"){yield{type:"done"};return}}}yield{type:"done"}}function Xo(e){let t="",n=[];for(let o of e){if(o.role==="system"){t=[t,o.content].filter(Boolean).join(`
`);continue}if(o.role==="user"){n.push({role:"user",content:[{type:"text",text:o.content}]});continue}if(o.role==="assistant"){let r=[];if(o.content&&r.push({type:"text",text:o.content}),o.toolCalls&&o.toolCalls.length>0)for(let s of o.toolCalls)r.push({type:"tool_use",id:s.id||`tool-${s.name}`,name:s.name,input:s.arguments||{}});r.length>0&&n.push({role:"assistant",content:r});continue}o.role==="tool"&&n.push({role:"user",content:[{type:"tool_result",tool_use_id:o.toolCallId||o.name||"tool",content:o.content}]})}return{system:t,anthropicMessages:n}}async function Zo(e){try{return await e.text()}catch(t){return""}}async function*de(e,t,n){if(e.provider==="anthropic"){if(!e.apiKey)throw new Error("Anthropic API key is missing");yield*On({apiKey:e.apiKey,model:e.model||"claude-3-5-sonnet-latest",baseUrl:e.baseUrl||"https://api.anthropic.com"},t,n);return}let o=e.provider==="ollama"?e.baseUrl||"http://localhost:11434":e.baseUrl||"https://api.openai.com";if(!e.apiKey&&e.provider!=="ollama")throw new Error("OpenAI API key is missing");yield*Dn({apiKey:e.apiKey||"",model:e.model||(e.provider==="ollama"?"llama3.1":"gpt-4o-mini"),baseUrl:o},t,n)}function ut(e,t){for(let n of e){let o=t.get(n.index)||{name:"",arguments:{}};if(n.id&&(o.id=n.id),n.name&&(o.name=n.name),typeof n.arguments=="string"){let r=o._rawArgs||"";o._rawArgs=r+n.arguments}t.set(n.index,o)}}function gt(e){let t=[];for(let[,n]of e){let o=n._rawArgs;if(o)try{n.arguments=JSON.parse(o)}catch(r){n.arguments={}}delete n._rawArgs,t.push(n)}return t}function Lt(e){let t=new Set(["resolveProject","listProjects","listEntityTypes","describeEntityType","listProjectTypes","describeProjectType","getChildren","getParents"]);return e.filter(n=>t.has(n.name)||n.name.includes(":"))}function _n(e){var n;let t=[];for(let o of e)!o.ok&&((n=o.error)!=null&&n.startsWith("Missing required fields:"))&&o.error.split(":").slice(1).join(":").split(",").forEach(s=>{let i=s.trim();i&&t.push(i)});return t}function Gt(e){let t=e.trim().toLowerCase();return["yes","y","confirm","ok","okay","proceed"].includes(t)}function Jt(e){let t=e.trim().toLowerCase();return["no","n","cancel","stop"].includes(t)}function ft(e,t,n="$",o=[]){if(!e)return o;let r=e.type?Array.isArray(e.type)?e.type:[e.type]:[];if(r.length>0&&!r.some(i=>Qo(i,t)))return o.push({path:n,message:`Expected ${r.join("|")}`}),o;if(e.enum&&!e.enum.includes(t)&&o.push({path:n,message:"Value not in enum"}),e.type==="object"&&t&&typeof t=="object"&&!Array.isArray(t)){let s=t;if((e.required||[]).forEach(a=>{a in s||o.push({path:`${n}.${a}`,message:"Missing required field"})}),e.properties)for(let[a,p]of Object.entries(e.properties))a in s&&ft(p,s[a],`${n}.${a}`,o)}return e.type==="array"&&Array.isArray(t)&&e.items&&t.forEach((s,i)=>{ft(e.items,s,`${n}[${i}]`,o)}),o}function Qo(e,t){return e==="array"?Array.isArray(t):e==="integer"?Number.isInteger(t):e==="number"?typeof t=="number":e==="boolean"?typeof t=="boolean":e==="string"?typeof t=="string":e==="object"?t!=null&&typeof t=="object"&&!Array.isArray(t):!0}async function ht(e,t){let n=[],o=new Map(t.map(r=>[r.name,r]));for(let r of e){let s=o.get(r.name);if(!s){n.push({toolName:r.name,ok:!1,error:"Tool not found"});continue}let i=ft(s.schema,r.arguments);if(i.length>0){n.push({toolName:r.name,ok:!1,error:`Schema validation failed: ${i.map(a=>`${a.path}: ${a.message}`).join(", ")}`});continue}try{let a=await s.handler(r.arguments);n.push({toolName:r.name,ok:!0,result:a})}catch(a){n.push({toolName:r.name,ok:!1,error:(a==null?void 0:a.message)||"Tool execution failed"})}}return n}function Bt(e){if(e==null)return"(no result)";if(typeof e=="string")return e;try{return JSON.stringify(e)}catch(t){return String(e)}}function Ln(e){return new Promise(t=>setTimeout(t,e))}async function Gn(e){var n,o,r,s;let t=(n=e.maxSteps)!=null?n:6;for(let i=0;i<t;i+=1){let a=e.ui.appendMessage("assistant",""),p=new Map,l=new Map,c=Boolean((o=e.plugin.settings.ai)==null?void 0:o.strictExecution),u=2,g=0;for(;;)try{for await(let d of de(e.plugin.settings.ai,e.messages,e.tools)){if(d.type==="content"&&d.delta){let m=(a==null?void 0:a.textContent)||"";e.ui.updateMessage(a,m+d.delta)}if(d.type==="tool_call_delta"&&d.toolCalls){ut(d.toolCalls,l);for(let m of d.toolCalls)if(m.name&&!p.has(m.name)){let j=e.ui.appendMessage("tool",`Using tool: ${m.name}`);j&&p.set(m.name,j)}}}break}catch(d){if(g+=1,g>u)throw d;e.ui.appendMessage("tool",`Retrying LLM request (${g}/${u})...`),await Ln(300*g)}let f=gt(l),y=(a==null?void 0:a.textContent)||"";if(e.messages.push({role:"assistant",content:y,toolCalls:f}),e.state.appendMessage({role:"assistant",content:y}),f.length===0)return;for(let d of f)e.ui.appendMessage("tool",`Tool call: ${d.name} ${Bt(d.arguments)}`);let P=await ht(f,e.tools),w=_n(P);for(let d=0;d<P.length;d+=1){let m=P[d],j=m.ok?{ok:!0,result:m.result}:{ok:!1,error:m.error},v=m.ok?`Tool result (${m.toolName}): ${Bt(m.result)}`:`Tool error (${m.toolName}): ${m.error}`;e.ui.appendMessage("tool",v),e.state.appendMessage({role:"tool",name:m.toolName,toolCallId:(r=f[d])==null?void 0:r.id,content:JSON.stringify(j)}),e.state.recordToolLog(m.toolName,m.ok,m.error),e.messages.push({role:"tool",name:m.toolName,toolCallId:(s=f[d])==null?void 0:s.id,content:JSON.stringify(j)})}if(c&&P.some(d=>!d.ok)){e.ui.appendMessage("assistant","Strict mode: tool execution failed. Please adjust input and try again.");return}if(w.length>0){let d=Array.from(new Set(w));e.ui.appendMessage("assistant",`Missing required fields: ${d.join(", ")}. Please provide them and try again.`);return}}e.ui.appendMessage("assistant","Stopped after reaching max tool steps.")}var er=["You are a planner for ProjectFlow AI.","Return ONLY valid JSON with keys: needsFollowup (boolean), question (string), plan (string), context (string), fields (object).","fields must include required values for createEntity/createProject when applicable (e.g., TITLE, DESCRIPTION).","If you need more info, set needsFollowup=true and ask a concise question.","If you have enough info, set needsFollowup=false and provide a short plan, context summary, and fields.","Do NOT call tools in this stage."].join(`
`);async function Ut(e){var r;let t=[{role:"system",content:er},...e.messages.filter(s=>s.role!=="tool")],n=await tr({plugin:e.plugin,messages:t,tools:e.tools,allowToolCalls:(r=e.allowToolCalls)!=null?r:!1}),o=nr(n);return o||{needsFollowup:!1,plan:"",context:"",fields:{}}}async function tr(e){var r;let t="",o=e.allowToolCalls?e.tools:[];for(let s=0;s<6;s+=1){let i=new Map;t="";for await(let l of de(e.plugin.settings.ai,e.messages,o))l.type==="content"&&l.delta&&(t+=l.delta),l.type==="tool_call_delta"&&l.toolCalls&&ut(l.toolCalls,i);let a=gt(i);if(e.messages.push({role:"assistant",content:t,toolCalls:a}),a.length===0||!e.allowToolCalls)return t.trim();let p=await ht(a,e.tools);for(let l=0;l<p.length;l+=1){let c=p[l],u=c.ok?{ok:!0,result:c.result}:{ok:!1,error:c.error};e.messages.push({role:"tool",name:c.toolName,toolCallId:(r=a[l])==null?void 0:r.id,content:JSON.stringify(u)})}}return t.trim()}function nr(e){let t=e.indexOf("{"),n=e.lastIndexOf("}");if(t===-1||n===-1||n<=t)return null;let o=e.slice(t,n+1);try{let r=JSON.parse(o),s=r.fields&&typeof r.fields=="object"?r.fields:{};return{needsFollowup:Boolean(r.needsFollowup),question:typeof r.question=="string"?r.question:"",plan:typeof r.plan=="string"?r.plan:"",context:typeof r.context=="string"?r.context:"",fields:s}}catch(r){return null}}function Jn(e){let t=e.app.workspace.getActiveFile();if(!t)return null;let n=e.settings.projectIndex;if(!n)return null;let o=t.path,r=Object.values(n.byFullName||{}),s=null;for(let i of r)i.path&&o.startsWith(i.path)&&(!s||i.path.length>s.path.length)&&(s=i);return s}function Bn(e,t,n=5){let o=e.settings.projectIndex;if(!o)return[];let r=t.trim().toLowerCase();return r?Object.values(o.byFullName||{}).map(a=>{var u,g;let p=((u=a.projectTag)==null?void 0:u.toLowerCase())||"",l=((g=a.projectName)==null?void 0:g.toLowerCase())||"",c=0;return p===r&&(c+=100),l===r&&(c+=90),p.startsWith(r)&&(c+=60),l.startsWith(r)&&(c+=50),p.includes(r)&&(c+=30),l.includes(r)&&(c+=20),{entry:a,score:c}}).filter(a=>a.score>0).sort((a,p)=>p.score-a.score).slice(0,n).map(a=>a.entry):[]}async function yt(e){let t=or(e),n=e.app.workspace.getActiveFile(),o="";if(n)try{o=(await e.app.vault.cachedRead(n)).slice(0,1e3)}catch(a){o=""}let r=e.settings.projectIndex,s=Jn(e),i=rr(e);return["You are ProjectFlow AI. You must use tools to perform any actions.","Never edit markdown directly; use tools only.","Respond with tool calls when an action is required.","If required fields are missing, ask the user for them instead of calling tools.","Use camelCase fields in createEntity (e.g., fields.title, fields.description).",'Example tool call: createEntity { projectRef:{tag:"my-tag"}, entityTypeId:"task", fields:{ title:"...", description:"..." } }',"Context:",`Selected text: ${t||"(none)"}`,`Active file: ${(n==null?void 0:n.path)||"(none)"}`,`Active file content (truncated): ${o||"(none)"}`,`Active project: ${s?`${s.projectTag} (${s.fullName})`:"(none)"}`,`Entity required fields: ${i}`,`Project index snapshot: ${r?JSON.stringify(r):"(none)"}`].join(`
`)}function Un(e){return`I'm going to create a project with tag ${e}
${e}`}function or(e){var n;let t=(n=e.app.workspace.activeEditor)==null?void 0:n.editor;return t?t.getSelection():""}function rr(e){let t=e.settings.entityTypes||{},n={};for(let[o,r]of Object.entries(t))r!=null&&r.requiredFields&&r.requiredFields.length>0&&(n[o]=r.requiredFields);try{return JSON.stringify(n)}catch(o){return"(unavailable)"}}var sr=["You are an intent classifier for an Obsidian productivity assistant.","Classify the user input into exactly one of: chat, action, mixed, unclear.","Definitions:","chat: user is asking a question or discussing concepts. No execution requested.","action: user explicitly requests operations such as creating, updating, deleting projects, tasks, notes, or structures.","mixed: user asks a question AND requests an action in the same message.","unclear: not enough information to decide.","Respond ONLY with valid JSON:",'{"intent":"...","reason":"...","confidence":0.0}',"Do not include markdown."].join(`
`),Vn={intent:"chat",reason:"Invalid classifier output.",confidence:0};async function Hn(e,t){let n=[{role:"system",content:sr},{role:"user",content:e}],o="";try{for await(let s of de(t,n,[]))s.type==="content"&&s.delta&&(o+=s.delta);let r=ir(o);return r!=null?r:Vn}catch(r){return Vn}}function ir(e){let t=e.indexOf("{"),n=e.lastIndexOf("}");if(t===-1||n===-1||n<=t)return null;let o=e.slice(t,n+1);try{let r=JSON.parse(o),s=ar(r.intent);if(!s)return null;let i=typeof r.confidence=="number"&&r.confidence>=0&&r.confidence<=1?r.confidence:0;return{intent:s,reason:typeof r.reason=="string"?r.reason:"",confidence:i}}catch(r){return null}}function ar(e){if(typeof e!="string")return null;let t=e.trim().toLowerCase();return t==="chat"||t==="action"||t==="mixed"||t==="unclear"?t:null}var cr=["You are a helpful Obsidian assistant.","Answer conversationally.","Do not propose plans unless explicitly asked.","Do not call tools.","If the user implies possible actions, suggest them softly."].join(`
`),lr="I can also set this up for you. Shall I proceed?",Oe=class{constructor(t,n,o){this.plugin=t;this.ui=n;this.state=o;this.busy=!1;this.pendingPlan=null;this.pendingMixedInput=null;this.pendingPlan=this.state.getPendingPlan()}async handleSend(t){if(this.busy)return;let n=t.trim();if(!n)return;this.ui.appendMessage("user",n);let o=this.plugin.settings.ai;if(!(o!=null&&o.enabled)){this.ui.appendMessage("assistant","AI module is disabled in settings.");return}if(!o.apiKey&&o.provider!=="ollama"){await this.handleTagLookup(n);return}await this.handleLLM(n)}onClose(){this.state.flushConversation()}clearConversation(){this.pendingPlan=null,this.state.clearConversation(),this.state.setPendingPlan(null),this.ui.clearMessages(),this.ui.appendMessage("assistant","Conversation cleared.")}async handleFollowup(t){let n=this.pendingPlan;if(!n)return;let o=t.trim();if(!o)return;this.state.appendMessage({role:"user",content:o});let r=dt(this.plugin),s=await mt(this.plugin),i=[...r,...s];if(n.status==="awaiting_confirmation"){if(Gt(o)){let j=await yt(this.plugin),v=this.state.getConversationWindow().filter(O=>O.role!=="tool"),T=[`Original request: ${n.originalInput}`,n.plan?`Plan: ${n.plan}`:"",n.context?`Context: ${n.context}`:"",n.fields?`Fields: ${JSON.stringify(n.fields)}`:"",n.clarifications&&n.clarifications.length>0?`Clarifications: ${n.clarifications.join(" | ")}`:"","User confirmed to proceed."].filter(Boolean).join(`
`),A=[{role:"system",content:j},...v,{role:"user",content:T}];this.setPendingPlan(null),await Gn({plugin:this.plugin,ui:this.ui,state:this.state,messages:A,tools:i});return}if(Jt(o)){this.setPendingPlan(null),this.ui.appendMessage("assistant","Cancelled. Tell me if you want to try a different action."),this.state.appendMessage({role:"assistant",content:"Cancelled. Tell me if you want to try a different action."});return}this.ui.appendConfirmationActions(),this.ui.appendMessage("assistant","Please confirm to proceed with these actions."),this.state.appendMessage({role:"assistant",content:"Please confirm to proceed with these actions."});return}let a=Lt(i),p=await yt(this.plugin),l=this.state.getConversationWindow().filter(j=>j.role!=="tool"),c=n.clarifications||[];c.push(o),n.clarifications=c;let u=[`Original request: ${n.originalInput}`,n.plan?`Plan so far: ${n.plan}`:"",n.context?`Context so far: ${n.context}`:"",`User clarification: ${o}`].filter(Boolean).join(`
`),g=[{role:"system",content:p},...l,{role:"user",content:u}],f=await Ut({plugin:this.plugin,messages:g,tools:a,allowToolCalls:!1});if(f.needsFollowup&&f.question){n.plan=f.plan,n.context=f.context,n.question=f.question,n.fields=f.fields,n.status="clarifying",this.setPendingPlan(n),this.ui.appendMessage("assistant",f.question),this.state.appendMessage({role:"assistant",content:f.question});return}n.plan=f.plan,n.context=f.context,n.fields=f.fields,n.status="awaiting_confirmation",this.setPendingPlan(n);let y=f.plan?`Planned steps: ${f.plan}`:"",P=f.context?`Planner context: ${f.context}`:"",w=f.fields&&Object.keys(f.fields).length>0?`Fields: ${JSON.stringify(f.fields)}`:"",d=[y,P,w].filter(Boolean).join(`
`);d&&(this.ui.appendMessage("assistant",d),this.state.appendMessage({role:"assistant",content:d})),this.ui.appendConfirmationActions();let m="Please confirm to proceed with these actions.";this.ui.appendMessage("assistant",m),this.state.appendMessage({role:"assistant",content:m})}async handleTagLookup(t){let n=this.plugin.getApi();if(!n){this.ui.appendMessage("assistant","Core API is not available.");return}try{let o=n.resolveProject({tag:t});if(!o){let r=Bn(this.plugin,t);if(r.length===0)this.ui.appendMessage("assistant","Project not found.");else if(r.length===1)this.ui.appendMessage("assistant",`Resolved project: ${r[0].fullName} (${r[0].projectTag})`);else{let s=r.map(i=>`- ${i.projectTag} (${i.fullName})`).join(`
`);this.ui.appendMessage("assistant",`Multiple matches found:
${s}`)}return}this.ui.appendMessage("assistant",`Resolved project: ${o.entry.fullName} (${o.entry.projectTag})`)}catch(o){this.ui.appendMessage("assistant",(o==null?void 0:o.message)||"Failed to resolve project.")}}async handleLLM(t){if(!this.busy){this.busy=!0,this.ui.setBusy(!0);try{this.pendingPlan?await this.handleFollowup(t):this.pendingMixedInput?await this.handleMixedFollowup(t):await this.handleNewRequest(t)}catch(n){this.ui.appendMessage("assistant",(n==null?void 0:n.message)||"LLM request failed.")}finally{this.busy=!1,this.ui.setBusy(!1)}}}async handleNewRequest(t){let n=this.state.getConversationWindow().filter(s=>s.role!=="tool");this.state.appendMessage({role:"user",content:t});let o=this.plugin.settings.ai,r=await Hn(t,o);if(r.intent==="action"){await this.handleActionRequest(t,n);return}if(r.intent==="mixed"){await this.handleMixedRequest(t,n);return}if(r.intent==="unclear"){let s="Could you clarify what you'd like me to do?";this.ui.appendMessage("assistant",s),this.state.appendMessage({role:"assistant",content:s});return}await this.handleChatRequest(t,n)}async handleChatRequest(t,n){let o=[{role:"system",content:cr},...n,{role:"user",content:t}],r=this.ui.appendMessage("assistant",""),s="";for await(let i of de(this.plugin.settings.ai,o,[]))i.type==="content"&&i.delta&&(s+=i.delta,this.ui.updateMessage(r,s));return r||this.ui.appendMessage("assistant",s),this.state.appendMessage({role:"assistant",content:s}),s}async handleActionRequest(t,n){let o=dt(this.plugin),r=await mt(this.plugin),s=[...o,...r],i=Lt(s),a=await yt(this.plugin),p=Un(t),l=[{role:"system",content:a},...n,{role:"user",content:p}],c=await Ut({plugin:this.plugin,messages:l,tools:i,allowToolCalls:!1});if(c.needsFollowup&&c.question){this.setPendingPlan({originalInput:t,plan:c.plan,context:c.context,question:c.question,fields:c.fields,createdAt:new Date().toISOString(),status:"clarifying",clarifications:[]}),this.ui.appendMessage("assistant",c.question),this.state.appendMessage({role:"assistant",content:c.question});return}let u=c.plan?`Planned steps: ${c.plan}`:"",g=c.context?`Planner context: ${c.context}`:"",f=c.fields&&Object.keys(c.fields).length>0?`Fields: ${JSON.stringify(c.fields)}`:"",y=[u,g,f].filter(Boolean).join(`
`);y&&(this.ui.appendMessage("assistant",y),this.state.appendMessage({role:"assistant",content:y})),this.setPendingPlan({originalInput:t,plan:c.plan,context:c.context,fields:c.fields,createdAt:new Date().toISOString(),status:"awaiting_confirmation",clarifications:[]}),this.ui.appendConfirmationActions();let P="Please confirm to proceed with these actions.";this.ui.appendMessage("assistant",P),this.state.appendMessage({role:"assistant",content:P})}async handleMixedRequest(t,n){await this.handleChatRequest(t,n);let o=this.getMixedOfferText();this.ui.appendMessage("assistant",o),this.state.appendMessage({role:"assistant",content:o}),this.pendingMixedInput=t}async handleMixedFollowup(t){let n=this.pendingMixedInput;if(!n)return;let o=t.trim();if(!o)return;if(this.state.appendMessage({role:"user",content:o}),Gt(o)){this.pendingMixedInput=null;let s=this.state.getConversationWindow().filter(i=>i.role!=="tool");await this.handleActionRequest(n,s);return}if(Jt(o)){this.pendingMixedInput=null;let s="Okay. Let me know if you'd like me to set it up.";this.ui.appendMessage("assistant",s),this.state.appendMessage({role:"assistant",content:s});return}let r="Please confirm if you'd like me to proceed.";this.ui.appendMessage("assistant",r),this.state.appendMessage({role:"assistant",content:r})}getMixedOfferText(){var n,o;return((o=(n=this.plugin.settings.ai)==null?void 0:n.mixedOfferText)==null?void 0:o.trim())||lr}setPendingPlan(t){this.pendingPlan=t,this.state.setPendingPlan(t)}};var Pt=class{constructor(t){this.plugin=t;this.conversation=[];this.persistTimer=null;var n;this.conversation=((n=this.plugin.settings.ai)==null?void 0:n.conversation)||[]}getConversationWindow(){var n,o;let t=Math.max(0,(o=(n=this.plugin.settings.ai)==null?void 0:n.memoryLimit)!=null?o:10);return t===0?[]:this.conversation.slice(-t)}appendMessage(t){var o,r;this.conversation.push({role:t.role,content:t.content,name:t.name,toolCallId:t.toolCallId});let n=Math.max(0,(r=(o=this.plugin.settings.ai)==null?void 0:o.memoryLimit)!=null?r:10);n>0&&this.conversation.length>n&&(this.conversation=this.conversation.slice(-n)),this.persistConversation()}clearConversation(){this.conversation=[],this.plugin.settings.ai&&(this.plugin.settings.ai.conversation=[],this.plugin.saveSettings())}flushConversation(){this.persistTimer&&(window.clearTimeout(this.persistTimer),this.persistTimer=null),this.plugin.settings.ai&&(this.plugin.settings.ai.conversation=this.conversation.map(t=>({role:t.role,content:t.content,name:t.name,toolCallId:t.toolCallId})),this.plugin.saveSettings())}recordToolLog(t,n,o){if(!this.plugin.settings.ai)return;let r=this.plugin.settings.ai.toolLog||[];r.push({ts:new Date().toISOString(),toolName:t,ok:n,error:o});let s=r.slice(-200);this.plugin.settings.ai.toolLog=s,this.plugin.saveSettings()}getPendingPlan(){var t;return((t=this.plugin.settings.ai)==null?void 0:t.pendingPlan)||null}setPendingPlan(t){this.plugin.settings.ai&&(this.plugin.settings.ai.pendingPlan=t,this.plugin.saveSettings())}persistConversation(){this.persistTimer&&window.clearTimeout(this.persistTimer),this.persistTimer=window.setTimeout(async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.conversation=this.conversation.map(t=>({role:t.role,content:t.content,name:t.name,toolCallId:t.toolCallId})),await this.plugin.saveSettings())},400)}};var re="projectflow-ai-chat",_e=class extends jt.ItemView{constructor(n,o){super(n);this.messageContainer=null;this.inputEl=null;this.sendBtn=null;this.statusEl=null;this.controller=null;this.plugin=o}getViewType(){return re}getDisplayText(){return"ProjectFlow AI"}getIcon(){return"brain-circuit"}async onOpen(){let n=this.containerEl.children[1];n.empty(),n.addClass("pf-ai-view");let o=n.createDiv({cls:"pf-ai-header"});o.createEl("h3",{text:"ProjectFlow AI"});let r=o.createEl("button",{text:"Clear"});r.addClass("pf-ai-clear"),r.onclick=()=>{var u;return(u=this.controller)==null?void 0:u.clearConversation()};let s=n.createDiv({cls:"pf-ai-messages"});this.messageContainer=s;let i=n.createDiv({cls:"pf-ai-input"}),a=i.createEl("textarea");a.placeholder="Ask ProjectFlow...";let p=i.createEl("button",{text:"Send"}),l=i.createDiv({cls:"pf-ai-status"});l.setText(""),l.hide(),this.inputEl=a,this.sendBtn=p,this.statusEl=l;let c=new Pt(this.plugin);this.controller=new Oe(this.plugin,this,c),p.onclick=()=>this.handleSend(),a.onkeydown=u=>{u.key==="Enter"&&!u.shiftKey&&(u.preventDefault(),this.handleSend())}}async onClose(){var n;(n=this.controller)==null||n.onClose(),this.messageContainer=null,this.inputEl=null,this.sendBtn=null,this.statusEl=null,this.controller=null}appendMessage(n,o){if(!this.messageContainer)return null;let r=this.messageContainer.createDiv({cls:`pf-ai-message ${n}`});return this.renderMessage(r,o),this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}),r}updateMessage(n,o){var r;n&&(this.renderMessage(n,o),(r=this.messageContainer)==null||r.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}))}appendConfirmationActions(){if(!this.messageContainer)return;let n=this.messageContainer.createDiv({cls:"pf-ai-confirmation"}),o=n.createEl("button",{text:"Proceed"});o.addClass("pf-ai-confirm");let r=n.createEl("button",{text:"Reject"});r.addClass("pf-ai-reject");let s=i=>{o.disabled=!0,r.disabled=!0,i==="proceed"?(o.addClass("pf-ai-selected"),o.setText("Proceed \u2713")):(r.addClass("pf-ai-selected"),r.setText("Reject \u2713"))};o.onclick=()=>{var i;s("proceed"),(i=this.controller)==null||i.handleFollowup("yes")},r.onclick=()=>{var i;s("reject"),(i=this.controller)==null||i.handleFollowup("no")},this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"})}clearMessages(){var n;(n=this.messageContainer)==null||n.empty()}setBusy(n){this.sendBtn&&(this.sendBtn.disabled=n),this.statusEl&&(n?(this.statusEl.setText("Thinking..."),this.statusEl.show()):(this.statusEl.setText(""),this.statusEl.hide()))}async handleSend(){var o,r;let n=(((o=this.inputEl)==null?void 0:o.value)||"").trim();n&&(this.inputEl&&(this.inputEl.value=""),await((r=this.controller)==null?void 0:r.handleSend(n)))}renderMessage(n,o){let r=this.tryFormatJson(o),s=r!=null?r:o;n.empty(),jt.MarkdownRenderer.renderMarkdown(s,n,"",this)}tryFormatJson(n){let o=n.trim();if(!o||!(o.startsWith("{")||o.startsWith("[")))return null;try{let r=JSON.parse(o);return`\`\`\`json
${JSON.stringify(r,null,2)}
\`\`\``}catch(r){return null}}};var xt=class extends wo.Plugin{async onload(){var n;console.log("ProjectFlow plugin loaded"),await this.loadSettings(),this.addSettingTab(new tt(this.app,this)),this.registerView(re,o=>new _e(o,this)),this.addCommand({id:"add-project-info",name:"Add Project Info",callback:()=>Mn(this)}),this.addCommand({id:"remove-project-by-id",name:"Remove Project",callback:()=>kn(this)}),this.addCommand({id:"archive-project-by-id",name:"Archive Project",callback:()=>Fn(this)}),await this.exposeCoreApi(),(n=this.settings.ai)!=null&&n.enabled&&this.app.workspace.onLayoutReady(()=>{this.toggleAiView(!0)})}async loadSettings(){let n=await this.loadData();try{let{migrateSettings:o,CURRENT_SETTINGS_SCHEMA_VERSION:r}=await Promise.resolve().then(()=>(Vt(),Kn)),{DEFAULT_ENTITY_TYPES:s,DEFAULT_PROJECT_TYPES:i}=await Promise.resolve().then(()=>(Se(),gn)),{ensureProjectIndex:a}=await Promise.resolve().then(()=>(je(),Me)),{ensureProjectGraph:p}=await Promise.resolve().then(()=>(ve(),Fe));this.settings=Object.assign({},nt,o(n));let l=!1;this.settings.templatesRoot||(this.settings.templatesRoot="Templates/ProjectFlow",l=!0),(!this.settings.entityTypes||Object.keys(this.settings.entityTypes).length===0)&&(this.settings.entityTypes=s,l=!0),(!this.settings.projectTypes||Object.keys(this.settings.projectTypes).length===0)&&(this.settings.projectTypes=i,l=!0),(!this.settings.schemaVersion||this.settings.schemaVersion<r)&&(this.settings.schemaVersion=r,l=!0);let{index:c,updated:u}=a(this.settings.projectIndex,this.settings.projectRecords);u&&(this.settings.projectIndex=c,l=!0);let{graph:g,updated:f}=p(this.settings.projectGraph,this.settings.projectRecords,this.settings.archivedRecords);f&&(this.settings.projectGraph=g,l=!0),l&&await this.saveData(this.settings)}catch(o){this.settings=Object.assign({},nt,n)}}async saveSettings(){await this.saveData(this.settings)}getApi(){return this.coreApi}async toggleAiView(n){if(n){let o=this.app.workspace.getLeavesOfType(re);if(o.length>0){await o[0].setViewState({type:re,active:!0});return}let r=this.app.workspace.getRightLeaf(!1);if(!r)return;await r.setViewState({type:re,active:!0})}else this.app.workspace.detachLeavesOfType(re)}onunload(){this.app.workspace.detachLeavesOfType(re)}async exposeCoreApi(){let{createCoreApi:n}=await Promise.resolve().then(()=>(vo(),jo));this.coreApi=n(this);let o=window;o.PluginApi=o.PluginApi||{},o.PluginApi["@projectflow/core"]=this.coreApi}};var wr=xt;
