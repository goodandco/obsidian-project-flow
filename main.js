/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var At=Object.defineProperty;var Io=Object.getOwnPropertyDescriptor;var Mo=Object.getOwnPropertyNames;var No=Object.prototype.hasOwnProperty;var M=(e,t)=>()=>(e&&(t=e(e=0)),t);var U=(e,t)=>{for(var n in t)At(e,n,{get:t[n],enumerable:!0})},Fo=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Mo(t))!No.call(e,r)&&r!==n&&At(e,r,{get:()=>t[r],enumerable:!(o=Io(t,r))||o.enumerable});return e};var ko=e=>Fo(At({},"__esModule",{value:!0}),e);var vn={};U(vn,{DEFAULT_ENTITY_TYPES:()=>ue,DEFAULT_PROJECT_TYPES:()=>fe});var ue,fe,Ne=M(()=>{ue={task:{id:"task",name:"Task",templatePath:"template-task.md",targetFolder:"Work/Tasks",filenameRule:"${PROJECT_ID}-${title}",requiredFields:["title","description"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},"meeting.planning":{id:"meeting.planning",name:"Meeting (Planning)",templatePath:"template-meeting-planning.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.refinement":{id:"meeting.refinement",name:"Meeting (Refinement)",templatePath:"template-meeting-refinement.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.retro":{id:"meeting.retro",name:"Meeting (Retro)",templatePath:"template-meeting-retro.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.demo":{id:"meeting.demo",name:"Meeting (Demo)",templatePath:"template-meeting-demo.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.daily":{id:"meeting.daily",name:"Meeting (Daily)",templatePath:"template-meeting-daily.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.knowledge":{id:"meeting.knowledge",name:"Meeting (Knowledge)",templatePath:"template-meeting-knowledge.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},sprint:{id:"sprint",name:"Sprint",templatePath:"template-sprint.md",targetFolder:"Work",filenameRule:"Sprint ${title}",requiredFields:["title"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},idea:{id:"idea",name:"Idea",templatePath:"template-idea.md",targetFolder:"Knowledge Base",filenameRule:"Idea ${title}",requiredFields:["title"],patchMarkers:["AI:CONTENT"]}},fe={operational:{id:"operational",name:"Operational",description:"Default ProjectFlow structure for active projects.",folderStructure:["Knowledge Base","Meetings","Work","Work/Tasks","People"],initialNotes:[{fileName:"${PROJECT_FULL_NAME}.md",template:"project.md"},{fileName:"${PROJECT_NAME} Meetings.md",template:"meetings.md"},{fileName:"${PROJECT_NAME} People.md",template:"people.md"},{fileName:"${PROJECT_NAME} Work.md",template:"work.md"},{fileName:"${PROJECT_NAME} Knowledge Base.md",template:"knowledge-base.md"}],allowedEntityTypes:Object.keys(ue)}}});var ye={};U(ye,{SafeFileManager:()=>St});var St,ve=M(()=>{St=class{constructor(t){this.vault=t.vault}async createBatch(t){let n=[];try{for(let o of t)o.type==="folder"?await this.ensureFolder(o.path):await this.createIfAbsent(o.path,o.data)==="created"&&n.push(o.path);return{ok:!0}}catch(o){for(let r of n.reverse())try{let s=this.vault.getAbstractFileByPath(r);s&&this.vault.delete&&await this.vault.delete(s)}catch(s){}return{ok:!1,error:o}}}async has(t){var n;try{return this.vault.getAbstractFileByPath(t)?!0:(n=this.vault.adapter)!=null&&n.exists?await this.vault.adapter.exists(t):!1}catch(o){return!1}}async ensureFolder(t){var o;if(!this.vault.getAbstractFileByPath(t))try{await this.vault.createFolder(t)}catch(r){if(r&&typeof r=="object"&&((o=r.message)!=null&&o.includes("Parent folder"))){let s=t.split("/").filter(Boolean),i="";for(let a of s)if(i=i?`${i}/${a}`:a,!this.vault.getAbstractFileByPath(i))try{await this.vault.createFolder(i)}catch(d){}}}}async createIfAbsent(t,n){if(await this.has(t))return"skipped";try{return await this.vault.create(t,n),"created"}catch(o){return await this.has(t),"skipped"}}async removeDir(t){let n=this.vault.getAbstractFileByPath(t);if(n&&this.vault)try{await this.vault.trash(n,!0),await new Promise(o=>setTimeout(o,200))}catch(o){console.warn(`removeDir: failed to trash ${t}: ${o}`)}else console.warn(`removeDir: file not found: ${t}. File: ${n==null?void 0:n.path}`)}}});var Fe={};U(Fe,{sanitizeFileName:()=>qe,sanitizePath:()=>W});function qe(e){let t=(e!=null?e:"").trim();return Array.from(t).filter(o=>o.charCodeAt(0)>=32).join("").replace(/[\\/:*?"<>|]/g,"-").replace(/\s+/g," ").replace(/\.+$/g,"").substring(0,200)||"untitled"}function W(e){return e?e.split("/").filter(Boolean).map(qe).join("/"):""}var Pe=M(()=>{});var ke={};U(ke,{PROJECT_INDEX_VERSION:()=>It,addToProjectIndex:()=>$o,buildProjectIndex:()=>jn,ensureProjectIndex:()=>Qe,getProjectIndexCache:()=>Ze,removeFromProjectIndex:()=>Oo,setProjectIndexCache:()=>Do,toIndexEntry:()=>Mt});function Ze(){return Xe}function Do(e){Xe=e}function jn(e){let t={},n={},o={};if(e&&typeof e=="object"){for(let[r,s]of Object.entries(e))if(!(!s||typeof s!="object")){for(let[i,a]of Object.entries(s))if(!(!a||typeof a!="object"))for(let[d,c]of Object.entries(a)){if(!c||!c.variables||!c.info)continue;let l=Mt(c,d,r,i);t[l.fullName]=l,n[l.projectId]=l,o[l.projectTag]=l}}}return{version:1,byFullName:t,byId:n,byTag:o}}function Mt(e,t,n,o){var r;return{fullName:e.variables.PROJECT_FULL_NAME,projectId:t,projectTag:e.variables.PROJECT_TAG,path:e.variables.PROJECT_PATH,dimension:n,category:o,projectName:e.info.name,parent:(r=e.info.parent)!=null?r:null}}function Qe(e,t){if(!e||e.version!==1){let n=jn(t);return Xe=n,{index:n,updated:!0}}return Xe=e,{index:e,updated:!1}}function $o(e,t,n,o,r){let s=Mt(t,n,o,r);return e.byFullName[s.fullName]=s,e.byId[s.projectId]=s,e.byTag[s.projectTag]=s,e}function Oo(e,t){return delete e.byFullName[t.fullName],delete e.byId[t.projectId],delete e.byTag[t.projectTag],e}var It,Xe,je=M(()=>{It=1,Xe=null});var $e={};U($e,{PROJECT_GRAPH_VERSION:()=>Nt,addProjectToGraph:()=>Bo,buildProjectGraph:()=>Ft,cleanArchivedGraph:()=>kt,ensureProjectGraph:()=>De,getChildren:()=>Dt,getParents:()=>$t,getProjectGraphCache:()=>_o,removeProjectFromGraph:()=>Go,setProjectGraphCache:()=>Lo});function _o(){return et}function Lo(e){et=e}function Ft(e,t){let n={},o={};return e&&wn(e,n),t&&wn(t,o),{version:1,byFullName:n,archivedByFullName:o}}function De(e,t,n){if(!e||e.version!==1){let o=Ft(t,n);return et=o,{graph:o,updated:!0}}return et=e,{graph:e,updated:!1}}function Bo(e,t,n){let o=t.variables.PROJECT_FULL_NAME,r=Tn(t.info.parent),s=n?e.archivedByFullName:e.byFullName;if(s[o]=s[o]||{parent:r,children:[]},s[o].parent=r!=null?r:null,r){let i=s[r]||{parent:null,children:[]};i.children.includes(o)||i.children.push(o),s[r]=i}return e}function Go(e,t,n){let o=n?e.archivedByFullName:e.byFullName,r=o[t];return r!=null&&r.parent&&o[r.parent]&&(o[r.parent].children=o[r.parent].children.filter(s=>s!==t)),delete o[t],e}function kt(e,t){let n=Ft(void 0,t);return e.archivedByFullName=n.archivedByFullName,e}function Dt(e,t,n){var r,s;return(s=(r=(n?e.archivedByFullName:e.byFullName)[t])==null?void 0:r.children)!=null?s:[]}function $t(e,t,n){var i,a,d,c;let o=n?e.archivedByFullName:e.byFullName,r=[],s=(a=(i=o[t])==null?void 0:i.parent)!=null?a:null;for(;s;)r.push(s),s=(c=(d=o[s])==null?void 0:d.parent)!=null?c:null;return r}function wn(e,t){for(let n of Object.values(e))for(let o of Object.values(n))for(let r of Object.values(o)){if(!r||!r.variables)continue;let s=r.variables.PROJECT_FULL_NAME,i=Tn(r.info.parent);if(t[s]=t[s]||{parent:i,children:[]},t[s].parent=i!=null?i:null,i){let a=t[i]||{parent:null,children:[]};a.children.includes(s)||a.children.push(s),t[i]=a}}}function Tn(e){let t=e==null?void 0:e.trim();return t&&t.length>0?t:null}var Nt,et,we=M(()=>{Nt=1,et=null});var En={};U(En,{ensureValidOrThrow:()=>zo,validateProjectName:()=>Uo,validateTag:()=>Ho});function Uo(e){if(!e||!e.trim())return{ok:!1,reason:"Project name is required"};let t=e.trim();if(t.length>120)return{ok:!1,reason:"Project name too long (max 120)"};for(let n of t)if(n.charCodeAt(0)<32||n==="/"||n==="\\")return{ok:!1,reason:"Project name contains invalid characters"};return{ok:!0}}function Ho(e){if(!e||!e.trim())return{ok:!1,reason:"Tag is required"};let t=e.trim();return Vo.test(t)?{ok:!0}:{ok:!1,reason:"Tag must be 2-63 chars, start with letter/digit; may include -, _, /"}}function zo(e,t){let n=e();if(!n.ok)throw new Error(`${t}: ${n.reason}`)}var Vo,bn=M(()=>{Vo=/^[A-Za-z0-9][A-Za-z0-9_/-]{1,62}$/});var at={};U(at,{processTemplate:()=>Wo});function Sn(e){return e==null?"":String(e)}function Wo(e,t){if(!e||typeof e!="string")return"";let n=e;for(let[o,r]of Object.entries(t)){let s=Sn(r),i=`$_${o}`;n.includes(i)&&(n=n.split(i).join(s))}for(let[o,r]of Object.entries(t)){let s=Sn(r),i=new RegExp(`\\$\\{${Ko(o)}\\}`,"g");n=n.replace(i,s)}return n}function Ko(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var ct=M(()=>{});function In(e,t){let n=new Date,o=Yo(e.year)||n.getFullYear().toString(),r=n.toISOString().split("T")[0],s=t.projectsRoot||"1. Projects",i=e.parent&&e.parent.trim().length>0?`.${e.parent.trim()}`:"",a=`${o}${i}.${e.name}`,d=t.dimensions.find(p=>p.name===e.dimension),c=d?`${d.order}. ${d.name}`:e.dimension,l=`${s}/${c}/${e.category}/${a}`,g=`${l}`;return{PROJECT_NAME:e.name,PROJECT_TAG:e.tag,PROJECT_PARENT:e.parent?e.parent:"",PARENT_TAG:e.parent?e.tag:"",YEAR:o,DATE:r,PROJECT_FULL_NAME:a,PROJECT_RELATIVE_PATH:l,PROJECT_PATH:g,DIMENSION:d?d.name:e.dimension,CATEGORY:e.category,PROJECT_ID:e.id,PROJECT_DIMENSION:d?d.name:e.dimension}}function Yo(e){if(!e)return null;let t=e.trim();return/^\d{4}$/.test(t)?t:null}async function lt(e,t){try{let{processTemplate:n}=await Promise.resolve().then(()=>(ct(),at));return n(e,t)}catch(n){console.warn("Template processor import failed, using legacy replacement:",n);let o=e;return Object.entries(t).forEach(([r,s])=>{let i=`$_${r}`;o=o.split(i).join(s)}),o}}var Mn=M(()=>{});var Nn={};U(Nn,{mergeEntityTypes:()=>pt,mergeProjectTypes:()=>Ee});function pt(e){let t={...ue};if(e&&typeof e=="object")for(let[n,o]of Object.entries(e))!o||typeof o!="object"||(t[n]={...t[n],...o,id:n});return t}function Ee(e){let t={...fe};if(e&&typeof e=="object")for(let[n,o]of Object.entries(e))!o||typeof o!="object"||(t[n]={...t[n],...o,id:n});return t}var Le=M(()=>{Ne()});var Fn={};U(Fn,{resolveProjectType:()=>qo});function qo(e,t){let n=Ee(e.projectTypes),o=t==null?void 0:t.projectTypeId,r=o&&n[o]?o:"operational",s=n[r]||n.operational;return{projectTypeId:r,projectType:s}}var kn=M(()=>{Le()});async function dt(e,t){var n,o;try{let{resolveProjectType:r}=await Promise.resolve().then(()=>(kn(),Fn)),{projectTypeId:s,projectType:i}=r(e.settings,t);t.projectTypeId=s,Xo(t);let a=In(t,e.settings),d=e.settings.projectsRoot||"1. Projects",{sanitizePath:c,sanitizeFileName:l}=await Promise.resolve().then(()=>(Pe(),Fe)),{SafeFileManager:g}=await Promise.resolve().then(()=>(ve(),ye)),p=new g(e.app),m=c(d),f=e.settings.dimensions.find(T=>T.name===t.dimension),P=f?`${f.order}. ${f.name}`:t.dimension,v=l(P),u=l(t.category),h=c(`${m}/${v}/${u}/${a.PROJECT_FULL_NAME}`),j=(n=i==null?void 0:i.folderStructure)!=null?n:["Knowledge Base","Meetings","Work","Work/Tasks","People"],w=[{type:"folder",path:h},...j.map(T=>({type:"folder",path:c(`${h}/${T}`)}))],x=e.app.vault.adapter,N=`.obsidian/plugins/${e.manifest.id}/src/templates`,O=(o=i==null?void 0:i.initialNotes)!=null?o:[{fileName:`${a.PROJECT_FULL_NAME}.md`,template:"project.md"},{fileName:`${t.name} Meetings.md`,template:"meetings.md"},{fileName:`${t.name} People.md`,template:"people.md"},{fileName:`${t.name} Work.md`,template:"work.md"},{fileName:`${t.name} Knowledge Base.md`,template:"knowledge-base.md"}],K=[];for(let T of O){let F=T.fileName?await lt(T.fileName,a):T.fileName,q=`${N}/${T.template}`;if(!await x.exists(q))throw new Error(`Template file not found: ${T.template}`);let ge=await x.read(q),Te=await lt(ge,a),ne=c(`${h}/${l(F)}`);K.push({type:"file",path:ne,data:Te})}let Y=await p.createBatch([...w,...K]);if(!("ok"in Y)||!Y.ok)throw new Error(`Batch creation failed: ${Y.error||"unknown"}`);return await nr(e,t.name,a),await er(e,t,a),[!0,`Project "${t.name}" created successfully!`]}catch(r){return[!1,`Error creating project: ${r}`]}}function Xo(e){let t=Zo(e.name);if(t.year&&!e.year&&(e.year=t.year),t.name!==e.name&&(e.name=t.name),e.year){let n=Qo(e.name,e.year);e.name=n}}function Zo(e){let t=e.trim(),n=t.match(/^(\d{4})[.\-\s]+(.+)$/);return n?{year:n[1],name:n[2].trim()}:{year:null,name:t}}function Qo(e,t){let n=new RegExp(`^${t}[.\\-\\s]+`,"i");return e.trim().replace(n,"").trim()}async function er(e,t,n){try{let{ensureProjectIndex:o,addToProjectIndex:r}=await Promise.resolve().then(()=>(je(),ke)),{ensureProjectGraph:s,addProjectToGraph:i}=await Promise.resolve().then(()=>(we(),$e)),a={info:t,variables:n,createdAt:new Date().toISOString()},d=t.dimension,c=t.category,l=t.id;if(!e.settings.projectRecords||Array.isArray(e.settings.projectRecords)){let f={},P=Array.isArray(e.settings.projectRecords)?e.settings.projectRecords:[];for(let v of P){let u=v.info.dimension,h=v.info.category,j=v.info.id;f[u]=f[u]||{},f[u][h]=f[u][h]||{},f[u][h][j]=v}e.settings.projectRecords=f}let g=e.settings.projectRecords;if(g[d]=g[d]||{},g[d][c]=g[d][c]||{},g[d][c][l])throw new Error(`Project with id "${l}" already exists in ${d}:${c}`);g[d][c][l]=a;let{index:p}=o(e.settings.projectIndex,g);e.settings.projectIndex=r(p,a,l,d,c);let{graph:m}=s(e.settings.projectGraph,g,e.settings.archivedRecords);e.settings.projectGraph=i(m,a,!1),await e.saveData(e.settings)}catch(o){throw console.warn("Failed to record project creation:",o),o}}async function tr(e,t,n,o,r){try{let s=e.app.vault.adapter,i=`.obsidian/plugins/${e.manifest.id}/src/templates/${o}`;if(!await s.exists(i))throw new Error(`Template file not found: ${o}`);let a=await s.read(i),d=await lt(a,r),c=`${t}/${n}`,{SafeFileManager:l}=await Promise.resolve().then(()=>(ve(),ye));await new l(e.app).createIfAbsent(c,d)}catch(s){throw console.error(`Failed to create ${n}:`,s),new Error(`Failed to create ${n}: ${s}`)}}async function nr(e,t,n){let{sanitizePath:o,sanitizeFileName:r}=await Promise.resolve().then(()=>(Pe(),Fe)),{SafeFileManager:s}=await Promise.resolve().then(()=>(ve(),ye)),i=new s(e.app),a=o(`Templates/${t}_Templates`);await i.ensureFolder(a);let d=[{source:"template-meeting-daily.md",target:`${t}_Meeting_Daily_Template.md`},{source:"template-meeting-discussion.md",target:`${t}_Meeting_Discussion_Template.md`},{source:"template-meeting-knowledge.md",target:`${t}_Meeting_Knowledge_Template.md`},{source:"template-meeting-planning.md",target:`${t}_Meeting_Planning_Template.md`},{source:"template-meeting-refinement.md",target:`${t}_Meeting_Refinement_Template.md`},{source:"template-meeting-retro.md",target:`${t}_Meeting_Retro_Template.md`},{source:"template-meeting-demo.md",target:`${t}_Meeting_Demo_Template.md`},{source:"template-sprint.md",target:`${t}_Sprint_Template.md`},{source:"template-task.md",target:`${t}_Task_Template.md`},{source:"template-idea.md",target:`${t}_Idea_Template.md`},{source:"template-knowledge-base-item.md",target:`${t}_Knowledge_Item_Template.md`}];for(let c of d)try{let l=r(c.target);await tr(e,a,l,c.source,n)}catch(l){console.warn(`Failed to create template ${c.target}: ${l}`)}}var Ot=M(()=>{Mn()});var Zn={};U(Zn,{CURRENT_SETTINGS_SCHEMA_VERSION:()=>Ge,migrateSettings:()=>Rr});function Rr(e){var r,s,i,a,d,c,l,g,p,m,f,P;let t={dimensions:(r=e==null?void 0:e.dimensions)!=null?r:[],projectsRoot:(s=e==null?void 0:e.projectsRoot)!=null?s:"1. Projects",archiveRoot:(i=e==null?void 0:e.archiveRoot)!=null?i:"4. Archive",templatesRoot:(a=e==null?void 0:e.templatesRoot)!=null?a:"Templates/ProjectFlow",ai:e==null?void 0:e.ai,schemaVersion:(d=e==null?void 0:e.schemaVersion)!=null?d:0,projectRecords:{},archivedRecords:(c=e==null?void 0:e.archivedRecords)!=null?c:{},entityTypes:(l=e==null?void 0:e.entityTypes)!=null?l:{},projectTypes:(g=e==null?void 0:e.projectTypes)!=null?g:{},projectIndex:e==null?void 0:e.projectIndex,projectGraph:e==null?void 0:e.projectGraph},n=e==null?void 0:e.projectRecords;if(n&&typeof n=="object"&&!Array.isArray(n))t.projectRecords=n;else if(Array.isArray(n)){let v={};for(let u of n){if(!u||!u.info)continue;let h=u.info.dimension,j=u.info.category,w=u.info.id;!h||!j||!w||(v[h]=v[h]||{},v[h][j]=v[h][j]||{},v[h][j][w]=u)}t.projectRecords=v}else t.projectRecords={};if(Array.isArray(t.dimensions)){let v=1;t.dimensions=t.dimensions.map(u=>{var h;if(u&&typeof u=="object"){let j=(h=u.name)!=null?h:"",w=u.order,x=typeof j=="string"?j.match(/^\s*(\d+)\.\s*(.+)$/):null;return x&&(w=parseInt(x[1],10),j=x[2]),(w==null||Number.isNaN(w))&&(w=v++),{name:j,order:w,categories:Array.isArray(u.categories)?u.categories:[]}}return{name:String(u!=null?u:""),order:v++,categories:[]}})}else t.dimensions=[];let o=[...t.dimensions].sort((v,u)=>{var h,j;return((h=v.order)!=null?h:0)-((j=u.order)!=null?j:0)});return o.forEach((v,u)=>{v.order=u+1}),t.dimensions=o,(!t.schemaVersion||t.schemaVersion<Ge)&&((!t.entityTypes||Object.keys(t.entityTypes).length===0)&&(t.entityTypes=ue),(!t.projectTypes||Object.keys(t.projectTypes).length===0)&&(t.projectTypes=fe),t.ai?t.ai={enabled:Boolean(t.ai.enabled),provider:t.ai.provider||"openai",apiKey:(p=t.ai.apiKey)!=null?p:"",model:(m=t.ai.model)!=null?m:"gpt-4o-mini",baseUrl:(f=t.ai.baseUrl)!=null?f:"https://api.openai.com",strictExecution:Boolean(t.ai.strictExecution),memoryLimit:Number.isFinite(t.ai.memoryLimit)?t.ai.memoryLimit:10,mixedOfferText:(P=t.ai.mixedOfferText)!=null?P:Xn,mcpServers:Array.isArray(t.ai.mcpServers)?t.ai.mcpServers:[],toolLog:Array.isArray(t.ai.toolLog)?t.ai.toolLog:[]}:t.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",strictExecution:!1,memoryLimit:10,mixedOfferText:Xn,mcpServers:[],toolLog:[]},t.schemaVersion=Ge),t}var Ge,Xn,Wt=M(()=>{Ne();Ge=8,Xn="I can also set this up for you. Shall I proceed?"});function Qn(e){return e?e.startsWith("/")||e.includes("\\")?!1:!e.split("/").filter(Boolean).some(n=>n==="."||n===".."):!0}function Je(e,t){let n=W(e),o=W(t);return o?n===o||n.startsWith(`${o}/`):!1}var eo=M(()=>{Pe()});function Er(e,t,n,o,r){let s=br(t),i=to(e,s,!1);if(i){let a=i.end,d=to(e,s,!0,a),c=d?d.start:Ar(e,a),l=e[a]!==`
`;return{updated:!0,text:[e.slice(0,a),l?`
`:"",Kt(n),e.slice(c>=0?c:e.length)].join("")}}if(o==="strict")return{updated:!1,text:e};if(r){let a=no(e,r,n,o);if(a.updated)return a}return{updated:!0,text:so(e,r||"AI Notes",n)}}function no(e,t,n,o){let r=ro(t),i=new RegExp(`^#{1,6}\\s+${io(r)}\\s*$`,"m").exec(e);if(!i||i.index==null)return o==="strict"?{updated:!1,text:e}:{updated:!0,text:so(e,r,n)};let a=i.index,d=e.indexOf(`
`,a),c=d>=0?d+1:e.length,l=Sr(e,c);return{updated:!0,text:[e.slice(0,c),Kt(n),e.slice(l)].join("")}}async function wt(e,t){var i;let n=e.vault.adapter,o=(i=t.patchMode)!=null?i:"lenient";if(!await n.exists(t.path))return{ok:!1,error:`File not found: ${t.path}`};let r=await n.read(t.path),s=Er(r,t.marker,t.content,o,t.fallbackHeading);return s.updated?(await n.write(t.path,s.text),{ok:!0}):{ok:!1,error:"Marker or heading not found in strict mode."}}async function oo(e,t){var i;let n=e.vault.adapter,o=(i=t.patchMode)!=null?i:"lenient";if(!await n.exists(t.path))return{ok:!1,error:`File not found: ${t.path}`};let r=await n.read(t.path),s=no(r,t.heading,t.content,o);return s.updated?(await n.write(t.path,s.text),{ok:!0}):{ok:!1,error:"Heading not found in strict mode."}}function br(e){return e.trim().replace(/^<!--\s*/,"").replace(/\s*(?:-->|>)\s*$/,"").replace(/^\/\s*/,"").trim()}function ro(e){return e.replace(/^#+\s*/,"").trim()}function to(e,t,n,o=0){let r=n?"\\/\\s*":"",s=new RegExp(`<!--\\s*${r}${io(t)}\\s*(?:-->|>)`,"gi");s.lastIndex=o;let i=s.exec(e);return!i||i.index==null?null:{start:i.index,end:i.index+i[0].length}}function Ar(e,t){let n=/<!--\s*\/?\s*[A-Za-z0-9:_-]+\s*(?:-->|>)/g;n.lastIndex=t;let o=n.exec(e);return o&&o.index!=null?o.index:-1}function Sr(e,t){let n=/^#{1,6}\s+/gm;n.lastIndex=t;let o=n.exec(e);return o&&o.index!=null?o.index:e.length}function Kt(e){let t=e!=null?e:"";return t.endsWith(`
`)?t:`${t}
`}function so(e,t,n){let o=ro(t);return`${e.endsWith(`
`)?e:`${e}
`}
## ${o}
${Kt(n)}`}function io(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var Yt=M(()=>{});var co={};U(co,{listProjects:()=>qt,resolveArchivedProject:()=>Tt,resolveProject:()=>Ve});function Ve(e,t){var i,a,d;let n=Ze()||Qe(e.settings.projectIndex,e.settings.projectRecords).index,o=ao(t),r=o.fullName&&n.byFullName[o.fullName]||o.id&&n.byId[o.id]||o.tag&&n.byTag[o.tag];if(!r)return null;let s=(d=(a=(i=e.settings.projectRecords)==null?void 0:i[r.dimension])==null?void 0:a[r.category])==null?void 0:d[r.projectId];return s?{entry:r,record:s}:null}function Tt(e,t){var r;let n=ao(t),o=Ir(e.settings.archivedRecords,n);return o?{entry:{fullName:o.variables.PROJECT_FULL_NAME,projectId:o.info.id,projectTag:o.variables.PROJECT_TAG,path:o.variables.PROJECT_PATH,dimension:o.info.dimension,category:o.info.category,projectName:o.info.name,parent:(r=o.info.parent)!=null?r:null},record:o}:null}function qt(e){let t=Ze()||Qe(e.settings.projectIndex,e.settings.projectRecords).index;return Object.values(t.byFullName)}function ao(e){var t,n,o;if(typeof e=="string"){let r=e.trim();return r.startsWith("project/")?{tag:r}:r.includes(".")?{fullName:r}:{id:r}}return{fullName:(t=e.fullName)==null?void 0:t.trim(),id:(n=e.id)==null?void 0:n.trim(),tag:(o=e.tag)==null?void 0:o.trim()}}function Ir(e,t){if(!e)return null;for(let n of Object.values(e))for(let o of Object.values(n))for(let r of Object.values(o))if(r&&(t.fullName&&r.variables.PROJECT_FULL_NAME===t.fullName||t.id&&r.info.id===t.id||t.tag&&r.variables.PROJECT_TAG===t.tag))return r;return null}var Xt=M(()=>{je()});async function po(e,t){let{resolveProject:n}=await Promise.resolve().then(()=>(Xt(),co)),{mergeEntityTypes:o}=await Promise.resolve().then(()=>(Le(),Nn)),{processTemplate:r}=await Promise.resolve().then(()=>(ct(),at)),{SafeFileManager:s}=await Promise.resolve().then(()=>(ve(),ye)),i=n(e,t.projectRef);if(!i)throw new Error("Project not found for reference.");let d=o(e.settings.entityTypes)[t.entityTypeId];if(!d)throw new Error(`Entity type not found: ${t.entityTypeId}`);let c=Nr(t.fields);Mr(d,c);let l={...i.record.variables,...c||{}},g=await kr(e,d,i.record,l);if(!g)throw new Error(`Template not found for entity type: ${d.id}`);let m=await e.app.vault.adapter.read(g.path),f=r(m,l),P=r(d.targetFolder,l);if(!Qn(P))throw new Error("Unsafe targetFolder path.");let v=W(i.record.variables.PROJECT_PATH),u=P?W(`${v}/${P}`):v;if(!Je(u,v))throw new Error("Target folder is outside project path.");if(!lo(u,e.settings))throw new Error("Target folder is outside allowed roots.");let h=d.filenameRule||"Untitled",j=r(h,l),w=j.endsWith(".md")?j.slice(0,-3):j,x=qe(w),N=W(`${u}/${x}.md`);if(!Je(N,v))throw new Error("Target file is outside project path.");if(!lo(N,e.settings))throw new Error("Target file is outside allowed roots.");let O=new s(e.app);if(await O.ensureFolder(u),await O.has(N))throw new Error(`File already exists: ${N}`);return await O.createIfAbsent(N,f),await Fr(e,N,c),{path:N}}function lo(e,t){let n=t.projectsRoot||"1. Projects",o=t.archiveRoot||"4. Archive";return Je(e,n)||Je(e,o)}function Mr(e,t){if(!e.requiredFields||e.requiredFields.length===0)return;let n=e.requiredFields.filter(o=>t==null||t[o]==null||String(t[o]).trim()==="");if(n.length>0)throw new Error(`Missing required fields: ${n.join(", ")}`)}function Nr(e){if(!e)return e;let t={...e};for(let[n,o]of Object.entries(e)){if(o==null)continue;let r=n.toUpperCase(),s=n.toLowerCase();r in t||(t[r]=o),s in t||(t[s]=o)}return t}async function Fr(e,t,n){if(!n)return;let o=Object.entries(n).filter(([r,s])=>r.toLowerCase()===r).filter(([r,s])=>r!=="title"&&s!=null&&String(s).trim().length>0);for(let[r,s]of o){let i=`ai:${r}`,a=String(s);(await wt(e.app,{path:t,marker:i,content:a,patchMode:"strict"})).ok}}async function kr(e,t,n,o){let{processTemplate:r}=await Promise.resolve().then(()=>(ct(),at)),s=e.app.vault.adapter,i=r(t.templatePath,o),a=W(`Templates/${n.info.name}_Templates`),d=W(e.settings.templatesRoot||"Templates/ProjectFlow"),c=`.obsidian/plugins/${e.manifest.id}/src/templates`,l=p=>p.map(m=>m==="project"?{scope:m,path:W(`${a}/${i}`)}:m==="vault"?{scope:m,path:W(`${d}/${i}`)}:{scope:m,path:`${c}/${i}`}),g=t.templateScope?[t.templateScope,"builtin"].filter((p,m,f)=>f.indexOf(p)===m):["project","vault","builtin"];for(let p of l(g))if(await s.exists(p.path))return p;return null}var uo=M(()=>{Pe();eo();Yt()});function mo(e){if(e instanceof ie)return e;let t=e instanceof Error?e.message:"Unknown error";return new ie("validation_error",t)}var ie,Zt=M(()=>{ie=class extends Error{constructor(n,o,r){super(o);this.code=n,this.details=r}}});function H(e,t){if(typeof e!="string"||e.trim().length===0)throw new ie("invalid_request",`${t} is required`,{field:t});return e.trim()}function xt(e){if(e==null)throw new ie("invalid_request","projectRef is required",{field:"projectRef"});if(typeof e=="string"){H(e,"projectRef");return}let t=typeof e.fullName=="string"&&e.fullName.trim().length>0,n=typeof e.id=="string"&&e.id.trim().length>0,o=typeof e.tag=="string"&&e.tag.trim().length>0;if(!t&&!n&&!o)throw new ie("invalid_request","projectRef must include fullName, id, or tag",{field:"projectRef"})}function go(e){if(H(e==null?void 0:e.name,"name"),H(e==null?void 0:e.tag,"tag"),H(e==null?void 0:e.id,"id"),H(e==null?void 0:e.dimension,"dimension"),H(e==null?void 0:e.category,"category"),(e==null?void 0:e.year)!=null){let t=String(e.year).trim();if(!/^\d{4}$/.test(t))throw new ie("invalid_request","year must be a 4-digit string",{field:"year"})}}function ho(e){xt(e==null?void 0:e.projectRef),H(e==null?void 0:e.entityTypeId,"entityTypeId")}function fo(e){H(e==null?void 0:e.path,"path"),H(e==null?void 0:e.marker,"marker"),H(e==null?void 0:e.content,"content")}function yo(e){H(e==null?void 0:e.path,"path"),H(e==null?void 0:e.heading,"heading"),H(e==null?void 0:e.content,"content")}var Ct=M(()=>{Zt()});function vo(e){return{listEntityTypes:()=>pt(e.settings.entityTypes),describeEntityType:t=>pt(e.settings.entityTypes)[t]||null,createEntity:async t=>(ho(t),po(e,t))}}var Po=M(()=>{Le();uo();Ct()});function jo(e){return{patchMarker:async t=>(fo(t),wt(e.app,t)),patchSection:async t=>(yo(t),oo(e.app,t))}}var wo=M(()=>{Yt();Ct()});function To(e){return{resolveProject:t=>(xt(t),Ve(e,t)),listProjects:()=>qt(e),listProjectTypes:()=>Ee(e.settings.projectTypes),describeProjectType:t=>Ee(e.settings.projectTypes)[t]||null,createProject:async t=>(go(t),dt(e,t)),getChildren:(t,n)=>{xt(t);let o=n?Tt(e,t):Ve(e,t);if(!o)return[];let{graph:r}=De(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return Dt(r,o.entry.fullName,Boolean(n))},getParents:(t,n)=>{let o=n?Tt(e,t):Ve(e,t);if(!o)return[];let{graph:r}=De(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return $t(r,o.entry.fullName,Boolean(n))},clearArchivedProjectGraph:async()=>{let{graph:t}=De(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return e.settings.projectGraph=kt(t,e.settings.archivedRecords),await e.saveData(e.settings),{ok:!0}}}}var xo=M(()=>{Le();Ot();Xt();we();Ct()});var Co={};U(Co,{createCoreApi:()=>Dr});function Dr(e){let t="1.0.0",n=To(e),o=vo(e),r=jo(e);return{version:t,capabilities:{resolveProject:!0,listProjects:!0,entityTypes:!0,projectTypes:!0,createProject:!0,createEntity:!0,patching:!0,projectGraph:!0,errorHandling:"throws"},compatibility:{settingsSchemaVersion:Ge,projectIndexVersion:1,projectGraphVersion:1},...n,...o,...r,wrapError:s=>{let i=mo(s);return{ok:!1,error:{code:i.code,message:i.message,details:i.details}}}}}var Ro=M(()=>{Po();wo();xo();Zt();Wt();je();we()});var Or={};U(Or,{default:()=>$r});module.exports=ko(Or);var Eo=require("obsidian");var E=require("obsidian");Ne();var Pn=require("obsidian"),Ye=class extends Pn.Modal{constructor(n,o){super(n);this.onResult=o}onOpen(){let{contentEl:n}=this;n.empty(),n.addClass("project-flow-settings"),n.createEl("p",{text:"Do you want skip settings to defaults? This will override all custom settings."});let o=n.createDiv({cls:"gc-row"});o.createDiv({cls:"gc-spacer"});let r=o.createEl("button",{text:"Yes, use defaults"}),s=o.createEl("button",{text:"Go back"});r.onclick=()=>{this.close(),this.onResult(!0)},s.onclick=()=>{this.close(),this.onResult(!1)}}onClose(){this.contentEl.empty()}};async function tt(e,t,n,o){let r="",s=e.settings.projectRecords,i=s[t][n][o],{SafeFileManager:a}=await Promise.resolve().then(()=>(ve(),ye)),d=new a(e.app),{sanitizePath:c}=await Promise.resolve().then(()=>(Pe(),Fe)),l=c(i.variables.PROJECT_PATH),g=c(`Templates/${i.info.name}_Templates`);try{await d.removeDir(l),await d.removeDir(g);try{s[t][n][o]&&(delete s[t][n][o],Object.keys(s[t][n]).length===0&&delete s[t][n],Object.keys(s[t]).length===0&&delete s[t]);try{let{ensureProjectIndex:p,removeFromProjectIndex:m,toIndexEntry:f}=await Promise.resolve().then(()=>(je(),ke)),{ensureProjectGraph:P,removeProjectFromGraph:v}=await Promise.resolve().then(()=>(we(),$e)),{index:u}=p(e.settings.projectIndex,s);e.settings.projectIndex=m(u,f(i,o,t,n));let{graph:h}=P(e.settings.projectGraph,s,e.settings.archivedRecords);e.settings.projectGraph=v(h,i.variables.PROJECT_FULL_NAME,!1)}catch(p){console.warn("Failed to update projectIndex after delete:",p)}await e.saveData(e.settings),r="Project deleted successfully."}catch(p){r="Failed to update projectRecords after delete",console.warn(r,p)}return[!0,r]}catch(p){r="Error removing project: "+p.message,console.error("Error removing project:",p)}return[!1,r]}async function nt(e,t,n,o){var r,s,i,a,d;try{let c=e.settings.projectRecords,l=(s=(r=c==null?void 0:c[t])==null?void 0:r[n])==null?void 0:s[o];if(!l)return[!1,"Project not found."];let{sanitizePath:g}=await Promise.resolve().then(()=>(Pe(),Fe)),{SafeFileManager:p}=await Promise.resolve().then(()=>(ve(),ye)),m=new p(e.app),f=e.app.vault.adapter,P=g(l.variables.PROJECT_PATH),v=g(`Templates/${l.info.name}_Templates`),u=e.settings.archiveRoot||"4. Archive",h=l.variables.YEAR,j=l.variables.DIMENSION||l.info.dimension,w=l.info.category,x=l.info.parent&&l.info.parent.trim().length>0?l.info.parent.trim():null,N=l.info.name,O=x?`${h}.${j}.${w}.${x}.${N}`:`${h}.${j}.${w}.${N}`,K=g(`${u}/${O}`),Y=T=>{let F=T.split("/").filter(Boolean);return F.pop(),F.join("/")};if(await m.ensureFolder(Y(K)),!await f.exists(P))return[!1,`Project directory not found: ${P}`];if(await f.exists(K))return[!1,`Archive destination already exists: ${K}`];await f.rename(P,K);try{if(await f.exists(v)){let T=g(`${K}/Templates`);await m.ensureFolder(T);let F=g(`${T}/${l.info.name}_Templates`);if(await f.exists(F)){let q=g(`${T}/${l.info.name}_Templates_archived`);await f.rename(v,q)}else await f.rename(v,F)}}catch(T){console.warn("Archiving templates failed:",T)}try{let T=e.settings.projectRecords;(!e.settings.archivedRecords||Array.isArray(e.settings.archivedRecords))&&(e.settings.archivedRecords=e.settings.archivedRecords&&Array.isArray(e.settings.archivedRecords)?{}:e.settings.archivedRecords||{});let F=e.settings.archivedRecords;F[t]=F[t]||{},F[t][n]=F[t][n]||{},F[t][n][o]=l,(a=(i=T==null?void 0:T[t])==null?void 0:i[n])!=null&&a[o]&&(delete T[t][n][o],Object.keys(T[t][n]).length===0&&delete T[t][n],Object.keys(T[t]||{}).length===0&&delete T[t]);try{let{ensureProjectIndex:q,removeFromProjectIndex:ge,toIndexEntry:Te}=await Promise.resolve().then(()=>(je(),ke)),{ensureProjectGraph:ne,removeProjectFromGraph:Ue,addProjectToGraph:xe}=await Promise.resolve().then(()=>(we(),$e)),{index:Et}=q(e.settings.projectIndex,T);e.settings.projectIndex=ge(Et,Te(l,o,t,n));let{graph:He}=ne(e.settings.projectGraph,T,F);e.settings.projectGraph=Ue(He,l.variables.PROJECT_FULL_NAME,!1),e.settings.projectGraph=xe(e.settings.projectGraph,l,!0)}catch(q){console.warn("Failed to update projectIndex after archive:",q)}await e.saveData(e.settings)}catch(T){console.warn("Failed to move project record to archive in settings:",T)}return[!0,"Project archived successfully."]}catch(c){return console.error("Archive failed:",c),[!1,(d=c==null?void 0:c.message)!=null?d:"Failed to archive project."]}}var Jo=[{name:"Business",order:1,categories:["R&D","Jobs","OpenSource","Education"]},{name:"Family",order:2,categories:["Vacations","Parenting","Common"]},{name:"Friends",order:3,categories:[]},{name:"Health",order:4,categories:["Clinics","Issues","R&D"]},{name:"Personal",order:5,categories:["R&D","Languages","SelfManagement","Writing","Reading","Music","Sports"]},{name:"Residence",order:6,categories:[]}],rt={dimensions:JSON.parse(JSON.stringify(Jo)),projectsRoot:"1. Projects",archiveRoot:"4. Archive",templatesRoot:"Templates/ProjectFlow",ai:{enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",strictExecution:!1,memoryLimit:10,mcpServers:[],toolLog:[]},projectRecords:{},archivedRecords:{},projectGraph:{version:1,byFullName:{},archivedByFullName:{}},entityTypes:ue,projectTypes:fe};function xn(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}var ot=class extends E.PluginSettingTab{constructor(n,o){super(n,o);this.plugin=o}display(){var nn,on,rn,sn,an,cn,ln,pn,dn,un,mn,gn,hn,fn,yn;let{containerEl:n}=this;n.empty(),n.addClass("project-flow-settings");let o=n.createDiv({cls:"gc-row"});o.createDiv({cls:"gc-spacer"});let r=o.createEl("button",{cls:["gc-icon-button","clickable-icon"],attr:{"aria-label":"Reset to defaults",title:"Reset to defaults"}});try{(0,E.setIcon)(r,"rotate-ccw")}catch(y){r.setText("Reset to defaults")}r.onclick=()=>{new Ye(this.app,async b=>{b&&(this.plugin.settings=JSON.parse(JSON.stringify(rt)),await this.plugin.saveSettings(),new E.Notice("Settings were reset to defaults."),this.display())}).open()},n.createEl("h2",{text:"Folders"});let s=n.createDiv({cls:"gc-column"}),i=s.createDiv({cls:"setting-item"});i.createEl("label",{text:"Projects root"});let a=i.createEl("input",{type:"text"});a.value=this.plugin.settings.projectsRoot||"1. Projects",a.placeholder="e.g. 1. Projects",a.onchange=async()=>{this.plugin.settings.projectsRoot=a.value.trim()||"1. Projects",await this.plugin.saveSettings()};let d=s.createDiv({cls:"setting-item"});d.createEl("label",{text:"Archive root"});let c=d.createEl("input",{type:"text"});c.value=this.plugin.settings.archiveRoot||"4. Archive",c.placeholder="e.g. 4. Archive",c.onchange=async()=>{this.plugin.settings.archiveRoot=c.value.trim()||"4. Archive",await this.plugin.saveSettings()};let l=s.createDiv({cls:"setting-item"});l.createEl("label",{text:"Templates root"});let g=l.createEl("input",{type:"text"});g.value=this.plugin.settings.templatesRoot||"Templates/ProjectFlow",g.placeholder="e.g. Templates/ProjectFlow",g.onchange=async()=>{this.plugin.settings.templatesRoot=g.value.trim()||"Templates/ProjectFlow",await this.plugin.saveSettings()},n.createEl("h2",{text:"Dimensions"}),[...this.plugin.settings.dimensions].sort((y,b)=>{var _,$;return((_=y.order)!=null?_:0)-(($=b.order)!=null?$:0)}).forEach((y,b)=>{let _=n.createDiv({cls:"dimension-setting"}),$=_.createDiv({cls:"dimension-header"});$.addClass("gc-row"),$.createSpan({text:`${y.order}. `});let z=$.createEl("b",{text:y.name});$.createDiv({cls:"gc-spacer"});let G=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});G.setAttr("aria-label","Move up"),G.setAttr("title","Move up");try{(0,E.setIcon)(G,"arrow-up")}catch(A){G.setText("Up")}G.onclick=async()=>{let S=[...this.plugin.settings.dimensions].filter(k=>{var I,R;return((I=k.order)!=null?I:0)<((R=y.order)!=null?R:0)}).sort((k,I)=>{var R,D;return((R=I.order)!=null?R:0)-((D=k.order)!=null?D:0)})[0];if(!S)return;let C=S.order;S.order=y.order,y.order=C,await this.plugin.saveSettings(),this.display()};let ae=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ae.setAttr("aria-label","Move down"),ae.setAttr("title","Move down");try{(0,E.setIcon)(ae,"arrow-down")}catch(A){ae.setText("Down")}ae.onclick=async()=>{let S=[...this.plugin.settings.dimensions].filter(k=>{var I,R;return((I=k.order)!=null?I:0)>((R=y.order)!=null?R:0)}).sort((k,I)=>{var R,D;return((R=k.order)!=null?R:0)-((D=I.order)!=null?D:0)})[0];if(!S)return;let C=S.order;S.order=y.order,y.order=C,await this.plugin.saveSettings(),this.display()};let ce=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ce.setAttr("aria-label",`Delete ${y.name}`),ce.setAttr("title",`Delete ${y.name}`);try{(0,E.setIcon)(ce,"trash")}catch(A){ce.setText("Remove")}ce.onclick=async()=>{let A=this.plugin.settings.dimensions.findIndex(S=>S===y);A>=0&&this.plugin.settings.dimensions.splice(A,1),await this.plugin.saveSettings(),this.display()};let B=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});B.setAttr("aria-label",`Rename ${y.name}`),B.setAttr("title",`Rename ${y.name}`);try{(0,E.setIcon)(B,"pencil")}catch(A){B.setText("Edit")}if(B.onclick=async()=>{var le;let A=y.name,S=z.parentElement;(le=z.detach)==null||le.call(z),B.style.display="none",ce.style.display="none";let C=S.createEl("input",{type:"text"});C.value=A,C.addClass("gc-rename");let k=S.createDiv({cls:"gc-row"});k.createDiv({cls:"gc-spacer"});let I=k.createEl("button",{cls:["gc-icon-button","clickable-icon"]});I.setAttr("aria-label","Apply"),I.setAttr("title","Apply");try{(0,E.setIcon)(I,"check")}catch(J){I.setText("Apply")}let R=k.createEl("button",{cls:["gc-icon-button","clickable-icon"]});R.setAttr("aria-label","Discard"),R.setAttr("title","Discard");try{(0,E.setIcon)(R,"x")}catch(J){R.setText("Discard")}let D=()=>{this.display()},X=async J=>{let Z=J.trim();if(!Z||Z===A){D();return}if(this.plugin.settings.dimensions.some(Me=>Me!==y&&Me.name===Z)){new E.Notice("A dimension with this name already exists.");return}y.name=Z,await this.plugin.saveSettings(),D()};I.onclick=async()=>{await X(C.value)},R.onclick=()=>D(),C.focus(),C.select(),C.onkeydown=async J=>{J.key==="Enter"&&await X(C.value),J.key==="Escape"&&D()},C.onblur=async()=>{await X(C.value)}},y.categories.length>0){let A=_.createDiv({cls:"categories-list gc-list"});y.categories.forEach((S,C)=>{var Me;let k=A.createDiv({cls:"gc-list-item gc-row"}),I=this.plugin.settings.projectRecords||{},R=y.name,D=Object.keys(((Me=I==null?void 0:I[R])==null?void 0:Me[S])||{}),X=k.createEl("b",{text:S}),le=k.createDiv({cls:"gc-id-wrap"});D.length>0&&(le.createSpan({text:" "}),D.forEach((V,We)=>{let L=le.createSpan({cls:"gc-id-chip"});L.style.display="inline-flex",L.style.alignItems="center",L.style.gap="4px";let Ce=L.createSpan({cls:"gc-id-tag",text:V}),pe=Math.abs(xn(V))%360;Ce.style.backgroundColor=`hsl(${pe}, 70%, 90%)`,Ce.style.color=`hsl(${pe}, 70%, 25%)`;let Q=L.createSpan({cls:"gc-id-actions"});Q.style.display="none";let ee=Q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ee.setAttr("aria-label",`Delete ${V}`),ee.setAttr("title",`Delete ${V}`);try{(0,E.setIcon)(ee,"trash")}catch(de){ee.setText("Del")}ee.onclick=async de=>{de.stopPropagation();let[,te]=await tt(this.plugin,R,S,V);new E.Notice(te),this.display()};let oe=Q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});oe.setAttr("aria-label",`Archive ${V}`),oe.setAttr("title",`Archive ${V}`);try{(0,E.setIcon)(oe,"archive")}catch(de){oe.setText("Arc")}oe.onclick=async de=>{de.stopPropagation();let[,te]=await nt(this.plugin,R,S,V);new E.Notice(te),this.display()},L.onmouseenter=()=>{Q.style.display="inline-flex"},L.onmouseleave=()=>{Q.style.display="none"},We<D.length-1&&le.createSpan({text:" "})})),k.createDiv({cls:"gc-spacer"});let J=k.createEl("button",{cls:["remove-category","gc-icon-button","clickable-icon"]});J.setAttr("aria-label",`Delete ${S}`),J.setAttr("title",`Delete ${S}`);try{(0,E.setIcon)(J,"trash")}catch(V){J.setText("Remove")}J.onclick=async()=>{y.categories.splice(C,1),await this.plugin.saveSettings(),this.display()};let Z=k.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Z.setAttr("aria-label",`Rename ${S}`),Z.setAttr("title",`Rename ${S}`);try{(0,E.setIcon)(Z,"pencil")}catch(V){Z.setText("Edit")}Z.onclick=async()=>{var de;let V=y.categories[C],We=X.parentElement;(de=X.detach)==null||de.call(X),Z.style.display="none",J.style.display="none";let L=We.createEl("input",{type:"text"});L.value=V,L.addClass("gc-rename");let Ce=We.createDiv({cls:"gc-row"});Ce.createDiv({cls:"gc-spacer"});let pe=Ce.createEl("button",{cls:["gc-icon-button","clickable-icon"]});pe.setAttr("aria-label","Apply"),pe.setAttr("title","Apply");try{(0,E.setIcon)(pe,"check")}catch(te){pe.setText("Apply")}let Q=Ce.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Q.setAttr("aria-label","Discard"),Q.setAttr("title","Discard");try{(0,E.setIcon)(Q,"x")}catch(te){Q.setText("Discard")}let ee=()=>{this.display()},oe=async te=>{let Ke=te.trim();if(!Ke||Ke===V){ee();return}if(y.categories.some((Ao,So)=>So!==C&&Ao===Ke)){new E.Notice("This category already exists in the dimension.");return}y.categories[C]=Ke,await this.plugin.saveSettings(),ee()};pe.onclick=async()=>{await oe(L.value)},Q.onclick=()=>ee(),L.focus(),L.select(),L.onkeydown=async te=>{te.key==="Enter"&&await oe(L.value),te.key==="Escape"&&ee()},L.onblur=async()=>{await oe(L.value)}}})}let he=_.createDiv({cls:"add-category gc-row"}),Se=he.createEl("input",{type:"text",placeholder:"New category"});he.createDiv({cls:"gc-spacer"});let Ie=he.createEl("button",{text:"Add Category"});Ie.onclick=async()=>{let A=Se.value.trim();A&&!y.categories.includes(A)&&(y.categories.push(A),await this.plugin.saveSettings(),this.display())}});let m=n.createDiv({cls:"add-dimension"});m.createEl("h3",{text:"Add new dimension"});let f=m.createDiv({cls:"gc-row"}),P=f.createEl("input",{type:"text",placeholder:"Dimension name"});f.createDiv({cls:"gc-spacer"});let v=f.createEl("button",{text:"Add Dimension"});v.onclick=async()=>{let y=P.value.trim();if(y&&!this.plugin.settings.dimensions.some(b=>b.name===y)){{let b=this.plugin.settings.dimensions.reduce((_,$)=>{var z;return Math.max(_,(z=$.order)!=null?z:0)},0);this.plugin.settings.dimensions.push({name:y,order:b+1,categories:[]})}await this.plugin.saveSettings(),this.display()}},n.createEl("h2",{text:"AI Module"});let u=n.createDiv({cls:"gc-column"}),h=u.createDiv({cls:"setting-item"});h.createEl("label",{text:"Enable AI module"});let j=h.createEl("input",{type:"checkbox"});j.checked=Boolean((nn=this.plugin.settings.ai)==null?void 0:nn.enabled),j.onchange=async()=>{var y,b;this.plugin.settings.ai||(this.plugin.settings.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",mixedOfferText:"I can also set this up for you. Shall I proceed?"}),this.plugin.settings.ai.enabled=j.checked,await this.plugin.saveSettings(),await((b=(y=this.plugin).toggleAiView)==null?void 0:b.call(y,j.checked))};let w=u.createDiv({cls:"setting-item"});w.createEl("label",{text:"Provider"});let x=w.createEl("select");["openai","anthropic","ollama"].forEach(y=>{let b=x.createEl("option",{text:y});b.value=y}),x.value=((on=this.plugin.settings.ai)==null?void 0:on.provider)||"openai",x.onchange=async()=>{if(!this.plugin.settings.ai)return;let y={openai:{baseUrl:"https://api.openai.com",model:"gpt-4o-mini"},anthropic:{baseUrl:"https://api.anthropic.com",model:"claude-3-5-sonnet-latest"},ollama:{baseUrl:"http://localhost:11434",model:"llama3.1"}};this.plugin.settings.ai.provider=x.value;let b=this.plugin.settings.ai.baseUrl||"",_=this.plugin.settings.ai.model||"",$=Object.values(y).map(G=>G.baseUrl),z=Object.values(y).map(G=>G.model);(!b||$.includes(b))&&(this.plugin.settings.ai.baseUrl=y[x.value].baseUrl),(!_||z.includes(_))&&(this.plugin.settings.ai.model=y[x.value].model),await this.plugin.saveSettings(),this.display()};let N=u.createDiv({cls:"setting-item"});N.createEl("label",{text:"API key (not required for local providers)"});let O=N.createEl("input",{type:"password"});O.placeholder="sk-...",O.value=((rn=this.plugin.settings.ai)==null?void 0:rn.apiKey)||"",O.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.apiKey=O.value.trim(),await this.plugin.saveSettings())};let K=u.createDiv({cls:"setting-item"});K.createEl("label",{text:"Model"});let Y=K.createEl("input",{type:"text"});Y.placeholder=((sn=this.plugin.settings.ai)==null?void 0:sn.provider)==="anthropic"?"claude-3-5-sonnet-latest":((an=this.plugin.settings.ai)==null?void 0:an.provider)==="ollama"?"llama3.1":"gpt-4o-mini",Y.value=((cn=this.plugin.settings.ai)==null?void 0:cn.model)||Y.placeholder,Y.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.model=Y.value.trim()||"gpt-4o-mini",await this.plugin.saveSettings())};let T=u.createDiv({cls:"setting-item"});T.createEl("label",{text:"Base URL"});let F=T.createEl("input",{type:"text"});F.placeholder=((ln=this.plugin.settings.ai)==null?void 0:ln.provider)==="anthropic"?"https://api.anthropic.com":((pn=this.plugin.settings.ai)==null?void 0:pn.provider)==="ollama"?"http://localhost:11434":"https://api.openai.com",F.value=((dn=this.plugin.settings.ai)==null?void 0:dn.baseUrl)||F.placeholder,F.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.baseUrl=F.value.trim()||"https://api.openai.com",await this.plugin.saveSettings())};let q=u.createDiv({cls:"setting-item"});q.createEl("label",{text:"Strict execution mode"});let ge=q.createEl("input",{type:"checkbox"});ge.checked=Boolean((un=this.plugin.settings.ai)==null?void 0:un.strictExecution),ge.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.strictExecution=ge.checked,await this.plugin.saveSettings())};let Te=u.createDiv({cls:"setting-item"});Te.createEl("label",{text:"Conversation memory (messages)"});let ne=Te.createEl("input",{type:"number"});ne.min="0",ne.max="50",ne.value=String((gn=(mn=this.plugin.settings.ai)==null?void 0:mn.memoryLimit)!=null?gn:10),ne.onchange=async()=>{if(!this.plugin.settings.ai)return;let y=Number(ne.value);this.plugin.settings.ai.memoryLimit=Number.isFinite(y)?Math.max(0,Math.min(50,y)):10,await this.plugin.saveSettings()};let Ue=u.createDiv({cls:"setting-item"});Ue.createEl("label",{text:"Mixed intent offer text"});let xe=Ue.createEl("textarea"),Et="I can also set this up for you. Shall I proceed?";xe.placeholder=Et,xe.value=((hn=this.plugin.settings.ai)==null?void 0:hn.mixedOfferText)||"",xe.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.mixedOfferText=xe.value.trim(),await this.plugin.saveSettings())};let He=u.createDiv({cls:"setting-item"});He.createEl("label",{text:"MCP servers (JSON array)"});let ze=He.createEl("textarea");ze.placeholder='[{"name":"calendar","url":"http://localhost:3000","apiKey":""}]',ze.value=JSON.stringify(((fn=this.plugin.settings.ai)==null?void 0:fn.mcpServers)||[]),ze.onchange=async()=>{if(this.plugin.settings.ai)try{let y=JSON.parse(ze.value||"[]");this.plugin.settings.ai.mcpServers=Array.isArray(y)?y:[],await this.plugin.saveSettings()}catch(y){new E.Notice("Invalid MCP servers JSON")}},n.createEl("h2",{text:"Archive"});let bt=this.plugin.settings.archivedRecords||{},Qt=bt&&!Array.isArray(bt)?bt:{},en={};for(let y of this.plugin.settings.dimensions)en[y.name]=(yn=y.order)!=null?yn:Number.MAX_SAFE_INTEGER;let bo=Object.keys(Qt).map(y=>{var b;return{name:y,order:(b=en[y])!=null?b:Number.MAX_SAFE_INTEGER}}).sort((y,b)=>y.order-b.order||y.name.localeCompare(b.name)),tn=!1;bo.forEach(({name:y,order:b})=>{let _=Qt[y]||{},$=Object.keys(_).filter(B=>Object.keys(_[B]||{}).length>0).sort();if($.length===0)return;tn=!0;let z=n.createDiv({cls:"dimension-setting"}),G=z.createDiv({cls:"dimension-header gc-row"}),ae=this.plugin.settings.dimensions.find(B=>B.name===y);ae&&G.createSpan({text:`${ae.order}. `}),G.createEl("b",{text:y}),G.createDiv({cls:"gc-spacer"});let ce=z.createDiv({cls:"categories-list gc-list"});$.forEach(B=>{let he=ce.createDiv({cls:"gc-list-item gc-row"}),Se=Object.keys((_==null?void 0:_[B])||{}).sort();he.createEl("b",{text:B});let Ie=he.createDiv({cls:"gc-id-wrap"});Se.length>0&&(Ie.createSpan({text:" "}),Se.forEach((A,S)=>{let C=Ie.createSpan({cls:"gc-id-chip"});C.style.display="inline-flex",C.style.alignItems="center",C.style.gap="4px";let k=C.createSpan({cls:"gc-id-tag",text:A}),I=Math.abs(xn(A))%360;k.style.backgroundColor=`hsl(${I}, 70%, 90%)`,k.style.color=`hsl(${I}, 70%, 25%)`;let R=C.createSpan({cls:"gc-id-actions"});R.style.display="none";let D=R.createEl("button",{cls:["gc-icon-button","clickable-icon"]});D.setAttr("aria-label",`Delete ${A}`),D.setAttr("title",`Delete ${A}`);try{(0,E.setIcon)(D,"trash")}catch(X){D.setText("Del")}D.onclick=async X=>{X.stopPropagation();let[,le]=await this.plugin.deleteArchivedProject(y,B,A);new E.Notice(le),this.display()},C.onmouseenter=()=>{R.style.display="inline-flex"},C.onmouseleave=()=>{R.style.display="none"},S<Se.length-1&&Ie.createSpan({text:" "})})),he.createDiv({cls:"gc-spacer"})})}),tn||n.createDiv({cls:"setting-item"}).createSpan({text:"No archived projects yet."})}};var _t=require("obsidian");var Cn=require("obsidian"),st=class extends Cn.Modal{constructor(n,o,r){super(n);this.prompt=o,this.callback=r}onOpen(){let{contentEl:n}=this;n.createEl("h2",{text:this.prompt});let o=n.createEl("input",{type:"text"});o.focus();let r=n.createEl("button",{text:"Submit"});r.onclick=()=>{let s=o.value.trim();this.close(),this.callback(s||null)}}onClose(){let{contentEl:n}=this;n.empty()}};var Rn=require("obsidian"),Oe=class extends Rn.Modal{constructor(n,o,r,s){super(n);this.prompt=o,this.choices=r,this.callback=s}onOpen(){let{contentEl:n}=this;n.createEl("h2",{text:this.prompt}),this.choices.forEach(o=>{let r=n.createEl("button",{text:o});r.onclick=()=>{this.close(),this.callback(o)}})}onClose(){let{contentEl:n}=this;n.empty()}};async function _e(e,t){return new Promise(n=>{new st(e,t,n).open()})}async function Re(e,t,n){return new Promise(o=>{new Oe(e,t,n,o).open()})}async function An(e,t){var m,f;let n=await _e(e,"Enter project name:");if(!n)return[null,"Project creation cancelled. No project name provided."];let o=await _e(e,"Enter project tag:");if(!o)return[null,"Project creation cancelled. No project tag provided."];let r=await _e(e,"Enter Project ID (used for task prefixes):");if(!r)return[null,"Project creation cancelled. No Project ID provided."];let s=await _e(e,"Enter parent name (optional):"),i=s&&s.trim().length>0?s.trim():null,a=[...t.dimensions].sort((P,v)=>{var u,h;return((u=P.order)!=null?u:0)-((h=v.order)!=null?h:0)}).map(P=>P.name),d=await Re(e,"Select dimension:",a);if(!d)return[null,"Project creation cancelled. No dimension selected."];let c=t.dimensions.find(P=>P.name===d);if(!c||c.categories.length===0)return[null,"Selected dimension has no categories. Please add categories in settings first."];let l=c.categories,g=await Re(e,"Select category:",l);if(!g)return[null,"Project creation cancelled. No category selected."];let p={name:n,tag:o,id:r,parent:i,dimension:d,category:g};try{let P=t.projectRecords;if(P&&!Array.isArray(P)&&((f=(m=P[d])==null?void 0:m[g])==null?void 0:f[r]))return[null,`Project with ID "${r}" already exists in ${d}:${g}. Choose a different ID.`]}catch(P){}try{let{validateProjectName:P,validateTag:v,ensureValidOrThrow:u}=await Promise.resolve().then(()=>(bn(),En));u(()=>P(p.name),"Invalid project name"),u(()=>v(p.tag),"Invalid tag"),u(()=>v(p.id),"Invalid Project ID")}catch(P){let v=P.message||"Invalid input";return console.error("Validation error:",P),[null,v]}return[p,"Project details collected."]}async function it(e,t){var l;if(!t.projectRecords)return[null,"You don't have any projects yet."];let n=t.projectRecords,o=[...t.dimensions].sort((g,p)=>{var m,f;return((m=g.order)!=null?m:0)-((f=p.order)!=null?f:0)}).map(g=>g.name),r=await Re(e,"Select dimension of your project:",o);if(!r)return[null,"Project action cancelled. No dimension selected."];let s=t.dimensions.find(g=>g.name===r);if(!s||s.categories.length===0)return[null,"Selected dimension has no categories. No project found."];let i=s.categories,a=await Re(e,"Select category:",i);if(!a)return[null,"Project action cancelled. No category selected."];let d=(l=n[r])==null?void 0:l[a];if(!d||Object.keys(d).length===0)return[null,"No projects found in this category."];let c=await Re(e,"Select Project:",Object.keys(d));return c?[{dimension:r,category:a,projectId:c},"Project details collected."]:[null,"Project action cancelled. No project selected."]}Ot();async function Dn(e){let[t,n]=await An(e.app,e.settings);if(t===null){new _t.Notice(n);return}let[,o]=await dt(e,t);new _t.Notice(o),console.log(o)}var Lt=require("obsidian");async function $n(e){let[t,n]=await it(e.app,e.settings);if(t===null){new Lt.Notice(n);return}let{dimension:o,category:r,projectId:s}=t,[,i]=await tt(e,o,r,s);new Lt.Notice(i),console.log(i)}var Bt=require("obsidian");async function On(e){let[t,n]=await it(e.app,e.settings);if(t===null){new Bt.Notice(n);return}let{dimension:o,category:r,projectId:s}=t,[,i]=await nt(e,o,r,s);new Bt.Notice(i),console.log(i)}var re=require("obsidian");async function _n(e){let t=[];for(let n of e)try{let o=`${n.url.replace(/\/$/,"")}/tools`,r=await fetch(o,{method:"GET",headers:n.apiKey?{"x-api-key":n.apiKey}:void 0});if(!r.ok)continue;let s=await r.json(),i=Array.isArray(s==null?void 0:s.tools)?s.tools:[];t.push({server:n,tools:i})}catch(o){}return t}function Ln(e,t){return t.map(n=>({name:`${e.name}:${n.name}`,description:n.description||"MCP tool",schema:n.inputSchema||{type:"object",properties:{},additionalProperties:!0},handler:async o=>or(e,n.name,o)}))}async function or(e,t,n){let o=`${e.url.replace(/\/$/,"")}/call`,r=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",...e.apiKey?{"x-api-key":e.apiKey}:{}},body:JSON.stringify({name:t,args:n})});if(!r.ok){let s=await r.text().catch(()=>"");throw new Error(`MCP call failed: ${r.status} ${s||r.statusText}`)}return await r.json().catch(()=>({}))}var ut={type:"object",description:"Reference to a project by tag, id, or full name.",properties:{tag:{type:"string"},id:{type:"string"},fullName:{type:"string"}},additionalProperties:!1},rr={type:"object",description:"Fields to set on the entity (camelCase, e.g. title, description).",properties:{title:{type:"string"},description:{type:"string"}},additionalProperties:!0};function mt(e){let t=e.getApi();return t?[{name:"resolveProject",description:"Resolve a project by tag, id, or full name.",schema:{type:"object",properties:{projectRef:ut},required:["projectRef"],additionalProperties:!1},handler:async n=>t.resolveProject(n.projectRef)},{name:"listEntityTypes",description:"List available entity types.",schema:{type:"object",properties:{},additionalProperties:!1},handler:async()=>t.listEntityTypes()},{name:"createProject",description:"Create a project with the required metadata.",schema:{type:"object",properties:{name:{type:"string"},tag:{type:"string"},id:{type:"string"},year:{type:"string"},dimension:{type:"string"},category:{type:"string"},parent:{type:"string"},projectTypeId:{type:"string"}},required:["name","tag","id","dimension","category"],additionalProperties:!1},handler:async n=>t.createProject(n)},{name:"createEntity",description:"Create an entity inside a project using a template.",schema:{type:"object",properties:{projectRef:ut,entityTypeId:{type:"string"},fields:rr},required:["projectRef","entityTypeId"],additionalProperties:!1},handler:async n=>t.createEntity(n)},{name:"patchMarker",description:"Patch content into a file at an AI marker.",schema:{type:"object",properties:{path:{type:"string"},marker:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","marker","content"],additionalProperties:!1},handler:async n=>t.patchMarker(n)},{name:"patchSection",description:"Patch content into a file by heading.",schema:{type:"object",properties:{path:{type:"string"},heading:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","heading","content"],additionalProperties:!1},handler:async n=>t.patchSection(n)},{name:"getChildren",description:"Get child projects for a given project.",schema:{type:"object",properties:{projectRef:ut,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async n=>t.getChildren(n.projectRef,n.archived)},{name:"getParents",description:"Get parent projects for a given project.",schema:{type:"object",properties:{projectRef:ut,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async n=>t.getParents(n.projectRef,n.archived)}]:[]}async function gt(e){var r;let t=((r=e.settings.ai)==null?void 0:r.mcpServers)||[];if(t.length===0)return[];let n=await _n(t),o=[];for(let s of n)o.push(...Ln(s.server,s.tools));return o}async function*Bn(e,t,n){var l,g;let o=`${e.baseUrl.replace(/\/$/,"")}/v1/chat/completions`,r={model:e.model,messages:t.map(p=>{let m={role:p.role,content:p.content};return p.role==="tool"&&p.toolCallId&&(m.tool_call_id=p.toolCallId),p.role==="assistant"&&p.toolCalls&&p.toolCalls.length>0&&(m.tool_calls=p.toolCalls.map(f=>{var P;return{id:f.id,type:"function",function:{name:f.name,arguments:JSON.stringify((P=f.arguments)!=null?P:{})}}})),m}),tools:n.map(p=>({type:"function",function:{name:p.name,description:p.description,parameters:p.schema}})),tool_choice:"auto",stream:!0},s={"Content-Type":"application/json"};e.apiKey&&(s.Authorization=`Bearer ${e.apiKey}`);let i=await fetch(o,{method:"POST",headers:s,body:JSON.stringify(r)});if(!i.ok||!i.body){let p=await sr(i);throw new Error(`OpenAI request failed: ${i.status} ${p||i.statusText}`)}let a=i.body.getReader(),d=new TextDecoder,c="";for(;;){let{value:p,done:m}=await a.read();if(m)break;c+=d.decode(p,{stream:!0});let f=c.split(`
`);c=f.pop()||"";for(let P of f){let v=P.trim();if(!v.startsWith("data:"))continue;let u=v.replace(/^data:\s*/,"");if(u==="[DONE]"){yield{type:"done"};return}let h;try{h=JSON.parse(u)}catch(w){continue}let j=(g=(l=h==null?void 0:h.choices)==null?void 0:l[0])==null?void 0:g.delta;j&&(j.content&&(yield{type:"content",delta:j.content}),j.tool_calls&&(yield{type:"tool_call_delta",toolCalls:j.tool_calls.map(x=>{var N,O;return{index:x.index,id:x.id,name:(N=x.function)==null?void 0:N.name,arguments:(O=x.function)==null?void 0:O.arguments}})}))}}yield{type:"done"}}async function sr(e){try{return await e.text()}catch(t){return""}}async function*Gn(e,t,n){let o=`${e.baseUrl.replace(/\/$/,"")}/v1/messages`,{system:r,anthropicMessages:s}=ir(t),i={model:e.model,max_tokens:1024,system:r,messages:s,tools:n.map(p=>({name:p.name,description:p.description,input_schema:p.schema})),stream:!0},a=await fetch(o,{method:"POST",headers:{"x-api-key":e.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify(i)});if(!a.ok||!a.body){let p=await ar(a);throw new Error(`Anthropic request failed: ${a.status} ${p||a.statusText}`)}let d=a.body.getReader(),c=new TextDecoder,l="",g=new Set;for(;;){let{value:p,done:m}=await d.read();if(m)break;l+=c.decode(p,{stream:!0});let f=l.split(`
`);l=f.pop()||"";for(let P of f){let v=P.trim();if(!v.startsWith("data:"))continue;let u=v.replace(/^data:\s*/,"");if(!u||u==="[DONE]"){yield{type:"done"};return}let h;try{h=JSON.parse(u)}catch(w){continue}let j=h==null?void 0:h.type;if(j==="content_block_delta"){let w=h.delta;if((w==null?void 0:w.type)==="text_delta"&&(yield{type:"content",delta:w.text}),(w==null?void 0:w.type)==="input_json_delta"){if(g.has(h.index))continue;yield{type:"tool_call_delta",toolCalls:[{index:h.index,arguments:w.partial_json}]}}}if(j==="content_block_start"){let w=h.content_block;if((w==null?void 0:w.type)==="tool_use"){let x=w.input&&Object.keys(w.input).length>0;x&&g.add(h.index),yield{type:"tool_call_delta",toolCalls:[{index:h.index,id:w.id,name:w.name,arguments:x?JSON.stringify(w.input):""}]}}}if(j==="message_stop"){yield{type:"done"};return}}}yield{type:"done"}}function ir(e){let t="",n=[];for(let o of e){if(o.role==="system"){t=[t,o.content].filter(Boolean).join(`
`);continue}if(o.role==="user"){n.push({role:"user",content:[{type:"text",text:o.content}]});continue}if(o.role==="assistant"){let r=[];if(o.content&&r.push({type:"text",text:o.content}),o.toolCalls&&o.toolCalls.length>0)for(let s of o.toolCalls)r.push({type:"tool_use",id:s.id||`tool-${s.name}`,name:s.name,input:s.arguments||{}});r.length>0&&n.push({role:"assistant",content:r});continue}o.role==="tool"&&n.push({role:"user",content:[{type:"tool_result",tool_use_id:o.toolCallId||o.name||"tool",content:o.content}]})}return{system:t,anthropicMessages:n}}async function ar(e){try{return await e.text()}catch(t){return""}}async function*me(e,t,n){if(e.provider==="anthropic"){if(!e.apiKey)throw new Error("Anthropic API key is missing");yield*Gn({apiKey:e.apiKey,model:e.model||"claude-3-5-sonnet-latest",baseUrl:e.baseUrl||"https://api.anthropic.com"},t,n);return}let o=e.provider==="ollama"?e.baseUrl||"http://localhost:11434":e.baseUrl||"https://api.openai.com";if(!e.apiKey&&e.provider!=="ollama")throw new Error("OpenAI API key is missing");yield*Bn({apiKey:e.apiKey||"",model:e.model||(e.provider==="ollama"?"llama3.1":"gpt-4o-mini"),baseUrl:o},t,n)}function ht(e,t){for(let n of e){let o=t.get(n.index)||{name:"",arguments:{}};if(n.id&&(o.id=n.id),n.name&&(o.name=n.name),typeof n.arguments=="string"){let r=o._rawArgs||"";o._rawArgs=r+n.arguments}t.set(n.index,o)}}function ft(e){let t=[];for(let[,n]of e){let o=n._rawArgs;if(o)try{n.arguments=JSON.parse(o)}catch(r){n.arguments={}}delete n._rawArgs,t.push(n)}return t}function Gt(e){let t=new Set(["resolveProject","listProjects","listEntityTypes","describeEntityType","listProjectTypes","describeProjectType","getChildren","getParents"]);return e.filter(n=>t.has(n.name)||n.name.includes(":"))}function Jn(e){var n;let t=[];for(let o of e)!o.ok&&((n=o.error)!=null&&n.startsWith("Missing required fields:"))&&o.error.split(":").slice(1).join(":").split(",").forEach(s=>{let i=s.trim();i&&t.push(i)});return t}function Jt(e){let t=e.trim().toLowerCase();return["yes","y","confirm","ok","okay","proceed"].includes(t)}function Vt(e){let t=e.trim().toLowerCase();return["no","n","cancel","stop"].includes(t)}function yt(e,t,n="$",o=[]){if(!e)return o;let r=e.type?Array.isArray(e.type)?e.type:[e.type]:[];if(r.length>0&&!r.some(i=>cr(i,t)))return o.push({path:n,message:`Expected ${r.join("|")}`}),o;if(e.enum&&!e.enum.includes(t)&&o.push({path:n,message:"Value not in enum"}),e.type==="object"&&t&&typeof t=="object"&&!Array.isArray(t)){let s=t;if((e.required||[]).forEach(a=>{a in s||o.push({path:`${n}.${a}`,message:"Missing required field"})}),e.properties)for(let[a,d]of Object.entries(e.properties))a in s&&yt(d,s[a],`${n}.${a}`,o)}return e.type==="array"&&Array.isArray(t)&&e.items&&t.forEach((s,i)=>{yt(e.items,s,`${n}[${i}]`,o)}),o}function cr(e,t){return e==="array"?Array.isArray(t):e==="integer"?Number.isInteger(t):e==="number"?typeof t=="number":e==="boolean"?typeof t=="boolean":e==="string"?typeof t=="string":e==="object"?t!=null&&typeof t=="object"&&!Array.isArray(t):!0}async function vt(e,t){let n=[],o=new Map(t.map(r=>[r.name,r]));for(let r of e){let s=o.get(r.name);if(!s){n.push({toolName:r.name,ok:!1,error:"Tool not found"});continue}let i=yt(s.schema,r.arguments);if(i.length>0){n.push({toolName:r.name,ok:!1,error:`Schema validation failed: ${i.map(a=>`${a.path}: ${a.message}`).join(", ")}`});continue}try{let a=await s.handler(r.arguments);n.push({toolName:r.name,ok:!0,result:a})}catch(a){n.push({toolName:r.name,ok:!1,error:(a==null?void 0:a.message)||"Tool execution failed"})}}return n}function Ut(e){if(e==null)return"(no result)";if(typeof e=="string")return e;try{return JSON.stringify(e)}catch(t){return String(e)}}function Vn(e){return new Promise(t=>setTimeout(t,e))}var Un=new Set(["resolveProject","createEntity","getChildren","getParents"]);function lr(e,t){if(!(!t||!t.projectId))for(let n of e){if(!Un.has(n.name))continue;let o=n.arguments;o.projectRef||(o.projectRef={id:t.projectId})}}function pr(e,t,n){for(let o=0;o<n.length;o+=1){let r=n[o];if(!r.ok)continue;let s=t[o];if(s){if(s.name==="resolveProject"){let i=r.result;if(i!=null&&i.entry){let a=i.entry;e.setProjectContext({projectId:a.projectId,projectTag:a.projectTag,fullName:a.fullName})}continue}if(Un.has(s.name)){let i=s.arguments;e.setProjectContextFromRef(i.projectRef);continue}if(s.name==="createProject"){let i=s.arguments;i!=null&&i.id&&(i!=null&&i.tag)&&(i!=null&&i.name)&&e.setProjectContext({projectId:String(i.id),projectTag:String(i.tag),fullName:String(i.name)})}}}}async function Hn(e){var n,o,r,s;let t=(n=e.maxSteps)!=null?n:6;for(let i=0;i<t;i+=1){let a=e.ui.appendMessage("assistant",""),d=new Map,c=new Map,l=Boolean((o=e.plugin.settings.ai)==null?void 0:o.strictExecution),g=2,p=0;for(;;)try{for await(let u of me(e.plugin.settings.ai,e.messages,e.tools)){if(u.type==="content"&&u.delta){let h=(a==null?void 0:a.textContent)||"";e.ui.updateMessage(a,h+u.delta)}if(u.type==="tool_call_delta"&&u.toolCalls){ht(u.toolCalls,c);for(let h of u.toolCalls)if(h.name&&!d.has(h.name)){let j=e.ui.appendMessage("tool",`Using tool: ${h.name}`);j&&d.set(h.name,j)}}}break}catch(u){if(p+=1,p>g)throw u;e.ui.appendMessage("tool",`Retrying LLM request (${p}/${g})...`),await Vn(300*p)}let m=ft(c),f=(a==null?void 0:a.textContent)||"";if(e.messages.push({role:"assistant",content:f,toolCalls:m}),e.state.appendMessage({role:"assistant",content:f}),m.length===0)return;lr(m,e.state.getProjectContext());for(let u of m)e.ui.appendMessage("tool",`Tool call: ${u.name} ${Ut(u.arguments)}`);let P=await vt(m,e.tools);pr(e.state,m,P);let v=Jn(P);for(let u=0;u<P.length;u+=1){let h=P[u],j=h.ok?{ok:!0,result:h.result}:{ok:!1,error:h.error},w=h.ok?`Tool result (${h.toolName}): ${Ut(h.result)}`:`Tool error (${h.toolName}): ${h.error}`;e.ui.appendMessage("tool",w),e.state.appendMessage({role:"tool",name:h.toolName,toolCallId:(r=m[u])==null?void 0:r.id,content:JSON.stringify(j)}),e.state.recordToolLog(h.toolName,h.ok,h.error),e.messages.push({role:"tool",name:h.toolName,toolCallId:(s=m[u])==null?void 0:s.id,content:JSON.stringify(j)})}if(l&&P.some(u=>!u.ok)){e.ui.appendMessage("assistant","Strict mode: tool execution failed. Please adjust input and try again.");return}if(v.length>0){let u=Array.from(new Set(v));e.ui.appendMessage("assistant",`Missing required fields: ${u.join(", ")}. Please provide them and try again.`);return}}e.ui.appendMessage("assistant","Stopped after reaching max tool steps.")}var dr=["You are a planner for ProjectFlow AI.","Return ONLY valid JSON with keys: needsFollowup (boolean), question (string), plan (string), context (string), fields (object).","fields must include required values for createEntity/createProject when applicable (e.g., TITLE, DESCRIPTION).","If you need more info, set needsFollowup=true and ask a concise question.","If you have enough info, set needsFollowup=false and provide a short plan, context summary, and fields.","If a chat project context is provided, assume that project and do NOT ask the user to choose a project.","When planning createProject, do not include the year in the name; use a separate year field if needed.","Do NOT call tools in this stage.","Format text in `question` and `plan` keys as markdown"].join(`
`);async function Ht(e){var s;let t=e.chatProjectContext?`${e.chatProjectContext.projectId} (${e.chatProjectContext.projectTag})`:"(none)",n=[{role:"system",content:`${dr}
Chat project context: ${t}`},...e.messages.filter(i=>i.role!=="tool")],o=await ur({plugin:e.plugin,messages:n,tools:e.tools,allowToolCalls:(s=e.allowToolCalls)!=null?s:!1}),r=mr(o);return r||{needsFollowup:!1,plan:"",context:"",fields:{}}}async function ur(e){var r;let t="",o=e.allowToolCalls?e.tools:[];for(let s=0;s<6;s+=1){let i=new Map;t="";for await(let c of me(e.plugin.settings.ai,e.messages,o))c.type==="content"&&c.delta&&(t+=c.delta),c.type==="tool_call_delta"&&c.toolCalls&&ht(c.toolCalls,i);let a=ft(i);if(e.messages.push({role:"assistant",content:t,toolCalls:a}),a.length===0||!e.allowToolCalls)return t.trim();let d=await vt(a,e.tools);for(let c=0;c<d.length;c+=1){let l=d[c],g=l.ok?{ok:!0,result:l.result}:{ok:!1,error:l.error};e.messages.push({role:"tool",name:l.toolName,toolCallId:(r=a[c])==null?void 0:r.id,content:JSON.stringify(g)})}}return t.trim()}function mr(e){let t=e.indexOf("{"),n=e.lastIndexOf("}");if(t===-1||n===-1||n<=t)return null;let o=e.slice(t,n+1);try{let r=JSON.parse(o),s=r.fields&&typeof r.fields=="object"?r.fields:{};return{needsFollowup:Boolean(r.needsFollowup),question:typeof r.question=="string"?r.question:"",plan:typeof r.plan=="string"?r.plan:"",context:typeof r.context=="string"?r.context:"",fields:s}}catch(r){return null}}function zn(e){let t=e.app.workspace.getActiveFile();if(!t)return null;let n=e.settings.projectIndex;if(!n)return null;let o=t.path,r=Object.values(n.byFullName||{}),s=null;for(let i of r)i.path&&o.startsWith(i.path)&&(!s||i.path.length>s.path.length)&&(s=i);return s}function Wn(e,t,n=5){let o=e.settings.projectIndex;if(!o)return[];let r=t.trim().toLowerCase();return r?Object.values(o.byFullName||{}).map(a=>{var g,p;let d=((g=a.projectTag)==null?void 0:g.toLowerCase())||"",c=((p=a.projectName)==null?void 0:p.toLowerCase())||"",l=0;return d===r&&(l+=100),c===r&&(l+=90),d.startsWith(r)&&(l+=60),c.startsWith(r)&&(l+=50),d.includes(r)&&(l+=30),c.includes(r)&&(l+=20),{entry:a,score:l}}).filter(a=>a.score>0).sort((a,d)=>d.score-a.score).slice(0,n).map(a=>a.entry):[]}async function Pt(e,t){let n=gr(e),o=e.app.workspace.getActiveFile(),r="";if(o)try{r=(await e.app.vault.cachedRead(o)).slice(0,1e3)}catch(c){r=""}let s=e.settings.projectIndex,i=zn(e),a=hr(e),d=t?`${t.projectId} (${t.projectTag})`:"(none)";return["You are ProjectFlow AI. You must use tools to perform any actions.","Never edit markdown directly; use tools only.","Respond with tool calls when an action is required.","If required fields are missing, ask the user for them instead of calling tools.","If a chat project context is available, use it as the default projectRef and do not ask for project selection unless the user wants to change it.","When creating projects, use a separate year field if needed; do not include the year inside the name.","Use camelCase fields in createEntity (e.g., fields.title, fields.description).",'Example tool call: createEntity { projectRef:{tag:"my-tag"}, entityTypeId:"task", fields:{ title:"...", description:"..." } }',"Context:",`Selected text: ${n||"(none)"}`,`Active file: ${(o==null?void 0:o.path)||"(none)"}`,`Active file content (truncated): ${r||"(none)"}`,`Active project: ${i?`${i.projectTag} (${i.fullName})`:"(none)"}`,`Chat project context: ${d}`,`Entity required fields: ${a}`,`Project index snapshot: ${s?JSON.stringify(s):"(none)"}`].join(`
`)}function gr(e){var n;let t=(n=e.app.workspace.activeEditor)==null?void 0:n.editor;return t?t.getSelection():""}function hr(e){let t=e.settings.entityTypes||{},n={};for(let[o,r]of Object.entries(t))r!=null&&r.requiredFields&&r.requiredFields.length>0&&(n[o]=r.requiredFields);try{return JSON.stringify(n)}catch(o){return"(unavailable)"}}var fr=["You are an intent classifier for an Obsidian productivity assistant.","Classify the user input into exactly one of: chat, action, mixed, unclear.","Definitions:","chat: user is asking a question or discussing concepts. No execution requested.","action: user explicitly requests operations such as creating, updating, deleting projects, tasks, notes, or structures.","mixed: user asks a question AND requests an action in the same message.","unclear: not enough information to decide.","Respond ONLY with valid JSON:",'{"intent":"...","reason":"...","confidence":0.0}',"Do not include markdown."].join(`
`),Kn={intent:"chat",reason:"Invalid classifier output.",confidence:0};async function Yn(e,t){let n=[{role:"system",content:fr},{role:"user",content:e}],o="";try{for await(let s of me(t,n,[]))s.type==="content"&&s.delta&&(o+=s.delta);let r=yr(o);return r!=null?r:Kn}catch(r){return Kn}}function yr(e){let t=e.indexOf("{"),n=e.lastIndexOf("}");if(t===-1||n===-1||n<=t)return null;let o=e.slice(t,n+1);try{let r=JSON.parse(o),s=vr(r.intent);if(!s)return null;let i=typeof r.confidence=="number"&&r.confidence>=0&&r.confidence<=1?r.confidence:0;return{intent:s,reason:typeof r.reason=="string"?r.reason:"",confidence:i}}catch(r){return null}}function vr(e){if(typeof e!="string")return null;let t=e.trim().toLowerCase();return t==="chat"||t==="action"||t==="mixed"||t==="unclear"?t:null}var Pr=["You are a helpful Obsidian assistant.","Answer conversationally.","Be concise.","Do not propose plans unless explicitly asked.","Do not call tools.","If the user implies possible actions, suggest them softly."].join(`
`),jr="I can also set this up for you. Shall I proceed?",be=class{constructor(t,n,o){this.plugin=t;this.ui=n;this.state=o;this.busy=!1;this.pendingPlan=null;this.pendingMixedInput=null;this.pendingPlan=this.state.getPendingPlan()}async handleSend(t){if(this.busy)return;let n=t.trim();if(!n)return;this.ui.appendMessage("user",n);let o=this.plugin.settings.ai;if(!(o!=null&&o.enabled)){this.ui.appendMessage("assistant","AI module is disabled in settings.");return}if(!o.apiKey&&o.provider!=="ollama"){await this.handleTagLookup(n);return}await this.handleLLM(n)}onClose(){this.state.flushConversation()}clearConversation(){this.pendingPlan=null,this.state.clearConversation(),this.state.setPendingPlan(null),this.ui.clearMessages(),this.ui.appendMessage("assistant","Conversation cleared.")}async handleFollowup(t){let n=this.pendingPlan;if(!n)return;let o=t.trim();if(!o)return;this.state.appendMessage({role:"user",content:o});let r=mt(this.plugin),s=await gt(this.plugin),i=[...r,...s];if(n.status==="awaiting_confirmation"){if(Jt(o)){let j=await Pt(this.plugin,this.getChatProjectContext()),w=this.state.getConversationWindow().filter(O=>O.role!=="tool"),x=[`Original request: ${n.originalInput}`,n.plan?`Plan: ${n.plan}`:"",n.context?`Context: ${n.context}`:"",n.fields?`Fields: ${JSON.stringify(n.fields)}`:"",n.clarifications&&n.clarifications.length>0?`Clarifications: ${n.clarifications.join(" | ")}`:"","User confirmed to proceed."].filter(Boolean).join(`
`),N=[{role:"system",content:j},...w,{role:"user",content:x}];this.setPendingPlan(null),await Hn({plugin:this.plugin,ui:this.ui,state:this.state,messages:N,tools:i});return}if(Vt(o)){this.setPendingPlan(null),this.ui.appendMessage("assistant","Cancelled. Tell me if you want to try a different action."),this.state.appendMessage({role:"assistant",content:"Cancelled. Tell me if you want to try a different action."});return}this.ui.appendConfirmationActions(),this.ui.appendMessage("assistant","Please confirm to proceed with these actions."),this.state.appendMessage({role:"assistant",content:"Please confirm to proceed with these actions."});return}let a=Gt(i),d=await Pt(this.plugin,this.getChatProjectContext()),c=this.state.getConversationWindow().filter(j=>j.role!=="tool"),l=n.clarifications||[];l.push(o),n.clarifications=l;let g=[`Original request: ${n.originalInput}`,n.plan?`Plan so far: ${n.plan}`:"",n.context?`Context so far: ${n.context}`:"",`User clarification: ${o}`].filter(Boolean).join(`
`),p=[{role:"system",content:d},...c,{role:"user",content:g}],m=await Ht({plugin:this.plugin,messages:p,tools:a,allowToolCalls:!1,chatProjectContext:this.getChatProjectContext()});if(m.needsFollowup&&m.question){n.plan=m.plan,n.context=m.context,n.question=m.question,n.fields=m.fields,n.status="clarifying",this.setPendingPlan(n),this.ui.appendMessage("assistant",m.question),this.state.appendMessage({role:"assistant",content:m.question});return}n.plan=m.plan,n.context=m.context,n.fields=m.fields,n.status="awaiting_confirmation",this.setPendingPlan(n);let f=m.plan?`Planned steps: ${m.plan}`:"",P=m.context?`Planner context: ${m.context}`:"",v=m.fields&&Object.keys(m.fields).length>0?`Fields: 
 \`\`\`json 
${JSON.stringify(m.fields)}
 \`\`\``:"",u=[f,P,v].filter(Boolean).join(`
`);u&&(this.ui.appendMessage("assistant",u),this.state.appendMessage({role:"assistant",content:u})),this.ui.appendConfirmationActions();let h="Please confirm to proceed with these actions.";this.ui.appendMessage("assistant",h),this.state.appendMessage({role:"assistant",content:h})}async handleTagLookup(t){let n=this.plugin.getApi();if(!n){this.ui.appendMessage("assistant","Core API is not available.");return}try{let o=n.resolveProject({tag:t});if(!o){let r=Wn(this.plugin,t);if(r.length===0)this.ui.appendMessage("assistant","Project not found.");else if(r.length===1)this.ui.appendMessage("assistant",`Resolved project: ${r[0].fullName} (${r[0].projectTag})`),this.state.setProjectContext({projectId:r[0].projectId,projectTag:r[0].projectTag,fullName:r[0].fullName});else{let s=r.map(i=>`- ${i.projectTag} (${i.fullName})`).join(`
`);this.ui.appendMessage("assistant",`Multiple matches found:
${s}`)}return}this.ui.appendMessage("assistant",`Resolved project: ${o.entry.fullName} (${o.entry.projectTag})`),this.state.setProjectContext({projectId:o.entry.projectId,projectTag:o.entry.projectTag,fullName:o.entry.fullName})}catch(o){this.ui.appendMessage("assistant",(o==null?void 0:o.message)||"Failed to resolve project.")}}async handleLLM(t){if(!this.busy){this.busy=!0,this.ui.setBusy(!0);try{this.pendingPlan?await this.handleFollowup(t):this.pendingMixedInput?await this.handleMixedFollowup(t):await this.handleNewRequest(t)}catch(n){this.ui.appendMessage("assistant",(n==null?void 0:n.message)||"LLM request failed.")}finally{this.busy=!1,this.ui.setBusy(!1)}}}async handleNewRequest(t){let n=this.state.getConversationWindow().filter(s=>s.role!=="tool");this.state.appendMessage({role:"user",content:t});let o=this.plugin.settings.ai,r=await Yn(t,o);if(r.intent==="action"){await this.handleActionRequest(t,n);return}if(r.intent==="mixed"){await this.handleMixedRequest(t,n);return}if(r.intent==="unclear"){let s="Could you clarify what you'd like me to do?";this.ui.appendMessage("assistant",s),this.state.appendMessage({role:"assistant",content:s});return}await this.handleChatRequest(t,n)}async handleChatRequest(t,n){let o=[{role:"system",content:Pr},...n,{role:"user",content:t}],r=this.ui.appendMessage("assistant",""),s="";for await(let i of me(this.plugin.settings.ai,o,[]))i.type==="content"&&i.delta&&(s+=i.delta,this.ui.updateMessage(r,s));return r||this.ui.appendMessage("assistant",s),this.state.appendMessage({role:"assistant",content:s}),s}async handleActionRequest(t,n){let o=mt(this.plugin),r=await gt(this.plugin),s=[...o,...r],i=Gt(s),a=await Pt(this.plugin,this.getChatProjectContext()),d=t,c=t.trim(),l=n;if(l.length>0){let h=l[l.length-1];h.role==="user"&&h.content.trim()===c&&(l=l.slice(0,-1))}let g=[{role:"system",content:a},...l,{role:"user",content:d}],p=await Ht({plugin:this.plugin,messages:g,tools:i,allowToolCalls:!1,chatProjectContext:this.getChatProjectContext()});if(p.needsFollowup&&p.question){this.setPendingPlan({originalInput:t,plan:p.plan,context:p.context,question:p.question,fields:p.fields,createdAt:new Date().toISOString(),status:"clarifying",clarifications:[]}),this.ui.appendMessage("assistant",p.question),this.state.appendMessage({role:"assistant",content:p.question});return}let m=p.plan?`Planned steps: ${p.plan}`:"",f=p.context?`Planner context: ${p.context}`:"",P=p.fields&&Object.keys(p.fields).length>0?`Fields: ${JSON.stringify(p.fields)}`:"",v=[m,f,P].filter(Boolean).join(`
`);v&&(this.ui.appendMessage("assistant",v),this.state.appendMessage({role:"assistant",content:v})),this.setPendingPlan({originalInput:t,plan:p.plan,context:p.context,fields:p.fields,createdAt:new Date().toISOString(),status:"awaiting_confirmation",clarifications:[]}),this.ui.appendConfirmationActions();let u="Please confirm to proceed with these actions.";this.ui.appendMessage("assistant",u),this.state.appendMessage({role:"assistant",content:u})}async handleMixedRequest(t,n){await this.handleChatRequest(t,n);let o=this.getMixedOfferText();this.ui.appendMessage("assistant",o),this.state.appendMessage({role:"assistant",content:o}),this.pendingMixedInput=t}async handleMixedFollowup(t){let n=this.pendingMixedInput;if(!n)return;let o=t.trim();if(!o)return;if(this.state.appendMessage({role:"user",content:o}),Jt(o)){this.pendingMixedInput=null;let s=this.state.getConversationWindow().filter(i=>i.role!=="tool");await this.handleActionRequest(n,s);return}if(Vt(o)){this.pendingMixedInput=null;let s="Okay. Let me know if you'd like me to set it up.";this.ui.appendMessage("assistant",s),this.state.appendMessage({role:"assistant",content:s});return}let r="Please confirm if you'd like me to proceed.";this.ui.appendMessage("assistant",r),this.state.appendMessage({role:"assistant",content:r})}getMixedOfferText(){var n,o;return((o=(n=this.plugin.settings.ai)==null?void 0:n.mixedOfferText)==null?void 0:o.trim())||jr}getChatProjectContext(){let t=this.state;return t&&typeof t.getProjectContext=="function"?t.getProjectContext():null}setPendingPlan(t){this.pendingPlan=t,this.state.setPendingPlan(t)}};var wr="ai-conversations.json";var qn="New chat";function zt(){let e=Math.random().toString(36).slice(2,8);return`conv_${Date.now().toString(36)}_${e}`}function jt(e){let t=(e||"").replace(/\s+/g," ").trim();return t?t.slice(0,60):qn}function Tr(e){return jt(e)}function xr(e){return e==="system"||e==="user"||e==="assistant"||e==="tool"}function Cr(e){var t,n,o;if(typeof e=="string"){let r=e.trim();return r.startsWith("project/")?{tag:r}:r.includes(".")?{fullName:r}:{id:r}}return{fullName:(t=e.fullName)==null?void 0:t.trim(),id:(n=e.id)==null?void 0:n.trim(),tag:(o=e.tag)==null?void 0:o.trim()}}var Ae=class{constructor(t){this.plugin=t;this.data={schemaVersion:1,conversations:[]};this.persistTimer=null}static async create(t){let n=new Ae(t);return await n.load(),n}getConversationWindow(){var o,r;let t=Math.max(0,(r=(o=this.plugin.settings.ai)==null?void 0:o.memoryLimit)!=null?r:10);if(t===0)return[];let n=this.getActiveConversation();return n?n.messages.slice(-t):[]}getActiveConversationId(){var t;return(t=this.data.activeConversationId)!=null?t:null}getActiveConversationTitle(){var t;return((t=this.getActiveConversation())==null?void 0:t.title)||""}getActiveConversationMessages(){let t=this.getActiveConversation();return t?t.messages.slice():[]}getConversationSummaries(){return[...this.data.conversations].sort((t,n)=>n.updatedAt.localeCompare(t.updatedAt)).map(t=>({id:t.id,title:t.title,createdAt:t.createdAt,updatedAt:t.updatedAt,messageCount:t.messages.length}))}getConversationProjectId(t){var o;let n=this.getActiveConversationById(t);return((o=n==null?void 0:n.projectContext)==null?void 0:o.projectId)||null}getProjectContext(){let t=this.getActiveConversation();return(t==null?void 0:t.projectContext)||null}setProjectContext(t){let n=this.getActiveConversation();n&&(n.projectContext=t,n.updatedAt=new Date().toISOString(),this.persistConversation())}setProjectContextFromRef(t){if(!t)return;let n=this.resolveProjectRef(t);n&&this.setProjectContext({projectId:n.projectId,projectTag:n.projectTag,fullName:n.fullName})}clearProjectContext(){this.setProjectContext(null)}createConversation(t){let n=new Date().toISOString(),o={id:zt(),title:jt(t),createdAt:n,updatedAt:n,messages:[],pendingPlan:null,projectContext:null};return this.data.conversations.push(o),this.data.activeConversationId=o.id,this.persistConversation(),o.id}renameConversation(t,n){let o=this.data.conversations.find(r=>r.id===t);o&&(o.title=jt(n),o.updatedAt=new Date().toISOString(),this.persistConversation())}removeConversation(t){let n=this.data.activeConversationId;if(this.data.conversations=this.data.conversations.filter(o=>o.id!==t),n===t){let o=this.data.conversations[0];this.data.activeConversationId=o?o.id:void 0}this.persistConversation()}setActiveConversation(t){this.data.conversations.some(n=>n.id===t)&&(this.data.activeConversationId=t,this.persistConversation())}clearActiveConversation(){this.data.activeConversationId=void 0,this.persistConversation()}appendMessage(t){let n=this.getActiveConversation();if(!n){let o=this.createConversation();if(n=this.getActiveConversationById(o),!n)return}n.messages.push({role:t.role,content:t.content,name:t.name,toolCallId:t.toolCallId}),n.updatedAt=new Date().toISOString(),n.title===qn&&t.role==="user"&&(n.title=Tr(t.content)),this.persistConversation()}clearConversation(){let t=this.getActiveConversation();t&&(t.messages=[],t.pendingPlan=null,t.updatedAt=new Date().toISOString(),this.persistConversation())}flushConversation(){this.persistTimer&&(window.clearTimeout(this.persistTimer),this.persistTimer=null),this.writeNow()}recordToolLog(t,n,o){if(!this.plugin.settings.ai)return;let r=this.plugin.settings.ai.toolLog||[];r.push({ts:new Date().toISOString(),toolName:t,ok:n,error:o});let s=r.slice(-200);this.plugin.settings.ai.toolLog=s,this.plugin.saveSettings()}getPendingPlan(){let t=this.getActiveConversation();return(t==null?void 0:t.pendingPlan)||null}setPendingPlan(t){let n=this.getActiveConversation();n&&(n.pendingPlan=t,n.updatedAt=new Date().toISOString(),this.persistConversation())}resolveProjectRef(t){let n=this.plugin.settings.projectIndex;if(!n)return null;let o=Cr(t);return o.fullName&&n.byFullName[o.fullName]||o.id&&n.byId[o.id]||o.tag&&n.byTag[o.tag]||null}getActiveConversation(){let t=this.data.activeConversationId;return t&&this.getActiveConversationById(t)||null}getActiveConversationById(t){return this.data.conversations.find(n=>n.id===t)||null}persistConversation(){this.persistTimer&&window.clearTimeout(this.persistTimer),this.persistTimer=window.setTimeout(()=>{this.writeNow()},400)}async load(){var a,d,c;let t=this.plugin.app.vault.adapter,n=this.getDataPath();if(await t.exists(n))try{let l=await t.read(n);this.data=this.normalizeData(JSON.parse(l))}catch(l){this.data={schemaVersion:1,conversations:[]}}let r=((a=this.plugin.settings.ai)==null?void 0:a.conversation)||[],s=(c=(d=this.plugin.settings.ai)==null?void 0:d.pendingPlan)!=null?c:null;if(this.data.conversations.length===0&&(r.length>0||s)){let l=new Date().toISOString(),g={id:zt(),title:"Migrated chat",createdAt:l,updatedAt:l,messages:r.map(p=>({role:p.role,content:p.content,name:p.name,toolCallId:p.toolCallId})),pendingPlan:s};this.data.conversations.push(g),this.data.activeConversationId=g.id,await this.cleanupLegacySettings(),await this.writeNow();return}this.data.activeConversationId||this.data.conversations.length>0&&(this.data.activeConversationId=this.data.conversations[0].id)}normalizeData(t){var s;let n={schemaVersion:1,activeConversationId:typeof(t==null?void 0:t.activeConversationId)=="string"?t.activeConversationId:void 0,conversations:[]},o=Array.isArray(t==null?void 0:t.conversations)?t.conversations:[],r=new Set;for(let i of o){if(!i||typeof i!="object")continue;let a=typeof i.id=="string"?i.id:zt();if(r.has(a))continue;r.add(a);let d=jt(i.title),c=typeof i.createdAt=="string"?i.createdAt:new Date().toISOString(),l=typeof i.updatedAt=="string"?i.updatedAt:c,g=Array.isArray(i.messages)?i.messages.filter(f=>f&&typeof f.content=="string"&&xr(f.role)).map(f=>({role:f.role,content:f.content,name:typeof f.name=="string"?f.name:void 0,toolCallId:typeof f.toolCallId=="string"?f.toolCallId:void 0})):[],p=(s=i.pendingPlan)!=null?s:null,m=i.projectContext&&typeof i.projectContext=="object"?{projectId:String(i.projectContext.projectId||""),projectTag:String(i.projectContext.projectTag||""),fullName:String(i.projectContext.fullName||"")}:null;n.conversations.push({id:a,title:d,createdAt:c,updatedAt:l,messages:g,pendingPlan:p,projectContext:m})}return n}async cleanupLegacySettings(){if(!this.plugin.settings.ai)return;let t=!1;this.plugin.settings.ai.conversation&&(delete this.plugin.settings.ai.conversation,t=!0),this.plugin.settings.ai.pendingPlan&&(delete this.plugin.settings.ai.pendingPlan,t=!0),t&&await this.plugin.saveSettings()}async ensureDataFolder(){let t=this.plugin.app.vault.adapter,n=this.getDataFolder();await t.exists(n)||await t.mkdir(n)}async writeNow(){try{await this.ensureDataFolder(),await this.plugin.app.vault.adapter.write(this.getDataPath(),JSON.stringify(this.data,null,2))}catch(t){}}getDataFolder(){var n;return`.obsidian/plugins/${((n=this.plugin.manifest)==null?void 0:n.id)||"project-flow"}`}getDataPath(){return`${this.getDataFolder()}/${wr}`}};var se="projectflow-ai-chat",Be=class extends re.ItemView{constructor(n,o){super(n);this.messageContainer=null;this.inputEl=null;this.sendBtn=null;this.statusEl=null;this.conversationListEl=null;this.headerTitleEl=null;this.headerProjectEl=null;this.controller=null;this.state=null;this.shellEl=null;this.sidebarEl=null;this.sidebarToggleBtn=null;this.resizeObserver=null;this.isNarrow=!1;this.sidebarVisible=!0;this.emptyConversationTitle="New chat";this.plugin=o}getViewType(){return se}getDisplayText(){return"ProjectFlow AI"}getIcon(){return"brain-circuit"}async onOpen(){let n=this.containerEl.children[1];n.empty(),n.addClass("pf-ai-view");let o=n.createDiv({cls:"pf-ai-shell"});this.shellEl=o;let r=o.createDiv({cls:"pf-ai-sidebar"});this.sidebarEl=r;let s=r.createDiv({cls:"pf-ai-conv-header"});s.createEl("h4",{text:"Conversations"});let i=s.createEl("button");i.addClass("pf-ai-new"),i.setAttr("aria-label","New conversation"),i.setAttr("title","New conversation"),(0,re.setIcon)(i,"plus"),i.onclick=()=>this.handleNewConversation(),this.conversationListEl=r.createDiv({cls:"pf-ai-conv-list"});let a=o.createDiv({cls:"pf-ai-main"}),d=a.createDiv({cls:"pf-ai-header"}),c=d.createDiv({cls:"pf-ai-header-left"}),l=c.createEl("button");l.addClass("pf-ai-sidebar-toggle"),l.setAttr("aria-label","Show conversations"),l.setAttr("title","Show conversations"),(0,re.setIcon)(l,"arrow-left"),l.onclick=()=>this.toggleSidebarVisibility(),this.sidebarToggleBtn=l,this.headerTitleEl=c.createEl("h3"),this.headerProjectEl=c.createEl("span"),this.headerProjectEl.addClass("pf-ai-project-id");let g=d.createEl("button",{text:"Clear"});g.addClass("pf-ai-clear"),g.onclick=()=>{var u;(u=this.controller)==null||u.clearConversation(),this.renderConversationList(),this.updateHeaderTitle()};let p=a.createDiv({cls:"pf-ai-messages"});this.messageContainer=p;let m=a.createDiv({cls:"pf-ai-input"}),f=m.createEl("textarea");f.placeholder="Ask ProjectFlow...";let P=m.createEl("button",{text:"Send"}),v=m.createDiv({cls:"pf-ai-status"});v.setText(""),v.style.display="none",this.inputEl=f,this.sendBtn=P,this.statusEl=v,this.state=await Ae.create(this.plugin),this.clearEmptyActiveConversation(),this.controller=new be(this.plugin,this,this.state),this.renderConversationList(),this.renderActiveConversation(),this.updateHeaderTitle(),this.setupResizeObserver(),this.applySidebarState(),P.onclick=()=>this.handleSend(),f.onkeydown=u=>{u.key==="Enter"&&!u.shiftKey&&(u.preventDefault(),this.handleSend())}}async onClose(){var n,o;(n=this.controller)==null||n.onClose(),this.messageContainer=null,this.inputEl=null,this.sendBtn=null,this.statusEl=null,this.conversationListEl=null,this.headerTitleEl=null,this.headerProjectEl=null,this.controller=null,this.state=null,this.shellEl=null,this.sidebarEl=null,this.sidebarToggleBtn=null,(o=this.resizeObserver)==null||o.disconnect(),this.resizeObserver=null}appendMessage(n,o){if(!this.messageContainer)return null;let r=this.shouldAutoScroll(),s=this.messageContainer.createDiv({cls:`pf-ai-message ${n}`});return this.renderMessage(s,o),r&&this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}),s}updateMessage(n,o){var s;if(!n)return;let r=this.shouldAutoScroll();this.renderMessage(n,o),r&&((s=this.messageContainer)==null||s.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}))}appendConfirmationActions(){if(!this.messageContainer)return;let n=this.shouldAutoScroll(),o=this.messageContainer.createDiv({cls:"pf-ai-confirmation"}),r=o.createEl("button",{text:"Proceed"});r.addClass("pf-ai-confirm");let s=o.createEl("button",{text:"Reject"});s.addClass("pf-ai-reject");let i=a=>{r.disabled=!0,s.disabled=!0,a==="proceed"?(r.addClass("pf-ai-selected"),r.setText("Proceed \u2713")):(s.addClass("pf-ai-selected"),s.setText("Reject \u2713"))};r.onclick=async()=>{var a;i("proceed"),await((a=this.controller)==null?void 0:a.handleFollowup("yes")),this.renderConversationList(),this.updateHeaderTitle()},s.onclick=async()=>{var a;i("reject"),await((a=this.controller)==null?void 0:a.handleFollowup("no")),this.renderConversationList(),this.updateHeaderTitle()},n&&this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"})}clearMessages(){var n;(n=this.messageContainer)==null||n.empty()}setBusy(n){this.sendBtn&&(this.sendBtn.disabled=n),this.statusEl&&(n?(this.statusEl.setText("Thinking..."),this.statusEl.style.display="block"):(this.statusEl.setText(""),this.statusEl.style.display="none"))}async handleSend(){var o,r;let n=(((o=this.inputEl)==null?void 0:o.value)||"").trim();n&&(this.inputEl&&(this.inputEl.value=""),await((r=this.controller)==null?void 0:r.handleSend(n)),this.renderConversationList(),this.updateHeaderTitle(),this.hideSidebarIfNarrow())}handleNewConversation(){this.state&&(this.state.createConversation(),this.resetController(),this.renderConversationList(),this.renderActiveConversation(),this.updateHeaderTitle(),this.hideSidebarIfNarrow())}selectConversation(n){this.state&&n!==this.state.getActiveConversationId()&&(this.state.setActiveConversation(n),this.resetController(),this.renderConversationList(),this.renderActiveConversation(),this.updateHeaderTitle(),this.hideSidebarIfNarrow())}handleRenameConversation(n){var s,i;if(!this.state)return;let o=((s=this.state.getConversationSummaries().find(a=>a.id===n))==null?void 0:s.title)||"",r=(i=window.prompt("Rename conversation",o))==null?void 0:i.trim();r&&(this.state.renameConversation(n,r),this.renderConversationList(),this.updateHeaderTitle())}handleRemoveConversation(n){this.state&&window.confirm("Remove this conversation?")&&(this.state.removeConversation(n),this.resetController(),this.renderConversationList(),this.renderActiveConversation(),this.updateHeaderTitle(),this.isNarrow&&!this.hasActiveConversation()&&(this.sidebarVisible=!0),this.applySidebarState())}resetController(){var n;this.state&&((n=this.controller)==null||n.onClose(),this.controller=new be(this.plugin,this,this.state))}renderConversationList(){if(!this.conversationListEl||!this.state)return;let n=this.conversationListEl;n.empty();let o=this.state.getConversationSummaries(),r=this.state.getActiveConversationId(),s=o.filter(i=>!(i.messageCount===0&&i.title===this.emptyConversationTitle));if(o.length===0){n.createDiv({cls:"pf-ai-conv-empty",text:"You don't have chats yet. Press + to create one."});return}if(s.length===0){n.createDiv({cls:"pf-ai-conv-empty",text:"You don't have chats yet. Press + to create one."});return}for(let i of s){let a=n.createDiv({cls:"pf-ai-conv-item"});i.id===r&&a.addClass("is-active"),a.createDiv({text:i.title}).addClass("pf-ai-conv-title");let c=this.state.getConversationProjectId(i.id);if(c){let m=a.createDiv({text:c});m.addClass("pf-ai-conv-project");let f=this.colorForProject(c);m.style.borderColor=f,m.style.color=f}a.onclick=()=>this.selectConversation(i.id);let l=a.createDiv({cls:"pf-ai-conv-actions"}),g=l.createEl("button");g.addClass("pf-ai-conv-rename"),g.setAttr("aria-label","Rename conversation"),g.setAttr("title","Rename conversation"),(0,re.setIcon)(g,"pencil"),g.onclick=m=>{m.stopPropagation(),this.handleRenameConversation(i.id)};let p=l.createEl("button");p.addClass("pf-ai-conv-remove"),p.setAttr("aria-label","Remove conversation"),p.setAttr("title","Remove conversation"),(0,re.setIcon)(p,"trash"),p.onclick=m=>{m.stopPropagation(),this.handleRemoveConversation(i.id)}}}renderActiveConversation(){if(!this.state)return;let n=this.state.getActiveConversationMessages();this.renderConversationMessages(n)}renderConversationMessages(n){if(this.messageContainer){this.messageContainer.empty();for(let o of n){let r=this.messageContainer.createDiv({cls:`pf-ai-message ${o.role}`});this.renderMessage(r,o.content)}this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight})}}updateHeaderTitle(){var o;if(!this.headerTitleEl||!this.state)return;let n=this.state.getActiveConversationTitle();if(this.headerTitleEl.setText(n?`ProjectFlow AI \u2014 ${n}`:"ProjectFlow AI"),this.headerProjectEl){let r=(o=this.state.getProjectContext())==null?void 0:o.projectId;r?(this.headerProjectEl.setText(r),this.headerProjectEl.style.display="inline-flex"):(this.headerProjectEl.setText(""),this.headerProjectEl.style.display="none")}}renderMessage(n,o){let r=this.tryFormatJson(o),s=r!=null?r:o;n.empty(),re.MarkdownRenderer.renderMarkdown(s,n,"",this)}tryFormatJson(n){let o=n.trim();if(!o||!(o.startsWith("{")||o.startsWith("[")))return null;try{let r=JSON.parse(o);return`\`\`\`json
${JSON.stringify(r,null,2)}
\`\`\``}catch(r){return null}}shouldAutoScroll(){let n=this.messageContainer;if(!n)return!1;let o=24;return n.scrollHeight-(n.scrollTop+n.clientHeight)<=o}setupResizeObserver(){var n;this.shellEl&&((n=this.resizeObserver)==null||n.disconnect(),this.resizeObserver=new ResizeObserver(o=>{let r=o[0];if(!r)return;let s=r.contentRect.width,i=this.isNarrow;this.isNarrow=s<520,this.isNarrow?!i&&this.isNarrow&&(this.sidebarVisible=!this.hasActiveConversation()):this.sidebarVisible=!0,this.applySidebarState()}),this.resizeObserver.observe(this.shellEl))}toggleSidebarVisibility(){this.isNarrow&&(this.sidebarVisible=!this.sidebarVisible,this.applySidebarState())}hideSidebarIfNarrow(){this.isNarrow&&(this.sidebarVisible=!1,this.applySidebarState())}applySidebarState(){let n=this.shellEl;n&&(n.toggleClass("pf-ai-narrow",this.isNarrow),n.toggleClass("pf-ai-sidebar-hidden",this.isNarrow&&!this.sidebarVisible),n.toggleClass("pf-ai-sidebar-open",this.isNarrow&&this.sidebarVisible))}hasActiveConversation(){return this.state?Boolean(this.state.getActiveConversationId()):!1}clearEmptyActiveConversation(){if(!this.state)return;let n=this.state.getActiveConversationId();if(!n)return;let o=this.state.getConversationSummaries().find(r=>r.id===n);o&&o.messageCount===0&&o.title===this.emptyConversationTitle&&this.state.clearActiveConversation()}colorForProject(n){let o=0;for(let s=0;s<n.length;s+=1)o=o*31+n.charCodeAt(s)|0;return`hsl(${Math.abs(o)%360} 55% 45%)`}};var Rt=class extends Eo.Plugin{async onload(){var n;console.log("ProjectFlow plugin loaded"),await this.loadSettings(),this.addSettingTab(new ot(this.app,this)),this.registerView(se,o=>new Be(o,this)),this.addCommand({id:"add-project-info",name:"Add Project Info",callback:()=>Dn(this)}),this.addCommand({id:"remove-project-by-id",name:"Remove Project",callback:()=>$n(this)}),this.addCommand({id:"archive-project-by-id",name:"Archive Project",callback:()=>On(this)}),await this.exposeCoreApi(),(n=this.settings.ai)!=null&&n.enabled&&this.app.workspace.onLayoutReady(()=>{this.toggleAiView(!0)})}async loadSettings(){let n=await this.loadData();try{let{migrateSettings:o,CURRENT_SETTINGS_SCHEMA_VERSION:r}=await Promise.resolve().then(()=>(Wt(),Zn)),{DEFAULT_ENTITY_TYPES:s,DEFAULT_PROJECT_TYPES:i}=await Promise.resolve().then(()=>(Ne(),vn)),{ensureProjectIndex:a}=await Promise.resolve().then(()=>(je(),ke)),{ensureProjectGraph:d}=await Promise.resolve().then(()=>(we(),$e));this.settings=Object.assign({},rt,o(n));let c=!1;this.settings.templatesRoot||(this.settings.templatesRoot="Templates/ProjectFlow",c=!0),(!this.settings.entityTypes||Object.keys(this.settings.entityTypes).length===0)&&(this.settings.entityTypes=s,c=!0),(!this.settings.projectTypes||Object.keys(this.settings.projectTypes).length===0)&&(this.settings.projectTypes=i,c=!0),(!this.settings.schemaVersion||this.settings.schemaVersion<r)&&(this.settings.schemaVersion=r,c=!0);let{index:l,updated:g}=a(this.settings.projectIndex,this.settings.projectRecords);g&&(this.settings.projectIndex=l,c=!0);let{graph:p,updated:m}=d(this.settings.projectGraph,this.settings.projectRecords,this.settings.archivedRecords);m&&(this.settings.projectGraph=p,c=!0),c&&await this.saveData(this.settings)}catch(o){this.settings=Object.assign({},rt,n)}}async saveSettings(){await this.saveData(this.settings)}getApi(){return this.coreApi}async toggleAiView(n){if(n){let o=this.app.workspace.getLeavesOfType(se);if(o.length>0){await o[0].setViewState({type:se,active:!0});return}let r=this.app.workspace.getRightLeaf(!1);if(!r)return;await r.setViewState({type:se,active:!0})}else this.app.workspace.detachLeavesOfType(se)}onunload(){this.app.workspace.detachLeavesOfType(se)}async exposeCoreApi(){let{createCoreApi:n}=await Promise.resolve().then(()=>(Ro(),Co));this.coreApi=n(this);let o=window;o.PluginApi=o.PluginApi||{},o.PluginApi["@projectflow/core"]=this.coreApi}};var $r=Rt;
