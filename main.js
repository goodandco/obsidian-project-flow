/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var gt=Object.defineProperty;var Gr=Object.getOwnPropertyDescriptor;var Lr=Object.getOwnPropertyNames;var Br=Object.prototype.hasOwnProperty;var F=(e,r)=>()=>(e&&(r=e(e=0)),r);var U=(e,r)=>{for(var t in r)gt(e,t,{get:r[t],enumerable:!0})},Jr=(e,r,t,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of Lr(r))!Br.call(e,n)&&n!==t&&gt(e,n,{get:()=>r[n],enumerable:!(o=Gr(r,n))||o.enumerable});return e};var Ur=e=>Jr(gt({},"__esModule",{value:!0}),e);var Ot={};U(Ot,{DEFAULT_ENTITY_TYPES:()=>ce,DEFAULT_PROJECT_TYPES:()=>me});var ce,me,Ae=F(()=>{ce={task:{id:"task",name:"Task",templatePath:"template-task.md",targetFolder:"Work/Tasks",filenameRule:"${PROJECT_ID}-${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},"meeting.planning":{id:"meeting.planning",name:"Meeting (Planning)",templatePath:"template-meeting-planning.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.refinement":{id:"meeting.refinement",name:"Meeting (Refinement)",templatePath:"template-meeting-refinement.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.retro":{id:"meeting.retro",name:"Meeting (Retro)",templatePath:"template-meeting-retro.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.demo":{id:"meeting.demo",name:"Meeting (Demo)",templatePath:"template-meeting-demo.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.daily":{id:"meeting.daily",name:"Meeting (Daily)",templatePath:"template-meeting-daily.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.knowledge":{id:"meeting.knowledge",name:"Meeting (Knowledge)",templatePath:"template-meeting-knowledge.md",targetFolder:"Meetings",filenameRule:"${DATE} ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},sprint:{id:"sprint",name:"Sprint",templatePath:"template-sprint.md",targetFolder:"Work",filenameRule:"Sprint ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},idea:{id:"idea",name:"Idea",templatePath:"template-idea.md",targetFolder:"Knowledge Base",filenameRule:"Idea ${TITLE}",requiredFields:["TITLE"],patchMarkers:["AI:CONTENT"]}},me={operational:{id:"operational",name:"Operational",description:"Default ProjectFlow structure for active projects.",folderStructure:["Knowledge Base","Meetings","Work","Work/Tasks","People"],initialNotes:[{fileName:"${PROJECT_FULL_NAME}.md",template:"project.md"},{fileName:"${PROJECT_NAME} Meetings.md",template:"meetings.md"},{fileName:"${PROJECT_NAME} People.md",template:"people.md"},{fileName:"${PROJECT_NAME} Work.md",template:"work.md"},{fileName:"${PROJECT_NAME} Knowledge Base.md",template:"knowledge-base.md"}],allowedEntityTypes:Object.keys(ce)}}});var ge={};U(ge,{SafeFileManager:()=>ut});var ut,ue=F(()=>{ut=class{constructor(r){this.vault=r.vault}async createBatch(r){let t=[];try{for(let o of r)o.type==="folder"?await this.ensureFolder(o.path):await this.createIfAbsent(o.path,o.data)==="created"&&t.push(o.path);return{ok:!0}}catch(o){for(let n of t.reverse())try{let s=this.vault.getAbstractFileByPath(n);s&&this.vault.delete&&await this.vault.delete(s)}catch(s){}return{ok:!1,error:o}}}async has(r){var t;try{return this.vault.getAbstractFileByPath(r)?!0:(t=this.vault.adapter)!=null&&t.exists?await this.vault.adapter.exists(r):!1}catch(o){return!1}}async ensureFolder(r){var o;if(!this.vault.getAbstractFileByPath(r))try{await this.vault.createFolder(r)}catch(n){if(n&&typeof n=="object"&&((o=n.message)!=null&&o.includes("Parent folder"))){let s=r.split("/").filter(Boolean),i="";for(let a of s)if(i=i?`${i}/${a}`:a,!this.vault.getAbstractFileByPath(i))try{await this.vault.createFolder(i)}catch(c){}}}}async createIfAbsent(r,t){if(await this.has(r))return"skipped";try{return await this.vault.create(r,t),"created"}catch(o){return await this.has(r),"skipped"}}async removeDir(r){let t=this.vault.getAbstractFileByPath(r);if(t&&this.vault)try{await this.vault.trash(t,!0),await new Promise(o=>setTimeout(o,200))}catch(o){console.warn(`removeDir: failed to trash ${r}: ${o}`)}else console.warn(`removeDir: file not found: ${r}. File: ${t==null?void 0:t.path}`)}}});var Ie={};U(Ie,{sanitizeFileName:()=>Ve,sanitizePath:()=>H});function Ve(e){let r=(e!=null?e:"").trim();return Array.from(r).filter(o=>o.charCodeAt(0)>=32).join("").replace(/[\\/:*?"<>|]/g,"-").replace(/\s+/g," ").replace(/\.+$/g,"").substring(0,200)||"untitled"}function H(e){return e?e.split("/").filter(Boolean).map(Ve).join("/"):""}var fe=F(()=>{});var Se={};U(Se,{PROJECT_INDEX_VERSION:()=>ft,addToProjectIndex:()=>Wr,buildProjectIndex:()=>Lt,ensureProjectIndex:()=>He,getProjectIndexCache:()=>Ke,removeFromProjectIndex:()=>Kr,setProjectIndexCache:()=>Vr,toIndexEntry:()=>ht});function Ke(){return We}function Vr(e){We=e}function Lt(e){let r={},t={},o={};if(e&&typeof e=="object"){for(let[n,s]of Object.entries(e))if(!(!s||typeof s!="object")){for(let[i,a]of Object.entries(s))if(!(!a||typeof a!="object"))for(let[c,l]of Object.entries(a)){if(!l||!l.variables||!l.info)continue;let p=ht(l,c,n,i);r[p.fullName]=p,t[p.projectId]=p,o[p.projectTag]=p}}}return{version:1,byFullName:r,byId:t,byTag:o}}function ht(e,r,t,o){var n;return{fullName:e.variables.PROJECT_FULL_NAME,projectId:r,projectTag:e.variables.PROJECT_TAG,path:e.variables.PROJECT_PATH,dimension:t,category:o,projectName:e.info.name,parent:(n=e.info.parent)!=null?n:null}}function He(e,r){if(!e||e.version!==1){let t=Lt(r);return We=t,{index:t,updated:!0}}return We=e,{index:e,updated:!1}}function Wr(e,r,t,o,n){let s=ht(r,t,o,n);return e.byFullName[s.fullName]=s,e.byId[s.projectId]=s,e.byTag[s.projectTag]=s,e}function Kr(e,r){return delete e.byFullName[r.fullName],delete e.byId[r.projectId],delete e.byTag[r.projectTag],e}var ft,We,he=F(()=>{ft=1,We=null});var $e={};U($e,{PROJECT_GRAPH_VERSION:()=>yt,addProjectToGraph:()=>zr,buildProjectGraph:()=>Pt,cleanArchivedGraph:()=>jt,ensureProjectGraph:()=>ke,getChildren:()=>vt,getParents:()=>wt,getProjectGraphCache:()=>Hr,removeProjectFromGraph:()=>Xr,setProjectGraphCache:()=>Yr});function Hr(){return Ye}function Yr(e){Ye=e}function Pt(e,r){let t={},o={};return e&&Bt(e,t),r&&Bt(r,o),{version:1,byFullName:t,archivedByFullName:o}}function ke(e,r,t){if(!e||e.version!==1){let o=Pt(r,t);return Ye=o,{graph:o,updated:!0}}return Ye=e,{graph:e,updated:!1}}function zr(e,r,t){let o=r.variables.PROJECT_FULL_NAME,n=Jt(r.info.parent),s=t?e.archivedByFullName:e.byFullName;if(s[o]=s[o]||{parent:n,children:[]},s[o].parent=n!=null?n:null,n){let i=s[n]||{parent:null,children:[]};i.children.includes(o)||i.children.push(o),s[n]=i}return e}function Xr(e,r,t){let o=t?e.archivedByFullName:e.byFullName,n=o[r];return n!=null&&n.parent&&o[n.parent]&&(o[n.parent].children=o[n.parent].children.filter(s=>s!==r)),delete o[r],e}function jt(e,r){let t=Pt(void 0,r);return e.archivedByFullName=t.archivedByFullName,e}function vt(e,r,t){var n,s;return(s=(n=(t?e.archivedByFullName:e.byFullName)[r])==null?void 0:n.children)!=null?s:[]}function wt(e,r,t){var i,a,c,l;let o=t?e.archivedByFullName:e.byFullName,n=[],s=(a=(i=o[r])==null?void 0:i.parent)!=null?a:null;for(;s;)n.push(s),s=(l=(c=o[s])==null?void 0:c.parent)!=null?l:null;return n}function Bt(e,r){for(let t of Object.values(e))for(let o of Object.values(t))for(let n of Object.values(o)){if(!n||!n.variables)continue;let s=n.variables.PROJECT_FULL_NAME,i=Jt(n.info.parent);if(r[s]=r[s]||{parent:i,children:[]},r[s].parent=i!=null?i:null,i){let a=r[i]||{parent:null,children:[]};a.children.includes(s)||a.children.push(s),r[i]=a}}}function Jt(e){let r=e==null?void 0:e.trim();return r&&r.length>0?r:null}var yt,Ye,ye=F(()=>{yt=1,Ye=null});var Kt={};U(Kt,{ensureValidOrThrow:()=>to,validateProjectName:()=>qr,validateTag:()=>eo});function qr(e){if(!e||!e.trim())return{ok:!1,reason:"Project name is required"};let r=e.trim();if(r.length>120)return{ok:!1,reason:"Project name too long (max 120)"};for(let t of r)if(t.charCodeAt(0)<32||t==="/"||t==="\\")return{ok:!1,reason:"Project name contains invalid characters"};return{ok:!0}}function eo(e){if(!e||!e.trim())return{ok:!1,reason:"Tag is required"};let r=e.trim();return Qr.test(r)?{ok:!0}:{ok:!1,reason:"Tag must be 2-63 chars, start with letter/digit; may include -, _, /"}}function to(e,r){let t=e();if(!t.ok)throw new Error(`${r}: ${t.reason}`)}var Qr,Ht=F(()=>{Qr=/^[A-Za-z0-9][A-Za-z0-9_/-]{1,62}$/});var tt={};U(tt,{processTemplate:()=>ro});function zt(e){return e==null?"":String(e)}function ro(e,r){if(!e||typeof e!="string")return"";let t=e;for(let[o,n]of Object.entries(r)){let s=zt(n),i=`$_${o}`;t.includes(i)&&(t=t.split(i).join(s))}for(let[o,n]of Object.entries(r)){let s=zt(n),i=new RegExp(`\\$\\{${oo(o)}\\}`,"g");t=t.replace(i,s)}return t}function oo(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var rt=F(()=>{});function Xt(e,r){let t=new Date,o=t.getFullYear().toString(),n=t.toISOString().split("T")[0],s=r.projectsRoot||"1. Projects",i=e.parent&&e.parent.trim().length>0?`.${e.parent.trim()}`:"",a=`${o}${i}.${e.name}`,c=r.dimensions.find(d=>d.name===e.dimension),l=c?`${c.order}. ${c.name}`:e.dimension,p=`${s}/${l}/${e.category}/${a}`,u=`${p}`;return{PROJECT_NAME:e.name,PROJECT_TAG:e.tag,PROJECT_PARENT:e.parent?e.parent:"",PARENT_TAG:e.parent?e.tag:"",YEAR:o,DATE:n,PROJECT_FULL_NAME:a,PROJECT_RELATIVE_PATH:p,PROJECT_PATH:u,DIMENSION:c?c.name:e.dimension,CATEGORY:e.category,PROJECT_ID:e.id,PROJECT_DIMENSION:c?c.name:e.dimension}}async function ot(e,r){try{let{processTemplate:t}=await Promise.resolve().then(()=>(rt(),tt));return t(e,r)}catch(t){console.warn("Template processor import failed, using legacy replacement:",t);let o=e;return Object.entries(r).forEach(([n,s])=>{let i=`$_${n}`;o=o.split(i).join(s)}),o}}var Zt=F(()=>{});var Qt={};U(Qt,{mergeEntityTypes:()=>nt,mergeProjectTypes:()=>Te});function nt(e){let r={...ce};if(e&&typeof e=="object")for(let[t,o]of Object.entries(e))!o||typeof o!="object"||(r[t]={...r[t],...o,id:t});return r}function Te(e){let r={...me};if(e&&typeof e=="object")for(let[t,o]of Object.entries(e))!o||typeof o!="object"||(r[t]={...r[t],...o,id:t});return r}var st=F(()=>{Ae()});var qt={};U(qt,{resolveProjectType:()=>no});function no(e,r){let t=Te(e.projectTypes),o=r==null?void 0:r.projectTypeId,n=o&&t[o]?o:"operational",s=t[n]||t.operational;return{projectTypeId:n,projectType:s}}var er=F(()=>{st()});async function it(e,r){var t,o;try{let{resolveProjectType:n}=await Promise.resolve().then(()=>(er(),qt)),{projectTypeId:s,projectType:i}=n(e.settings,r);r.projectTypeId=s;let a=Xt(r,e.settings),c=e.settings.projectsRoot||"1. Projects",{sanitizePath:l,sanitizeFileName:p}=await Promise.resolve().then(()=>(fe(),Ie)),{SafeFileManager:u}=await Promise.resolve().then(()=>(ue(),ge)),d=new u(e.app),j=l(c),g=e.settings.dimensions.find(w=>w.name===r.dimension),m=g?`${g.order}. ${g.name}`:r.dimension,f=p(m),P=p(r.category),y=l(`${j}/${f}/${P}/${a.PROJECT_FULL_NAME}`),T=(t=i==null?void 0:i.folderStructure)!=null?t:["Knowledge Base","Meetings","Work","Work/Tasks","People"],v=[{type:"folder",path:y},...T.map(w=>({type:"folder",path:l(`${y}/${w}`)}))],R=e.app.vault.adapter,O=`.obsidian/plugins/${e.manifest.id}/src/templates`,Y=(o=i==null?void 0:i.initialNotes)!=null?o:[{fileName:`${a.PROJECT_FULL_NAME}.md`,template:"project.md"},{fileName:`${r.name} Meetings.md`,template:"meetings.md"},{fileName:`${r.name} People.md`,template:"people.md"},{fileName:`${r.name} Work.md`,template:"work.md"},{fileName:`${r.name} Knowledge Base.md`,template:"knowledge-base.md"}],z=[];for(let w of Y){let $=w.fileName?await ot(w.fileName,a):w.fileName,W=`${O}/${w.template}`;if(!await R.exists(W))throw new Error(`Template file not found: ${w.template}`);let Pe=await R.read(W),je=await ot(Pe,a),Re=l(`${y}/${p($)}`);z.push({type:"file",path:Re,data:je})}let X=await d.createBatch([...v,...z]);if(!("ok"in X)||!X.ok)throw new Error(`Batch creation failed: ${X.error||"unknown"}`);return await ao(e,r.name,a),await so(e,r,a),[!0,`Project "${r.name}" created successfully!`]}catch(n){return[!1,`Error creating project: ${n}`]}}async function so(e,r,t){try{let{ensureProjectIndex:o,addToProjectIndex:n}=await Promise.resolve().then(()=>(he(),Se)),{ensureProjectGraph:s,addProjectToGraph:i}=await Promise.resolve().then(()=>(ye(),$e)),a={info:r,variables:t,createdAt:new Date().toISOString()},c=r.dimension,l=r.category,p=r.id;if(!e.settings.projectRecords||Array.isArray(e.settings.projectRecords)){let g={},m=Array.isArray(e.settings.projectRecords)?e.settings.projectRecords:[];for(let f of m){let P=f.info.dimension,y=f.info.category,T=f.info.id;g[P]=g[P]||{},g[P][y]=g[P][y]||{},g[P][y][T]=f}e.settings.projectRecords=g}let u=e.settings.projectRecords;if(u[c]=u[c]||{},u[c][l]=u[c][l]||{},u[c][l][p])throw new Error(`Project with id "${p}" already exists in ${c}:${l}`);u[c][l][p]=a;let{index:d}=o(e.settings.projectIndex,u);e.settings.projectIndex=n(d,a,p,c,l);let{graph:j}=s(e.settings.projectGraph,u,e.settings.archivedRecords);e.settings.projectGraph=i(j,a,!1),await e.saveData(e.settings)}catch(o){throw console.warn("Failed to record project creation:",o),o}}async function io(e,r,t,o,n){try{let s=e.app.vault.adapter,i=`.obsidian/plugins/${e.manifest.id}/src/templates/${o}`;if(!await s.exists(i))throw new Error(`Template file not found: ${o}`);let a=await s.read(i),c=await ot(a,n),l=`${r}/${t}`,{SafeFileManager:p}=await Promise.resolve().then(()=>(ue(),ge));await new p(e.app).createIfAbsent(l,c)}catch(s){throw console.error(`Failed to create ${t}:`,s),new Error(`Failed to create ${t}: ${s}`)}}async function ao(e,r,t){let{sanitizePath:o,sanitizeFileName:n}=await Promise.resolve().then(()=>(fe(),Ie)),{SafeFileManager:s}=await Promise.resolve().then(()=>(ue(),ge)),i=new s(e.app),a=o(`Templates/${r}_Templates`);await i.ensureFolder(a);let c=[{source:"template-meeting-daily.md",target:`${r}_Meeting_Daily_Template.md`},{source:"template-meeting-discussion.md",target:`${r}_Meeting_Discussion_Template.md`},{source:"template-meeting-knowledge.md",target:`${r}_Meeting_Knowledge_Template.md`},{source:"template-meeting-planning.md",target:`${r}_Meeting_Planning_Template.md`},{source:"template-meeting-refinement.md",target:`${r}_Meeting_Refinement_Template.md`},{source:"template-meeting-retro.md",target:`${r}_Meeting_Retro_Template.md`},{source:"template-meeting-demo.md",target:`${r}_Meeting_Demo_Template.md`},{source:"template-sprint.md",target:`${r}_Sprint_Template.md`},{source:"template-task.md",target:`${r}_Task_Template.md`},{source:"template-idea.md",target:`${r}_Idea_Template.md`},{source:"template-knowledge-base-item.md",target:`${r}_Knowledge_Item_Template.md`},{source:"template-meeting-daily.md",target:"template-meeting-daily.md"},{source:"template-meeting-discussion.md",target:"template-meeting-discussion.md"},{source:"template-meeting-knowledge.md",target:"template-meeting-knowledge.md"},{source:"template-meeting-planning.md",target:"template-meeting-planning.md"},{source:"template-meeting-refinement.md",target:"template-meeting-refinement.md"},{source:"template-meeting-retro.md",target:"template-meeting-retro.md"},{source:"template-meeting-demo.md",target:"template-meeting-demo.md"},{source:"template-sprint.md",target:"template-sprint.md"},{source:"template-task.md",target:"template-task.md"},{source:"template-idea.md",target:"template-idea.md"},{source:"template-knowledge-base-item.md",target:"template-knowledge-base-item.md"}];for(let l of c)try{let p=n(l.target);await io(e,a,p,l.source,t)}catch(p){console.warn(`Failed to create template ${l.target}: ${p}`)}}var Tt=F(()=>{Zt()});var ur={};U(ur,{CURRENT_SETTINGS_SCHEMA_VERSION:()=>Fe,migrateSettings:()=>ho});function ho(e){var n,s,i,a,c,l,p,u,d,j,g;let r={dimensions:(n=e==null?void 0:e.dimensions)!=null?n:[],projectsRoot:(s=e==null?void 0:e.projectsRoot)!=null?s:"1. Projects",archiveRoot:(i=e==null?void 0:e.archiveRoot)!=null?i:"4. Archive",templatesRoot:(a=e==null?void 0:e.templatesRoot)!=null?a:"Templates/ProjectFlow",ai:e==null?void 0:e.ai,schemaVersion:(c=e==null?void 0:e.schemaVersion)!=null?c:0,projectRecords:{},archivedRecords:(l=e==null?void 0:e.archivedRecords)!=null?l:{},entityTypes:(p=e==null?void 0:e.entityTypes)!=null?p:{},projectTypes:(u=e==null?void 0:e.projectTypes)!=null?u:{},projectIndex:e==null?void 0:e.projectIndex,projectGraph:e==null?void 0:e.projectGraph},t=e==null?void 0:e.projectRecords;if(t&&typeof t=="object"&&!Array.isArray(t))r.projectRecords=t;else if(Array.isArray(t)){let m={};for(let f of t){if(!f||!f.info)continue;let P=f.info.dimension,y=f.info.category,T=f.info.id;!P||!y||!T||(m[P]=m[P]||{},m[P][y]=m[P][y]||{},m[P][y][T]=f)}r.projectRecords=m}else r.projectRecords={};if(Array.isArray(r.dimensions)){let m=1;r.dimensions=r.dimensions.map(f=>{var P;if(f&&typeof f=="object"){let y=(P=f.name)!=null?P:"",T=f.order,v=typeof y=="string"?y.match(/^\s*(\d+)\.\s*(.+)$/):null;return v&&(T=parseInt(v[1],10),y=v[2]),(T==null||Number.isNaN(T))&&(T=m++),{name:y,order:T,categories:Array.isArray(f.categories)?f.categories:[]}}return{name:String(f!=null?f:""),order:m++,categories:[]}})}else r.dimensions=[];let o=[...r.dimensions].sort((m,f)=>{var P,y;return((P=m.order)!=null?P:0)-((y=f.order)!=null?y:0)});return o.forEach((m,f)=>{m.order=f+1}),r.dimensions=o,(!r.schemaVersion||r.schemaVersion<Fe)&&((!r.entityTypes||Object.keys(r.entityTypes).length===0)&&(r.entityTypes=ce),(!r.projectTypes||Object.keys(r.projectTypes).length===0)&&(r.projectTypes=me),r.ai?r.ai={enabled:Boolean(r.ai.enabled),provider:r.ai.provider||"openai",apiKey:(d=r.ai.apiKey)!=null?d:"",model:(j=r.ai.model)!=null?j:"gpt-4o-mini",baseUrl:(g=r.ai.baseUrl)!=null?g:"https://api.openai.com"}:r.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com"},r.schemaVersion=Fe),r}var Fe,xt=F(()=>{Ae();Fe=5});function fr(e){return e?e.startsWith("/")||e.includes("\\")?!1:!e.split("/").filter(Boolean).some(t=>t==="."||t===".."):!0}function De(e,r){let t=H(e),o=H(r);return o?t===o||t.startsWith(`${o}/`):!1}var hr=F(()=>{fe()});var Pr={};U(Pr,{listProjects:()=>At,resolveArchivedProject:()=>pt,resolveProject:()=>_e});function _e(e,r){var i,a,c;let t=Ke()||He(e.settings.projectIndex,e.settings.projectRecords).index,o=yr(r),n=o.fullName&&t.byFullName[o.fullName]||o.id&&t.byId[o.id]||o.tag&&t.byTag[o.tag];if(!n)return null;let s=(c=(a=(i=e.settings.projectRecords)==null?void 0:i[n.dimension])==null?void 0:a[n.category])==null?void 0:c[n.projectId];return s?{entry:n,record:s}:null}function pt(e,r){var n;let t=yr(r),o=yo(e.settings.archivedRecords,t);return o?{entry:{fullName:o.variables.PROJECT_FULL_NAME,projectId:o.info.id,projectTag:o.variables.PROJECT_TAG,path:o.variables.PROJECT_PATH,dimension:o.info.dimension,category:o.info.category,projectName:o.info.name,parent:(n=o.info.parent)!=null?n:null},record:o}:null}function At(e){let r=Ke()||He(e.settings.projectIndex,e.settings.projectRecords).index;return Object.values(r.byFullName)}function yr(e){var r,t,o;if(typeof e=="string"){let n=e.trim();return n.startsWith("project/")?{tag:n}:n.includes(".")?{fullName:n}:{id:n}}return{fullName:(r=e.fullName)==null?void 0:r.trim(),id:(t=e.id)==null?void 0:t.trim(),tag:(o=e.tag)==null?void 0:o.trim()}}function yo(e,r){if(!e)return null;for(let t of Object.values(e))for(let o of Object.values(t))for(let n of Object.values(o))if(n&&(r.fullName&&n.variables.PROJECT_FULL_NAME===r.fullName||r.id&&n.info.id===r.id||r.tag&&n.variables.PROJECT_TAG===r.tag))return n;return null}var It=F(()=>{he()});async function vr(e,r){let{resolveProject:t}=await Promise.resolve().then(()=>(It(),Pr)),{mergeEntityTypes:o}=await Promise.resolve().then(()=>(st(),Qt)),{processTemplate:n}=await Promise.resolve().then(()=>(rt(),tt)),{SafeFileManager:s}=await Promise.resolve().then(()=>(ue(),ge)),i=t(e,r.projectRef);if(!i)throw new Error("Project not found for reference.");let c=o(e.settings.entityTypes)[r.entityTypeId];if(!c)throw new Error(`Entity type not found: ${r.entityTypeId}`);Po(c,r.fields);let l={...i.record.variables,...r.fields||{}},p=await jo(e,c,i.record,l);if(!p)throw new Error(`Template not found for entity type: ${c.id}`);let d=await e.app.vault.adapter.read(p.path),j=n(d,l),g=n(c.targetFolder,l);if(!fr(g))throw new Error("Unsafe targetFolder path.");let m=H(i.record.variables.PROJECT_PATH),f=g?H(`${m}/${g}`):m;if(!De(f,m))throw new Error("Target folder is outside project path.");if(!jr(f,e.settings))throw new Error("Target folder is outside allowed roots.");let P=c.filenameRule||"Untitled",y=n(P,l),T=y.endsWith(".md")?y.slice(0,-3):y,v=Ve(T),R=H(`${f}/${v}.md`);if(!De(R,m))throw new Error("Target file is outside project path.");if(!jr(R,e.settings))throw new Error("Target file is outside allowed roots.");let O=new s(e.app);if(await O.ensureFolder(f),await O.has(R))throw new Error(`File already exists: ${R}`);return await O.createIfAbsent(R,j),{path:R}}function jr(e,r){let t=r.projectsRoot||"1. Projects",o=r.archiveRoot||"4. Archive";return De(e,t)||De(e,o)}function Po(e,r){if(!e.requiredFields||e.requiredFields.length===0)return;let t=e.requiredFields.filter(o=>r==null||r[o]==null||String(r[o]).trim()==="");if(t.length>0)throw new Error(`Missing required fields: ${t.join(", ")}`)}async function jo(e,r,t,o){let{processTemplate:n}=await Promise.resolve().then(()=>(rt(),tt)),s=e.app.vault.adapter,i=n(r.templatePath,o),a=H(`Templates/${t.info.name}_Templates`),c=H(e.settings.templatesRoot||"Templates/ProjectFlow"),l=`.obsidian/plugins/${e.manifest.id}/src/templates`,p=d=>d.map(j=>j==="project"?{scope:j,path:H(`${a}/${i}`)}:j==="vault"?{scope:j,path:H(`${c}/${i}`)}:{scope:j,path:`${l}/${i}`}),u=r.templateScope?[r.templateScope,"builtin"].filter((d,j,g)=>g.indexOf(d)===j):["project","vault","builtin"];for(let d of p(u))if(await s.exists(d.path))return d;return null}var wr=F(()=>{fe();hr()});function vo(e,r,t,o,n){let s=wo(r),i=e.indexOf(s);if(i>=0){let a=e.indexOf(`
`,i),c=a>=0?a+1:e.length,l=To(e,c),p=l>=0?l:e.length;return{updated:!0,text:[e.slice(0,c),St(t),e.slice(p)].join("")}}if(o==="strict")return{updated:!1,text:e};if(n){let a=Tr(e,n,t,o);if(a.updated)return a}return{updated:!0,text:xr(e,n||"AI Notes",t)}}function Tr(e,r,t,o){let n=br(r),i=new RegExp(`^#{1,6}\\s+${Eo(n)}\\s*$`,"m").exec(e);if(!i||i.index==null)return o==="strict"?{updated:!1,text:e}:{updated:!0,text:xr(e,n,t)};let a=i.index,c=e.indexOf(`
`,a),l=c>=0?c+1:e.length,p=Ro(e,l);return{updated:!0,text:[e.slice(0,l),St(t),e.slice(p)].join("")}}async function Rr(e,r){var i;let t=e.vault.adapter,o=(i=r.patchMode)!=null?i:"lenient";if(!await t.exists(r.path))return{ok:!1,error:`File not found: ${r.path}`};let n=await t.read(r.path),s=vo(n,r.marker,r.content,o,r.fallbackHeading);return s.updated?(await t.write(r.path,s.text),{ok:!0}):{ok:!1,error:"Marker or heading not found in strict mode."}}async function Er(e,r){var i;let t=e.vault.adapter,o=(i=r.patchMode)!=null?i:"lenient";if(!await t.exists(r.path))return{ok:!1,error:`File not found: ${r.path}`};let n=await t.read(r.path),s=Tr(n,r.heading,r.content,o);return s.updated?(await t.write(r.path,s.text),{ok:!0}):{ok:!1,error:"Heading not found in strict mode."}}function wo(e){let r=e.trim();return r.startsWith("<!--")&&r.endsWith("-->")?r:`<!-- ${r} -->`}function br(e){return e.replace(/^#+\s*/,"").trim()}function To(e,r){let t=/<!--\s*AI:[A-Z_]+\s*-->/g;t.lastIndex=r;let o=t.exec(e);return o&&o.index!=null?o.index:-1}function Ro(e,r){let t=/^#{1,6}\s+/gm;t.lastIndex=r;let o=t.exec(e);return o&&o.index!=null?o.index:e.length}function St(e){let r=e!=null?e:"";return r.endsWith(`
`)?r:`${r}
`}function xr(e,r,t){let o=br(r);return`${e.endsWith(`
`)?e:`${e}
`}
## ${o}
${St(t)}`}function Eo(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var Ar=F(()=>{});function Ir(e){if(e instanceof pe)return e;let r=e instanceof Error?e.message:"Unknown error";return new pe("validation_error",r)}var pe,kt=F(()=>{pe=class extends Error{constructor(t,o,n){super(o);this.code=t,this.details=n}}});function V(e,r){if(typeof e!="string"||e.trim().length===0)throw new pe("invalid_request",`${r} is required`,{field:r});return e.trim()}function dt(e){if(e==null)throw new pe("invalid_request","projectRef is required",{field:"projectRef"});if(typeof e=="string"){V(e,"projectRef");return}let r=typeof e.fullName=="string"&&e.fullName.trim().length>0,t=typeof e.id=="string"&&e.id.trim().length>0,o=typeof e.tag=="string"&&e.tag.trim().length>0;if(!r&&!t&&!o)throw new pe("invalid_request","projectRef must include fullName, id, or tag",{field:"projectRef"})}function Sr(e){V(e==null?void 0:e.name,"name"),V(e==null?void 0:e.tag,"tag"),V(e==null?void 0:e.id,"id"),V(e==null?void 0:e.dimension,"dimension"),V(e==null?void 0:e.category,"category")}function kr(e){dt(e==null?void 0:e.projectRef),V(e==null?void 0:e.entityTypeId,"entityTypeId")}function $r(e){V(e==null?void 0:e.path,"path"),V(e==null?void 0:e.marker,"marker"),V(e==null?void 0:e.content,"content")}function Nr(e){V(e==null?void 0:e.path,"path"),V(e==null?void 0:e.heading,"heading"),V(e==null?void 0:e.content,"content")}var Cr=F(()=>{kt()});var Fr={};U(Fr,{createCoreApi:()=>bo});function bo(e){return{version:"1.0.0",capabilities:{resolveProject:!0,listProjects:!0,entityTypes:!0,projectTypes:!0,createProject:!0,createEntity:!0,patching:!0,projectGraph:!0,errorHandling:"throws"},compatibility:{settingsSchemaVersion:Fe,projectIndexVersion:1,projectGraphVersion:1},resolveProject:t=>(dt(t),_e(e,t)),listProjects:()=>At(e),listProjectTypes:()=>Te(e.settings.projectTypes),describeProjectType:t=>Te(e.settings.projectTypes)[t]||null,listEntityTypes:()=>nt(e.settings.entityTypes),describeEntityType:t=>nt(e.settings.entityTypes)[t]||null,createProject:async t=>(Sr(t),it(e,t)),createEntity:async t=>(kr(t),vr(e,t)),patchMarker:async t=>($r(t),Rr(e.app,t)),patchSection:async t=>(Nr(t),Er(e.app,t)),getChildren:(t,o)=>{dt(t);let n=o?pt(e,t):_e(e,t);if(!n)return[];let{graph:s}=ke(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return vt(s,n.entry.fullName,Boolean(o))},getParents:(t,o)=>{let n=o?pt(e,t):_e(e,t);if(!n)return[];let{graph:s}=ke(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return wt(s,n.entry.fullName,Boolean(o))},clearArchivedProjectGraph:async()=>{let{graph:t}=ke(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return e.settings.projectGraph=jt(t,e.settings.archivedRecords),await e.saveData(e.settings),{ok:!0}},wrapError:t=>{let o=Ir(t);return{ok:!1,error:{code:o.code,message:o.message,details:o.details}}}}}var Dr=F(()=>{st();Tt();wr();Ar();It();ye();Cr();kt();xt();he();ye()});var Ao={};U(Ao,{default:()=>xo});module.exports=Ur(Ao);var _r=require("obsidian");var x=require("obsidian");Ae();var Gt=require("obsidian"),Ue=class extends Gt.Modal{constructor(t,o){super(t);this.onResult=o}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("project-flow-settings"),t.createEl("p",{text:"Do you want skip settings to defaults? This will override all custom settings."});let o=t.createDiv({cls:"gc-row"});o.createDiv({cls:"gc-spacer"});let n=o.createEl("button",{text:"Yes, use defaults"}),s=o.createEl("button",{text:"Go back"});n.onclick=()=>{this.close(),this.onResult(!0)},s.onclick=()=>{this.close(),this.onResult(!1)}}onClose(){this.contentEl.empty()}};async function ze(e,r,t,o){let n="",s=e.settings.projectRecords,i=s[r][t][o],{SafeFileManager:a}=await Promise.resolve().then(()=>(ue(),ge)),c=new a(e.app),{sanitizePath:l}=await Promise.resolve().then(()=>(fe(),Ie)),p=l(i.variables.PROJECT_PATH),u=l(`Templates/${i.info.name}_Templates`);try{await c.removeDir(p),await c.removeDir(u);try{s[r][t][o]&&(delete s[r][t][o],Object.keys(s[r][t]).length===0&&delete s[r][t],Object.keys(s[r]).length===0&&delete s[r]);try{let{ensureProjectIndex:d,removeFromProjectIndex:j,toIndexEntry:g}=await Promise.resolve().then(()=>(he(),Se)),{ensureProjectGraph:m,removeProjectFromGraph:f}=await Promise.resolve().then(()=>(ye(),$e)),{index:P}=d(e.settings.projectIndex,s);e.settings.projectIndex=j(P,g(i,o,r,t));let{graph:y}=m(e.settings.projectGraph,s,e.settings.archivedRecords);e.settings.projectGraph=f(y,i.variables.PROJECT_FULL_NAME,!1)}catch(d){console.warn("Failed to update projectIndex after delete:",d)}await e.saveData(e.settings),n="Project deleted successfully."}catch(d){n="Failed to update projectRecords after delete",console.warn(n,d)}return[!0,n]}catch(d){n="Error removing project: "+d.message,console.error("Error removing project:",d)}return[!1,n]}async function Xe(e,r,t,o){var n,s,i,a,c;try{let l=e.settings.projectRecords,p=(s=(n=l==null?void 0:l[r])==null?void 0:n[t])==null?void 0:s[o];if(!p)return[!1,"Project not found."];let{sanitizePath:u}=await Promise.resolve().then(()=>(fe(),Ie)),{SafeFileManager:d}=await Promise.resolve().then(()=>(ue(),ge)),j=new d(e.app),g=e.app.vault.adapter,m=u(p.variables.PROJECT_PATH),f=u(`Templates/${p.info.name}_Templates`),P=e.settings.archiveRoot||"4. Archive",y=p.variables.YEAR,T=p.variables.DIMENSION||p.info.dimension,v=p.info.category,R=p.info.parent&&p.info.parent.trim().length>0?p.info.parent.trim():null,O=p.info.name,Y=R?`${y}.${T}.${v}.${R}.${O}`:`${y}.${T}.${v}.${O}`,z=u(`${P}/${Y}`),X=w=>{let $=w.split("/").filter(Boolean);return $.pop(),$.join("/")};if(await j.ensureFolder(X(z)),!await g.exists(m))return[!1,`Project directory not found: ${m}`];if(await g.exists(z))return[!1,`Archive destination already exists: ${z}`];await g.rename(m,z);try{if(await g.exists(f)){let w=u(`${z}/Templates`);await j.ensureFolder(w);let $=u(`${w}/${p.info.name}_Templates`);if(await g.exists($)){let W=u(`${w}/${p.info.name}_Templates_archived`);await g.rename(f,W)}else await g.rename(f,$)}}catch(w){console.warn("Archiving templates failed:",w)}try{let w=e.settings.projectRecords;(!e.settings.archivedRecords||Array.isArray(e.settings.archivedRecords))&&(e.settings.archivedRecords=e.settings.archivedRecords&&Array.isArray(e.settings.archivedRecords)?{}:e.settings.archivedRecords||{});let $=e.settings.archivedRecords;$[r]=$[r]||{},$[r][t]=$[r][t]||{},$[r][t][o]=p,(a=(i=w==null?void 0:w[r])==null?void 0:i[t])!=null&&a[o]&&(delete w[r][t][o],Object.keys(w[r][t]).length===0&&delete w[r][t],Object.keys(w[r]||{}).length===0&&delete w[r]);try{let{ensureProjectIndex:W,removeFromProjectIndex:Pe,toIndexEntry:je}=await Promise.resolve().then(()=>(he(),Se)),{ensureProjectGraph:Re,removeProjectFromGraph:Me,addProjectToGraph:Oe}=await Promise.resolve().then(()=>(ye(),$e)),{index:Ge}=W(e.settings.projectIndex,w);e.settings.projectIndex=Pe(Ge,je(p,o,r,t));let{graph:Le}=Re(e.settings.projectGraph,w,$);e.settings.projectGraph=Me(Le,p.variables.PROJECT_FULL_NAME,!1),e.settings.projectGraph=Oe(e.settings.projectGraph,p,!0)}catch(W){console.warn("Failed to update projectIndex after archive:",W)}await e.saveData(e.settings)}catch(w){console.warn("Failed to move project record to archive in settings:",w)}return[!0,"Project archived successfully."]}catch(l){return console.error("Archive failed:",l),[!1,(c=l==null?void 0:l.message)!=null?c:"Failed to archive project."]}}var Zr=[{name:"Business",order:1,categories:["R&D","Jobs","OpenSource","Education"]},{name:"Family",order:2,categories:["Vacations","Parenting","Common"]},{name:"Friends",order:3,categories:[]},{name:"Health",order:4,categories:["Clinics","Issues","R&D"]},{name:"Personal",order:5,categories:["R&D","Languages","SelfManagement","Writing","Reading","Music","Sports"]},{name:"Residence",order:6,categories:[]}],Qe={dimensions:JSON.parse(JSON.stringify(Zr)),projectsRoot:"1. Projects",archiveRoot:"4. Archive",templatesRoot:"Templates/ProjectFlow",ai:{enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com"},projectRecords:{},archivedRecords:{},projectGraph:{version:1,byFullName:{},archivedByFullName:{}},entityTypes:ce,projectTypes:me};function Ut(e){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return r}var Ze=class extends x.PluginSettingTab{constructor(t,o){super(t,o);this.plugin=o}display(){var Oe,Ge,Le,$t,Nt,Ct,Ft,Dt,_t,Mt;let{containerEl:t}=this;t.empty(),t.addClass("project-flow-settings");let o=t.createDiv({cls:"gc-row"});o.createDiv({cls:"gc-spacer"});let n=o.createEl("button",{cls:["gc-icon-button","clickable-icon"],attr:{"aria-label":"Reset to defaults",title:"Reset to defaults"}});try{(0,x.setIcon)(n,"rotate-ccw")}catch(h){n.setText("Reset to defaults")}n.onclick=()=>{new Ue(this.app,async A=>{A&&(this.plugin.settings=JSON.parse(JSON.stringify(Qe)),await this.plugin.saveSettings(),new x.Notice("Settings were reset to defaults."),this.display())}).open()},t.createEl("h2",{text:"Folders"});let s=t.createDiv({cls:"gc-column"}),i=s.createDiv({cls:"setting-item"});i.createEl("label",{text:"Projects root"});let a=i.createEl("input",{type:"text"});a.value=this.plugin.settings.projectsRoot||"1. Projects",a.placeholder="e.g. 1. Projects",a.onchange=async()=>{this.plugin.settings.projectsRoot=a.value.trim()||"1. Projects",await this.plugin.saveSettings()};let c=s.createDiv({cls:"setting-item"});c.createEl("label",{text:"Archive root"});let l=c.createEl("input",{type:"text"});l.value=this.plugin.settings.archiveRoot||"4. Archive",l.placeholder="e.g. 4. Archive",l.onchange=async()=>{this.plugin.settings.archiveRoot=l.value.trim()||"4. Archive",await this.plugin.saveSettings()};let p=s.createDiv({cls:"setting-item"});p.createEl("label",{text:"Templates root"});let u=p.createEl("input",{type:"text"});u.value=this.plugin.settings.templatesRoot||"Templates/ProjectFlow",u.placeholder="e.g. Templates/ProjectFlow",u.onchange=async()=>{this.plugin.settings.templatesRoot=u.value.trim()||"Templates/ProjectFlow",await this.plugin.saveSettings()},t.createEl("h2",{text:"Dimensions"}),[...this.plugin.settings.dimensions].sort((h,A)=>{var _,D;return((_=h.order)!=null?_:0)-((D=A.order)!=null?D:0)}).forEach((h,A)=>{let _=t.createDiv({cls:"dimension-setting"}),D=_.createDiv({cls:"dimension-header"});D.addClass("gc-row"),D.createSpan({text:`${h.order}. `});let K=D.createEl("b",{text:h.name});D.createDiv({cls:"gc-spacer"});let L=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});L.setAttr("aria-label","Move up"),L.setAttr("title","Move up");try{(0,x.setIcon)(L,"arrow-up")}catch(I){L.setText("Up")}L.onclick=async()=>{let S=[...this.plugin.settings.dimensions].filter(N=>{var k,b;return((k=N.order)!=null?k:0)<((b=h.order)!=null?b:0)}).sort((N,k)=>{var b,C;return((b=k.order)!=null?b:0)-((C=N.order)!=null?C:0)})[0];if(!S)return;let E=S.order;S.order=h.order,h.order=E,await this.plugin.saveSettings(),this.display()};let oe=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});oe.setAttr("aria-label","Move down"),oe.setAttr("title","Move down");try{(0,x.setIcon)(oe,"arrow-down")}catch(I){oe.setText("Down")}oe.onclick=async()=>{let S=[...this.plugin.settings.dimensions].filter(N=>{var k,b;return((k=N.order)!=null?k:0)>((b=h.order)!=null?b:0)}).sort((N,k)=>{var b,C;return((b=N.order)!=null?b:0)-((C=k.order)!=null?C:0)})[0];if(!S)return;let E=S.order;S.order=h.order,h.order=E,await this.plugin.saveSettings(),this.display()};let ne=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ne.setAttr("aria-label",`Delete ${h.name}`),ne.setAttr("title",`Delete ${h.name}`);try{(0,x.setIcon)(ne,"trash")}catch(I){ne.setText("Remove")}ne.onclick=async()=>{let I=this.plugin.settings.dimensions.findIndex(S=>S===h);I>=0&&this.plugin.settings.dimensions.splice(I,1),await this.plugin.saveSettings(),this.display()};let G=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});G.setAttr("aria-label",`Rename ${h.name}`),G.setAttr("title",`Rename ${h.name}`);try{(0,x.setIcon)(G,"pencil")}catch(I){G.setText("Edit")}if(G.onclick=async()=>{var se;let I=h.name,S=K.parentElement;(se=K.detach)==null||se.call(K),G.style.display="none",ne.style.display="none";let E=S.createEl("input",{type:"text"});E.value=I,E.addClass("gc-rename");let N=S.createDiv({cls:"gc-row"});N.createDiv({cls:"gc-spacer"});let k=N.createEl("button",{cls:["gc-icon-button","clickable-icon"]});k.setAttr("aria-label","Apply"),k.setAttr("title","Apply");try{(0,x.setIcon)(k,"check")}catch(B){k.setText("Apply")}let b=N.createEl("button",{cls:["gc-icon-button","clickable-icon"]});b.setAttr("aria-label","Discard"),b.setAttr("title","Discard");try{(0,x.setIcon)(b,"x")}catch(B){b.setText("Discard")}let C=()=>{this.display()},Z=async B=>{let Q=B.trim();if(!Q||Q===I){C();return}if(this.plugin.settings.dimensions.some(xe=>xe!==h&&xe.name===Q)){new x.Notice("A dimension with this name already exists.");return}h.name=Q,await this.plugin.saveSettings(),C()};k.onclick=async()=>{await Z(E.value)},b.onclick=()=>C(),E.focus(),E.select(),E.onkeydown=async B=>{B.key==="Enter"&&await Z(E.value),B.key==="Escape"&&C()},E.onblur=async()=>{await Z(E.value)}},h.categories.length>0){let I=_.createDiv({cls:"categories-list gc-list"});h.categories.forEach((S,E)=>{var xe;let N=I.createDiv({cls:"gc-list-item gc-row"}),k=this.plugin.settings.projectRecords||{},b=h.name,C=Object.keys(((xe=k==null?void 0:k[b])==null?void 0:xe[S])||{}),Z=N.createEl("b",{text:S}),se=N.createDiv({cls:"gc-id-wrap"});C.length>0&&(se.createSpan({text:" "}),C.forEach((J,Be)=>{let M=se.createSpan({cls:"gc-id-chip"});M.style.display="inline-flex",M.style.alignItems="center",M.style.gap="4px";let ve=M.createSpan({cls:"gc-id-tag",text:J}),ie=Math.abs(Ut(J))%360;ve.style.backgroundColor=`hsl(${ie}, 70%, 90%)`,ve.style.color=`hsl(${ie}, 70%, 25%)`;let q=M.createSpan({cls:"gc-id-actions"});q.style.display="none";let ee=q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ee.setAttr("aria-label",`Delete ${J}`),ee.setAttr("title",`Delete ${J}`);try{(0,x.setIcon)(ee,"trash")}catch(ae){ee.setText("Del")}ee.onclick=async ae=>{ae.stopPropagation();let[,te]=await ze(this.plugin,b,S,J);new x.Notice(te),this.display()};let re=q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});re.setAttr("aria-label",`Archive ${J}`),re.setAttr("title",`Archive ${J}`);try{(0,x.setIcon)(re,"archive")}catch(ae){re.setText("Arc")}re.onclick=async ae=>{ae.stopPropagation();let[,te]=await Xe(this.plugin,b,S,J);new x.Notice(te),this.display()},M.onmouseenter=()=>{q.style.display="inline-flex"},M.onmouseleave=()=>{q.style.display="none"},Be<C.length-1&&se.createSpan({text:" "})})),N.createDiv({cls:"gc-spacer"});let B=N.createEl("button",{cls:["remove-category","gc-icon-button","clickable-icon"]});B.setAttr("aria-label",`Delete ${S}`),B.setAttr("title",`Delete ${S}`);try{(0,x.setIcon)(B,"trash")}catch(J){B.setText("Remove")}B.onclick=async()=>{h.categories.splice(E,1),await this.plugin.saveSettings(),this.display()};let Q=N.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Q.setAttr("aria-label",`Rename ${S}`),Q.setAttr("title",`Rename ${S}`);try{(0,x.setIcon)(Q,"pencil")}catch(J){Q.setText("Edit")}Q.onclick=async()=>{var ae;let J=h.categories[E],Be=Z.parentElement;(ae=Z.detach)==null||ae.call(Z),Q.style.display="none",B.style.display="none";let M=Be.createEl("input",{type:"text"});M.value=J,M.addClass("gc-rename");let ve=Be.createDiv({cls:"gc-row"});ve.createDiv({cls:"gc-spacer"});let ie=ve.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ie.setAttr("aria-label","Apply"),ie.setAttr("title","Apply");try{(0,x.setIcon)(ie,"check")}catch(te){ie.setText("Apply")}let q=ve.createEl("button",{cls:["gc-icon-button","clickable-icon"]});q.setAttr("aria-label","Discard"),q.setAttr("title","Discard");try{(0,x.setIcon)(q,"x")}catch(te){q.setText("Discard")}let ee=()=>{this.display()},re=async te=>{let Je=te.trim();if(!Je||Je===J){ee();return}if(h.categories.some((Mr,Or)=>Or!==E&&Mr===Je)){new x.Notice("This category already exists in the dimension.");return}h.categories[E]=Je,await this.plugin.saveSettings(),ee()};ie.onclick=async()=>{await re(M.value)},q.onclick=()=>ee(),M.focus(),M.select(),M.onkeydown=async te=>{te.key==="Enter"&&await re(M.value),te.key==="Escape"&&ee()},M.onblur=async()=>{await re(M.value)}}})}let de=_.createDiv({cls:"add-category gc-row"}),Ee=de.createEl("input",{type:"text",placeholder:"New category"});de.createDiv({cls:"gc-spacer"});let be=de.createEl("button",{text:"Add Category"});be.onclick=async()=>{let I=Ee.value.trim();I&&!h.categories.includes(I)&&(h.categories.push(I),await this.plugin.saveSettings(),this.display())}});let j=t.createDiv({cls:"add-dimension"});j.createEl("h3",{text:"Add new dimension"});let g=j.createDiv({cls:"gc-row"}),m=g.createEl("input",{type:"text",placeholder:"Dimension name"});g.createDiv({cls:"gc-spacer"});let f=g.createEl("button",{text:"Add Dimension"});f.onclick=async()=>{let h=m.value.trim();if(h&&!this.plugin.settings.dimensions.some(A=>A.name===h)){{let A=this.plugin.settings.dimensions.reduce((_,D)=>{var K;return Math.max(_,(K=D.order)!=null?K:0)},0);this.plugin.settings.dimensions.push({name:h,order:A+1,categories:[]})}await this.plugin.saveSettings(),this.display()}},t.createEl("h2",{text:"AI Module"});let P=t.createDiv({cls:"gc-column"}),y=P.createDiv({cls:"setting-item"});y.createEl("label",{text:"Enable AI module"});let T=y.createEl("input",{type:"checkbox"});T.checked=Boolean((Oe=this.plugin.settings.ai)==null?void 0:Oe.enabled),T.onchange=async()=>{var h,A;this.plugin.settings.ai||(this.plugin.settings.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com"}),this.plugin.settings.ai.enabled=T.checked,await this.plugin.saveSettings(),await((A=(h=this.plugin).toggleAiView)==null?void 0:A.call(h,T.checked))};let v=P.createDiv({cls:"setting-item"});v.createEl("label",{text:"Provider"});let R=v.createEl("select");["openai","anthropic","ollama"].forEach(h=>{let A=R.createEl("option",{text:h});A.value=h}),R.value=((Ge=this.plugin.settings.ai)==null?void 0:Ge.provider)||"openai",R.onchange=async()=>{if(!this.plugin.settings.ai)return;let h={openai:{baseUrl:"https://api.openai.com",model:"gpt-4o-mini"},anthropic:{baseUrl:"https://api.anthropic.com",model:"claude-3-5-sonnet-latest"},ollama:{baseUrl:"http://localhost:11434",model:"llama3.1"}};this.plugin.settings.ai.provider=R.value;let A=this.plugin.settings.ai.baseUrl||"",_=this.plugin.settings.ai.model||"",D=Object.values(h).map(L=>L.baseUrl),K=Object.values(h).map(L=>L.model);(!A||D.includes(A))&&(this.plugin.settings.ai.baseUrl=h[R.value].baseUrl),(!_||K.includes(_))&&(this.plugin.settings.ai.model=h[R.value].model),await this.plugin.saveSettings(),this.display()};let O=P.createDiv({cls:"setting-item"});O.createEl("label",{text:"API key (not required for local providers)"});let Y=O.createEl("input",{type:"password"});Y.placeholder="sk-...",Y.value=((Le=this.plugin.settings.ai)==null?void 0:Le.apiKey)||"",Y.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.apiKey=Y.value.trim(),await this.plugin.saveSettings())};let z=P.createDiv({cls:"setting-item"});z.createEl("label",{text:"Model"});let X=z.createEl("input",{type:"text"});X.placeholder=(($t=this.plugin.settings.ai)==null?void 0:$t.provider)==="anthropic"?"claude-3-5-sonnet-latest":((Nt=this.plugin.settings.ai)==null?void 0:Nt.provider)==="ollama"?"llama3.1":"gpt-4o-mini",X.value=((Ct=this.plugin.settings.ai)==null?void 0:Ct.model)||X.placeholder,X.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.model=X.value.trim()||"gpt-4o-mini",await this.plugin.saveSettings())};let w=P.createDiv({cls:"setting-item"});w.createEl("label",{text:"Base URL"});let $=w.createEl("input",{type:"text"});$.placeholder=((Ft=this.plugin.settings.ai)==null?void 0:Ft.provider)==="anthropic"?"https://api.anthropic.com":((Dt=this.plugin.settings.ai)==null?void 0:Dt.provider)==="ollama"?"http://localhost:11434":"https://api.openai.com",$.value=((_t=this.plugin.settings.ai)==null?void 0:_t.baseUrl)||$.placeholder,$.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.baseUrl=$.value.trim()||"https://api.openai.com",await this.plugin.saveSettings())},t.createEl("h2",{text:"Archive"});let W=this.plugin.settings.archivedRecords||{},Pe=W&&!Array.isArray(W)?W:{},je={};for(let h of this.plugin.settings.dimensions)je[h.name]=(Mt=h.order)!=null?Mt:Number.MAX_SAFE_INTEGER;let Re=Object.keys(Pe).map(h=>{var A;return{name:h,order:(A=je[h])!=null?A:Number.MAX_SAFE_INTEGER}}).sort((h,A)=>h.order-A.order||h.name.localeCompare(A.name)),Me=!1;Re.forEach(({name:h,order:A})=>{let _=Pe[h]||{},D=Object.keys(_).filter(G=>Object.keys(_[G]||{}).length>0).sort();if(D.length===0)return;Me=!0;let K=t.createDiv({cls:"dimension-setting"}),L=K.createDiv({cls:"dimension-header gc-row"}),oe=this.plugin.settings.dimensions.find(G=>G.name===h);oe&&L.createSpan({text:`${oe.order}. `}),L.createEl("b",{text:h}),L.createDiv({cls:"gc-spacer"});let ne=K.createDiv({cls:"categories-list gc-list"});D.forEach(G=>{let de=ne.createDiv({cls:"gc-list-item gc-row"}),Ee=Object.keys((_==null?void 0:_[G])||{}).sort();de.createEl("b",{text:G});let be=de.createDiv({cls:"gc-id-wrap"});Ee.length>0&&(be.createSpan({text:" "}),Ee.forEach((I,S)=>{let E=be.createSpan({cls:"gc-id-chip"});E.style.display="inline-flex",E.style.alignItems="center",E.style.gap="4px";let N=E.createSpan({cls:"gc-id-tag",text:I}),k=Math.abs(Ut(I))%360;N.style.backgroundColor=`hsl(${k}, 70%, 90%)`,N.style.color=`hsl(${k}, 70%, 25%)`;let b=E.createSpan({cls:"gc-id-actions"});b.style.display="none";let C=b.createEl("button",{cls:["gc-icon-button","clickable-icon"]});C.setAttr("aria-label",`Delete ${I}`),C.setAttr("title",`Delete ${I}`);try{(0,x.setIcon)(C,"trash")}catch(Z){C.setText("Del")}C.onclick=async Z=>{Z.stopPropagation();let[,se]=await this.plugin.deleteArchivedProject(h,G,I);new x.Notice(se),this.display()},E.onmouseenter=()=>{b.style.display="inline-flex"},E.onmouseleave=()=>{b.style.display="none"},S<Ee.length-1&&be.createSpan({text:" "})})),de.createDiv({cls:"gc-spacer"})})}),Me||t.createDiv({cls:"setting-item"}).createSpan({text:"No archived projects yet."})}};var Rt=require("obsidian");var Vt=require("obsidian"),qe=class extends Vt.Modal{constructor(t,o,n){super(t);this.prompt=o,this.callback=n}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:this.prompt});let o=t.createEl("input",{type:"text"});o.focus();let n=t.createEl("button",{text:"Submit"});n.onclick=()=>{let s=o.value.trim();this.close(),this.callback(s||null)}}onClose(){let{contentEl:t}=this;t.empty()}};var Wt=require("obsidian"),Ne=class extends Wt.Modal{constructor(t,o,n,s){super(t);this.prompt=o,this.choices=n,this.callback=s}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:this.prompt}),this.choices.forEach(o=>{let n=t.createEl("button",{text:o});n.onclick=()=>{this.close(),this.callback(o)}})}onClose(){let{contentEl:t}=this;t.empty()}};async function Ce(e,r){return new Promise(t=>{new qe(e,r,t).open()})}async function we(e,r,t){return new Promise(o=>{new Ne(e,r,t,o).open()})}async function Yt(e,r){var j,g;let t=await Ce(e,"Enter project name:");if(!t)return[null,"Project creation cancelled. No project name provided."];let o=await Ce(e,"Enter project tag:");if(!o)return[null,"Project creation cancelled. No project tag provided."];let n=await Ce(e,"Enter Project ID (used for task prefixes):");if(!n)return[null,"Project creation cancelled. No Project ID provided."];let s=await Ce(e,"Enter parent name (optional):"),i=s&&s.trim().length>0?s.trim():null,a=[...r.dimensions].sort((m,f)=>{var P,y;return((P=m.order)!=null?P:0)-((y=f.order)!=null?y:0)}).map(m=>m.name),c=await we(e,"Select dimension:",a);if(!c)return[null,"Project creation cancelled. No dimension selected."];let l=r.dimensions.find(m=>m.name===c);if(!l||l.categories.length===0)return[null,"Selected dimension has no categories. Please add categories in settings first."];let p=l.categories,u=await we(e,"Select category:",p);if(!u)return[null,"Project creation cancelled. No category selected."];let d={name:t,tag:o,id:n,parent:i,dimension:c,category:u};try{let m=r.projectRecords;if(m&&!Array.isArray(m)&&((g=(j=m[c])==null?void 0:j[u])==null?void 0:g[n]))return[null,`Project with ID "${n}" already exists in ${c}:${u}. Choose a different ID.`]}catch(m){}try{let{validateProjectName:m,validateTag:f,ensureValidOrThrow:P}=await Promise.resolve().then(()=>(Ht(),Kt));P(()=>m(d.name),"Invalid project name"),P(()=>f(d.tag),"Invalid tag"),P(()=>f(d.id),"Invalid Project ID")}catch(m){let f=m.message||"Invalid input";return console.error("Validation error:",m),[null,f]}return[d,"Project details collected."]}async function et(e,r){var p;if(!r.projectRecords)return[null,"You don't have any projects yet."];let t=r.projectRecords,o=[...r.dimensions].sort((u,d)=>{var j,g;return((j=u.order)!=null?j:0)-((g=d.order)!=null?g:0)}).map(u=>u.name),n=await we(e,"Select dimension of your project:",o);if(!n)return[null,"Project action cancelled. No dimension selected."];let s=r.dimensions.find(u=>u.name===n);if(!s||s.categories.length===0)return[null,"Selected dimension has no categories. No project found."];let i=s.categories,a=await we(e,"Select category:",i);if(!a)return[null,"Project action cancelled. No category selected."];let c=(p=t[n])==null?void 0:p[a];if(!c||Object.keys(c).length===0)return[null,"No projects found in this category."];let l=await we(e,"Select Project:",Object.keys(c));return l?[{dimension:n,category:a,projectId:l},"Project details collected."]:[null,"Project action cancelled. No project selected."]}Tt();async function tr(e){let[r,t]=await Yt(e.app,e.settings);if(r===null){new Rt.Notice(t);return}let[,o]=await it(e,r);new Rt.Notice(o),console.log(o)}var Et=require("obsidian");async function rr(e){let[r,t]=await et(e.app,e.settings);if(r===null){new Et.Notice(t);return}let{dimension:o,category:n,projectId:s}=r,[,i]=await ze(e,o,n,s);new Et.Notice(i),console.log(i)}var bt=require("obsidian");async function or(e){let[r,t]=await et(e.app,e.settings);if(r===null){new bt.Notice(t);return}let{dimension:o,category:n,projectId:s}=r,[,i]=await Xe(e,o,n,s);new bt.Notice(i),console.log(i)}var gr=require("obsidian");var at={type:"object",description:"Reference to a project by tag, id, or full name.",properties:{tag:{type:"string"},id:{type:"string"},fullName:{type:"string"}},additionalProperties:!1};function nr(e){let r=e.getApi();return r?[{name:"resolveProject",description:"Resolve a project by tag, id, or full name.",schema:{type:"object",properties:{projectRef:at},required:["projectRef"],additionalProperties:!1},handler:async t=>r.resolveProject(t.projectRef)},{name:"listEntityTypes",description:"List available entity types.",schema:{type:"object",properties:{},additionalProperties:!1},handler:async()=>r.listEntityTypes()},{name:"createProject",description:"Create a project with the required metadata.",schema:{type:"object",properties:{name:{type:"string"},tag:{type:"string"},id:{type:"string"},dimension:{type:"string"},category:{type:"string"},parent:{type:"string"},projectTypeId:{type:"string"}},required:["name","tag","id","dimension","category"],additionalProperties:!1},handler:async t=>r.createProject(t)},{name:"createEntity",description:"Create an entity inside a project using a template.",schema:{type:"object",properties:{projectRef:at,entityTypeId:{type:"string"},fields:{type:"object"}},required:["projectRef","entityTypeId"],additionalProperties:!1},handler:async t=>r.createEntity(t)},{name:"patchMarker",description:"Patch content into a file at an AI marker.",schema:{type:"object",properties:{path:{type:"string"},marker:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","marker","content"],additionalProperties:!1},handler:async t=>r.patchMarker(t)},{name:"patchSection",description:"Patch content into a file by heading.",schema:{type:"object",properties:{path:{type:"string"},heading:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","heading","content"],additionalProperties:!1},handler:async t=>r.patchSection(t)},{name:"getChildren",description:"Get child projects for a given project.",schema:{type:"object",properties:{projectRef:at,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async t=>r.getChildren(t.projectRef,t.archived)},{name:"getParents",description:"Get parent projects for a given project.",schema:{type:"object",properties:{projectRef:at,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async t=>r.getParents(t.projectRef,t.archived)}]:[]}function ct(e,r,t="$",o=[]){if(!e)return o;let n=e.type?Array.isArray(e.type)?e.type:[e.type]:[];if(n.length>0&&!n.some(i=>co(i,r)))return o.push({path:t,message:`Expected ${n.join("|")}`}),o;if(e.enum&&!e.enum.includes(r)&&o.push({path:t,message:"Value not in enum"}),e.type==="object"&&r&&typeof r=="object"&&!Array.isArray(r)){let s=r;if((e.required||[]).forEach(a=>{a in s||o.push({path:`${t}.${a}`,message:"Missing required field"})}),e.properties)for(let[a,c]of Object.entries(e.properties))a in s&&ct(c,s[a],`${t}.${a}`,o)}return e.type==="array"&&Array.isArray(r)&&e.items&&r.forEach((s,i)=>{ct(e.items,s,`${t}[${i}]`,o)}),o}function co(e,r){return e==="array"?Array.isArray(r):e==="integer"?Number.isInteger(r):e==="number"?typeof r=="number":e==="boolean"?typeof r=="boolean":e==="string"?typeof r=="string":e==="object"?r!=null&&typeof r=="object"&&!Array.isArray(r):!0}async function sr(e,r){let t=[],o=new Map(r.map(n=>[n.name,n]));for(let n of e){let s=o.get(n.name);if(!s){t.push({toolName:n.name,ok:!1,error:"Tool not found"});continue}let i=ct(s.schema,n.arguments);if(i.length>0){t.push({toolName:n.name,ok:!1,error:`Schema validation failed: ${i.map(a=>`${a.path}: ${a.message}`).join(", ")}`});continue}try{let a=await s.handler(n.arguments);t.push({toolName:n.name,ok:!0,result:a})}catch(a){t.push({toolName:n.name,ok:!1,error:(a==null?void 0:a.message)||"Tool execution failed"})}}return t}async function*ir(e,r,t){var p,u;let o=`${e.baseUrl.replace(/\/$/,"")}/v1/chat/completions`,n={model:e.model,messages:r.map(d=>{let j={role:d.role,content:d.content};return d.role==="tool"&&d.toolCallId&&(j.tool_call_id=d.toolCallId),d.role==="assistant"&&d.toolCalls&&d.toolCalls.length>0&&(j.tool_calls=d.toolCalls.map(g=>{var m;return{id:g.id,type:"function",function:{name:g.name,arguments:JSON.stringify((m=g.arguments)!=null?m:{})}}})),j}),tools:t.map(d=>({type:"function",function:{name:d.name,description:d.description,parameters:d.schema}})),tool_choice:"auto",stream:!0},s={"Content-Type":"application/json"};e.apiKey&&(s.Authorization=`Bearer ${e.apiKey}`);let i=await fetch(o,{method:"POST",headers:s,body:JSON.stringify(n)});if(!i.ok||!i.body){let d=await lo(i);throw new Error(`OpenAI request failed: ${i.status} ${d||i.statusText}`)}let a=i.body.getReader(),c=new TextDecoder,l="";for(;;){let{value:d,done:j}=await a.read();if(j)break;l+=c.decode(d,{stream:!0});let g=l.split(`
`);l=g.pop()||"";for(let m of g){let f=m.trim();if(!f.startsWith("data:"))continue;let P=f.replace(/^data:\s*/,"");if(P==="[DONE]"){yield{type:"done"};return}let y;try{y=JSON.parse(P)}catch(v){continue}let T=(u=(p=y==null?void 0:y.choices)==null?void 0:p[0])==null?void 0:u.delta;T&&(T.content&&(yield{type:"content",delta:T.content}),T.tool_calls&&(yield{type:"tool_call_delta",toolCalls:T.tool_calls.map(R=>{var O,Y;return{index:R.index,id:R.id,name:(O=R.function)==null?void 0:O.name,arguments:(Y=R.function)==null?void 0:Y.arguments}})}))}}yield{type:"done"}}function ar(e,r){for(let t of e){let o=r.get(t.index)||{name:"",arguments:{}};if(t.id&&(o.id=t.id),t.name&&(o.name=t.name),typeof t.arguments=="string"){let n=o._rawArgs||"";o._rawArgs=n+t.arguments}r.set(t.index,o)}}function cr(e){let r=[];for(let[,t]of e){let o=t._rawArgs;if(o)try{t.arguments=JSON.parse(o)}catch(n){t.arguments={}}delete t._rawArgs,r.push(t)}return r}async function lo(e){try{return await e.text()}catch(r){return""}}async function*lr(e,r,t){let o=`${e.baseUrl.replace(/\/$/,"")}/v1/messages`,{system:n,anthropicMessages:s}=po(r),i={model:e.model,max_tokens:1024,system:n,messages:s,tools:t.map(d=>({name:d.name,description:d.description,input_schema:d.schema})),stream:!0},a=await fetch(o,{method:"POST",headers:{"x-api-key":e.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify(i)});if(!a.ok||!a.body){let d=await mo(a);throw new Error(`Anthropic request failed: ${a.status} ${d||a.statusText}`)}let c=a.body.getReader(),l=new TextDecoder,p="",u=new Set;for(;;){let{value:d,done:j}=await c.read();if(j)break;p+=l.decode(d,{stream:!0});let g=p.split(`
`);p=g.pop()||"";for(let m of g){let f=m.trim();if(!f.startsWith("data:"))continue;let P=f.replace(/^data:\s*/,"");if(!P||P==="[DONE]"){yield{type:"done"};return}let y;try{y=JSON.parse(P)}catch(v){continue}let T=y==null?void 0:y.type;if(T==="content_block_delta"){let v=y.delta;if((v==null?void 0:v.type)==="text_delta"&&(yield{type:"content",delta:v.text}),(v==null?void 0:v.type)==="input_json_delta"){if(u.has(y.index))continue;yield{type:"tool_call_delta",toolCalls:[{index:y.index,arguments:v.partial_json}]}}}if(T==="content_block_start"){let v=y.content_block;if((v==null?void 0:v.type)==="tool_use"){let R=v.input&&Object.keys(v.input).length>0;R&&u.add(y.index),yield{type:"tool_call_delta",toolCalls:[{index:y.index,id:v.id,name:v.name,arguments:R?JSON.stringify(v.input):""}]}}}if(T==="message_stop"){yield{type:"done"};return}}}yield{type:"done"}}function po(e){let r="",t=[];for(let o of e){if(o.role==="system"){r=[r,o.content].filter(Boolean).join(`
`);continue}if(o.role==="user"){t.push({role:"user",content:[{type:"text",text:o.content}]});continue}if(o.role==="assistant"){let n=[];if(o.content&&n.push({type:"text",text:o.content}),o.toolCalls&&o.toolCalls.length>0)for(let s of o.toolCalls)n.push({type:"tool_use",id:s.id||`tool-${s.name}`,name:s.name,input:s.arguments||{}});n.length>0&&t.push({role:"assistant",content:n});continue}o.role==="tool"&&t.push({role:"user",content:[{type:"tool_result",tool_use_id:o.toolCallId||o.name||"tool",content:o.content}]})}return{system:r,anthropicMessages:t}}async function mo(e){try{return await e.text()}catch(r){return""}}async function*pr(e,r,t){if(e.provider==="anthropic"){if(!e.apiKey)throw new Error("Anthropic API key is missing");yield*lr({apiKey:e.apiKey,model:e.model||"claude-3-5-sonnet-latest",baseUrl:e.baseUrl||"https://api.anthropic.com"},r,t);return}let o=e.provider==="ollama"?e.baseUrl||"http://localhost:11434":e.baseUrl||"https://api.openai.com";if(!e.apiKey&&e.provider!=="ollama")throw new Error("OpenAI API key is missing");yield*ir({apiKey:e.apiKey||"",model:e.model||(e.provider==="ollama"?"llama3.1":"gpt-4o-mini"),baseUrl:o},r,t)}function dr(e){let r=e.app.workspace.getActiveFile();if(!r)return null;let t=e.settings.projectIndex;if(!t)return null;let o=r.path,n=Object.values(t.byFullName||{}),s=null;for(let i of n)i.path&&o.startsWith(i.path)&&(!s||i.path.length>s.path.length)&&(s=i);return s}function mr(e,r,t=5){let o=e.settings.projectIndex;if(!o)return[];let n=r.trim().toLowerCase();return n?Object.values(o.byFullName||{}).map(a=>{var u,d;let c=((u=a.projectTag)==null?void 0:u.toLowerCase())||"",l=((d=a.projectName)==null?void 0:d.toLowerCase())||"",p=0;return c===n&&(p+=100),l===n&&(p+=90),c.startsWith(n)&&(p+=60),l.startsWith(n)&&(p+=50),c.includes(n)&&(p+=30),l.includes(n)&&(p+=20),{entry:a,score:p}}).filter(a=>a.score>0).sort((a,c)=>c.score-a.score).slice(0,t).map(a=>a.entry):[]}var le="projectflow-ai-chat",lt=class extends gr.ItemView{constructor(t,o){super(t);this.messageContainer=null;this.inputEl=null;this.sendBtn=null;this.busy=!1;this.plugin=o}getViewType(){return le}getDisplayText(){return"ProjectFlow AI"}getIcon(){return"brain-circuit"}async onOpen(){let t=this.containerEl.children[1];t.empty(),t.addClass("pf-ai-view"),t.createDiv({cls:"pf-ai-header"}).createEl("h3",{text:"ProjectFlow AI"});let n=t.createDiv({cls:"pf-ai-messages"});this.messageContainer=n;let s=t.createDiv({cls:"pf-ai-input"}),i=s.createEl("textarea");i.placeholder="Ask ProjectFlow...";let a=s.createEl("button",{text:"Send"});this.inputEl=i,this.sendBtn=a,a.onclick=()=>this.handleSend(),i.onkeydown=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),this.handleSend())}}async onClose(){this.messageContainer=null,this.inputEl=null,this.sendBtn=null}appendMessage(t,o){if(!this.messageContainer)return null;let n=this.messageContainer.createDiv({cls:`pf-ai-message ${t}`});return n.setText(o),this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}),n}updateMessage(t,o){var n;t&&(t.setText(o),(n=this.messageContainer)==null||n.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}))}async handleSend(){var n;if(this.busy)return;let t=(((n=this.inputEl)==null?void 0:n.value)||"").trim();if(!t)return;this.inputEl.value="",this.appendMessage("user",t);let o=this.plugin.settings.ai;if(!(o!=null&&o.enabled)){this.appendMessage("assistant","AI module is disabled in settings.");return}if(!o.apiKey&&o.provider!=="ollama"){await this.handleTagLookup(t);return}await this.handleLLM(t)}async handleTagLookup(t){let o=this.plugin.getApi();if(!o){this.appendMessage("assistant","Core API is not available.");return}try{let n=o.resolveProject({tag:t});if(!n){let s=mr(this.plugin,t);if(s.length===0)this.appendMessage("assistant","Project not found.");else if(s.length===1)this.appendMessage("assistant",`Resolved project: ${s[0].fullName} (${s[0].projectTag})`);else{let i=s.map(a=>`- ${a.projectTag} (${a.fullName})`).join("\\n");this.appendMessage("assistant",`Multiple matches found:\\n${i}`)}return}this.appendMessage("assistant",`Resolved project: ${n.entry.fullName} (${n.entry.projectTag})`)}catch(n){this.appendMessage("assistant",(n==null?void 0:n.message)||"Failed to resolve project.")}}async handleLLM(t){if(!this.busy){this.busy=!0,this.sendBtn&&(this.sendBtn.disabled=!0);try{let o=nr(this.plugin),n=await this.buildSystemPrompt(),s=this.buildUserMessage(t),i=[{role:"system",content:n},{role:"user",content:s}];await this.runAgentLoop(i,o)}catch(o){this.appendMessage("assistant",(o==null?void 0:o.message)||"LLM request failed.")}finally{this.busy=!1,this.sendBtn&&(this.sendBtn.disabled=!1)}}}async runAgentLoop(t,o){var s;for(let i=0;i<6;i+=1){let a=this.appendMessage("assistant",""),c=new Map,l=new Map;for await(let g of pr(this.plugin.settings.ai,t,o)){if(g.type==="content"&&g.delta){let m=(a==null?void 0:a.textContent)||"";this.updateMessage(a,m+g.delta)}if(g.type==="tool_call_delta"&&g.toolCalls){ar(g.toolCalls,l);for(let m of g.toolCalls)if(m.name&&!c.has(m.name)){let f=this.appendMessage("tool",`Using tool: ${m.name}`);f&&c.set(m.name,f)}}}let p=cr(l),u=(a==null?void 0:a.textContent)||"";if(t.push({role:"assistant",content:u,toolCalls:p}),p.length===0)return;let d=await sr(p,o),j=uo(d);for(let g=0;g<d.length;g+=1){let m=d[g],f=m.ok?{ok:!0,result:m.result}:{ok:!1,error:m.error},P=m.ok?`Tool result (${m.toolName}): ${go(m.result)}`:`Tool error (${m.toolName}): ${m.error}`;this.appendMessage("tool",P),t.push({role:"tool",name:m.toolName,toolCallId:(s=p[g])==null?void 0:s.id,content:JSON.stringify(f)})}if(j.length>0){let g=Array.from(new Set(j));this.appendMessage("assistant",`Missing required fields: ${g.join(", ")}. Please provide them and try again.`);return}}this.appendMessage("assistant","Stopped after reaching max tool steps.")}async buildSystemPrompt(){let t=this.getSelection(),o=this.app.workspace.getActiveFile(),n="";if(o)try{n=(await this.app.vault.cachedRead(o)).slice(0,1e3)}catch(c){n=""}let s=this.plugin.settings.projectIndex,i=dr(this.plugin),a=fo(this.plugin);return["You are ProjectFlow AI. You must use tools to perform any actions.","Never edit markdown directly; use tools only.","Respond with tool calls when an action is required.","If required fields are missing, ask the user for them instead of calling tools.","Map user input lines like 'title:' and 'description:' to fields.TITLE and fields.DESCRIPTION.","Context:",`Selected text: ${t||"(none)"}`,`Active file: ${(o==null?void 0:o.path)||"(none)"}`,`Active file content (truncated): ${n||"(none)"}`,`Active project: ${i?`${i.projectTag} (${i.fullName})`:"(none)"}`,`Entity required fields: ${a}`,`Project index snapshot: ${s?JSON.stringify(s):"(none)"}`].join(`
`)}buildUserMessage(t){return`I'm going to create a project with tag ${t}
${t}`}getSelection(){var o;let t=(o=this.app.workspace.activeEditor)==null?void 0:o.editor;return t?t.getSelection():""}};function go(e){if(e==null)return"(no result)";if(typeof e=="string")return e;try{return JSON.stringify(e)}catch(r){return String(e)}}function uo(e){var t;let r=[];for(let o of e)!o.ok&&((t=o.error)!=null&&t.startsWith("Missing required fields:"))&&o.error.split(":").slice(1).join(":").split(",").forEach(s=>{let i=s.trim();i&&r.push(i)});return r}function fo(e){let r=e.settings.entityTypes||{},t={};for(let[o,n]of Object.entries(r))n!=null&&n.requiredFields&&n.requiredFields.length>0&&(t[o]=n.requiredFields);try{return JSON.stringify(t)}catch(o){return"(unavailable)"}}var mt=class extends _r.Plugin{async onload(){var t;console.log("ProjectFlow plugin loaded"),await this.loadSettings(),this.addSettingTab(new Ze(this.app,this)),this.registerView(le,o=>new lt(o,this)),this.addCommand({id:"add-project-info",name:"Add Project Info",callback:()=>tr(this)}),this.addCommand({id:"remove-project-by-id",name:"Remove Project",callback:()=>rr(this)}),this.addCommand({id:"archive-project-by-id",name:"Archive Project",callback:()=>or(this)}),await this.exposeCoreApi(),(t=this.settings.ai)!=null&&t.enabled&&this.app.workspace.onLayoutReady(()=>{this.toggleAiView(!0)})}async loadSettings(){let t=await this.loadData();try{let{migrateSettings:o,CURRENT_SETTINGS_SCHEMA_VERSION:n}=await Promise.resolve().then(()=>(xt(),ur)),{DEFAULT_ENTITY_TYPES:s,DEFAULT_PROJECT_TYPES:i}=await Promise.resolve().then(()=>(Ae(),Ot)),{ensureProjectIndex:a}=await Promise.resolve().then(()=>(he(),Se)),{ensureProjectGraph:c}=await Promise.resolve().then(()=>(ye(),$e));this.settings=Object.assign({},Qe,o(t));let l=!1;this.settings.templatesRoot||(this.settings.templatesRoot="Templates/ProjectFlow",l=!0),(!this.settings.entityTypes||Object.keys(this.settings.entityTypes).length===0)&&(this.settings.entityTypes=s,l=!0),(!this.settings.projectTypes||Object.keys(this.settings.projectTypes).length===0)&&(this.settings.projectTypes=i,l=!0),(!this.settings.schemaVersion||this.settings.schemaVersion<n)&&(this.settings.schemaVersion=n,l=!0);let{index:p,updated:u}=a(this.settings.projectIndex,this.settings.projectRecords);u&&(this.settings.projectIndex=p,l=!0);let{graph:d,updated:j}=c(this.settings.projectGraph,this.settings.projectRecords,this.settings.archivedRecords);j&&(this.settings.projectGraph=d,l=!0),l&&await this.saveData(this.settings)}catch(o){this.settings=Object.assign({},Qe,t)}}async saveSettings(){await this.saveData(this.settings)}getApi(){return this.coreApi}async toggleAiView(t){if(t){let o=this.app.workspace.getLeavesOfType(le);if(o.length>0){await o[0].setViewState({type:le,active:!0});return}let n=this.app.workspace.getRightLeaf(!1);if(!n)return;await n.setViewState({type:le,active:!0})}else this.app.workspace.detachLeavesOfType(le)}onunload(){this.app.workspace.detachLeavesOfType(le)}async exposeCoreApi(){let{createCoreApi:t}=await Promise.resolve().then(()=>(Dr(),Fr));this.coreApi=t(this);let o=window;o.PluginApi=o.PluginApi||{},o.PluginApi["@projectflow/core"]=this.coreApi}};var xo=mt;
