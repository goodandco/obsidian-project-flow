/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var gt=Object.defineProperty;var tr=Object.getOwnPropertyDescriptor;var nr=Object.getOwnPropertyNames;var rr=Object.prototype.hasOwnProperty;var M=(e,n)=>()=>(e&&(n=e(e=0)),n);var V=(e,n)=>{for(var t in n)gt(e,t,{get:n[t],enumerable:!0})},or=(e,n,t,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of nr(n))!rr.call(e,o)&&o!==t&&gt(e,o,{get:()=>n[o],enumerable:!(r=tr(n,o))||r.enumerable});return e};var sr=e=>or(gt({},"__esModule",{value:!0}),e);var Qt={};V(Qt,{DEFAULT_ENTITY_TYPES:()=>le,DEFAULT_PROJECT_TYPES:()=>ue});var le,ue,Se=M(()=>{le={task:{id:"task",name:"Task",templatePath:"template-task.md",targetFolder:"Work/Tasks",filenameRule:"${PROJECT_ID}-${title}",requiredFields:["title","description"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},"meeting.planning":{id:"meeting.planning",name:"Meeting (Planning)",templatePath:"template-meeting-planning.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.refinement":{id:"meeting.refinement",name:"Meeting (Refinement)",templatePath:"template-meeting-refinement.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.retro":{id:"meeting.retro",name:"Meeting (Retro)",templatePath:"template-meeting-retro.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.demo":{id:"meeting.demo",name:"Meeting (Demo)",templatePath:"template-meeting-demo.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.daily":{id:"meeting.daily",name:"Meeting (Daily)",templatePath:"template-meeting-daily.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.knowledge":{id:"meeting.knowledge",name:"Meeting (Knowledge)",templatePath:"template-meeting-knowledge.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},sprint:{id:"sprint",name:"Sprint",templatePath:"template-sprint.md",targetFolder:"Work",filenameRule:"Sprint ${title}",requiredFields:["title"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},idea:{id:"idea",name:"Idea",templatePath:"template-idea.md",targetFolder:"Knowledge Base",filenameRule:"Idea ${title}",requiredFields:["title"],patchMarkers:["AI:CONTENT"]}},ue={operational:{id:"operational",name:"Operational",description:"Default ProjectFlow structure for active projects.",folderStructure:["Knowledge Base","Meetings","Work","Work/Tasks","People"],initialNotes:[{fileName:"${PROJECT_FULL_NAME}.md",template:"project.md"},{fileName:"${PROJECT_NAME} Meetings.md",template:"meetings.md"},{fileName:"${PROJECT_NAME} People.md",template:"people.md"},{fileName:"${PROJECT_NAME} Work.md",template:"work.md"},{fileName:"${PROJECT_NAME} Knowledge Base.md",template:"knowledge-base.md"}],allowedEntityTypes:Object.keys(le)}}});var fe={};V(fe,{SafeFileManager:()=>ut});var ut,he=M(()=>{ut=class{constructor(n){this.vault=n.vault}async createBatch(n){let t=[];try{for(let r of n)r.type==="folder"?await this.ensureFolder(r.path):await this.createIfAbsent(r.path,r.data)==="created"&&t.push(r.path);return{ok:!0}}catch(r){for(let o of t.reverse())try{let s=this.vault.getAbstractFileByPath(o);s&&this.vault.delete&&await this.vault.delete(s)}catch(s){}return{ok:!1,error:r}}}async has(n){var t;try{return this.vault.getAbstractFileByPath(n)?!0:(t=this.vault.adapter)!=null&&t.exists?await this.vault.adapter.exists(n):!1}catch(r){return!1}}async ensureFolder(n){var r;if(!this.vault.getAbstractFileByPath(n))try{await this.vault.createFolder(n)}catch(o){if(o&&typeof o=="object"&&((r=o.message)!=null&&r.includes("Parent folder"))){let s=n.split("/").filter(Boolean),i="";for(let a of s)if(i=i?`${i}/${a}`:a,!this.vault.getAbstractFileByPath(i))try{await this.vault.createFolder(i)}catch(l){}}}}async createIfAbsent(n,t){if(await this.has(n))return"skipped";try{return await this.vault.create(n,t),"created"}catch(r){return await this.has(n),"skipped"}}async removeDir(n){let t=this.vault.getAbstractFileByPath(n);if(t&&this.vault)try{await this.vault.trash(t,!0),await new Promise(r=>setTimeout(r,200))}catch(r){console.warn(`removeDir: failed to trash ${n}: ${r}`)}else console.warn(`removeDir: file not found: ${n}. File: ${t==null?void 0:t.path}`)}}});var Ie={};V(Ie,{sanitizeFileName:()=>Ve,sanitizePath:()=>H});function Ve(e){let n=(e!=null?e:"").trim();return Array.from(n).filter(r=>r.charCodeAt(0)>=32).join("").replace(/[\\/:*?"<>|]/g,"-").replace(/\s+/g," ").replace(/\.+$/g,"").substring(0,200)||"untitled"}function H(e){return e?e.split("/").filter(Boolean).map(Ve).join("/"):""}var ye=M(()=>{});var ke={};V(ke,{PROJECT_INDEX_VERSION:()=>ft,addToProjectIndex:()=>ar,buildProjectIndex:()=>tn,ensureProjectIndex:()=>He,getProjectIndexCache:()=>Ke,removeFromProjectIndex:()=>cr,setProjectIndexCache:()=>ir,toIndexEntry:()=>ht});function Ke(){return We}function ir(e){We=e}function tn(e){let n={},t={},r={};if(e&&typeof e=="object"){for(let[o,s]of Object.entries(e))if(!(!s||typeof s!="object")){for(let[i,a]of Object.entries(s))if(!(!a||typeof a!="object"))for(let[l,p]of Object.entries(a)){if(!p||!p.variables||!p.info)continue;let c=ht(p,l,o,i);n[c.fullName]=c,t[c.projectId]=c,r[c.projectTag]=c}}}return{version:1,byFullName:n,byId:t,byTag:r}}function ht(e,n,t,r){var o;return{fullName:e.variables.PROJECT_FULL_NAME,projectId:n,projectTag:e.variables.PROJECT_TAG,path:e.variables.PROJECT_PATH,dimension:t,category:r,projectName:e.info.name,parent:(o=e.info.parent)!=null?o:null}}function He(e,n){if(!e||e.version!==1){let t=tn(n);return We=t,{index:t,updated:!0}}return We=e,{index:e,updated:!1}}function ar(e,n,t,r,o){let s=ht(n,t,r,o);return e.byFullName[s.fullName]=s,e.byId[s.projectId]=s,e.byTag[s.projectTag]=s,e}function cr(e,n){return delete e.byFullName[n.fullName],delete e.byId[n.projectId],delete e.byTag[n.projectTag],e}var ft,We,Pe=M(()=>{ft=1,We=null});var $e={};V($e,{PROJECT_GRAPH_VERSION:()=>yt,addProjectToGraph:()=>dr,buildProjectGraph:()=>Pt,cleanArchivedGraph:()=>jt,ensureProjectGraph:()=>Ne,getChildren:()=>vt,getParents:()=>wt,getProjectGraphCache:()=>lr,removeProjectFromGraph:()=>mr,setProjectGraphCache:()=>pr});function lr(){return Ye}function pr(e){Ye=e}function Pt(e,n){let t={},r={};return e&&nn(e,t),n&&nn(n,r),{version:1,byFullName:t,archivedByFullName:r}}function Ne(e,n,t){if(!e||e.version!==1){let r=Pt(n,t);return Ye=r,{graph:r,updated:!0}}return Ye=e,{graph:e,updated:!1}}function dr(e,n,t){let r=n.variables.PROJECT_FULL_NAME,o=rn(n.info.parent),s=t?e.archivedByFullName:e.byFullName;if(s[r]=s[r]||{parent:o,children:[]},s[r].parent=o!=null?o:null,o){let i=s[o]||{parent:null,children:[]};i.children.includes(r)||i.children.push(r),s[o]=i}return e}function mr(e,n,t){let r=t?e.archivedByFullName:e.byFullName,o=r[n];return o!=null&&o.parent&&r[o.parent]&&(r[o.parent].children=r[o.parent].children.filter(s=>s!==n)),delete r[n],e}function jt(e,n){let t=Pt(void 0,n);return e.archivedByFullName=t.archivedByFullName,e}function vt(e,n,t){var o,s;return(s=(o=(t?e.archivedByFullName:e.byFullName)[n])==null?void 0:o.children)!=null?s:[]}function wt(e,n,t){var i,a,l,p;let r=t?e.archivedByFullName:e.byFullName,o=[],s=(a=(i=r[n])==null?void 0:i.parent)!=null?a:null;for(;s;)o.push(s),s=(p=(l=r[s])==null?void 0:l.parent)!=null?p:null;return o}function nn(e,n){for(let t of Object.values(e))for(let r of Object.values(t))for(let o of Object.values(r)){if(!o||!o.variables)continue;let s=o.variables.PROJECT_FULL_NAME,i=rn(o.info.parent);if(n[s]=n[s]||{parent:i,children:[]},n[s].parent=i!=null?i:null,i){let a=n[i]||{parent:null,children:[]};a.children.includes(s)||a.children.push(s),n[i]=a}}}function rn(e){let n=e==null?void 0:e.trim();return n&&n.length>0?n:null}var yt,Ye,je=M(()=>{yt=1,Ye=null});var cn={};V(cn,{ensureValidOrThrow:()=>yr,validateProjectName:()=>fr,validateTag:()=>hr});function fr(e){if(!e||!e.trim())return{ok:!1,reason:"Project name is required"};let n=e.trim();if(n.length>120)return{ok:!1,reason:"Project name too long (max 120)"};for(let t of n)if(t.charCodeAt(0)<32||t==="/"||t==="\\")return{ok:!1,reason:"Project name contains invalid characters"};return{ok:!0}}function hr(e){if(!e||!e.trim())return{ok:!1,reason:"Tag is required"};let n=e.trim();return ur.test(n)?{ok:!0}:{ok:!1,reason:"Tag must be 2-63 chars, start with letter/digit; may include -, _, /"}}function yr(e,n){let t=e();if(!t.ok)throw new Error(`${n}: ${t.reason}`)}var ur,ln=M(()=>{ur=/^[A-Za-z0-9][A-Za-z0-9_/-]{1,62}$/});var tt={};V(tt,{processTemplate:()=>Pr});function dn(e){return e==null?"":String(e)}function Pr(e,n){if(!e||typeof e!="string")return"";let t=e;for(let[r,o]of Object.entries(n)){let s=dn(o),i=`$_${r}`;t.includes(i)&&(t=t.split(i).join(s))}for(let[r,o]of Object.entries(n)){let s=dn(o),i=new RegExp(`\\$\\{${jr(r)}\\}`,"g");t=t.replace(i,s)}return t}function jr(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var nt=M(()=>{});function mn(e,n){let t=new Date,r=t.getFullYear().toString(),o=t.toISOString().split("T")[0],s=n.projectsRoot||"1. Projects",i=e.parent&&e.parent.trim().length>0?`.${e.parent.trim()}`:"",a=`${r}${i}.${e.name}`,l=n.dimensions.find(m=>m.name===e.dimension),p=l?`${l.order}. ${l.name}`:e.dimension,c=`${s}/${p}/${e.category}/${a}`,d=`${c}`;return{PROJECT_NAME:e.name,PROJECT_TAG:e.tag,PROJECT_PARENT:e.parent?e.parent:"",PARENT_TAG:e.parent?e.tag:"",YEAR:r,DATE:o,PROJECT_FULL_NAME:a,PROJECT_RELATIVE_PATH:c,PROJECT_PATH:d,DIMENSION:l?l.name:e.dimension,CATEGORY:e.category,PROJECT_ID:e.id,PROJECT_DIMENSION:l?l.name:e.dimension}}async function rt(e,n){try{let{processTemplate:t}=await Promise.resolve().then(()=>(nt(),tt));return t(e,n)}catch(t){console.warn("Template processor import failed, using legacy replacement:",t);let r=e;return Object.entries(n).forEach(([o,s])=>{let i=`$_${o}`;r=r.split(i).join(s)}),r}}var gn=M(()=>{});var un={};V(un,{mergeEntityTypes:()=>ot,mergeProjectTypes:()=>xe});function ot(e){let n={...le};if(e&&typeof e=="object")for(let[t,r]of Object.entries(e))!r||typeof r!="object"||(n[t]={...n[t],...r,id:t});return n}function xe(e){let n={...ue};if(e&&typeof e=="object")for(let[t,r]of Object.entries(e))!r||typeof r!="object"||(n[t]={...n[t],...r,id:t});return n}var st=M(()=>{Se()});var fn={};V(fn,{resolveProjectType:()=>vr});function vr(e,n){let t=xe(e.projectTypes),r=n==null?void 0:n.projectTypeId,o=r&&t[r]?r:"operational",s=t[o]||t.operational;return{projectTypeId:o,projectType:s}}var hn=M(()=>{st()});async function it(e,n){var t,r;try{let{resolveProjectType:o}=await Promise.resolve().then(()=>(hn(),fn)),{projectTypeId:s,projectType:i}=o(e.settings,n);n.projectTypeId=s;let a=mn(n,e.settings),l=e.settings.projectsRoot||"1. Projects",{sanitizePath:p,sanitizeFileName:c}=await Promise.resolve().then(()=>(ye(),Ie)),{SafeFileManager:d}=await Promise.resolve().then(()=>(he(),fe)),m=new d(e.app),h=p(l),P=e.settings.dimensions.find(R=>R.name===n.dimension),w=P?`${P.order}. ${P.name}`:n.dimension,j=c(w),g=c(n.category),v=p(`${h}/${j}/${g}/${a.PROJECT_FULL_NAME}`),f=(t=i==null?void 0:i.folderStructure)!=null?t:["Knowledge Base","Meetings","Work","Work/Tasks","People"],y=[{type:"folder",path:v},...f.map(R=>({type:"folder",path:p(`${v}/${R}`)}))],T=e.app.vault.adapter,I=`.obsidian/plugins/${e.manifest.id}/src/templates`,O=(r=i==null?void 0:i.initialNotes)!=null?r:[{fileName:`${a.PROJECT_FULL_NAME}.md`,template:"project.md"},{fileName:`${n.name} Meetings.md`,template:"meetings.md"},{fileName:`${n.name} People.md`,template:"people.md"},{fileName:`${n.name} Work.md`,template:"work.md"},{fileName:`${n.name} Knowledge Base.md`,template:"knowledge-base.md"}],Y=[];for(let R of O){let N=R.fileName?await rt(R.fileName,a):R.fileName,q=`${I}/${R.template}`;if(!await T.exists(q))throw new Error(`Template file not found: ${R.template}`);let me=await T.read(q),ve=await rt(me,a),ne=p(`${v}/${c(N)}`);Y.push({type:"file",path:ne,data:ve})}let z=await m.createBatch([...y,...Y]);if(!("ok"in z)||!z.ok)throw new Error(`Batch creation failed: ${z.error||"unknown"}`);return await Rr(e,n.name,a),await wr(e,n,a),[!0,`Project "${n.name}" created successfully!`]}catch(o){return[!1,`Error creating project: ${o}`]}}async function wr(e,n,t){try{let{ensureProjectIndex:r,addToProjectIndex:o}=await Promise.resolve().then(()=>(Pe(),ke)),{ensureProjectGraph:s,addProjectToGraph:i}=await Promise.resolve().then(()=>(je(),$e)),a={info:n,variables:t,createdAt:new Date().toISOString()},l=n.dimension,p=n.category,c=n.id;if(!e.settings.projectRecords||Array.isArray(e.settings.projectRecords)){let P={},w=Array.isArray(e.settings.projectRecords)?e.settings.projectRecords:[];for(let j of w){let g=j.info.dimension,v=j.info.category,f=j.info.id;P[g]=P[g]||{},P[g][v]=P[g][v]||{},P[g][v][f]=j}e.settings.projectRecords=P}let d=e.settings.projectRecords;if(d[l]=d[l]||{},d[l][p]=d[l][p]||{},d[l][p][c])throw new Error(`Project with id "${c}" already exists in ${l}:${p}`);d[l][p][c]=a;let{index:m}=r(e.settings.projectIndex,d);e.settings.projectIndex=o(m,a,c,l,p);let{graph:h}=s(e.settings.projectGraph,d,e.settings.archivedRecords);e.settings.projectGraph=i(h,a,!1),await e.saveData(e.settings)}catch(r){throw console.warn("Failed to record project creation:",r),r}}async function Tr(e,n,t,r,o){try{let s=e.app.vault.adapter,i=`.obsidian/plugins/${e.manifest.id}/src/templates/${r}`;if(!await s.exists(i))throw new Error(`Template file not found: ${r}`);let a=await s.read(i),l=await rt(a,o),p=`${n}/${t}`,{SafeFileManager:c}=await Promise.resolve().then(()=>(he(),fe));await new c(e.app).createIfAbsent(p,l)}catch(s){throw console.error(`Failed to create ${t}:`,s),new Error(`Failed to create ${t}: ${s}`)}}async function Rr(e,n,t){let{sanitizePath:r,sanitizeFileName:o}=await Promise.resolve().then(()=>(ye(),Ie)),{SafeFileManager:s}=await Promise.resolve().then(()=>(he(),fe)),i=new s(e.app),a=r(`Templates/${n}_Templates`);await i.ensureFolder(a);let l=[{source:"template-meeting-daily.md",target:`${n}_Meeting_Daily_Template.md`},{source:"template-meeting-discussion.md",target:`${n}_Meeting_Discussion_Template.md`},{source:"template-meeting-knowledge.md",target:`${n}_Meeting_Knowledge_Template.md`},{source:"template-meeting-planning.md",target:`${n}_Meeting_Planning_Template.md`},{source:"template-meeting-refinement.md",target:`${n}_Meeting_Refinement_Template.md`},{source:"template-meeting-retro.md",target:`${n}_Meeting_Retro_Template.md`},{source:"template-meeting-demo.md",target:`${n}_Meeting_Demo_Template.md`},{source:"template-sprint.md",target:`${n}_Sprint_Template.md`},{source:"template-task.md",target:`${n}_Task_Template.md`},{source:"template-idea.md",target:`${n}_Idea_Template.md`},{source:"template-knowledge-base-item.md",target:`${n}_Knowledge_Item_Template.md`},{source:"template-meeting-daily.md",target:"template-meeting-daily.md"},{source:"template-meeting-discussion.md",target:"template-meeting-discussion.md"},{source:"template-meeting-knowledge.md",target:"template-meeting-knowledge.md"},{source:"template-meeting-planning.md",target:"template-meeting-planning.md"},{source:"template-meeting-refinement.md",target:"template-meeting-refinement.md"},{source:"template-meeting-retro.md",target:"template-meeting-retro.md"},{source:"template-meeting-demo.md",target:"template-meeting-demo.md"},{source:"template-sprint.md",target:"template-sprint.md"},{source:"template-task.md",target:"template-task.md"},{source:"template-idea.md",target:"template-idea.md"},{source:"template-knowledge-base-item.md",target:"template-knowledge-base-item.md"}];for(let p of l)try{let c=o(p.target);await Tr(e,a,c,p.source,t)}catch(c){console.warn(`Failed to create template ${p.target}: ${c}`)}}var Tt=M(()=>{gn()});var Sn={};V(Sn,{CURRENT_SETTINGS_SCHEMA_VERSION:()=>De,migrateSettings:()=>Or});function Or(e){var o,s,i,a,l,p,c,d,m,h,P,w;let n={dimensions:(o=e==null?void 0:e.dimensions)!=null?o:[],projectsRoot:(s=e==null?void 0:e.projectsRoot)!=null?s:"1. Projects",archiveRoot:(i=e==null?void 0:e.archiveRoot)!=null?i:"4. Archive",templatesRoot:(a=e==null?void 0:e.templatesRoot)!=null?a:"Templates/ProjectFlow",ai:e==null?void 0:e.ai,schemaVersion:(l=e==null?void 0:e.schemaVersion)!=null?l:0,projectRecords:{},archivedRecords:(p=e==null?void 0:e.archivedRecords)!=null?p:{},entityTypes:(c=e==null?void 0:e.entityTypes)!=null?c:{},projectTypes:(d=e==null?void 0:e.projectTypes)!=null?d:{},projectIndex:e==null?void 0:e.projectIndex,projectGraph:e==null?void 0:e.projectGraph},t=e==null?void 0:e.projectRecords;if(t&&typeof t=="object"&&!Array.isArray(t))n.projectRecords=t;else if(Array.isArray(t)){let j={};for(let g of t){if(!g||!g.info)continue;let v=g.info.dimension,f=g.info.category,y=g.info.id;!v||!f||!y||(j[v]=j[v]||{},j[v][f]=j[v][f]||{},j[v][f][y]=g)}n.projectRecords=j}else n.projectRecords={};if(Array.isArray(n.dimensions)){let j=1;n.dimensions=n.dimensions.map(g=>{var v;if(g&&typeof g=="object"){let f=(v=g.name)!=null?v:"",y=g.order,T=typeof f=="string"?f.match(/^\s*(\d+)\.\s*(.+)$/):null;return T&&(y=parseInt(T[1],10),f=T[2]),(y==null||Number.isNaN(y))&&(y=j++),{name:f,order:y,categories:Array.isArray(g.categories)?g.categories:[]}}return{name:String(g!=null?g:""),order:j++,categories:[]}})}else n.dimensions=[];let r=[...n.dimensions].sort((j,g)=>{var v,f;return((v=j.order)!=null?v:0)-((f=g.order)!=null?f:0)});return r.forEach((j,g)=>{j.order=g+1}),n.dimensions=r,(!n.schemaVersion||n.schemaVersion<De)&&((!n.entityTypes||Object.keys(n.entityTypes).length===0)&&(n.entityTypes=le),(!n.projectTypes||Object.keys(n.projectTypes).length===0)&&(n.projectTypes=ue),n.ai?n.ai={enabled:Boolean(n.ai.enabled),provider:n.ai.provider||"openai",apiKey:(m=n.ai.apiKey)!=null?m:"",model:(h=n.ai.model)!=null?h:"gpt-4o-mini",baseUrl:(P=n.ai.baseUrl)!=null?P:"https://api.openai.com",strictExecution:Boolean(n.ai.strictExecution),memoryLimit:Number.isFinite(n.ai.memoryLimit)?n.ai.memoryLimit:10,mcpServers:Array.isArray(n.ai.mcpServers)?n.ai.mcpServers:[],toolLog:Array.isArray(n.ai.toolLog)?n.ai.toolLog:[],conversation:Array.isArray(n.ai.conversation)?n.ai.conversation:[],pendingPlan:(w=n.ai.pendingPlan)!=null?w:null}:n.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",strictExecution:!1,memoryLimit:10,mcpServers:[],toolLog:[],conversation:[],pendingPlan:null},n.schemaVersion=De),n}var De,Nt=M(()=>{Se();De=7});function In(e){return e?e.startsWith("/")||e.includes("\\")?!1:!e.split("/").filter(Boolean).some(t=>t==="."||t===".."):!0}function Oe(e,n){let t=H(e),r=H(n);return r?t===r||t.startsWith(`${r}/`):!1}var kn=M(()=>{ye()});var $n={};V($n,{listProjects:()=>$t,resolveArchivedProject:()=>pt,resolveProject:()=>_e});function _e(e,n){var i,a,l;let t=Ke()||He(e.settings.projectIndex,e.settings.projectRecords).index,r=Nn(n),o=r.fullName&&t.byFullName[r.fullName]||r.id&&t.byId[r.id]||r.tag&&t.byTag[r.tag];if(!o)return null;let s=(l=(a=(i=e.settings.projectRecords)==null?void 0:i[o.dimension])==null?void 0:a[o.category])==null?void 0:l[o.projectId];return s?{entry:o,record:s}:null}function pt(e,n){var o;let t=Nn(n),r=_r(e.settings.archivedRecords,t);return r?{entry:{fullName:r.variables.PROJECT_FULL_NAME,projectId:r.info.id,projectTag:r.variables.PROJECT_TAG,path:r.variables.PROJECT_PATH,dimension:r.info.dimension,category:r.info.category,projectName:r.info.name,parent:(o=r.info.parent)!=null?o:null},record:r}:null}function $t(e){let n=Ke()||He(e.settings.projectIndex,e.settings.projectRecords).index;return Object.values(n.byFullName)}function Nn(e){var n,t,r;if(typeof e=="string"){let o=e.trim();return o.startsWith("project/")?{tag:o}:o.includes(".")?{fullName:o}:{id:o}}return{fullName:(n=e.fullName)==null?void 0:n.trim(),id:(t=e.id)==null?void 0:t.trim(),tag:(r=e.tag)==null?void 0:r.trim()}}function _r(e,n){if(!e)return null;for(let t of Object.values(e))for(let r of Object.values(t))for(let o of Object.values(r))if(o&&(n.fullName&&o.variables.PROJECT_FULL_NAME===n.fullName||n.id&&o.info.id===n.id||n.tag&&o.variables.PROJECT_TAG===n.tag))return o;return null}var Ft=M(()=>{Pe()});async function Mn(e,n){let{resolveProject:t}=await Promise.resolve().then(()=>(Ft(),$n)),{mergeEntityTypes:r}=await Promise.resolve().then(()=>(st(),un)),{processTemplate:o}=await Promise.resolve().then(()=>(nt(),tt)),{SafeFileManager:s}=await Promise.resolve().then(()=>(he(),fe)),i=t(e,n.projectRef);if(!i)throw new Error("Project not found for reference.");let l=r(e.settings.entityTypes)[n.entityTypeId];if(!l)throw new Error(`Entity type not found: ${n.entityTypeId}`);let p=Gr(n.fields);Lr(l,p);let c={...i.record.variables,...p||{}},d=await Br(e,l,i.record,c);if(!d)throw new Error(`Template not found for entity type: ${l.id}`);let h=await e.app.vault.adapter.read(d.path),P=o(h,c),w=o(l.targetFolder,c);if(!In(w))throw new Error("Unsafe targetFolder path.");let j=H(i.record.variables.PROJECT_PATH),g=w?H(`${j}/${w}`):j;if(!Oe(g,j))throw new Error("Target folder is outside project path.");if(!Fn(g,e.settings))throw new Error("Target folder is outside allowed roots.");let v=l.filenameRule||"Untitled",f=o(v,c),y=f.endsWith(".md")?f.slice(0,-3):f,T=Ve(y),I=H(`${g}/${T}.md`);if(!Oe(I,j))throw new Error("Target file is outside project path.");if(!Fn(I,e.settings))throw new Error("Target file is outside allowed roots.");let O=new s(e.app);if(await O.ensureFolder(g),await O.has(I))throw new Error(`File already exists: ${I}`);return await O.createIfAbsent(I,P),{path:I}}function Fn(e,n){let t=n.projectsRoot||"1. Projects",r=n.archiveRoot||"4. Archive";return Oe(e,t)||Oe(e,r)}function Lr(e,n){if(!e.requiredFields||e.requiredFields.length===0)return;let t=e.requiredFields.filter(r=>n==null||n[r]==null||String(n[r]).trim()==="");if(t.length>0)throw new Error(`Missing required fields: ${t.join(", ")}`)}function Gr(e){if(!e)return e;let n={...e};for(let[t,r]of Object.entries(e)){if(r==null)continue;let o=t.toUpperCase(),s=t.toLowerCase();o in n||(n[o]=r),s in n||(n[s]=r)}return n}async function Br(e,n,t,r){let{processTemplate:o}=await Promise.resolve().then(()=>(nt(),tt)),s=e.app.vault.adapter,i=o(n.templatePath,r),a=H(`Templates/${t.info.name}_Templates`),l=H(e.settings.templatesRoot||"Templates/ProjectFlow"),p=`.obsidian/plugins/${e.manifest.id}/src/templates`,c=m=>m.map(h=>h==="project"?{scope:h,path:H(`${a}/${i}`)}:h==="vault"?{scope:h,path:H(`${l}/${i}`)}:{scope:h,path:`${p}/${i}`}),d=n.templateScope?[n.templateScope,"builtin"].filter((m,h,P)=>P.indexOf(m)===h):["project","vault","builtin"];for(let m of c(d))if(await s.exists(m.path))return m;return null}var Dn=M(()=>{ye();kn()});function Jr(e,n,t,r,o){let s=Ur(n),i=e.indexOf(s);if(i>=0){let a=e.indexOf(`
`,i),l=a>=0?a+1:e.length,p=Vr(e,l),c=p>=0?p:e.length;return{updated:!0,text:[e.slice(0,l),Mt(t),e.slice(c)].join("")}}if(r==="strict")return{updated:!1,text:e};if(o){let a=On(e,o,t,r);if(a.updated)return a}return{updated:!0,text:Bn(e,o||"AI Notes",t)}}function On(e,n,t,r){let o=Gn(n),i=new RegExp(`^#{1,6}\\s+${Kr(o)}\\s*$`,"m").exec(e);if(!i||i.index==null)return r==="strict"?{updated:!1,text:e}:{updated:!0,text:Bn(e,o,t)};let a=i.index,l=e.indexOf(`
`,a),p=l>=0?l+1:e.length,c=Wr(e,p);return{updated:!0,text:[e.slice(0,p),Mt(t),e.slice(c)].join("")}}async function _n(e,n){var i;let t=e.vault.adapter,r=(i=n.patchMode)!=null?i:"lenient";if(!await t.exists(n.path))return{ok:!1,error:`File not found: ${n.path}`};let o=await t.read(n.path),s=Jr(o,n.marker,n.content,r,n.fallbackHeading);return s.updated?(await t.write(n.path,s.text),{ok:!0}):{ok:!1,error:"Marker or heading not found in strict mode."}}async function Ln(e,n){var i;let t=e.vault.adapter,r=(i=n.patchMode)!=null?i:"lenient";if(!await t.exists(n.path))return{ok:!1,error:`File not found: ${n.path}`};let o=await t.read(n.path),s=On(o,n.heading,n.content,r);return s.updated?(await t.write(n.path,s.text),{ok:!0}):{ok:!1,error:"Heading not found in strict mode."}}function Ur(e){let n=e.trim();return n.startsWith("<!--")&&n.endsWith("-->")?n:`<!-- ${n} -->`}function Gn(e){return e.replace(/^#+\s*/,"").trim()}function Vr(e,n){let t=/<!--\s*AI:[A-Z_]+\s*-->/g;t.lastIndex=n;let r=t.exec(e);return r&&r.index!=null?r.index:-1}function Wr(e,n){let t=/^#{1,6}\s+/gm;t.lastIndex=n;let r=t.exec(e);return r&&r.index!=null?r.index:e.length}function Mt(e){let n=e!=null?e:"";return n.endsWith(`
`)?n:`${n}
`}function Bn(e,n,t){let r=Gn(n);return`${e.endsWith(`
`)?e:`${e}
`}
## ${r}
${Mt(t)}`}function Kr(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var Jn=M(()=>{});function Un(e){if(e instanceof de)return e;let n=e instanceof Error?e.message:"Unknown error";return new de("validation_error",n)}var de,Dt=M(()=>{de=class extends Error{constructor(t,r,o){super(r);this.code=t,this.details=o}}});function W(e,n){if(typeof e!="string"||e.trim().length===0)throw new de("invalid_request",`${n} is required`,{field:n});return e.trim()}function dt(e){if(e==null)throw new de("invalid_request","projectRef is required",{field:"projectRef"});if(typeof e=="string"){W(e,"projectRef");return}let n=typeof e.fullName=="string"&&e.fullName.trim().length>0,t=typeof e.id=="string"&&e.id.trim().length>0,r=typeof e.tag=="string"&&e.tag.trim().length>0;if(!n&&!t&&!r)throw new de("invalid_request","projectRef must include fullName, id, or tag",{field:"projectRef"})}function Vn(e){W(e==null?void 0:e.name,"name"),W(e==null?void 0:e.tag,"tag"),W(e==null?void 0:e.id,"id"),W(e==null?void 0:e.dimension,"dimension"),W(e==null?void 0:e.category,"category")}function Wn(e){dt(e==null?void 0:e.projectRef),W(e==null?void 0:e.entityTypeId,"entityTypeId")}function Kn(e){W(e==null?void 0:e.path,"path"),W(e==null?void 0:e.marker,"marker"),W(e==null?void 0:e.content,"content")}function Hn(e){W(e==null?void 0:e.path,"path"),W(e==null?void 0:e.heading,"heading"),W(e==null?void 0:e.content,"content")}var Yn=M(()=>{Dt()});var zn={};V(zn,{createCoreApi:()=>Hr});function Hr(e){return{version:"1.0.0",capabilities:{resolveProject:!0,listProjects:!0,entityTypes:!0,projectTypes:!0,createProject:!0,createEntity:!0,patching:!0,projectGraph:!0,errorHandling:"throws"},compatibility:{settingsSchemaVersion:De,projectIndexVersion:1,projectGraphVersion:1},resolveProject:t=>(dt(t),_e(e,t)),listProjects:()=>$t(e),listProjectTypes:()=>xe(e.settings.projectTypes),describeProjectType:t=>xe(e.settings.projectTypes)[t]||null,listEntityTypes:()=>ot(e.settings.entityTypes),describeEntityType:t=>ot(e.settings.entityTypes)[t]||null,createProject:async t=>(Vn(t),it(e,t)),createEntity:async t=>(Wn(t),Mn(e,t)),patchMarker:async t=>(Kn(t),_n(e.app,t)),patchSection:async t=>(Hn(t),Ln(e.app,t)),getChildren:(t,r)=>{dt(t);let o=r?pt(e,t):_e(e,t);if(!o)return[];let{graph:s}=Ne(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return vt(s,o.entry.fullName,Boolean(r))},getParents:(t,r)=>{let o=r?pt(e,t):_e(e,t);if(!o)return[];let{graph:s}=Ne(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return wt(s,o.entry.fullName,Boolean(r))},clearArchivedProjectGraph:async()=>{let{graph:t}=Ne(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return e.settings.projectGraph=jt(t,e.settings.archivedRecords),await e.saveData(e.settings),{ok:!0}},wrapError:t=>{let r=Un(t);return{ok:!1,error:{code:r.code,message:r.message,details:r.details}}}}}var qn=M(()=>{st();Tt();Dn();Jn();Ft();je();Yn();Dt();Nt();Pe();je()});var zr={};V(zr,{default:()=>Yr});module.exports=sr(zr);var Xn=require("obsidian");var E=require("obsidian");Se();var en=require("obsidian"),Ue=class extends en.Modal{constructor(t,r){super(t);this.onResult=r}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("project-flow-settings"),t.createEl("p",{text:"Do you want skip settings to defaults? This will override all custom settings."});let r=t.createDiv({cls:"gc-row"});r.createDiv({cls:"gc-spacer"});let o=r.createEl("button",{text:"Yes, use defaults"}),s=r.createEl("button",{text:"Go back"});o.onclick=()=>{this.close(),this.onResult(!0)},s.onclick=()=>{this.close(),this.onResult(!1)}}onClose(){this.contentEl.empty()}};async function ze(e,n,t,r){let o="",s=e.settings.projectRecords,i=s[n][t][r],{SafeFileManager:a}=await Promise.resolve().then(()=>(he(),fe)),l=new a(e.app),{sanitizePath:p}=await Promise.resolve().then(()=>(ye(),Ie)),c=p(i.variables.PROJECT_PATH),d=p(`Templates/${i.info.name}_Templates`);try{await l.removeDir(c),await l.removeDir(d);try{s[n][t][r]&&(delete s[n][t][r],Object.keys(s[n][t]).length===0&&delete s[n][t],Object.keys(s[n]).length===0&&delete s[n]);try{let{ensureProjectIndex:m,removeFromProjectIndex:h,toIndexEntry:P}=await Promise.resolve().then(()=>(Pe(),ke)),{ensureProjectGraph:w,removeProjectFromGraph:j}=await Promise.resolve().then(()=>(je(),$e)),{index:g}=m(e.settings.projectIndex,s);e.settings.projectIndex=h(g,P(i,r,n,t));let{graph:v}=w(e.settings.projectGraph,s,e.settings.archivedRecords);e.settings.projectGraph=j(v,i.variables.PROJECT_FULL_NAME,!1)}catch(m){console.warn("Failed to update projectIndex after delete:",m)}await e.saveData(e.settings),o="Project deleted successfully."}catch(m){o="Failed to update projectRecords after delete",console.warn(o,m)}return[!0,o]}catch(m){o="Error removing project: "+m.message,console.error("Error removing project:",m)}return[!1,o]}async function qe(e,n,t,r){var o,s,i,a,l;try{let p=e.settings.projectRecords,c=(s=(o=p==null?void 0:p[n])==null?void 0:o[t])==null?void 0:s[r];if(!c)return[!1,"Project not found."];let{sanitizePath:d}=await Promise.resolve().then(()=>(ye(),Ie)),{SafeFileManager:m}=await Promise.resolve().then(()=>(he(),fe)),h=new m(e.app),P=e.app.vault.adapter,w=d(c.variables.PROJECT_PATH),j=d(`Templates/${c.info.name}_Templates`),g=e.settings.archiveRoot||"4. Archive",v=c.variables.YEAR,f=c.variables.DIMENSION||c.info.dimension,y=c.info.category,T=c.info.parent&&c.info.parent.trim().length>0?c.info.parent.trim():null,I=c.info.name,O=T?`${v}.${f}.${y}.${T}.${I}`:`${v}.${f}.${y}.${I}`,Y=d(`${g}/${O}`),z=R=>{let N=R.split("/").filter(Boolean);return N.pop(),N.join("/")};if(await h.ensureFolder(z(Y)),!await P.exists(w))return[!1,`Project directory not found: ${w}`];if(await P.exists(Y))return[!1,`Archive destination already exists: ${Y}`];await P.rename(w,Y);try{if(await P.exists(j)){let R=d(`${Y}/Templates`);await h.ensureFolder(R);let N=d(`${R}/${c.info.name}_Templates`);if(await P.exists(N)){let q=d(`${R}/${c.info.name}_Templates_archived`);await P.rename(j,q)}else await P.rename(j,N)}}catch(R){console.warn("Archiving templates failed:",R)}try{let R=e.settings.projectRecords;(!e.settings.archivedRecords||Array.isArray(e.settings.archivedRecords))&&(e.settings.archivedRecords=e.settings.archivedRecords&&Array.isArray(e.settings.archivedRecords)?{}:e.settings.archivedRecords||{});let N=e.settings.archivedRecords;N[n]=N[n]||{},N[n][t]=N[n][t]||{},N[n][t][r]=c,(a=(i=R==null?void 0:R[n])==null?void 0:i[t])!=null&&a[r]&&(delete R[n][t][r],Object.keys(R[n][t]).length===0&&delete R[n][t],Object.keys(R[n]||{}).length===0&&delete R[n]);try{let{ensureProjectIndex:q,removeFromProjectIndex:me,toIndexEntry:ve}=await Promise.resolve().then(()=>(Pe(),ke)),{ensureProjectGraph:ne,removeProjectFromGraph:Le,addProjectToGraph:we}=await Promise.resolve().then(()=>(je(),$e)),{index:be}=q(e.settings.projectIndex,R);e.settings.projectIndex=me(be,ve(c,r,n,t));let{graph:Ge}=ne(e.settings.projectGraph,R,N);e.settings.projectGraph=Le(Ge,c.variables.PROJECT_FULL_NAME,!1),e.settings.projectGraph=we(e.settings.projectGraph,c,!0)}catch(q){console.warn("Failed to update projectIndex after archive:",q)}await e.saveData(e.settings)}catch(R){console.warn("Failed to move project record to archive in settings:",R)}return[!0,"Project archived successfully."]}catch(p){return console.error("Archive failed:",p),[!1,(l=p==null?void 0:p.message)!=null?l:"Failed to archive project."]}}var gr=[{name:"Business",order:1,categories:["R&D","Jobs","OpenSource","Education"]},{name:"Family",order:2,categories:["Vacations","Parenting","Common"]},{name:"Friends",order:3,categories:[]},{name:"Health",order:4,categories:["Clinics","Issues","R&D"]},{name:"Personal",order:5,categories:["R&D","Languages","SelfManagement","Writing","Reading","Music","Sports"]},{name:"Residence",order:6,categories:[]}],Ze={dimensions:JSON.parse(JSON.stringify(gr)),projectsRoot:"1. Projects",archiveRoot:"4. Archive",templatesRoot:"Templates/ProjectFlow",ai:{enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",strictExecution:!1,memoryLimit:10,mcpServers:[],toolLog:[],conversation:[],pendingPlan:null},projectRecords:{},archivedRecords:{},projectGraph:{version:1,byFullName:{},archivedByFullName:{}},entityTypes:le,projectTypes:ue};function on(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return n}var Xe=class extends E.PluginSettingTab{constructor(t,r){super(t,r);this.plugin=r}display(){var Lt,Gt,Bt,Jt,Ut,Vt,Wt,Kt,Ht,Yt,zt,qt,Xt,Zt;let{containerEl:t}=this;t.empty(),t.addClass("project-flow-settings");let r=t.createDiv({cls:"gc-row"});r.createDiv({cls:"gc-spacer"});let o=r.createEl("button",{cls:["gc-icon-button","clickable-icon"],attr:{"aria-label":"Reset to defaults",title:"Reset to defaults"}});try{(0,E.setIcon)(o,"rotate-ccw")}catch(u){o.setText("Reset to defaults")}o.onclick=()=>{new Ue(this.app,async A=>{A&&(this.plugin.settings=JSON.parse(JSON.stringify(Ze)),await this.plugin.saveSettings(),new E.Notice("Settings were reset to defaults."),this.display())}).open()},t.createEl("h2",{text:"Folders"});let s=t.createDiv({cls:"gc-column"}),i=s.createDiv({cls:"setting-item"});i.createEl("label",{text:"Projects root"});let a=i.createEl("input",{type:"text"});a.value=this.plugin.settings.projectsRoot||"1. Projects",a.placeholder="e.g. 1. Projects",a.onchange=async()=>{this.plugin.settings.projectsRoot=a.value.trim()||"1. Projects",await this.plugin.saveSettings()};let l=s.createDiv({cls:"setting-item"});l.createEl("label",{text:"Archive root"});let p=l.createEl("input",{type:"text"});p.value=this.plugin.settings.archiveRoot||"4. Archive",p.placeholder="e.g. 4. Archive",p.onchange=async()=>{this.plugin.settings.archiveRoot=p.value.trim()||"4. Archive",await this.plugin.saveSettings()};let c=s.createDiv({cls:"setting-item"});c.createEl("label",{text:"Templates root"});let d=c.createEl("input",{type:"text"});d.value=this.plugin.settings.templatesRoot||"Templates/ProjectFlow",d.placeholder="e.g. Templates/ProjectFlow",d.onchange=async()=>{this.plugin.settings.templatesRoot=d.value.trim()||"Templates/ProjectFlow",await this.plugin.saveSettings()},t.createEl("h2",{text:"Dimensions"}),[...this.plugin.settings.dimensions].sort((u,A)=>{var _,D;return((_=u.order)!=null?_:0)-((D=A.order)!=null?D:0)}).forEach((u,A)=>{let _=t.createDiv({cls:"dimension-setting"}),D=_.createDiv({cls:"dimension-header"});D.addClass("gc-row"),D.createSpan({text:`${u.order}. `});let K=D.createEl("b",{text:u.name});D.createDiv({cls:"gc-spacer"});let B=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});B.setAttr("aria-label","Move up"),B.setAttr("title","Move up");try{(0,E.setIcon)(B,"arrow-up")}catch(C){B.setText("Up")}B.onclick=async()=>{let S=[...this.plugin.settings.dimensions].filter($=>{var k,b;return((k=$.order)!=null?k:0)<((b=u.order)!=null?b:0)}).sort(($,k)=>{var b,F;return((b=k.order)!=null?b:0)-((F=$.order)!=null?F:0)})[0];if(!S)return;let x=S.order;S.order=u.order,u.order=x,await this.plugin.saveSettings(),this.display()};let oe=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});oe.setAttr("aria-label","Move down"),oe.setAttr("title","Move down");try{(0,E.setIcon)(oe,"arrow-down")}catch(C){oe.setText("Down")}oe.onclick=async()=>{let S=[...this.plugin.settings.dimensions].filter($=>{var k,b;return((k=$.order)!=null?k:0)>((b=u.order)!=null?b:0)}).sort(($,k)=>{var b,F;return((b=$.order)!=null?b:0)-((F=k.order)!=null?F:0)})[0];if(!S)return;let x=S.order;S.order=u.order,u.order=x,await this.plugin.saveSettings(),this.display()};let se=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});se.setAttr("aria-label",`Delete ${u.name}`),se.setAttr("title",`Delete ${u.name}`);try{(0,E.setIcon)(se,"trash")}catch(C){se.setText("Remove")}se.onclick=async()=>{let C=this.plugin.settings.dimensions.findIndex(S=>S===u);C>=0&&this.plugin.settings.dimensions.splice(C,1),await this.plugin.saveSettings(),this.display()};let G=D.createEl("button",{cls:["gc-icon-button","clickable-icon"]});G.setAttr("aria-label",`Rename ${u.name}`),G.setAttr("title",`Rename ${u.name}`);try{(0,E.setIcon)(G,"pencil")}catch(C){G.setText("Edit")}if(G.onclick=async()=>{var ie;let C=u.name,S=K.parentElement;(ie=K.detach)==null||ie.call(K),G.style.display="none",se.style.display="none";let x=S.createEl("input",{type:"text"});x.value=C,x.addClass("gc-rename");let $=S.createDiv({cls:"gc-row"});$.createDiv({cls:"gc-spacer"});let k=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});k.setAttr("aria-label","Apply"),k.setAttr("title","Apply");try{(0,E.setIcon)(k,"check")}catch(J){k.setText("Apply")}let b=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});b.setAttr("aria-label","Discard"),b.setAttr("title","Discard");try{(0,E.setIcon)(b,"x")}catch(J){b.setText("Discard")}let F=()=>{this.display()},X=async J=>{let Z=J.trim();if(!Z||Z===C){F();return}if(this.plugin.settings.dimensions.some(Ce=>Ce!==u&&Ce.name===Z)){new E.Notice("A dimension with this name already exists.");return}u.name=Z,await this.plugin.saveSettings(),F()};k.onclick=async()=>{await X(x.value)},b.onclick=()=>F(),x.focus(),x.select(),x.onkeydown=async J=>{J.key==="Enter"&&await X(x.value),J.key==="Escape"&&F()},x.onblur=async()=>{await X(x.value)}},u.categories.length>0){let C=_.createDiv({cls:"categories-list gc-list"});u.categories.forEach((S,x)=>{var Ce;let $=C.createDiv({cls:"gc-list-item gc-row"}),k=this.plugin.settings.projectRecords||{},b=u.name,F=Object.keys(((Ce=k==null?void 0:k[b])==null?void 0:Ce[S])||{}),X=$.createEl("b",{text:S}),ie=$.createDiv({cls:"gc-id-wrap"});F.length>0&&(ie.createSpan({text:" "}),F.forEach((U,Be)=>{let L=ie.createSpan({cls:"gc-id-chip"});L.style.display="inline-flex",L.style.alignItems="center",L.style.gap="4px";let Te=L.createSpan({cls:"gc-id-tag",text:U}),ae=Math.abs(on(U))%360;Te.style.backgroundColor=`hsl(${ae}, 70%, 90%)`,Te.style.color=`hsl(${ae}, 70%, 25%)`;let Q=L.createSpan({cls:"gc-id-actions"});Q.style.display="none";let ee=Q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ee.setAttr("aria-label",`Delete ${U}`),ee.setAttr("title",`Delete ${U}`);try{(0,E.setIcon)(ee,"trash")}catch(ce){ee.setText("Del")}ee.onclick=async ce=>{ce.stopPropagation();let[,te]=await ze(this.plugin,b,S,U);new E.Notice(te),this.display()};let re=Q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});re.setAttr("aria-label",`Archive ${U}`),re.setAttr("title",`Archive ${U}`);try{(0,E.setIcon)(re,"archive")}catch(ce){re.setText("Arc")}re.onclick=async ce=>{ce.stopPropagation();let[,te]=await qe(this.plugin,b,S,U);new E.Notice(te),this.display()},L.onmouseenter=()=>{Q.style.display="inline-flex"},L.onmouseleave=()=>{Q.style.display="none"},Be<F.length-1&&ie.createSpan({text:" "})})),$.createDiv({cls:"gc-spacer"});let J=$.createEl("button",{cls:["remove-category","gc-icon-button","clickable-icon"]});J.setAttr("aria-label",`Delete ${S}`),J.setAttr("title",`Delete ${S}`);try{(0,E.setIcon)(J,"trash")}catch(U){J.setText("Remove")}J.onclick=async()=>{u.categories.splice(x,1),await this.plugin.saveSettings(),this.display()};let Z=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Z.setAttr("aria-label",`Rename ${S}`),Z.setAttr("title",`Rename ${S}`);try{(0,E.setIcon)(Z,"pencil")}catch(U){Z.setText("Edit")}Z.onclick=async()=>{var ce;let U=u.categories[x],Be=X.parentElement;(ce=X.detach)==null||ce.call(X),Z.style.display="none",J.style.display="none";let L=Be.createEl("input",{type:"text"});L.value=U,L.addClass("gc-rename");let Te=Be.createDiv({cls:"gc-row"});Te.createDiv({cls:"gc-spacer"});let ae=Te.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ae.setAttr("aria-label","Apply"),ae.setAttr("title","Apply");try{(0,E.setIcon)(ae,"check")}catch(te){ae.setText("Apply")}let Q=Te.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Q.setAttr("aria-label","Discard"),Q.setAttr("title","Discard");try{(0,E.setIcon)(Q,"x")}catch(te){Q.setText("Discard")}let ee=()=>{this.display()},re=async te=>{let Je=te.trim();if(!Je||Je===U){ee();return}if(u.categories.some((Qn,er)=>er!==x&&Qn===Je)){new E.Notice("This category already exists in the dimension.");return}u.categories[x]=Je,await this.plugin.saveSettings(),ee()};ae.onclick=async()=>{await re(L.value)},Q.onclick=()=>ee(),L.focus(),L.select(),L.onkeydown=async te=>{te.key==="Enter"&&await re(L.value),te.key==="Escape"&&ee()},L.onblur=async()=>{await re(L.value)}}})}let ge=_.createDiv({cls:"add-category gc-row"}),Ee=ge.createEl("input",{type:"text",placeholder:"New category"});ge.createDiv({cls:"gc-spacer"});let Ae=ge.createEl("button",{text:"Add Category"});Ae.onclick=async()=>{let C=Ee.value.trim();C&&!u.categories.includes(C)&&(u.categories.push(C),await this.plugin.saveSettings(),this.display())}});let h=t.createDiv({cls:"add-dimension"});h.createEl("h3",{text:"Add new dimension"});let P=h.createDiv({cls:"gc-row"}),w=P.createEl("input",{type:"text",placeholder:"Dimension name"});P.createDiv({cls:"gc-spacer"});let j=P.createEl("button",{text:"Add Dimension"});j.onclick=async()=>{let u=w.value.trim();if(u&&!this.plugin.settings.dimensions.some(A=>A.name===u)){{let A=this.plugin.settings.dimensions.reduce((_,D)=>{var K;return Math.max(_,(K=D.order)!=null?K:0)},0);this.plugin.settings.dimensions.push({name:u,order:A+1,categories:[]})}await this.plugin.saveSettings(),this.display()}},t.createEl("h2",{text:"AI Module"});let g=t.createDiv({cls:"gc-column"}),v=g.createDiv({cls:"setting-item"});v.createEl("label",{text:"Enable AI module"});let f=v.createEl("input",{type:"checkbox"});f.checked=Boolean((Lt=this.plugin.settings.ai)==null?void 0:Lt.enabled),f.onchange=async()=>{var u,A;this.plugin.settings.ai||(this.plugin.settings.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com"}),this.plugin.settings.ai.enabled=f.checked,await this.plugin.saveSettings(),await((A=(u=this.plugin).toggleAiView)==null?void 0:A.call(u,f.checked))};let y=g.createDiv({cls:"setting-item"});y.createEl("label",{text:"Provider"});let T=y.createEl("select");["openai","anthropic","ollama"].forEach(u=>{let A=T.createEl("option",{text:u});A.value=u}),T.value=((Gt=this.plugin.settings.ai)==null?void 0:Gt.provider)||"openai",T.onchange=async()=>{if(!this.plugin.settings.ai)return;let u={openai:{baseUrl:"https://api.openai.com",model:"gpt-4o-mini"},anthropic:{baseUrl:"https://api.anthropic.com",model:"claude-3-5-sonnet-latest"},ollama:{baseUrl:"http://localhost:11434",model:"llama3.1"}};this.plugin.settings.ai.provider=T.value;let A=this.plugin.settings.ai.baseUrl||"",_=this.plugin.settings.ai.model||"",D=Object.values(u).map(B=>B.baseUrl),K=Object.values(u).map(B=>B.model);(!A||D.includes(A))&&(this.plugin.settings.ai.baseUrl=u[T.value].baseUrl),(!_||K.includes(_))&&(this.plugin.settings.ai.model=u[T.value].model),await this.plugin.saveSettings(),this.display()};let I=g.createDiv({cls:"setting-item"});I.createEl("label",{text:"API key (not required for local providers)"});let O=I.createEl("input",{type:"password"});O.placeholder="sk-...",O.value=((Bt=this.plugin.settings.ai)==null?void 0:Bt.apiKey)||"",O.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.apiKey=O.value.trim(),await this.plugin.saveSettings())};let Y=g.createDiv({cls:"setting-item"});Y.createEl("label",{text:"Model"});let z=Y.createEl("input",{type:"text"});z.placeholder=((Jt=this.plugin.settings.ai)==null?void 0:Jt.provider)==="anthropic"?"claude-3-5-sonnet-latest":((Ut=this.plugin.settings.ai)==null?void 0:Ut.provider)==="ollama"?"llama3.1":"gpt-4o-mini",z.value=((Vt=this.plugin.settings.ai)==null?void 0:Vt.model)||z.placeholder,z.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.model=z.value.trim()||"gpt-4o-mini",await this.plugin.saveSettings())};let R=g.createDiv({cls:"setting-item"});R.createEl("label",{text:"Base URL"});let N=R.createEl("input",{type:"text"});N.placeholder=((Wt=this.plugin.settings.ai)==null?void 0:Wt.provider)==="anthropic"?"https://api.anthropic.com":((Kt=this.plugin.settings.ai)==null?void 0:Kt.provider)==="ollama"?"http://localhost:11434":"https://api.openai.com",N.value=((Ht=this.plugin.settings.ai)==null?void 0:Ht.baseUrl)||N.placeholder,N.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.baseUrl=N.value.trim()||"https://api.openai.com",await this.plugin.saveSettings())};let q=g.createDiv({cls:"setting-item"});q.createEl("label",{text:"Strict execution mode"});let me=q.createEl("input",{type:"checkbox"});me.checked=Boolean((Yt=this.plugin.settings.ai)==null?void 0:Yt.strictExecution),me.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.strictExecution=me.checked,await this.plugin.saveSettings())};let ve=g.createDiv({cls:"setting-item"});ve.createEl("label",{text:"Conversation memory (messages)"});let ne=ve.createEl("input",{type:"number"});ne.min="0",ne.max="50",ne.value=String((qt=(zt=this.plugin.settings.ai)==null?void 0:zt.memoryLimit)!=null?qt:10),ne.onchange=async()=>{if(!this.plugin.settings.ai)return;let u=Number(ne.value);this.plugin.settings.ai.memoryLimit=Number.isFinite(u)?Math.max(0,Math.min(50,u)):10,await this.plugin.saveSettings()};let Le=g.createDiv({cls:"setting-item"});Le.createEl("label",{text:"MCP servers (JSON array)"});let we=Le.createEl("textarea");we.placeholder='[{"name":"calendar","url":"http://localhost:3000","apiKey":""}]',we.value=JSON.stringify(((Xt=this.plugin.settings.ai)==null?void 0:Xt.mcpServers)||[]),we.onchange=async()=>{if(this.plugin.settings.ai)try{let u=JSON.parse(we.value||"[]");this.plugin.settings.ai.mcpServers=Array.isArray(u)?u:[],await this.plugin.saveSettings()}catch(u){new E.Notice("Invalid MCP servers JSON")}},t.createEl("h2",{text:"Archive"});let be=this.plugin.settings.archivedRecords||{},Ge=be&&!Array.isArray(be)?be:{},Ot={};for(let u of this.plugin.settings.dimensions)Ot[u.name]=(Zt=u.order)!=null?Zt:Number.MAX_SAFE_INTEGER;let Zn=Object.keys(Ge).map(u=>{var A;return{name:u,order:(A=Ot[u])!=null?A:Number.MAX_SAFE_INTEGER}}).sort((u,A)=>u.order-A.order||u.name.localeCompare(A.name)),_t=!1;Zn.forEach(({name:u,order:A})=>{let _=Ge[u]||{},D=Object.keys(_).filter(G=>Object.keys(_[G]||{}).length>0).sort();if(D.length===0)return;_t=!0;let K=t.createDiv({cls:"dimension-setting"}),B=K.createDiv({cls:"dimension-header gc-row"}),oe=this.plugin.settings.dimensions.find(G=>G.name===u);oe&&B.createSpan({text:`${oe.order}. `}),B.createEl("b",{text:u}),B.createDiv({cls:"gc-spacer"});let se=K.createDiv({cls:"categories-list gc-list"});D.forEach(G=>{let ge=se.createDiv({cls:"gc-list-item gc-row"}),Ee=Object.keys((_==null?void 0:_[G])||{}).sort();ge.createEl("b",{text:G});let Ae=ge.createDiv({cls:"gc-id-wrap"});Ee.length>0&&(Ae.createSpan({text:" "}),Ee.forEach((C,S)=>{let x=Ae.createSpan({cls:"gc-id-chip"});x.style.display="inline-flex",x.style.alignItems="center",x.style.gap="4px";let $=x.createSpan({cls:"gc-id-tag",text:C}),k=Math.abs(on(C))%360;$.style.backgroundColor=`hsl(${k}, 70%, 90%)`,$.style.color=`hsl(${k}, 70%, 25%)`;let b=x.createSpan({cls:"gc-id-actions"});b.style.display="none";let F=b.createEl("button",{cls:["gc-icon-button","clickable-icon"]});F.setAttr("aria-label",`Delete ${C}`),F.setAttr("title",`Delete ${C}`);try{(0,E.setIcon)(F,"trash")}catch(X){F.setText("Del")}F.onclick=async X=>{X.stopPropagation();let[,ie]=await this.plugin.deleteArchivedProject(u,G,C);new E.Notice(ie),this.display()},x.onmouseenter=()=>{b.style.display="inline-flex"},x.onmouseleave=()=>{b.style.display="none"},S<Ee.length-1&&Ae.createSpan({text:" "})})),ge.createDiv({cls:"gc-spacer"})})}),_t||t.createDiv({cls:"setting-item"}).createSpan({text:"No archived projects yet."})}};var Rt=require("obsidian");var sn=require("obsidian"),Qe=class extends sn.Modal{constructor(t,r,o){super(t);this.prompt=r,this.callback=o}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:this.prompt});let r=t.createEl("input",{type:"text"});r.focus();let o=t.createEl("button",{text:"Submit"});o.onclick=()=>{let s=r.value.trim();this.close(),this.callback(s||null)}}onClose(){let{contentEl:t}=this;t.empty()}};var an=require("obsidian"),Fe=class extends an.Modal{constructor(t,r,o,s){super(t);this.prompt=r,this.choices=o,this.callback=s}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:this.prompt}),this.choices.forEach(r=>{let o=t.createEl("button",{text:r});o.onclick=()=>{this.close(),this.callback(r)}})}onClose(){let{contentEl:t}=this;t.empty()}};async function Me(e,n){return new Promise(t=>{new Qe(e,n,t).open()})}async function Re(e,n,t){return new Promise(r=>{new Fe(e,n,t,r).open()})}async function pn(e,n){var h,P;let t=await Me(e,"Enter project name:");if(!t)return[null,"Project creation cancelled. No project name provided."];let r=await Me(e,"Enter project tag:");if(!r)return[null,"Project creation cancelled. No project tag provided."];let o=await Me(e,"Enter Project ID (used for task prefixes):");if(!o)return[null,"Project creation cancelled. No Project ID provided."];let s=await Me(e,"Enter parent name (optional):"),i=s&&s.trim().length>0?s.trim():null,a=[...n.dimensions].sort((w,j)=>{var g,v;return((g=w.order)!=null?g:0)-((v=j.order)!=null?v:0)}).map(w=>w.name),l=await Re(e,"Select dimension:",a);if(!l)return[null,"Project creation cancelled. No dimension selected."];let p=n.dimensions.find(w=>w.name===l);if(!p||p.categories.length===0)return[null,"Selected dimension has no categories. Please add categories in settings first."];let c=p.categories,d=await Re(e,"Select category:",c);if(!d)return[null,"Project creation cancelled. No category selected."];let m={name:t,tag:r,id:o,parent:i,dimension:l,category:d};try{let w=n.projectRecords;if(w&&!Array.isArray(w)&&((P=(h=w[l])==null?void 0:h[d])==null?void 0:P[o]))return[null,`Project with ID "${o}" already exists in ${l}:${d}. Choose a different ID.`]}catch(w){}try{let{validateProjectName:w,validateTag:j,ensureValidOrThrow:g}=await Promise.resolve().then(()=>(ln(),cn));g(()=>w(m.name),"Invalid project name"),g(()=>j(m.tag),"Invalid tag"),g(()=>j(m.id),"Invalid Project ID")}catch(w){let j=w.message||"Invalid input";return console.error("Validation error:",w),[null,j]}return[m,"Project details collected."]}async function et(e,n){var c;if(!n.projectRecords)return[null,"You don't have any projects yet."];let t=n.projectRecords,r=[...n.dimensions].sort((d,m)=>{var h,P;return((h=d.order)!=null?h:0)-((P=m.order)!=null?P:0)}).map(d=>d.name),o=await Re(e,"Select dimension of your project:",r);if(!o)return[null,"Project action cancelled. No dimension selected."];let s=n.dimensions.find(d=>d.name===o);if(!s||s.categories.length===0)return[null,"Selected dimension has no categories. No project found."];let i=s.categories,a=await Re(e,"Select category:",i);if(!a)return[null,"Project action cancelled. No category selected."];let l=(c=t[o])==null?void 0:c[a];if(!l||Object.keys(l).length===0)return[null,"No projects found in this category."];let p=await Re(e,"Select Project:",Object.keys(l));return p?[{dimension:o,category:a,projectId:p},"Project details collected."]:[null,"Project action cancelled. No project selected."]}Tt();async function yn(e){let[n,t]=await pn(e.app,e.settings);if(n===null){new Rt.Notice(t);return}let[,r]=await it(e,n);new Rt.Notice(r),console.log(r)}var xt=require("obsidian");async function Pn(e){let[n,t]=await et(e.app,e.settings);if(n===null){new xt.Notice(t);return}let{dimension:r,category:o,projectId:s}=n,[,i]=await ze(e,r,o,s);new xt.Notice(i),console.log(i)}var bt=require("obsidian");async function jn(e){let[n,t]=await et(e.app,e.settings);if(n===null){new bt.Notice(t);return}let{dimension:r,category:o,projectId:s}=n,[,i]=await qe(e,r,o,s);new bt.Notice(i),console.log(i)}var Cn=require("obsidian");async function vn(e){let n=[];for(let t of e)try{let r=`${t.url.replace(/\/$/,"")}/tools`,o=await fetch(r,{method:"GET",headers:t.apiKey?{"x-api-key":t.apiKey}:void 0});if(!o.ok)continue;let s=await o.json(),i=Array.isArray(s==null?void 0:s.tools)?s.tools:[];n.push({server:t,tools:i})}catch(r){}return n}function wn(e,n){return n.map(t=>({name:`${e.name}:${t.name}`,description:t.description||"MCP tool",schema:t.inputSchema||{type:"object",properties:{},additionalProperties:!0},handler:async r=>xr(e,t.name,r)}))}async function xr(e,n,t){let r=`${e.url.replace(/\/$/,"")}/call`,o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",...e.apiKey?{"x-api-key":e.apiKey}:{}},body:JSON.stringify({name:n,args:t})});if(!o.ok){let s=await o.text().catch(()=>"");throw new Error(`MCP call failed: ${o.status} ${s||o.statusText}`)}return await o.json().catch(()=>({}))}var at={type:"object",description:"Reference to a project by tag, id, or full name.",properties:{tag:{type:"string"},id:{type:"string"},fullName:{type:"string"}},additionalProperties:!1},br={type:"object",description:"Fields to set on the entity (camelCase, e.g. title, description).",properties:{title:{type:"string"},description:{type:"string"}},additionalProperties:!0};function Et(e){let n=e.getApi();return n?[{name:"resolveProject",description:"Resolve a project by tag, id, or full name.",schema:{type:"object",properties:{projectRef:at},required:["projectRef"],additionalProperties:!1},handler:async t=>n.resolveProject(t.projectRef)},{name:"listEntityTypes",description:"List available entity types.",schema:{type:"object",properties:{},additionalProperties:!1},handler:async()=>n.listEntityTypes()},{name:"createProject",description:"Create a project with the required metadata.",schema:{type:"object",properties:{name:{type:"string"},tag:{type:"string"},id:{type:"string"},dimension:{type:"string"},category:{type:"string"},parent:{type:"string"},projectTypeId:{type:"string"}},required:["name","tag","id","dimension","category"],additionalProperties:!1},handler:async t=>n.createProject(t)},{name:"createEntity",description:"Create an entity inside a project using a template.",schema:{type:"object",properties:{projectRef:at,entityTypeId:{type:"string"},fields:br},required:["projectRef","entityTypeId"],additionalProperties:!1},handler:async t=>n.createEntity(t)},{name:"patchMarker",description:"Patch content into a file at an AI marker.",schema:{type:"object",properties:{path:{type:"string"},marker:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","marker","content"],additionalProperties:!1},handler:async t=>n.patchMarker(t)},{name:"patchSection",description:"Patch content into a file by heading.",schema:{type:"object",properties:{path:{type:"string"},heading:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","heading","content"],additionalProperties:!1},handler:async t=>n.patchSection(t)},{name:"getChildren",description:"Get child projects for a given project.",schema:{type:"object",properties:{projectRef:at,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async t=>n.getChildren(t.projectRef,t.archived)},{name:"getParents",description:"Get parent projects for a given project.",schema:{type:"object",properties:{projectRef:at,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async t=>n.getParents(t.projectRef,t.archived)}]:[]}async function At(e){var o;let n=((o=e.settings.ai)==null?void 0:o.mcpServers)||[];if(n.length===0)return[];let t=await vn(n),r=[];for(let s of t)r.push(...wn(s.server,s.tools));return r}function ct(e,n,t="$",r=[]){if(!e)return r;let o=e.type?Array.isArray(e.type)?e.type:[e.type]:[];if(o.length>0&&!o.some(i=>Er(i,n)))return r.push({path:t,message:`Expected ${o.join("|")}`}),r;if(e.enum&&!e.enum.includes(n)&&r.push({path:t,message:"Value not in enum"}),e.type==="object"&&n&&typeof n=="object"&&!Array.isArray(n)){let s=n;if((e.required||[]).forEach(a=>{a in s||r.push({path:`${t}.${a}`,message:"Missing required field"})}),e.properties)for(let[a,l]of Object.entries(e.properties))a in s&&ct(l,s[a],`${t}.${a}`,r)}return e.type==="array"&&Array.isArray(n)&&e.items&&n.forEach((s,i)=>{ct(e.items,s,`${t}[${i}]`,r)}),r}function Er(e,n){return e==="array"?Array.isArray(n):e==="integer"?Number.isInteger(n):e==="number"?typeof n=="number":e==="boolean"?typeof n=="boolean":e==="string"?typeof n=="string":e==="object"?n!=null&&typeof n=="object"&&!Array.isArray(n):!0}async function Ct(e,n){let t=[],r=new Map(n.map(o=>[o.name,o]));for(let o of e){let s=r.get(o.name);if(!s){t.push({toolName:o.name,ok:!1,error:"Tool not found"});continue}let i=ct(s.schema,o.arguments);if(i.length>0){t.push({toolName:o.name,ok:!1,error:`Schema validation failed: ${i.map(a=>`${a.path}: ${a.message}`).join(", ")}`});continue}try{let a=await s.handler(o.arguments);t.push({toolName:o.name,ok:!0,result:a})}catch(a){t.push({toolName:o.name,ok:!1,error:(a==null?void 0:a.message)||"Tool execution failed"})}}return t}async function*Tn(e,n,t){var c,d;let r=`${e.baseUrl.replace(/\/$/,"")}/v1/chat/completions`,o={model:e.model,messages:n.map(m=>{let h={role:m.role,content:m.content};return m.role==="tool"&&m.toolCallId&&(h.tool_call_id=m.toolCallId),m.role==="assistant"&&m.toolCalls&&m.toolCalls.length>0&&(h.tool_calls=m.toolCalls.map(P=>{var w;return{id:P.id,type:"function",function:{name:P.name,arguments:JSON.stringify((w=P.arguments)!=null?w:{})}}})),h}),tools:t.map(m=>({type:"function",function:{name:m.name,description:m.description,parameters:m.schema}})),tool_choice:"auto",stream:!0},s={"Content-Type":"application/json"};e.apiKey&&(s.Authorization=`Bearer ${e.apiKey}`);let i=await fetch(r,{method:"POST",headers:s,body:JSON.stringify(o)});if(!i.ok||!i.body){let m=await Ar(i);throw new Error(`OpenAI request failed: ${i.status} ${m||i.statusText}`)}let a=i.body.getReader(),l=new TextDecoder,p="";for(;;){let{value:m,done:h}=await a.read();if(h)break;p+=l.decode(m,{stream:!0});let P=p.split(`
`);p=P.pop()||"";for(let w of P){let j=w.trim();if(!j.startsWith("data:"))continue;let g=j.replace(/^data:\s*/,"");if(g==="[DONE]"){yield{type:"done"};return}let v;try{v=JSON.parse(g)}catch(y){continue}let f=(d=(c=v==null?void 0:v.choices)==null?void 0:c[0])==null?void 0:d.delta;f&&(f.content&&(yield{type:"content",delta:f.content}),f.tool_calls&&(yield{type:"tool_call_delta",toolCalls:f.tool_calls.map(T=>{var I,O;return{index:T.index,id:T.id,name:(I=T.function)==null?void 0:I.name,arguments:(O=T.function)==null?void 0:O.arguments}})}))}}yield{type:"done"}}function St(e,n){for(let t of e){let r=n.get(t.index)||{name:"",arguments:{}};if(t.id&&(r.id=t.id),t.name&&(r.name=t.name),typeof t.arguments=="string"){let o=r._rawArgs||"";r._rawArgs=o+t.arguments}n.set(t.index,r)}}function It(e){let n=[];for(let[,t]of e){let r=t._rawArgs;if(r)try{t.arguments=JSON.parse(r)}catch(o){t.arguments={}}delete t._rawArgs,n.push(t)}return n}async function Ar(e){try{return await e.text()}catch(n){return""}}async function*Rn(e,n,t){let r=`${e.baseUrl.replace(/\/$/,"")}/v1/messages`,{system:o,anthropicMessages:s}=Cr(n),i={model:e.model,max_tokens:1024,system:o,messages:s,tools:t.map(m=>({name:m.name,description:m.description,input_schema:m.schema})),stream:!0},a=await fetch(r,{method:"POST",headers:{"x-api-key":e.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify(i)});if(!a.ok||!a.body){let m=await Sr(a);throw new Error(`Anthropic request failed: ${a.status} ${m||a.statusText}`)}let l=a.body.getReader(),p=new TextDecoder,c="",d=new Set;for(;;){let{value:m,done:h}=await l.read();if(h)break;c+=p.decode(m,{stream:!0});let P=c.split(`
`);c=P.pop()||"";for(let w of P){let j=w.trim();if(!j.startsWith("data:"))continue;let g=j.replace(/^data:\s*/,"");if(!g||g==="[DONE]"){yield{type:"done"};return}let v;try{v=JSON.parse(g)}catch(y){continue}let f=v==null?void 0:v.type;if(f==="content_block_delta"){let y=v.delta;if((y==null?void 0:y.type)==="text_delta"&&(yield{type:"content",delta:y.text}),(y==null?void 0:y.type)==="input_json_delta"){if(d.has(v.index))continue;yield{type:"tool_call_delta",toolCalls:[{index:v.index,arguments:y.partial_json}]}}}if(f==="content_block_start"){let y=v.content_block;if((y==null?void 0:y.type)==="tool_use"){let T=y.input&&Object.keys(y.input).length>0;T&&d.add(v.index),yield{type:"tool_call_delta",toolCalls:[{index:v.index,id:y.id,name:y.name,arguments:T?JSON.stringify(y.input):""}]}}}if(f==="message_stop"){yield{type:"done"};return}}}yield{type:"done"}}function Cr(e){let n="",t=[];for(let r of e){if(r.role==="system"){n=[n,r.content].filter(Boolean).join(`
`);continue}if(r.role==="user"){t.push({role:"user",content:[{type:"text",text:r.content}]});continue}if(r.role==="assistant"){let o=[];if(r.content&&o.push({type:"text",text:r.content}),r.toolCalls&&r.toolCalls.length>0)for(let s of r.toolCalls)o.push({type:"tool_use",id:s.id||`tool-${s.name}`,name:s.name,input:s.arguments||{}});o.length>0&&t.push({role:"assistant",content:o});continue}r.role==="tool"&&t.push({role:"user",content:[{type:"tool_result",tool_use_id:r.toolCallId||r.name||"tool",content:r.content}]})}return{system:n,anthropicMessages:t}}async function Sr(e){try{return await e.text()}catch(n){return""}}async function*kt(e,n,t){if(e.provider==="anthropic"){if(!e.apiKey)throw new Error("Anthropic API key is missing");yield*Rn({apiKey:e.apiKey,model:e.model||"claude-3-5-sonnet-latest",baseUrl:e.baseUrl||"https://api.anthropic.com"},n,t);return}let r=e.provider==="ollama"?e.baseUrl||"http://localhost:11434":e.baseUrl||"https://api.openai.com";if(!e.apiKey&&e.provider!=="ollama")throw new Error("OpenAI API key is missing");yield*Tn({apiKey:e.apiKey||"",model:e.model||(e.provider==="ollama"?"llama3.1":"gpt-4o-mini"),baseUrl:r},n,t)}function xn(e){let n=e.app.workspace.getActiveFile();if(!n)return null;let t=e.settings.projectIndex;if(!t)return null;let r=n.path,o=Object.values(t.byFullName||{}),s=null;for(let i of o)i.path&&r.startsWith(i.path)&&(!s||i.path.length>s.path.length)&&(s=i);return s}function bn(e,n,t=5){let r=e.settings.projectIndex;if(!r)return[];let o=n.trim().toLowerCase();return o?Object.values(r.byFullName||{}).map(a=>{var d,m;let l=((d=a.projectTag)==null?void 0:d.toLowerCase())||"",p=((m=a.projectName)==null?void 0:m.toLowerCase())||"",c=0;return l===o&&(c+=100),p===o&&(c+=90),l.startsWith(o)&&(c+=60),p.startsWith(o)&&(c+=50),l.includes(o)&&(c+=30),p.includes(o)&&(c+=20),{entry:a,score:c}}).filter(a=>a.score>0).sort((a,l)=>l.score-a.score).slice(0,t).map(a=>a.entry):[]}var pe="projectflow-ai-chat",lt=class extends Cn.ItemView{constructor(t,r){var o;super(t);this.messageContainer=null;this.inputEl=null;this.sendBtn=null;this.busy=!1;this.conversation=[];this.persistTimer=null;this.pendingPlan=null;this.plugin=r,this.pendingPlan=((o=this.plugin.settings.ai)==null?void 0:o.pendingPlan)||null}getViewType(){return pe}getDisplayText(){return"ProjectFlow AI"}getIcon(){return"brain-circuit"}async onOpen(){var p,c;let t=this.containerEl.children[1];t.empty(),t.addClass("pf-ai-view");let r=t.createDiv({cls:"pf-ai-header"});r.createEl("h3",{text:"ProjectFlow AI"});let o=r.createEl("button",{text:"Clear"});o.addClass("pf-ai-clear"),o.onclick=()=>this.clearConversation();let s=t.createDiv({cls:"pf-ai-messages"});this.messageContainer=s,this.conversation=((p=this.plugin.settings.ai)==null?void 0:p.conversation)||[],this.pendingPlan=((c=this.plugin.settings.ai)==null?void 0:c.pendingPlan)||null;let i=t.createDiv({cls:"pf-ai-input"}),a=i.createEl("textarea");a.placeholder="Ask ProjectFlow...";let l=i.createEl("button",{text:"Send"});this.inputEl=a,this.sendBtn=l,l.onclick=()=>this.handleSend(),a.onkeydown=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),this.handleSend())}}async onClose(){this.flushConversation(),this.messageContainer=null,this.inputEl=null,this.sendBtn=null}appendMessage(t,r){if(!this.messageContainer)return null;let o=this.messageContainer.createDiv({cls:`pf-ai-message ${t}`});return o.setText(r),this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}),o}updateMessage(t,r){var o;t&&(t.setText(r),(o=this.messageContainer)==null||o.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}))}async handleSend(){var o;if(this.busy)return;let t=(((o=this.inputEl)==null?void 0:o.value)||"").trim();if(!t)return;this.inputEl.value="",this.appendMessage("user",t);let r=this.plugin.settings.ai;if(!(r!=null&&r.enabled)){this.appendMessage("assistant","AI module is disabled in settings.");return}if(!r.apiKey&&r.provider!=="ollama"){await this.handleTagLookup(t);return}await this.handleLLM(t)}async handleTagLookup(t){let r=this.plugin.getApi();if(!r){this.appendMessage("assistant","Core API is not available.");return}try{let o=r.resolveProject({tag:t});if(!o){let s=bn(this.plugin,t);if(s.length===0)this.appendMessage("assistant","Project not found.");else if(s.length===1)this.appendMessage("assistant",`Resolved project: ${s[0].fullName} (${s[0].projectTag})`);else{let i=s.map(a=>`- ${a.projectTag} (${a.fullName})`).join("\\n");this.appendMessage("assistant",`Multiple matches found:\\n${i}`)}return}this.appendMessage("assistant",`Resolved project: ${o.entry.fullName} (${o.entry.projectTag})`)}catch(o){this.appendMessage("assistant",(o==null?void 0:o.message)||"Failed to resolve project.")}}async handleLLM(t){if(!this.busy){this.busy=!0,this.sendBtn&&(this.sendBtn.disabled=!0);try{this.pendingPlan?await this.handleFollowup(t):await this.handleNewRequest(t)}catch(r){this.appendMessage("assistant",(r==null?void 0:r.message)||"LLM request failed.")}finally{this.busy=!1,this.sendBtn&&(this.sendBtn.disabled=!1)}}}async handleNewRequest(t){let r=Et(this.plugin),o=await At(this.plugin),s=[...r,...o],i=An(s),a=await this.buildSystemPrompt(),l=this.buildUserMessage(t),p=this.getConversationWindow().filter(g=>g.role!=="tool"),c=[{role:"system",content:a},...p,{role:"user",content:l}];this.recordConversation({role:"user",content:t});let d=await this.runPlanningStage(c,i);if(d.needsFollowup&&d.question){this.pendingPlan={originalInput:t,plan:d.plan,context:d.context,question:d.question,fields:d.fields,createdAt:new Date().toISOString(),status:"clarifying",clarifications:[]},this.persistPendingPlan(),this.appendMessage("assistant",d.question),this.recordConversation({role:"assistant",content:d.question});return}let m=d.plan?`Planned steps: ${d.plan}`:"",h=d.context?`Planner context: ${d.context}`:"",P=d.fields&&Object.keys(d.fields).length>0?`Fields: ${JSON.stringify(d.fields)}`:"",w=[m,h,P].filter(Boolean).join(`
`);w&&(this.appendMessage("assistant",w),this.recordConversation({role:"assistant",content:w})),this.pendingPlan={originalInput:t,plan:d.plan,context:d.context,fields:d.fields,createdAt:new Date().toISOString(),status:"awaiting_confirmation",clarifications:[]},this.persistPendingPlan(),this.appendConfirmationActions();let j="Please confirm to proceed with these actions.";this.appendMessage("assistant",j),this.recordConversation({role:"assistant",content:j})}async handleFollowup(t){let r=this.pendingPlan;if(!r)return;this.recordConversation({role:"user",content:t});let o=Et(this.plugin),s=await At(this.plugin),i=[...o,...s];if(r.status==="awaiting_confirmation"){if(Mr(t)){let f=await this.buildSystemPrompt(),y=this.getConversationWindow().filter(O=>O.role!=="tool"),T=[`Original request: ${r.originalInput}`,r.plan?`Plan: ${r.plan}`:"",r.context?`Context: ${r.context}`:"",r.fields?`Fields: ${JSON.stringify(r.fields)}`:"",r.clarifications&&r.clarifications.length>0?`Clarifications: ${r.clarifications.join(" | ")}`:"","User confirmed to proceed."].filter(Boolean).join(`
`),I=[{role:"system",content:f},...y,{role:"user",content:T}];this.pendingPlan=null,this.persistPendingPlan(),await this.runAgentLoop(I,i);return}if(Dr(t)){this.pendingPlan=null,this.persistPendingPlan(),this.appendMessage("assistant","Cancelled. Tell me if you want to try a different action."),this.recordConversation({role:"assistant",content:"Cancelled. Tell me if you want to try a different action."});return}this.appendConfirmationActions(),this.appendMessage("assistant","Please confirm to proceed with these actions."),this.recordConversation({role:"assistant",content:"Please confirm to proceed with these actions."});return}let a=An(i),l=await this.buildSystemPrompt(),p=this.getConversationWindow().filter(f=>f.role!=="tool"),c=r.clarifications||[];c.push(t),r.clarifications=c;let d=[`Original request: ${r.originalInput}`,r.plan?`Plan so far: ${r.plan}`:"",r.context?`Context so far: ${r.context}`:"",`User clarification: ${t}`].filter(Boolean).join(`
`),m=[{role:"system",content:l},...p,{role:"user",content:d}],h=await this.runPlanningStage(m,a);if(h.needsFollowup&&h.question){r.plan=h.plan,r.context=h.context,r.question=h.question,r.fields=h.fields,r.status="clarifying",this.pendingPlan=r,this.persistPendingPlan(),this.appendMessage("assistant",h.question),this.recordConversation({role:"assistant",content:h.question});return}r.plan=h.plan,r.context=h.context,r.fields=h.fields,r.status="awaiting_confirmation",this.pendingPlan=r,this.persistPendingPlan();let P=h.plan?`Planned steps: ${h.plan}`:"",w=h.context?`Planner context: ${h.context}`:"",j=h.fields&&Object.keys(h.fields).length>0?`Fields: ${JSON.stringify(h.fields)}`:"",g=[P,w,j].filter(Boolean).join(`
`);g&&(this.appendMessage("assistant",g),this.recordConversation({role:"assistant",content:g})),this.appendConfirmationActions();let v="Please confirm to proceed with these actions.";this.appendMessage("assistant",v),this.recordConversation({role:"assistant",content:v})}async runAgentLoop(t,r){var s,i,a;for(let l=0;l<6;l+=1){let p=this.appendMessage("assistant",""),c=new Map,d=new Map,m=Boolean((s=this.plugin.settings.ai)==null?void 0:s.strictExecution),h=2,P=0;for(;;)try{for await(let f of kt(this.plugin.settings.ai,t,r)){if(f.type==="content"&&f.delta){let y=(p==null?void 0:p.textContent)||"";this.updateMessage(p,y+f.delta)}if(f.type==="tool_call_delta"&&f.toolCalls){St(f.toolCalls,d);for(let y of f.toolCalls)if(y.name&&!c.has(y.name)){let T=this.appendMessage("tool",`Using tool: ${y.name}`);T&&c.set(y.name,T)}}}break}catch(f){if(P+=1,P>h)throw f;this.appendMessage("tool",`Retrying LLM request (${P}/${h})...`),await Nr(300*P)}let w=It(d),j=(p==null?void 0:p.textContent)||"";if(t.push({role:"assistant",content:j,toolCalls:w}),this.recordConversation({role:"assistant",content:j}),w.length===0)return;for(let f of w)this.appendMessage("tool",`Tool call: ${f.name} ${En(f.arguments)}`);let g=await Ct(w,r),v=Ir(g);for(let f=0;f<g.length;f+=1){let y=g[f],T=y.ok?{ok:!0,result:y.result}:{ok:!1,error:y.error},I=y.ok?`Tool result (${y.toolName}): ${En(y.result)}`:`Tool error (${y.toolName}): ${y.error}`;this.appendMessage("tool",I),this.recordConversation({role:"tool",name:y.toolName,toolCallId:(i=w[f])==null?void 0:i.id,content:JSON.stringify(T)}),this.recordToolLog(y.toolName,y.ok,y.error),t.push({role:"tool",name:y.toolName,toolCallId:(a=w[f])==null?void 0:a.id,content:JSON.stringify(T)})}if(m&&g.some(f=>!f.ok)){this.appendMessage("assistant","Strict mode: tool execution failed. Please adjust input and try again.");return}if(v.length>0){let f=Array.from(new Set(v));this.appendMessage("assistant",`Missing required fields: ${f.join(", ")}. Please provide them and try again.`);return}}this.appendMessage("assistant","Stopped after reaching max tool steps.")}async buildSystemPrompt(){let t=this.getSelection(),r=this.app.workspace.getActiveFile(),o="";if(r)try{o=(await this.app.vault.cachedRead(r)).slice(0,1e3)}catch(l){o=""}let s=this.plugin.settings.projectIndex,i=xn(this.plugin),a=kr(this.plugin);return["You are ProjectFlow AI. You must use tools to perform any actions.","Never edit markdown directly; use tools only.","Respond with tool calls when an action is required.","If required fields are missing, ask the user for them instead of calling tools.","Use camelCase fields in createEntity (e.g., fields.title, fields.description).",'Example tool call: createEntity { projectRef:{tag:"my-tag"}, entityTypeId:"task", fields:{ title:"...", description:"..." } }',"Context:",`Selected text: ${t||"(none)"}`,`Active file: ${(r==null?void 0:r.path)||"(none)"}`,`Active file content (truncated): ${o||"(none)"}`,`Active project: ${i?`${i.projectTag} (${i.fullName})`:"(none)"}`,`Entity required fields: ${a}`,`Project index snapshot: ${s?JSON.stringify(s):"(none)"}`].join(`
`)}buildUserMessage(t){return`I'm going to create a project with tag ${t}
${t}`}getSelection(){var r;let t=(r=this.app.workspace.activeEditor)==null?void 0:r.editor;return t?t.getSelection():""}getConversationWindow(){var r,o;let t=Math.max(0,(o=(r=this.plugin.settings.ai)==null?void 0:r.memoryLimit)!=null?o:10);return t===0?[]:this.conversation.slice(-t)}recordConversation(t){var o,s;this.conversation.push({role:t.role,content:t.content,name:t.name,toolCallId:t.toolCallId});let r=Math.max(0,(s=(o=this.plugin.settings.ai)==null?void 0:o.memoryLimit)!=null?s:10);r>0&&this.conversation.length>r&&(this.conversation=this.conversation.slice(-r)),this.persistConversation()}persistConversation(){this.persistTimer&&window.clearTimeout(this.persistTimer),this.persistTimer=window.setTimeout(async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.conversation=this.conversation.map(t=>({role:t.role,content:t.content,name:t.name,toolCallId:t.toolCallId})),await this.plugin.saveSettings())},400)}flushConversation(){this.persistTimer&&(window.clearTimeout(this.persistTimer),this.persistTimer=null),this.plugin.settings.ai&&(this.plugin.settings.ai.conversation=this.conversation.map(t=>({role:t.role,content:t.content,name:t.name,toolCallId:t.toolCallId})),this.plugin.saveSettings())}recordToolLog(t,r,o){if(!this.plugin.settings.ai)return;let s=this.plugin.settings.ai.toolLog||[];s.push({ts:new Date().toISOString(),toolName:t,ok:r,error:o});let i=s.slice(-200);this.plugin.settings.ai.toolLog=i,this.plugin.saveSettings()}clearConversation(){this.conversation=[],this.pendingPlan=null,this.messageContainer&&this.messageContainer.empty(),this.plugin.settings.ai&&(this.plugin.settings.ai.conversation=[],this.plugin.settings.ai.pendingPlan=null,this.plugin.saveSettings()),this.appendMessage("assistant","Conversation cleared.")}appendConfirmationActions(){if(!this.messageContainer)return;let t=this.messageContainer.createDiv({cls:"pf-ai-confirmation"}),r=t.createEl("button",{text:"Proceed"});r.addClass("pf-ai-confirm");let o=t.createEl("button",{text:"Reject"});o.addClass("pf-ai-reject"),r.onclick=()=>this.handleFollowup("yes"),o.onclick=()=>this.handleFollowup("no"),this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"})}async runPlanningStage(t,r){let s=[{role:"system",content:["You are a planner for ProjectFlow AI.","Return ONLY valid JSON with keys: needsFollowup (boolean), question (string), plan (string), context (string), fields (object).","fields must include required values for createEntity/createProject when applicable (e.g., TITLE, DESCRIPTION).","If you need more info, set needsFollowup=true and ask a concise question.","If you have enough info, set needsFollowup=false and provide a short plan, context summary, and fields.","Do NOT call tools in this stage."].join(`
`)},...t.filter(l=>l.role!=="tool")],i=await $r(s,r,this.plugin),a=Fr(i);return a||{needsFollowup:!1,plan:"",context:"",fields:{}}}persistPendingPlan(){this.plugin.settings.ai&&(this.plugin.settings.ai.pendingPlan=this.pendingPlan,this.plugin.saveSettings())}};function En(e){if(e==null)return"(no result)";if(typeof e=="string")return e;try{return JSON.stringify(e)}catch(n){return String(e)}}function Ir(e){var t;let n=[];for(let r of e)!r.ok&&((t=r.error)!=null&&t.startsWith("Missing required fields:"))&&r.error.split(":").slice(1).join(":").split(",").forEach(s=>{let i=s.trim();i&&n.push(i)});return n}function kr(e){let n=e.settings.entityTypes||{},t={};for(let[r,o]of Object.entries(n))o!=null&&o.requiredFields&&o.requiredFields.length>0&&(t[r]=o.requiredFields);try{return JSON.stringify(t)}catch(r){return"(unavailable)"}}function Nr(e){return new Promise(n=>setTimeout(n,e))}async function $r(e,n,t){var s;let r="";for(let i=0;i<6;i+=1){let a=new Map;r="";for await(let c of kt(t.settings.ai,e,n))c.type==="content"&&c.delta&&(r+=c.delta),c.type==="tool_call_delta"&&c.toolCalls&&St(c.toolCalls,a);let l=It(a);if(e.push({role:"assistant",content:r,toolCalls:l}),l.length===0)return r.trim();let p=await Ct(l,n);for(let c=0;c<p.length;c+=1){let d=p[c],m=d.ok?{ok:!0,result:d.result}:{ok:!1,error:d.error};e.push({role:"tool",name:d.toolName,toolCallId:(s=l[c])==null?void 0:s.id,content:JSON.stringify(m)})}}return r.trim()}function Fr(e){let n=e.indexOf("{"),t=e.lastIndexOf("}");if(n===-1||t===-1||t<=n)return null;let r=e.slice(n,t+1);try{let o=JSON.parse(r),s=o.fields&&typeof o.fields=="object"?o.fields:{};return{needsFollowup:Boolean(o.needsFollowup),question:typeof o.question=="string"?o.question:"",plan:typeof o.plan=="string"?o.plan:"",context:typeof o.context=="string"?o.context:"",fields:s}}catch(o){return null}}function An(e){let n=new Set(["resolveProject","listProjects","listEntityTypes","describeEntityType","listProjectTypes","describeProjectType","getChildren","getParents"]);return e.filter(t=>n.has(t.name)||t.name.includes(":"))}function Mr(e){let n=e.trim().toLowerCase();return["yes","y","confirm","ok","okay","proceed"].includes(n)}function Dr(e){let n=e.trim().toLowerCase();return["no","n","cancel","stop"].includes(n)}var mt=class extends Xn.Plugin{async onload(){var t;console.log("ProjectFlow plugin loaded"),await this.loadSettings(),this.addSettingTab(new Xe(this.app,this)),this.registerView(pe,r=>new lt(r,this)),this.addCommand({id:"add-project-info",name:"Add Project Info",callback:()=>yn(this)}),this.addCommand({id:"remove-project-by-id",name:"Remove Project",callback:()=>Pn(this)}),this.addCommand({id:"archive-project-by-id",name:"Archive Project",callback:()=>jn(this)}),await this.exposeCoreApi(),(t=this.settings.ai)!=null&&t.enabled&&this.app.workspace.onLayoutReady(()=>{this.toggleAiView(!0)})}async loadSettings(){let t=await this.loadData();try{let{migrateSettings:r,CURRENT_SETTINGS_SCHEMA_VERSION:o}=await Promise.resolve().then(()=>(Nt(),Sn)),{DEFAULT_ENTITY_TYPES:s,DEFAULT_PROJECT_TYPES:i}=await Promise.resolve().then(()=>(Se(),Qt)),{ensureProjectIndex:a}=await Promise.resolve().then(()=>(Pe(),ke)),{ensureProjectGraph:l}=await Promise.resolve().then(()=>(je(),$e));this.settings=Object.assign({},Ze,r(t));let p=!1;this.settings.templatesRoot||(this.settings.templatesRoot="Templates/ProjectFlow",p=!0),(!this.settings.entityTypes||Object.keys(this.settings.entityTypes).length===0)&&(this.settings.entityTypes=s,p=!0),(!this.settings.projectTypes||Object.keys(this.settings.projectTypes).length===0)&&(this.settings.projectTypes=i,p=!0),(!this.settings.schemaVersion||this.settings.schemaVersion<o)&&(this.settings.schemaVersion=o,p=!0);let{index:c,updated:d}=a(this.settings.projectIndex,this.settings.projectRecords);d&&(this.settings.projectIndex=c,p=!0);let{graph:m,updated:h}=l(this.settings.projectGraph,this.settings.projectRecords,this.settings.archivedRecords);h&&(this.settings.projectGraph=m,p=!0),p&&await this.saveData(this.settings)}catch(r){this.settings=Object.assign({},Ze,t)}}async saveSettings(){await this.saveData(this.settings)}getApi(){return this.coreApi}async toggleAiView(t){if(t){let r=this.app.workspace.getLeavesOfType(pe);if(r.length>0){await r[0].setViewState({type:pe,active:!0});return}let o=this.app.workspace.getRightLeaf(!1);if(!o)return;await o.setViewState({type:pe,active:!0})}else this.app.workspace.detachLeavesOfType(pe)}onunload(){this.app.workspace.detachLeavesOfType(pe)}async exposeCoreApi(){let{createCoreApi:t}=await Promise.resolve().then(()=>(qn(),zn));this.coreApi=t(this);let r=window;r.PluginApi=r.PluginApi||{},r.PluginApi["@projectflow/core"]=this.coreApi}};var Yr=mt;
