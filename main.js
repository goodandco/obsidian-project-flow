/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var bt=Object.defineProperty;var Ss=Object.getOwnPropertyDescriptor;var Is=Object.getOwnPropertyNames;var Ms=Object.prototype.hasOwnProperty;var M=(e,t)=>()=>(e&&(t=e(e=0)),t);var U=(e,t)=>{for(var n in t)bt(e,n,{get:t[n],enumerable:!0})},Ns=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Is(t))!Ms.call(e,o)&&o!==n&&bt(e,o,{get:()=>t[o],enumerable:!(s=Ss(t,o))||s.enumerable});return e};var ks=e=>Ns(bt({},"__esModule",{value:!0}),e);var fn={};U(fn,{DEFAULT_ENTITY_TYPES:()=>de,DEFAULT_PROJECT_TYPES:()=>fe});var de,fe,Ne=M(()=>{de={task:{id:"task",name:"Task",templatePath:"template-task.md",targetFolder:"Work/Tasks",filenameRule:"${PROJECT_ID}-${title}",requiredFields:["title","description"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},"meeting.planning":{id:"meeting.planning",name:"Meeting (Planning)",templatePath:"template-meeting-planning.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.refinement":{id:"meeting.refinement",name:"Meeting (Refinement)",templatePath:"template-meeting-refinement.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.retro":{id:"meeting.retro",name:"Meeting (Retro)",templatePath:"template-meeting-retro.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.demo":{id:"meeting.demo",name:"Meeting (Demo)",templatePath:"template-meeting-demo.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.daily":{id:"meeting.daily",name:"Meeting (Daily)",templatePath:"template-meeting-daily.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},"meeting.knowledge":{id:"meeting.knowledge",name:"Meeting (Knowledge)",templatePath:"template-meeting-knowledge.md",targetFolder:"Meetings",filenameRule:"${DATE} ${title}",requiredFields:["title"],patchMarkers:["AI:AGENDA","AI:NOTES","AI:ACTIONS"]},sprint:{id:"sprint",name:"Sprint",templatePath:"template-sprint.md",targetFolder:"Work",filenameRule:"Sprint ${title}",requiredFields:["title"],patchMarkers:["AI:CONTENT","AI:ACTIONS"]},idea:{id:"idea",name:"Idea",templatePath:"template-idea.md",targetFolder:"Knowledge Base",filenameRule:"Idea ${title}",requiredFields:["title"],patchMarkers:["AI:CONTENT"]}},fe={operational:{id:"operational",name:"Operational",description:"Default ProjectFlow structure for active projects.",folderStructure:["Knowledge Base","Meetings","Work","Work/Tasks","People"],initialNotes:[{fileName:"${PROJECT_FULL_NAME}.md",template:"project.md"},{fileName:"${PROJECT_NAME} Meetings.md",template:"meetings.md"},{fileName:"${PROJECT_NAME} People.md",template:"people.md"},{fileName:"${PROJECT_NAME} Work.md",template:"work.md"},{fileName:"${PROJECT_NAME} Knowledge Base.md",template:"knowledge-base.md"}],allowedEntityTypes:Object.keys(de)}}});var ye={};U(ye,{SafeFileManager:()=>At});var At,ve=M(()=>{At=class{constructor(t){this.vault=t.vault}async createBatch(t){let n=[];try{for(let s of t)s.type==="folder"?await this.ensureFolder(s.path):await this.createIfAbsent(s.path,s.data)==="created"&&n.push(s.path);return{ok:!0}}catch(s){for(let o of n.reverse())try{let r=this.vault.getAbstractFileByPath(o);r&&this.vault.delete&&await this.vault.delete(r)}catch(r){}return{ok:!1,error:s}}}async has(t){var n;try{return this.vault.getAbstractFileByPath(t)?!0:(n=this.vault.adapter)!=null&&n.exists?await this.vault.adapter.exists(t):!1}catch(s){return!1}}async ensureFolder(t){var s;if(!this.vault.getAbstractFileByPath(t))try{await this.vault.createFolder(t)}catch(o){if(o&&typeof o=="object"&&((s=o.message)!=null&&s.includes("Parent folder"))){let r=t.split("/").filter(Boolean),i="";for(let a of r)if(i=i?`${i}/${a}`:a,!this.vault.getAbstractFileByPath(i))try{await this.vault.createFolder(i)}catch(p){}}}}async createIfAbsent(t,n){if(await this.has(t))return"skipped";try{return await this.vault.create(t,n),"created"}catch(s){return await this.has(t),"skipped"}}async removeDir(t){let n=this.vault.getAbstractFileByPath(t);if(n&&this.vault)try{await this.vault.trash(n,!0),await new Promise(s=>setTimeout(s,200))}catch(s){console.warn(`removeDir: failed to trash ${t}: ${s}`)}else console.warn(`removeDir: file not found: ${t}. File: ${n==null?void 0:n.path}`)}}});var ke={};U(ke,{sanitizeFileName:()=>qe,sanitizePath:()=>W});function qe(e){let t=(e!=null?e:"").trim();return Array.from(t).filter(s=>s.charCodeAt(0)>=32).join("").replace(/[\\/:*?"<>|]/g,"-").replace(/\s+/g," ").replace(/\.+$/g,"").substring(0,200)||"untitled"}function W(e){return e?e.split("/").filter(Boolean).map(qe).join("/"):""}var Pe=M(()=>{});var Fe={};U(Fe,{PROJECT_INDEX_VERSION:()=>St,addToProjectIndex:()=>Ds,buildProjectIndex:()=>vn,ensureProjectIndex:()=>Qe,getProjectIndexCache:()=>Ze,removeFromProjectIndex:()=>$s,setProjectIndexCache:()=>Fs,toIndexEntry:()=>It});function Ze(){return Xe}function Fs(e){Xe=e}function vn(e){let t={},n={},s={};if(e&&typeof e=="object"){for(let[o,r]of Object.entries(e))if(!(!r||typeof r!="object")){for(let[i,a]of Object.entries(r))if(!(!a||typeof a!="object"))for(let[p,l]of Object.entries(a)){if(!l||!l.variables||!l.info)continue;let c=It(l,p,o,i);t[c.fullName]=c,n[c.projectId]=c,s[c.projectTag]=c}}}return{version:1,byFullName:t,byId:n,byTag:s}}function It(e,t,n,s){var o;return{fullName:e.variables.PROJECT_FULL_NAME,projectId:t,projectTag:e.variables.PROJECT_TAG,path:e.variables.PROJECT_PATH,dimension:n,category:s,projectName:e.info.name,parent:(o=e.info.parent)!=null?o:null}}function Qe(e,t){if(!e||e.version!==1){let n=vn(t);return Xe=n,{index:n,updated:!0}}return Xe=e,{index:e,updated:!1}}function Ds(e,t,n,s,o){let r=It(t,n,s,o);return e.byFullName[r.fullName]=r,e.byId[r.projectId]=r,e.byTag[r.projectTag]=r,e}function $s(e,t){return delete e.byFullName[t.fullName],delete e.byId[t.projectId],delete e.byTag[t.projectTag],e}var St,Xe,we=M(()=>{St=1,Xe=null});var $e={};U($e,{PROJECT_GRAPH_VERSION:()=>Mt,addProjectToGraph:()=>Ls,buildProjectGraph:()=>Nt,cleanArchivedGraph:()=>kt,ensureProjectGraph:()=>De,getChildren:()=>Ft,getParents:()=>Dt,getProjectGraphCache:()=>Os,removeProjectFromGraph:()=>Bs,setProjectGraphCache:()=>_s});function Os(){return et}function _s(e){et=e}function Nt(e,t){let n={},s={};return e&&Pn(e,n),t&&Pn(t,s),{version:1,byFullName:n,archivedByFullName:s}}function De(e,t,n){if(!e||e.version!==1){let s=Nt(t,n);return et=s,{graph:s,updated:!0}}return et=e,{graph:e,updated:!1}}function Ls(e,t,n){let s=t.variables.PROJECT_FULL_NAME,o=wn(t.info.parent),r=n?e.archivedByFullName:e.byFullName;if(r[s]=r[s]||{parent:o,children:[]},r[s].parent=o!=null?o:null,o){let i=r[o]||{parent:null,children:[]};i.children.includes(s)||i.children.push(s),r[o]=i}return e}function Bs(e,t,n){let s=n?e.archivedByFullName:e.byFullName,o=s[t];return o!=null&&o.parent&&s[o.parent]&&(s[o.parent].children=s[o.parent].children.filter(r=>r!==t)),delete s[t],e}function kt(e,t){let n=Nt(void 0,t);return e.archivedByFullName=n.archivedByFullName,e}function Ft(e,t,n){var o,r;return(r=(o=(n?e.archivedByFullName:e.byFullName)[t])==null?void 0:o.children)!=null?r:[]}function Dt(e,t,n){var i,a,p,l;let s=n?e.archivedByFullName:e.byFullName,o=[],r=(a=(i=s[t])==null?void 0:i.parent)!=null?a:null;for(;r;)o.push(r),r=(l=(p=s[r])==null?void 0:p.parent)!=null?l:null;return o}function Pn(e,t){for(let n of Object.values(e))for(let s of Object.values(n))for(let o of Object.values(s)){if(!o||!o.variables)continue;let r=o.variables.PROJECT_FULL_NAME,i=wn(o.info.parent);if(t[r]=t[r]||{parent:i,children:[]},t[r].parent=i!=null?i:null,i){let a=t[i]||{parent:null,children:[]};a.children.includes(r)||a.children.push(r),t[i]=a}}}function wn(e){let t=e==null?void 0:e.trim();return t&&t.length>0?t:null}var Mt,et,je=M(()=>{Mt=1,et=null});var Cn={};U(Cn,{ensureValidOrThrow:()=>Hs,validateProjectName:()=>Vs,validateTag:()=>Us});function Vs(e){if(!e||!e.trim())return{ok:!1,reason:"Project name is required"};let t=e.trim();if(t.length>120)return{ok:!1,reason:"Project name too long (max 120)"};for(let n of t)if(n.charCodeAt(0)<32||n==="/"||n==="\\")return{ok:!1,reason:"Project name contains invalid characters"};return{ok:!0}}function Us(e){if(!e||!e.trim())return{ok:!1,reason:"Tag is required"};let t=e.trim();return Js.test(t)?{ok:!0}:{ok:!1,reason:"Tag must be 2-63 chars, start with letter/digit; may include -, _, /"}}function Hs(e,t){let n=e();if(!n.ok)throw new Error(`${t}: ${n.reason}`)}var Js,Rn=M(()=>{Js=/^[A-Za-z0-9][A-Za-z0-9_/-]{1,62}$/});var at={};U(at,{processTemplate:()=>zs});function bn(e){return e==null?"":String(e)}function zs(e,t){if(!e||typeof e!="string")return"";let n=e;for(let[s,o]of Object.entries(t)){let r=bn(o),i=`$_${s}`;n.includes(i)&&(n=n.split(i).join(r))}for(let[s,o]of Object.entries(t)){let r=bn(o),i=new RegExp(`\\$\\{${Ws(s)}\\}`,"g");n=n.replace(i,r)}return n}function Ws(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var ct=M(()=>{});function An(e,t){let n=new Date,s=n.getFullYear().toString(),o=n.toISOString().split("T")[0],r=t.projectsRoot||"1. Projects",i=e.parent&&e.parent.trim().length>0?`.${e.parent.trim()}`:"",a=`${s}${i}.${e.name}`,p=t.dimensions.find(m=>m.name===e.dimension),l=p?`${p.order}. ${p.name}`:e.dimension,c=`${r}/${l}/${e.category}/${a}`,g=`${c}`;return{PROJECT_NAME:e.name,PROJECT_TAG:e.tag,PROJECT_PARENT:e.parent?e.parent:"",PARENT_TAG:e.parent?e.tag:"",YEAR:s,DATE:o,PROJECT_FULL_NAME:a,PROJECT_RELATIVE_PATH:c,PROJECT_PATH:g,DIMENSION:p?p.name:e.dimension,CATEGORY:e.category,PROJECT_ID:e.id,PROJECT_DIMENSION:p?p.name:e.dimension}}async function lt(e,t){try{let{processTemplate:n}=await Promise.resolve().then(()=>(ct(),at));return n(e,t)}catch(n){console.warn("Template processor import failed, using legacy replacement:",n);let s=e;return Object.entries(t).forEach(([o,r])=>{let i=`$_${o}`;s=s.split(i).join(r)}),s}}var Sn=M(()=>{});var In={};U(In,{mergeEntityTypes:()=>pt,mergeProjectTypes:()=>Ee});function pt(e){let t={...de};if(e&&typeof e=="object")for(let[n,s]of Object.entries(e))!s||typeof s!="object"||(t[n]={...t[n],...s,id:n});return t}function Ee(e){let t={...fe};if(e&&typeof e=="object")for(let[n,s]of Object.entries(e))!s||typeof s!="object"||(t[n]={...t[n],...s,id:n});return t}var Le=M(()=>{Ne()});var Mn={};U(Mn,{resolveProjectType:()=>Ks});function Ks(e,t){let n=Ee(e.projectTypes),s=t==null?void 0:t.projectTypeId,o=s&&n[s]?s:"operational",r=n[o]||n.operational;return{projectTypeId:o,projectType:r}}var Nn=M(()=>{Le()});async function dt(e,t){var n,s;try{let{resolveProjectType:o}=await Promise.resolve().then(()=>(Nn(),Mn)),{projectTypeId:r,projectType:i}=o(e.settings,t);t.projectTypeId=r;let a=An(t,e.settings),p=e.settings.projectsRoot||"1. Projects",{sanitizePath:l,sanitizeFileName:c}=await Promise.resolve().then(()=>(Pe(),ke)),{SafeFileManager:g}=await Promise.resolve().then(()=>(ve(),ye)),m=new g(e.app),u=l(p),y=e.settings.dimensions.find(T=>T.name===t.dimension),P=y?`${y.order}. ${y.name}`:t.dimension,v=c(P),d=c(t.category),h=l(`${u}/${v}/${d}/${a.PROJECT_FULL_NAME}`),w=(n=i==null?void 0:i.folderStructure)!=null?n:["Knowledge Base","Meetings","Work","Work/Tasks","People"],j=[{type:"folder",path:h},...w.map(T=>({type:"folder",path:l(`${h}/${T}`)}))],x=e.app.vault.adapter,N=`.obsidian/plugins/${e.manifest.id}/src/templates`,O=(s=i==null?void 0:i.initialNotes)!=null?s:[{fileName:`${a.PROJECT_FULL_NAME}.md`,template:"project.md"},{fileName:`${t.name} Meetings.md`,template:"meetings.md"},{fileName:`${t.name} People.md`,template:"people.md"},{fileName:`${t.name} Work.md`,template:"work.md"},{fileName:`${t.name} Knowledge Base.md`,template:"knowledge-base.md"}],K=[];for(let T of O){let k=T.fileName?await lt(T.fileName,a):T.fileName,q=`${N}/${T.template}`;if(!await x.exists(q))throw new Error(`Template file not found: ${T.template}`);let ge=await x.read(q),Te=await lt(ge,a),ne=l(`${h}/${c(k)}`);K.push({type:"file",path:ne,data:Te})}let Y=await m.createBatch([...j,...K]);if(!("ok"in Y)||!Y.ok)throw new Error(`Batch creation failed: ${Y.error||"unknown"}`);return await Xs(e,t.name,a),await Ys(e,t,a),[!0,`Project "${t.name}" created successfully!`]}catch(o){return[!1,`Error creating project: ${o}`]}}async function Ys(e,t,n){try{let{ensureProjectIndex:s,addToProjectIndex:o}=await Promise.resolve().then(()=>(we(),Fe)),{ensureProjectGraph:r,addProjectToGraph:i}=await Promise.resolve().then(()=>(je(),$e)),a={info:t,variables:n,createdAt:new Date().toISOString()},p=t.dimension,l=t.category,c=t.id;if(!e.settings.projectRecords||Array.isArray(e.settings.projectRecords)){let y={},P=Array.isArray(e.settings.projectRecords)?e.settings.projectRecords:[];for(let v of P){let d=v.info.dimension,h=v.info.category,w=v.info.id;y[d]=y[d]||{},y[d][h]=y[d][h]||{},y[d][h][w]=v}e.settings.projectRecords=y}let g=e.settings.projectRecords;if(g[p]=g[p]||{},g[p][l]=g[p][l]||{},g[p][l][c])throw new Error(`Project with id "${c}" already exists in ${p}:${l}`);g[p][l][c]=a;let{index:m}=s(e.settings.projectIndex,g);e.settings.projectIndex=o(m,a,c,p,l);let{graph:u}=r(e.settings.projectGraph,g,e.settings.archivedRecords);e.settings.projectGraph=i(u,a,!1),await e.saveData(e.settings)}catch(s){throw console.warn("Failed to record project creation:",s),s}}async function qs(e,t,n,s,o){try{let r=e.app.vault.adapter,i=`.obsidian/plugins/${e.manifest.id}/src/templates/${s}`;if(!await r.exists(i))throw new Error(`Template file not found: ${s}`);let a=await r.read(i),p=await lt(a,o),l=`${t}/${n}`,{SafeFileManager:c}=await Promise.resolve().then(()=>(ve(),ye));await new c(e.app).createIfAbsent(l,p)}catch(r){throw console.error(`Failed to create ${n}:`,r),new Error(`Failed to create ${n}: ${r}`)}}async function Xs(e,t,n){let{sanitizePath:s,sanitizeFileName:o}=await Promise.resolve().then(()=>(Pe(),ke)),{SafeFileManager:r}=await Promise.resolve().then(()=>(ve(),ye)),i=new r(e.app),a=s(`Templates/${t}_Templates`);await i.ensureFolder(a);let p=[{source:"template-meeting-daily.md",target:`${t}_Meeting_Daily_Template.md`},{source:"template-meeting-discussion.md",target:`${t}_Meeting_Discussion_Template.md`},{source:"template-meeting-knowledge.md",target:`${t}_Meeting_Knowledge_Template.md`},{source:"template-meeting-planning.md",target:`${t}_Meeting_Planning_Template.md`},{source:"template-meeting-refinement.md",target:`${t}_Meeting_Refinement_Template.md`},{source:"template-meeting-retro.md",target:`${t}_Meeting_Retro_Template.md`},{source:"template-meeting-demo.md",target:`${t}_Meeting_Demo_Template.md`},{source:"template-sprint.md",target:`${t}_Sprint_Template.md`},{source:"template-task.md",target:`${t}_Task_Template.md`},{source:"template-idea.md",target:`${t}_Idea_Template.md`},{source:"template-knowledge-base-item.md",target:`${t}_Knowledge_Item_Template.md`},{source:"template-meeting-daily.md",target:"template-meeting-daily.md"},{source:"template-meeting-discussion.md",target:"template-meeting-discussion.md"},{source:"template-meeting-knowledge.md",target:"template-meeting-knowledge.md"},{source:"template-meeting-planning.md",target:"template-meeting-planning.md"},{source:"template-meeting-refinement.md",target:"template-meeting-refinement.md"},{source:"template-meeting-retro.md",target:"template-meeting-retro.md"},{source:"template-meeting-demo.md",target:"template-meeting-demo.md"},{source:"template-sprint.md",target:"template-sprint.md"},{source:"template-task.md",target:"template-task.md"},{source:"template-idea.md",target:"template-idea.md"},{source:"template-knowledge-base-item.md",target:"template-knowledge-base-item.md"}];for(let l of p)try{let c=o(l.target);await qs(e,a,c,l.source,n)}catch(c){console.warn(`Failed to create template ${l.target}: ${c}`)}}var $t=M(()=>{Sn()});var qn={};U(qn,{CURRENT_SETTINGS_SCHEMA_VERSION:()=>Ge,migrateSettings:()=>vo});function vo(e){var o,r,i,a,p,l,c,g,m,u,y,P;let t={dimensions:(o=e==null?void 0:e.dimensions)!=null?o:[],projectsRoot:(r=e==null?void 0:e.projectsRoot)!=null?r:"1. Projects",archiveRoot:(i=e==null?void 0:e.archiveRoot)!=null?i:"4. Archive",templatesRoot:(a=e==null?void 0:e.templatesRoot)!=null?a:"Templates/ProjectFlow",ai:e==null?void 0:e.ai,schemaVersion:(p=e==null?void 0:e.schemaVersion)!=null?p:0,projectRecords:{},archivedRecords:(l=e==null?void 0:e.archivedRecords)!=null?l:{},entityTypes:(c=e==null?void 0:e.entityTypes)!=null?c:{},projectTypes:(g=e==null?void 0:e.projectTypes)!=null?g:{},projectIndex:e==null?void 0:e.projectIndex,projectGraph:e==null?void 0:e.projectGraph},n=e==null?void 0:e.projectRecords;if(n&&typeof n=="object"&&!Array.isArray(n))t.projectRecords=n;else if(Array.isArray(n)){let v={};for(let d of n){if(!d||!d.info)continue;let h=d.info.dimension,w=d.info.category,j=d.info.id;!h||!w||!j||(v[h]=v[h]||{},v[h][w]=v[h][w]||{},v[h][w][j]=d)}t.projectRecords=v}else t.projectRecords={};if(Array.isArray(t.dimensions)){let v=1;t.dimensions=t.dimensions.map(d=>{var h;if(d&&typeof d=="object"){let w=(h=d.name)!=null?h:"",j=d.order,x=typeof w=="string"?w.match(/^\s*(\d+)\.\s*(.+)$/):null;return x&&(j=parseInt(x[1],10),w=x[2]),(j==null||Number.isNaN(j))&&(j=v++),{name:w,order:j,categories:Array.isArray(d.categories)?d.categories:[]}}return{name:String(d!=null?d:""),order:v++,categories:[]}})}else t.dimensions=[];let s=[...t.dimensions].sort((v,d)=>{var h,w;return((h=v.order)!=null?h:0)-((w=d.order)!=null?w:0)});return s.forEach((v,d)=>{v.order=d+1}),t.dimensions=s,(!t.schemaVersion||t.schemaVersion<Ge)&&((!t.entityTypes||Object.keys(t.entityTypes).length===0)&&(t.entityTypes=de),(!t.projectTypes||Object.keys(t.projectTypes).length===0)&&(t.projectTypes=fe),t.ai?t.ai={enabled:Boolean(t.ai.enabled),provider:t.ai.provider||"openai",apiKey:(m=t.ai.apiKey)!=null?m:"",model:(u=t.ai.model)!=null?u:"gpt-4o-mini",baseUrl:(y=t.ai.baseUrl)!=null?y:"https://api.openai.com",strictExecution:Boolean(t.ai.strictExecution),memoryLimit:Number.isFinite(t.ai.memoryLimit)?t.ai.memoryLimit:10,mixedOfferText:(P=t.ai.mixedOfferText)!=null?P:Yn,mcpServers:Array.isArray(t.ai.mcpServers)?t.ai.mcpServers:[],toolLog:Array.isArray(t.ai.toolLog)?t.ai.toolLog:[]}:t.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",strictExecution:!1,memoryLimit:10,mixedOfferText:Yn,mcpServers:[],toolLog:[]},t.schemaVersion=Ge),t}var Ge,Yn,zt=M(()=>{Ne();Ge=8,Yn="I can also set this up for you. Shall I proceed?"});function Xn(e){return e?e.startsWith("/")||e.includes("\\")?!1:!e.split("/").filter(Boolean).some(n=>n==="."||n===".."):!0}function Je(e,t){let n=W(e),s=W(t);return s?n===s||n.startsWith(`${s}/`):!1}var Zn=M(()=>{Pe()});var es={};U(es,{listProjects:()=>Wt,resolveArchivedProject:()=>jt,resolveProject:()=>Ve});function Ve(e,t){var i,a,p;let n=Ze()||Qe(e.settings.projectIndex,e.settings.projectRecords).index,s=Qn(t),o=s.fullName&&n.byFullName[s.fullName]||s.id&&n.byId[s.id]||s.tag&&n.byTag[s.tag];if(!o)return null;let r=(p=(a=(i=e.settings.projectRecords)==null?void 0:i[o.dimension])==null?void 0:a[o.category])==null?void 0:p[o.projectId];return r?{entry:o,record:r}:null}function jt(e,t){var o;let n=Qn(t),s=Po(e.settings.archivedRecords,n);return s?{entry:{fullName:s.variables.PROJECT_FULL_NAME,projectId:s.info.id,projectTag:s.variables.PROJECT_TAG,path:s.variables.PROJECT_PATH,dimension:s.info.dimension,category:s.info.category,projectName:s.info.name,parent:(o=s.info.parent)!=null?o:null},record:s}:null}function Wt(e){let t=Ze()||Qe(e.settings.projectIndex,e.settings.projectRecords).index;return Object.values(t.byFullName)}function Qn(e){var t,n,s;if(typeof e=="string"){let o=e.trim();return o.startsWith("project/")?{tag:o}:o.includes(".")?{fullName:o}:{id:o}}return{fullName:(t=e.fullName)==null?void 0:t.trim(),id:(n=e.id)==null?void 0:n.trim(),tag:(s=e.tag)==null?void 0:s.trim()}}function Po(e,t){if(!e)return null;for(let n of Object.values(e))for(let s of Object.values(n))for(let o of Object.values(s))if(o&&(t.fullName&&o.variables.PROJECT_FULL_NAME===t.fullName||t.id&&o.info.id===t.id||t.tag&&o.variables.PROJECT_TAG===t.tag))return o;return null}var Kt=M(()=>{we()});async function ns(e,t){let{resolveProject:n}=await Promise.resolve().then(()=>(Kt(),es)),{mergeEntityTypes:s}=await Promise.resolve().then(()=>(Le(),In)),{processTemplate:o}=await Promise.resolve().then(()=>(ct(),at)),{SafeFileManager:r}=await Promise.resolve().then(()=>(ve(),ye)),i=n(e,t.projectRef);if(!i)throw new Error("Project not found for reference.");let p=s(e.settings.entityTypes)[t.entityTypeId];if(!p)throw new Error(`Entity type not found: ${t.entityTypeId}`);let l=jo(t.fields);wo(p,l);let c={...i.record.variables,...l||{}},g=await To(e,p,i.record,c);if(!g)throw new Error(`Template not found for entity type: ${p.id}`);let u=await e.app.vault.adapter.read(g.path),y=o(u,c),P=o(p.targetFolder,c);if(!Xn(P))throw new Error("Unsafe targetFolder path.");let v=W(i.record.variables.PROJECT_PATH),d=P?W(`${v}/${P}`):v;if(!Je(d,v))throw new Error("Target folder is outside project path.");if(!ts(d,e.settings))throw new Error("Target folder is outside allowed roots.");let h=p.filenameRule||"Untitled",w=o(h,c),j=w.endsWith(".md")?w.slice(0,-3):w,x=qe(j),N=W(`${d}/${x}.md`);if(!Je(N,v))throw new Error("Target file is outside project path.");if(!ts(N,e.settings))throw new Error("Target file is outside allowed roots.");let O=new r(e.app);if(await O.ensureFolder(d),await O.has(N))throw new Error(`File already exists: ${N}`);return await O.createIfAbsent(N,y),{path:N}}function ts(e,t){let n=t.projectsRoot||"1. Projects",s=t.archiveRoot||"4. Archive";return Je(e,n)||Je(e,s)}function wo(e,t){if(!e.requiredFields||e.requiredFields.length===0)return;let n=e.requiredFields.filter(s=>t==null||t[s]==null||String(t[s]).trim()==="");if(n.length>0)throw new Error(`Missing required fields: ${n.join(", ")}`)}function jo(e){if(!e)return e;let t={...e};for(let[n,s]of Object.entries(e)){if(s==null)continue;let o=n.toUpperCase(),r=n.toLowerCase();o in t||(t[o]=s),r in t||(t[r]=s)}return t}async function To(e,t,n,s){let{processTemplate:o}=await Promise.resolve().then(()=>(ct(),at)),r=e.app.vault.adapter,i=o(t.templatePath,s),a=W(`Templates/${n.info.name}_Templates`),p=W(e.settings.templatesRoot||"Templates/ProjectFlow"),l=`.obsidian/plugins/${e.manifest.id}/src/templates`,c=m=>m.map(u=>u==="project"?{scope:u,path:W(`${a}/${i}`)}:u==="vault"?{scope:u,path:W(`${p}/${i}`)}:{scope:u,path:`${l}/${i}`}),g=t.templateScope?[t.templateScope,"builtin"].filter((m,u,y)=>y.indexOf(m)===u):["project","vault","builtin"];for(let m of c(g))if(await r.exists(m.path))return m;return null}var ss=M(()=>{Pe();Zn()});function os(e){if(e instanceof ue)return e;let t=e instanceof Error?e.message:"Unknown error";return new ue("validation_error",t)}var ue,Yt=M(()=>{ue=class extends Error{constructor(n,s,o){super(s);this.code=n,this.details=o}}});function H(e,t){if(typeof e!="string"||e.trim().length===0)throw new ue("invalid_request",`${t} is required`,{field:t});return e.trim()}function Tt(e){if(e==null)throw new ue("invalid_request","projectRef is required",{field:"projectRef"});if(typeof e=="string"){H(e,"projectRef");return}let t=typeof e.fullName=="string"&&e.fullName.trim().length>0,n=typeof e.id=="string"&&e.id.trim().length>0,s=typeof e.tag=="string"&&e.tag.trim().length>0;if(!t&&!n&&!s)throw new ue("invalid_request","projectRef must include fullName, id, or tag",{field:"projectRef"})}function rs(e){H(e==null?void 0:e.name,"name"),H(e==null?void 0:e.tag,"tag"),H(e==null?void 0:e.id,"id"),H(e==null?void 0:e.dimension,"dimension"),H(e==null?void 0:e.category,"category")}function is(e){Tt(e==null?void 0:e.projectRef),H(e==null?void 0:e.entityTypeId,"entityTypeId")}function as(e){H(e==null?void 0:e.path,"path"),H(e==null?void 0:e.marker,"marker"),H(e==null?void 0:e.content,"content")}function cs(e){H(e==null?void 0:e.path,"path"),H(e==null?void 0:e.heading,"heading"),H(e==null?void 0:e.content,"content")}var xt=M(()=>{Yt()});function ls(e){return{listEntityTypes:()=>pt(e.settings.entityTypes),describeEntityType:t=>pt(e.settings.entityTypes)[t]||null,createEntity:async t=>(is(t),ns(e,t))}}var ps=M(()=>{Le();ss();xt()});function xo(e,t,n,s,o){let r=Co(t),i=ds(e,r,!1);if(i){let a=i.end,p=ds(e,r,!0,a),l=p?p.start:Ro(e,a),c=e[a]!==`
`;return{updated:!0,text:[e.slice(0,a),c?`
`:"",qt(n),e.slice(l>=0?l:e.length)].join("")}}if(s==="strict")return{updated:!1,text:e};if(o){let a=ms(e,o,n,s);if(a.updated)return a}return{updated:!0,text:fs(e,o||"AI Notes",n)}}function ms(e,t,n,s){let o=hs(t),i=new RegExp(`^#{1,6}\\s+${ys(o)}\\s*$`,"m").exec(e);if(!i||i.index==null)return s==="strict"?{updated:!1,text:e}:{updated:!0,text:fs(e,o,n)};let a=i.index,p=e.indexOf(`
`,a),l=p>=0?p+1:e.length,c=Eo(e,l);return{updated:!0,text:[e.slice(0,l),qt(n),e.slice(c)].join("")}}async function us(e,t){var i;let n=e.vault.adapter,s=(i=t.patchMode)!=null?i:"lenient";if(!await n.exists(t.path))return{ok:!1,error:`File not found: ${t.path}`};let o=await n.read(t.path),r=xo(o,t.marker,t.content,s,t.fallbackHeading);return r.updated?(await n.write(t.path,r.text),{ok:!0}):{ok:!1,error:"Marker or heading not found in strict mode."}}async function gs(e,t){var i;let n=e.vault.adapter,s=(i=t.patchMode)!=null?i:"lenient";if(!await n.exists(t.path))return{ok:!1,error:`File not found: ${t.path}`};let o=await n.read(t.path),r=ms(o,t.heading,t.content,s);return r.updated?(await n.write(t.path,r.text),{ok:!0}):{ok:!1,error:"Heading not found in strict mode."}}function Co(e){return e.trim().replace(/^<!--\s*/,"").replace(/\s*(?:-->|>)\s*$/,"").replace(/^\/\s*/,"").trim()}function hs(e){return e.replace(/^#+\s*/,"").trim()}function ds(e,t,n,s=0){let o=n?"\\/\\s*":"",r=new RegExp(`<!--\\s*${o}${ys(t)}\\s*(?:-->|>)`,"gi");r.lastIndex=s;let i=r.exec(e);return!i||i.index==null?null:{start:i.index,end:i.index+i[0].length}}function Ro(e,t){let n=/<!--\s*\/?\s*[A-Za-z0-9:_-]+\s*(?:-->|>)/g;n.lastIndex=t;let s=n.exec(e);return s&&s.index!=null?s.index:-1}function Eo(e,t){let n=/^#{1,6}\s+/gm;n.lastIndex=t;let s=n.exec(e);return s&&s.index!=null?s.index:e.length}function qt(e){let t=e!=null?e:"";return t.endsWith(`
`)?t:`${t}
`}function fs(e,t,n){let s=hs(t);return`${e.endsWith(`
`)?e:`${e}
`}
## ${s}
${qt(n)}`}function ys(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var vs=M(()=>{});function Ps(e){return{patchMarker:async t=>(as(t),us(e.app,t)),patchSection:async t=>(cs(t),gs(e.app,t))}}var ws=M(()=>{vs();xt()});function js(e){return{resolveProject:t=>(Tt(t),Ve(e,t)),listProjects:()=>Wt(e),listProjectTypes:()=>Ee(e.settings.projectTypes),describeProjectType:t=>Ee(e.settings.projectTypes)[t]||null,createProject:async t=>(rs(t),dt(e,t)),getChildren:(t,n)=>{Tt(t);let s=n?jt(e,t):Ve(e,t);if(!s)return[];let{graph:o}=De(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return Ft(o,s.entry.fullName,Boolean(n))},getParents:(t,n)=>{let s=n?jt(e,t):Ve(e,t);if(!s)return[];let{graph:o}=De(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return Dt(o,s.entry.fullName,Boolean(n))},clearArchivedProjectGraph:async()=>{let{graph:t}=De(e.settings.projectGraph,e.settings.projectRecords,e.settings.archivedRecords);return e.settings.projectGraph=kt(t,e.settings.archivedRecords),await e.saveData(e.settings),{ok:!0}}}}var Ts=M(()=>{Le();$t();Kt();je();xt()});var xs={};U(xs,{createCoreApi:()=>bo});function bo(e){let t="1.0.0",n=js(e),s=ls(e),o=Ps(e);return{version:t,capabilities:{resolveProject:!0,listProjects:!0,entityTypes:!0,projectTypes:!0,createProject:!0,createEntity:!0,patching:!0,projectGraph:!0,errorHandling:"throws"},compatibility:{settingsSchemaVersion:Ge,projectIndexVersion:1,projectGraphVersion:1},...n,...s,...o,wrapError:r=>{let i=os(r);return{ok:!1,error:{code:i.code,message:i.message,details:i.details}}}}}var Cs=M(()=>{ps();ws();Ts();Yt();zt();we();je()});var So={};U(So,{default:()=>Ao});module.exports=ks(So);var Rs=require("obsidian");var E=require("obsidian");Ne();var yn=require("obsidian"),Ye=class extends yn.Modal{constructor(n,s){super(n);this.onResult=s}onOpen(){let{contentEl:n}=this;n.empty(),n.addClass("project-flow-settings"),n.createEl("p",{text:"Do you want skip settings to defaults? This will override all custom settings."});let s=n.createDiv({cls:"gc-row"});s.createDiv({cls:"gc-spacer"});let o=s.createEl("button",{text:"Yes, use defaults"}),r=s.createEl("button",{text:"Go back"});o.onclick=()=>{this.close(),this.onResult(!0)},r.onclick=()=>{this.close(),this.onResult(!1)}}onClose(){this.contentEl.empty()}};async function tt(e,t,n,s){let o="",r=e.settings.projectRecords,i=r[t][n][s],{SafeFileManager:a}=await Promise.resolve().then(()=>(ve(),ye)),p=new a(e.app),{sanitizePath:l}=await Promise.resolve().then(()=>(Pe(),ke)),c=l(i.variables.PROJECT_PATH),g=l(`Templates/${i.info.name}_Templates`);try{await p.removeDir(c),await p.removeDir(g);try{r[t][n][s]&&(delete r[t][n][s],Object.keys(r[t][n]).length===0&&delete r[t][n],Object.keys(r[t]).length===0&&delete r[t]);try{let{ensureProjectIndex:m,removeFromProjectIndex:u,toIndexEntry:y}=await Promise.resolve().then(()=>(we(),Fe)),{ensureProjectGraph:P,removeProjectFromGraph:v}=await Promise.resolve().then(()=>(je(),$e)),{index:d}=m(e.settings.projectIndex,r);e.settings.projectIndex=u(d,y(i,s,t,n));let{graph:h}=P(e.settings.projectGraph,r,e.settings.archivedRecords);e.settings.projectGraph=v(h,i.variables.PROJECT_FULL_NAME,!1)}catch(m){console.warn("Failed to update projectIndex after delete:",m)}await e.saveData(e.settings),o="Project deleted successfully."}catch(m){o="Failed to update projectRecords after delete",console.warn(o,m)}return[!0,o]}catch(m){o="Error removing project: "+m.message,console.error("Error removing project:",m)}return[!1,o]}async function nt(e,t,n,s){var o,r,i,a,p;try{let l=e.settings.projectRecords,c=(r=(o=l==null?void 0:l[t])==null?void 0:o[n])==null?void 0:r[s];if(!c)return[!1,"Project not found."];let{sanitizePath:g}=await Promise.resolve().then(()=>(Pe(),ke)),{SafeFileManager:m}=await Promise.resolve().then(()=>(ve(),ye)),u=new m(e.app),y=e.app.vault.adapter,P=g(c.variables.PROJECT_PATH),v=g(`Templates/${c.info.name}_Templates`),d=e.settings.archiveRoot||"4. Archive",h=c.variables.YEAR,w=c.variables.DIMENSION||c.info.dimension,j=c.info.category,x=c.info.parent&&c.info.parent.trim().length>0?c.info.parent.trim():null,N=c.info.name,O=x?`${h}.${w}.${j}.${x}.${N}`:`${h}.${w}.${j}.${N}`,K=g(`${d}/${O}`),Y=T=>{let k=T.split("/").filter(Boolean);return k.pop(),k.join("/")};if(await u.ensureFolder(Y(K)),!await y.exists(P))return[!1,`Project directory not found: ${P}`];if(await y.exists(K))return[!1,`Archive destination already exists: ${K}`];await y.rename(P,K);try{if(await y.exists(v)){let T=g(`${K}/Templates`);await u.ensureFolder(T);let k=g(`${T}/${c.info.name}_Templates`);if(await y.exists(k)){let q=g(`${T}/${c.info.name}_Templates_archived`);await y.rename(v,q)}else await y.rename(v,k)}}catch(T){console.warn("Archiving templates failed:",T)}try{let T=e.settings.projectRecords;(!e.settings.archivedRecords||Array.isArray(e.settings.archivedRecords))&&(e.settings.archivedRecords=e.settings.archivedRecords&&Array.isArray(e.settings.archivedRecords)?{}:e.settings.archivedRecords||{});let k=e.settings.archivedRecords;k[t]=k[t]||{},k[t][n]=k[t][n]||{},k[t][n][s]=c,(a=(i=T==null?void 0:T[t])==null?void 0:i[n])!=null&&a[s]&&(delete T[t][n][s],Object.keys(T[t][n]).length===0&&delete T[t][n],Object.keys(T[t]||{}).length===0&&delete T[t]);try{let{ensureProjectIndex:q,removeFromProjectIndex:ge,toIndexEntry:Te}=await Promise.resolve().then(()=>(we(),Fe)),{ensureProjectGraph:ne,removeProjectFromGraph:Ue,addProjectToGraph:xe}=await Promise.resolve().then(()=>(je(),$e)),{index:Rt}=q(e.settings.projectIndex,T);e.settings.projectIndex=ge(Rt,Te(c,s,t,n));let{graph:He}=ne(e.settings.projectGraph,T,k);e.settings.projectGraph=Ue(He,c.variables.PROJECT_FULL_NAME,!1),e.settings.projectGraph=xe(e.settings.projectGraph,c,!0)}catch(q){console.warn("Failed to update projectIndex after archive:",q)}await e.saveData(e.settings)}catch(T){console.warn("Failed to move project record to archive in settings:",T)}return[!0,"Project archived successfully."]}catch(l){return console.error("Archive failed:",l),[!1,(p=l==null?void 0:l.message)!=null?p:"Failed to archive project."]}}var Gs=[{name:"Business",order:1,categories:["R&D","Jobs","OpenSource","Education"]},{name:"Family",order:2,categories:["Vacations","Parenting","Common"]},{name:"Friends",order:3,categories:[]},{name:"Health",order:4,categories:["Clinics","Issues","R&D"]},{name:"Personal",order:5,categories:["R&D","Languages","SelfManagement","Writing","Reading","Music","Sports"]},{name:"Residence",order:6,categories:[]}],ot={dimensions:JSON.parse(JSON.stringify(Gs)),projectsRoot:"1. Projects",archiveRoot:"4. Archive",templatesRoot:"Templates/ProjectFlow",ai:{enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",strictExecution:!1,memoryLimit:10,mcpServers:[],toolLog:[]},projectRecords:{},archivedRecords:{},projectGraph:{version:1,byFullName:{},archivedByFullName:{}},entityTypes:de,projectTypes:fe};function jn(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}var st=class extends E.PluginSettingTab{constructor(n,s){super(n,s);this.plugin=s}display(){var en,tn,nn,sn,on,rn,an,cn,ln,pn,dn,mn,un,gn,hn;let{containerEl:n}=this;n.empty(),n.addClass("project-flow-settings");let s=n.createDiv({cls:"gc-row"});s.createDiv({cls:"gc-spacer"});let o=s.createEl("button",{cls:["gc-icon-button","clickable-icon"],attr:{"aria-label":"Reset to defaults",title:"Reset to defaults"}});try{(0,E.setIcon)(o,"rotate-ccw")}catch(f){o.setText("Reset to defaults")}o.onclick=()=>{new Ye(this.app,async b=>{b&&(this.plugin.settings=JSON.parse(JSON.stringify(ot)),await this.plugin.saveSettings(),new E.Notice("Settings were reset to defaults."),this.display())}).open()},n.createEl("h2",{text:"Folders"});let r=n.createDiv({cls:"gc-column"}),i=r.createDiv({cls:"setting-item"});i.createEl("label",{text:"Projects root"});let a=i.createEl("input",{type:"text"});a.value=this.plugin.settings.projectsRoot||"1. Projects",a.placeholder="e.g. 1. Projects",a.onchange=async()=>{this.plugin.settings.projectsRoot=a.value.trim()||"1. Projects",await this.plugin.saveSettings()};let p=r.createDiv({cls:"setting-item"});p.createEl("label",{text:"Archive root"});let l=p.createEl("input",{type:"text"});l.value=this.plugin.settings.archiveRoot||"4. Archive",l.placeholder="e.g. 4. Archive",l.onchange=async()=>{this.plugin.settings.archiveRoot=l.value.trim()||"4. Archive",await this.plugin.saveSettings()};let c=r.createDiv({cls:"setting-item"});c.createEl("label",{text:"Templates root"});let g=c.createEl("input",{type:"text"});g.value=this.plugin.settings.templatesRoot||"Templates/ProjectFlow",g.placeholder="e.g. Templates/ProjectFlow",g.onchange=async()=>{this.plugin.settings.templatesRoot=g.value.trim()||"Templates/ProjectFlow",await this.plugin.saveSettings()},n.createEl("h2",{text:"Dimensions"}),[...this.plugin.settings.dimensions].sort((f,b)=>{var _,$;return((_=f.order)!=null?_:0)-(($=b.order)!=null?$:0)}).forEach((f,b)=>{let _=n.createDiv({cls:"dimension-setting"}),$=_.createDiv({cls:"dimension-header"});$.addClass("gc-row"),$.createSpan({text:`${f.order}. `});let z=$.createEl("b",{text:f.name});$.createDiv({cls:"gc-spacer"});let G=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});G.setAttr("aria-label","Move up"),G.setAttr("title","Move up");try{(0,E.setIcon)(G,"arrow-up")}catch(A){G.setText("Up")}G.onclick=async()=>{let S=[...this.plugin.settings.dimensions].filter(F=>{var I,R;return((I=F.order)!=null?I:0)<((R=f.order)!=null?R:0)}).sort((F,I)=>{var R,D;return((R=I.order)!=null?R:0)-((D=F.order)!=null?D:0)})[0];if(!S)return;let C=S.order;S.order=f.order,f.order=C,await this.plugin.saveSettings(),this.display()};let ie=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ie.setAttr("aria-label","Move down"),ie.setAttr("title","Move down");try{(0,E.setIcon)(ie,"arrow-down")}catch(A){ie.setText("Down")}ie.onclick=async()=>{let S=[...this.plugin.settings.dimensions].filter(F=>{var I,R;return((I=F.order)!=null?I:0)>((R=f.order)!=null?R:0)}).sort((F,I)=>{var R,D;return((R=F.order)!=null?R:0)-((D=I.order)!=null?D:0)})[0];if(!S)return;let C=S.order;S.order=f.order,f.order=C,await this.plugin.saveSettings(),this.display()};let ae=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ae.setAttr("aria-label",`Delete ${f.name}`),ae.setAttr("title",`Delete ${f.name}`);try{(0,E.setIcon)(ae,"trash")}catch(A){ae.setText("Remove")}ae.onclick=async()=>{let A=this.plugin.settings.dimensions.findIndex(S=>S===f);A>=0&&this.plugin.settings.dimensions.splice(A,1),await this.plugin.saveSettings(),this.display()};let B=$.createEl("button",{cls:["gc-icon-button","clickable-icon"]});B.setAttr("aria-label",`Rename ${f.name}`),B.setAttr("title",`Rename ${f.name}`);try{(0,E.setIcon)(B,"pencil")}catch(A){B.setText("Edit")}if(B.onclick=async()=>{var ce;let A=f.name,S=z.parentElement;(ce=z.detach)==null||ce.call(z),B.style.display="none",ae.style.display="none";let C=S.createEl("input",{type:"text"});C.value=A,C.addClass("gc-rename");let F=S.createDiv({cls:"gc-row"});F.createDiv({cls:"gc-spacer"});let I=F.createEl("button",{cls:["gc-icon-button","clickable-icon"]});I.setAttr("aria-label","Apply"),I.setAttr("title","Apply");try{(0,E.setIcon)(I,"check")}catch(J){I.setText("Apply")}let R=F.createEl("button",{cls:["gc-icon-button","clickable-icon"]});R.setAttr("aria-label","Discard"),R.setAttr("title","Discard");try{(0,E.setIcon)(R,"x")}catch(J){R.setText("Discard")}let D=()=>{this.display()},X=async J=>{let Z=J.trim();if(!Z||Z===A){D();return}if(this.plugin.settings.dimensions.some(Me=>Me!==f&&Me.name===Z)){new E.Notice("A dimension with this name already exists.");return}f.name=Z,await this.plugin.saveSettings(),D()};I.onclick=async()=>{await X(C.value)},R.onclick=()=>D(),C.focus(),C.select(),C.onkeydown=async J=>{J.key==="Enter"&&await X(C.value),J.key==="Escape"&&D()},C.onblur=async()=>{await X(C.value)}},f.categories.length>0){let A=_.createDiv({cls:"categories-list gc-list"});f.categories.forEach((S,C)=>{var Me;let F=A.createDiv({cls:"gc-list-item gc-row"}),I=this.plugin.settings.projectRecords||{},R=f.name,D=Object.keys(((Me=I==null?void 0:I[R])==null?void 0:Me[S])||{}),X=F.createEl("b",{text:S}),ce=F.createDiv({cls:"gc-id-wrap"});D.length>0&&(ce.createSpan({text:" "}),D.forEach((V,We)=>{let L=ce.createSpan({cls:"gc-id-chip"});L.style.display="inline-flex",L.style.alignItems="center",L.style.gap="4px";let Ce=L.createSpan({cls:"gc-id-tag",text:V}),le=Math.abs(jn(V))%360;Ce.style.backgroundColor=`hsl(${le}, 70%, 90%)`,Ce.style.color=`hsl(${le}, 70%, 25%)`;let Q=L.createSpan({cls:"gc-id-actions"});Q.style.display="none";let ee=Q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});ee.setAttr("aria-label",`Delete ${V}`),ee.setAttr("title",`Delete ${V}`);try{(0,E.setIcon)(ee,"trash")}catch(pe){ee.setText("Del")}ee.onclick=async pe=>{pe.stopPropagation();let[,te]=await tt(this.plugin,R,S,V);new E.Notice(te),this.display()};let se=Q.createEl("button",{cls:["gc-icon-button","clickable-icon"]});se.setAttr("aria-label",`Archive ${V}`),se.setAttr("title",`Archive ${V}`);try{(0,E.setIcon)(se,"archive")}catch(pe){se.setText("Arc")}se.onclick=async pe=>{pe.stopPropagation();let[,te]=await nt(this.plugin,R,S,V);new E.Notice(te),this.display()},L.onmouseenter=()=>{Q.style.display="inline-flex"},L.onmouseleave=()=>{Q.style.display="none"},We<D.length-1&&ce.createSpan({text:" "})})),F.createDiv({cls:"gc-spacer"});let J=F.createEl("button",{cls:["remove-category","gc-icon-button","clickable-icon"]});J.setAttr("aria-label",`Delete ${S}`),J.setAttr("title",`Delete ${S}`);try{(0,E.setIcon)(J,"trash")}catch(V){J.setText("Remove")}J.onclick=async()=>{f.categories.splice(C,1),await this.plugin.saveSettings(),this.display()};let Z=F.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Z.setAttr("aria-label",`Rename ${S}`),Z.setAttr("title",`Rename ${S}`);try{(0,E.setIcon)(Z,"pencil")}catch(V){Z.setText("Edit")}Z.onclick=async()=>{var pe;let V=f.categories[C],We=X.parentElement;(pe=X.detach)==null||pe.call(X),Z.style.display="none",J.style.display="none";let L=We.createEl("input",{type:"text"});L.value=V,L.addClass("gc-rename");let Ce=We.createDiv({cls:"gc-row"});Ce.createDiv({cls:"gc-spacer"});let le=Ce.createEl("button",{cls:["gc-icon-button","clickable-icon"]});le.setAttr("aria-label","Apply"),le.setAttr("title","Apply");try{(0,E.setIcon)(le,"check")}catch(te){le.setText("Apply")}let Q=Ce.createEl("button",{cls:["gc-icon-button","clickable-icon"]});Q.setAttr("aria-label","Discard"),Q.setAttr("title","Discard");try{(0,E.setIcon)(Q,"x")}catch(te){Q.setText("Discard")}let ee=()=>{this.display()},se=async te=>{let Ke=te.trim();if(!Ke||Ke===V){ee();return}if(f.categories.some((bs,As)=>As!==C&&bs===Ke)){new E.Notice("This category already exists in the dimension.");return}f.categories[C]=Ke,await this.plugin.saveSettings(),ee()};le.onclick=async()=>{await se(L.value)},Q.onclick=()=>ee(),L.focus(),L.select(),L.onkeydown=async te=>{te.key==="Enter"&&await se(L.value),te.key==="Escape"&&ee()},L.onblur=async()=>{await se(L.value)}}})}let he=_.createDiv({cls:"add-category gc-row"}),Se=he.createEl("input",{type:"text",placeholder:"New category"});he.createDiv({cls:"gc-spacer"});let Ie=he.createEl("button",{text:"Add Category"});Ie.onclick=async()=>{let A=Se.value.trim();A&&!f.categories.includes(A)&&(f.categories.push(A),await this.plugin.saveSettings(),this.display())}});let u=n.createDiv({cls:"add-dimension"});u.createEl("h3",{text:"Add new dimension"});let y=u.createDiv({cls:"gc-row"}),P=y.createEl("input",{type:"text",placeholder:"Dimension name"});y.createDiv({cls:"gc-spacer"});let v=y.createEl("button",{text:"Add Dimension"});v.onclick=async()=>{let f=P.value.trim();if(f&&!this.plugin.settings.dimensions.some(b=>b.name===f)){{let b=this.plugin.settings.dimensions.reduce((_,$)=>{var z;return Math.max(_,(z=$.order)!=null?z:0)},0);this.plugin.settings.dimensions.push({name:f,order:b+1,categories:[]})}await this.plugin.saveSettings(),this.display()}},n.createEl("h2",{text:"AI Module"});let d=n.createDiv({cls:"gc-column"}),h=d.createDiv({cls:"setting-item"});h.createEl("label",{text:"Enable AI module"});let w=h.createEl("input",{type:"checkbox"});w.checked=Boolean((en=this.plugin.settings.ai)==null?void 0:en.enabled),w.onchange=async()=>{var f,b;this.plugin.settings.ai||(this.plugin.settings.ai={enabled:!1,provider:"openai",apiKey:"",model:"gpt-4o-mini",baseUrl:"https://api.openai.com",mixedOfferText:"I can also set this up for you. Shall I proceed?"}),this.plugin.settings.ai.enabled=w.checked,await this.plugin.saveSettings(),await((b=(f=this.plugin).toggleAiView)==null?void 0:b.call(f,w.checked))};let j=d.createDiv({cls:"setting-item"});j.createEl("label",{text:"Provider"});let x=j.createEl("select");["openai","anthropic","ollama"].forEach(f=>{let b=x.createEl("option",{text:f});b.value=f}),x.value=((tn=this.plugin.settings.ai)==null?void 0:tn.provider)||"openai",x.onchange=async()=>{if(!this.plugin.settings.ai)return;let f={openai:{baseUrl:"https://api.openai.com",model:"gpt-4o-mini"},anthropic:{baseUrl:"https://api.anthropic.com",model:"claude-3-5-sonnet-latest"},ollama:{baseUrl:"http://localhost:11434",model:"llama3.1"}};this.plugin.settings.ai.provider=x.value;let b=this.plugin.settings.ai.baseUrl||"",_=this.plugin.settings.ai.model||"",$=Object.values(f).map(G=>G.baseUrl),z=Object.values(f).map(G=>G.model);(!b||$.includes(b))&&(this.plugin.settings.ai.baseUrl=f[x.value].baseUrl),(!_||z.includes(_))&&(this.plugin.settings.ai.model=f[x.value].model),await this.plugin.saveSettings(),this.display()};let N=d.createDiv({cls:"setting-item"});N.createEl("label",{text:"API key (not required for local providers)"});let O=N.createEl("input",{type:"password"});O.placeholder="sk-...",O.value=((nn=this.plugin.settings.ai)==null?void 0:nn.apiKey)||"",O.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.apiKey=O.value.trim(),await this.plugin.saveSettings())};let K=d.createDiv({cls:"setting-item"});K.createEl("label",{text:"Model"});let Y=K.createEl("input",{type:"text"});Y.placeholder=((sn=this.plugin.settings.ai)==null?void 0:sn.provider)==="anthropic"?"claude-3-5-sonnet-latest":((on=this.plugin.settings.ai)==null?void 0:on.provider)==="ollama"?"llama3.1":"gpt-4o-mini",Y.value=((rn=this.plugin.settings.ai)==null?void 0:rn.model)||Y.placeholder,Y.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.model=Y.value.trim()||"gpt-4o-mini",await this.plugin.saveSettings())};let T=d.createDiv({cls:"setting-item"});T.createEl("label",{text:"Base URL"});let k=T.createEl("input",{type:"text"});k.placeholder=((an=this.plugin.settings.ai)==null?void 0:an.provider)==="anthropic"?"https://api.anthropic.com":((cn=this.plugin.settings.ai)==null?void 0:cn.provider)==="ollama"?"http://localhost:11434":"https://api.openai.com",k.value=((ln=this.plugin.settings.ai)==null?void 0:ln.baseUrl)||k.placeholder,k.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.baseUrl=k.value.trim()||"https://api.openai.com",await this.plugin.saveSettings())};let q=d.createDiv({cls:"setting-item"});q.createEl("label",{text:"Strict execution mode"});let ge=q.createEl("input",{type:"checkbox"});ge.checked=Boolean((pn=this.plugin.settings.ai)==null?void 0:pn.strictExecution),ge.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.strictExecution=ge.checked,await this.plugin.saveSettings())};let Te=d.createDiv({cls:"setting-item"});Te.createEl("label",{text:"Conversation memory (messages)"});let ne=Te.createEl("input",{type:"number"});ne.min="0",ne.max="50",ne.value=String((mn=(dn=this.plugin.settings.ai)==null?void 0:dn.memoryLimit)!=null?mn:10),ne.onchange=async()=>{if(!this.plugin.settings.ai)return;let f=Number(ne.value);this.plugin.settings.ai.memoryLimit=Number.isFinite(f)?Math.max(0,Math.min(50,f)):10,await this.plugin.saveSettings()};let Ue=d.createDiv({cls:"setting-item"});Ue.createEl("label",{text:"Mixed intent offer text"});let xe=Ue.createEl("textarea"),Rt="I can also set this up for you. Shall I proceed?";xe.placeholder=Rt,xe.value=((un=this.plugin.settings.ai)==null?void 0:un.mixedOfferText)||"",xe.onchange=async()=>{this.plugin.settings.ai&&(this.plugin.settings.ai.mixedOfferText=xe.value.trim(),await this.plugin.saveSettings())};let He=d.createDiv({cls:"setting-item"});He.createEl("label",{text:"MCP servers (JSON array)"});let ze=He.createEl("textarea");ze.placeholder='[{"name":"calendar","url":"http://localhost:3000","apiKey":""}]',ze.value=JSON.stringify(((gn=this.plugin.settings.ai)==null?void 0:gn.mcpServers)||[]),ze.onchange=async()=>{if(this.plugin.settings.ai)try{let f=JSON.parse(ze.value||"[]");this.plugin.settings.ai.mcpServers=Array.isArray(f)?f:[],await this.plugin.saveSettings()}catch(f){new E.Notice("Invalid MCP servers JSON")}},n.createEl("h2",{text:"Archive"});let Et=this.plugin.settings.archivedRecords||{},Xt=Et&&!Array.isArray(Et)?Et:{},Zt={};for(let f of this.plugin.settings.dimensions)Zt[f.name]=(hn=f.order)!=null?hn:Number.MAX_SAFE_INTEGER;let Es=Object.keys(Xt).map(f=>{var b;return{name:f,order:(b=Zt[f])!=null?b:Number.MAX_SAFE_INTEGER}}).sort((f,b)=>f.order-b.order||f.name.localeCompare(b.name)),Qt=!1;Es.forEach(({name:f,order:b})=>{let _=Xt[f]||{},$=Object.keys(_).filter(B=>Object.keys(_[B]||{}).length>0).sort();if($.length===0)return;Qt=!0;let z=n.createDiv({cls:"dimension-setting"}),G=z.createDiv({cls:"dimension-header gc-row"}),ie=this.plugin.settings.dimensions.find(B=>B.name===f);ie&&G.createSpan({text:`${ie.order}. `}),G.createEl("b",{text:f}),G.createDiv({cls:"gc-spacer"});let ae=z.createDiv({cls:"categories-list gc-list"});$.forEach(B=>{let he=ae.createDiv({cls:"gc-list-item gc-row"}),Se=Object.keys((_==null?void 0:_[B])||{}).sort();he.createEl("b",{text:B});let Ie=he.createDiv({cls:"gc-id-wrap"});Se.length>0&&(Ie.createSpan({text:" "}),Se.forEach((A,S)=>{let C=Ie.createSpan({cls:"gc-id-chip"});C.style.display="inline-flex",C.style.alignItems="center",C.style.gap="4px";let F=C.createSpan({cls:"gc-id-tag",text:A}),I=Math.abs(jn(A))%360;F.style.backgroundColor=`hsl(${I}, 70%, 90%)`,F.style.color=`hsl(${I}, 70%, 25%)`;let R=C.createSpan({cls:"gc-id-actions"});R.style.display="none";let D=R.createEl("button",{cls:["gc-icon-button","clickable-icon"]});D.setAttr("aria-label",`Delete ${A}`),D.setAttr("title",`Delete ${A}`);try{(0,E.setIcon)(D,"trash")}catch(X){D.setText("Del")}D.onclick=async X=>{X.stopPropagation();let[,ce]=await this.plugin.deleteArchivedProject(f,B,A);new E.Notice(ce),this.display()},C.onmouseenter=()=>{R.style.display="inline-flex"},C.onmouseleave=()=>{R.style.display="none"},S<Se.length-1&&Ie.createSpan({text:" "})})),he.createDiv({cls:"gc-spacer"})})}),Qt||n.createDiv({cls:"setting-item"}).createSpan({text:"No archived projects yet."})}};var Ot=require("obsidian");var Tn=require("obsidian"),rt=class extends Tn.Modal{constructor(n,s,o){super(n);this.prompt=s,this.callback=o}onOpen(){let{contentEl:n}=this;n.createEl("h2",{text:this.prompt});let s=n.createEl("input",{type:"text"});s.focus();let o=n.createEl("button",{text:"Submit"});o.onclick=()=>{let r=s.value.trim();this.close(),this.callback(r||null)}}onClose(){let{contentEl:n}=this;n.empty()}};var xn=require("obsidian"),Oe=class extends xn.Modal{constructor(n,s,o,r){super(n);this.prompt=s,this.choices=o,this.callback=r}onOpen(){let{contentEl:n}=this;n.createEl("h2",{text:this.prompt}),this.choices.forEach(s=>{let o=n.createEl("button",{text:s});o.onclick=()=>{this.close(),this.callback(s)}})}onClose(){let{contentEl:n}=this;n.empty()}};async function _e(e,t){return new Promise(n=>{new rt(e,t,n).open()})}async function Re(e,t,n){return new Promise(s=>{new Oe(e,t,n,s).open()})}async function En(e,t){var u,y;let n=await _e(e,"Enter project name:");if(!n)return[null,"Project creation cancelled. No project name provided."];let s=await _e(e,"Enter project tag:");if(!s)return[null,"Project creation cancelled. No project tag provided."];let o=await _e(e,"Enter Project ID (used for task prefixes):");if(!o)return[null,"Project creation cancelled. No Project ID provided."];let r=await _e(e,"Enter parent name (optional):"),i=r&&r.trim().length>0?r.trim():null,a=[...t.dimensions].sort((P,v)=>{var d,h;return((d=P.order)!=null?d:0)-((h=v.order)!=null?h:0)}).map(P=>P.name),p=await Re(e,"Select dimension:",a);if(!p)return[null,"Project creation cancelled. No dimension selected."];let l=t.dimensions.find(P=>P.name===p);if(!l||l.categories.length===0)return[null,"Selected dimension has no categories. Please add categories in settings first."];let c=l.categories,g=await Re(e,"Select category:",c);if(!g)return[null,"Project creation cancelled. No category selected."];let m={name:n,tag:s,id:o,parent:i,dimension:p,category:g};try{let P=t.projectRecords;if(P&&!Array.isArray(P)&&((y=(u=P[p])==null?void 0:u[g])==null?void 0:y[o]))return[null,`Project with ID "${o}" already exists in ${p}:${g}. Choose a different ID.`]}catch(P){}try{let{validateProjectName:P,validateTag:v,ensureValidOrThrow:d}=await Promise.resolve().then(()=>(Rn(),Cn));d(()=>P(m.name),"Invalid project name"),d(()=>v(m.tag),"Invalid tag"),d(()=>v(m.id),"Invalid Project ID")}catch(P){let v=P.message||"Invalid input";return console.error("Validation error:",P),[null,v]}return[m,"Project details collected."]}async function it(e,t){var c;if(!t.projectRecords)return[null,"You don't have any projects yet."];let n=t.projectRecords,s=[...t.dimensions].sort((g,m)=>{var u,y;return((u=g.order)!=null?u:0)-((y=m.order)!=null?y:0)}).map(g=>g.name),o=await Re(e,"Select dimension of your project:",s);if(!o)return[null,"Project action cancelled. No dimension selected."];let r=t.dimensions.find(g=>g.name===o);if(!r||r.categories.length===0)return[null,"Selected dimension has no categories. No project found."];let i=r.categories,a=await Re(e,"Select category:",i);if(!a)return[null,"Project action cancelled. No category selected."];let p=(c=n[o])==null?void 0:c[a];if(!p||Object.keys(p).length===0)return[null,"No projects found in this category."];let l=await Re(e,"Select Project:",Object.keys(p));return l?[{dimension:o,category:a,projectId:l},"Project details collected."]:[null,"Project action cancelled. No project selected."]}$t();async function kn(e){let[t,n]=await En(e.app,e.settings);if(t===null){new Ot.Notice(n);return}let[,s]=await dt(e,t);new Ot.Notice(s),console.log(s)}var _t=require("obsidian");async function Fn(e){let[t,n]=await it(e.app,e.settings);if(t===null){new _t.Notice(n);return}let{dimension:s,category:o,projectId:r}=t,[,i]=await tt(e,s,o,r);new _t.Notice(i),console.log(i)}var Lt=require("obsidian");async function Dn(e){let[t,n]=await it(e.app,e.settings);if(t===null){new Lt.Notice(n);return}let{dimension:s,category:o,projectId:r}=t,[,i]=await nt(e,s,o,r);new Lt.Notice(i),console.log(i)}var oe=require("obsidian");async function $n(e){let t=[];for(let n of e)try{let s=`${n.url.replace(/\/$/,"")}/tools`,o=await fetch(s,{method:"GET",headers:n.apiKey?{"x-api-key":n.apiKey}:void 0});if(!o.ok)continue;let r=await o.json(),i=Array.isArray(r==null?void 0:r.tools)?r.tools:[];t.push({server:n,tools:i})}catch(s){}return t}function On(e,t){return t.map(n=>({name:`${e.name}:${n.name}`,description:n.description||"MCP tool",schema:n.inputSchema||{type:"object",properties:{},additionalProperties:!0},handler:async s=>Zs(e,n.name,s)}))}async function Zs(e,t,n){let s=`${e.url.replace(/\/$/,"")}/call`,o=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",...e.apiKey?{"x-api-key":e.apiKey}:{}},body:JSON.stringify({name:t,args:n})});if(!o.ok){let r=await o.text().catch(()=>"");throw new Error(`MCP call failed: ${o.status} ${r||o.statusText}`)}return await o.json().catch(()=>({}))}var mt={type:"object",description:"Reference to a project by tag, id, or full name.",properties:{tag:{type:"string"},id:{type:"string"},fullName:{type:"string"}},additionalProperties:!1},Qs={type:"object",description:"Fields to set on the entity (camelCase, e.g. title, description).",properties:{title:{type:"string"},description:{type:"string"}},additionalProperties:!0};function ut(e){let t=e.getApi();return t?[{name:"resolveProject",description:"Resolve a project by tag, id, or full name.",schema:{type:"object",properties:{projectRef:mt},required:["projectRef"],additionalProperties:!1},handler:async n=>t.resolveProject(n.projectRef)},{name:"listEntityTypes",description:"List available entity types.",schema:{type:"object",properties:{},additionalProperties:!1},handler:async()=>t.listEntityTypes()},{name:"createProject",description:"Create a project with the required metadata.",schema:{type:"object",properties:{name:{type:"string"},tag:{type:"string"},id:{type:"string"},dimension:{type:"string"},category:{type:"string"},parent:{type:"string"},projectTypeId:{type:"string"}},required:["name","tag","id","dimension","category"],additionalProperties:!1},handler:async n=>t.createProject(n)},{name:"createEntity",description:"Create an entity inside a project using a template.",schema:{type:"object",properties:{projectRef:mt,entityTypeId:{type:"string"},fields:Qs},required:["projectRef","entityTypeId"],additionalProperties:!1},handler:async n=>t.createEntity(n)},{name:"patchMarker",description:"Patch content into a file at an AI marker.",schema:{type:"object",properties:{path:{type:"string"},marker:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","marker","content"],additionalProperties:!1},handler:async n=>t.patchMarker(n)},{name:"patchSection",description:"Patch content into a file by heading.",schema:{type:"object",properties:{path:{type:"string"},heading:{type:"string"},content:{type:"string"},mode:{type:"string",enum:["lenient","strict"]}},required:["path","heading","content"],additionalProperties:!1},handler:async n=>t.patchSection(n)},{name:"getChildren",description:"Get child projects for a given project.",schema:{type:"object",properties:{projectRef:mt,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async n=>t.getChildren(n.projectRef,n.archived)},{name:"getParents",description:"Get parent projects for a given project.",schema:{type:"object",properties:{projectRef:mt,archived:{type:"boolean"}},required:["projectRef"],additionalProperties:!1},handler:async n=>t.getParents(n.projectRef,n.archived)}]:[]}async function gt(e){var o;let t=((o=e.settings.ai)==null?void 0:o.mcpServers)||[];if(t.length===0)return[];let n=await $n(t),s=[];for(let r of n)s.push(...On(r.server,r.tools));return s}async function*_n(e,t,n){var c,g;let s=`${e.baseUrl.replace(/\/$/,"")}/v1/chat/completions`,o={model:e.model,messages:t.map(m=>{let u={role:m.role,content:m.content};return m.role==="tool"&&m.toolCallId&&(u.tool_call_id=m.toolCallId),m.role==="assistant"&&m.toolCalls&&m.toolCalls.length>0&&(u.tool_calls=m.toolCalls.map(y=>{var P;return{id:y.id,type:"function",function:{name:y.name,arguments:JSON.stringify((P=y.arguments)!=null?P:{})}}})),u}),tools:n.map(m=>({type:"function",function:{name:m.name,description:m.description,parameters:m.schema}})),tool_choice:"auto",stream:!0},r={"Content-Type":"application/json"};e.apiKey&&(r.Authorization=`Bearer ${e.apiKey}`);let i=await fetch(s,{method:"POST",headers:r,body:JSON.stringify(o)});if(!i.ok||!i.body){let m=await eo(i);throw new Error(`OpenAI request failed: ${i.status} ${m||i.statusText}`)}let a=i.body.getReader(),p=new TextDecoder,l="";for(;;){let{value:m,done:u}=await a.read();if(u)break;l+=p.decode(m,{stream:!0});let y=l.split(`
`);l=y.pop()||"";for(let P of y){let v=P.trim();if(!v.startsWith("data:"))continue;let d=v.replace(/^data:\s*/,"");if(d==="[DONE]"){yield{type:"done"};return}let h;try{h=JSON.parse(d)}catch(j){continue}let w=(g=(c=h==null?void 0:h.choices)==null?void 0:c[0])==null?void 0:g.delta;w&&(w.content&&(yield{type:"content",delta:w.content}),w.tool_calls&&(yield{type:"tool_call_delta",toolCalls:w.tool_calls.map(x=>{var N,O;return{index:x.index,id:x.id,name:(N=x.function)==null?void 0:N.name,arguments:(O=x.function)==null?void 0:O.arguments}})}))}}yield{type:"done"}}async function eo(e){try{return await e.text()}catch(t){return""}}async function*Ln(e,t,n){let s=`${e.baseUrl.replace(/\/$/,"")}/v1/messages`,{system:o,anthropicMessages:r}=to(t),i={model:e.model,max_tokens:1024,system:o,messages:r,tools:n.map(m=>({name:m.name,description:m.description,input_schema:m.schema})),stream:!0},a=await fetch(s,{method:"POST",headers:{"x-api-key":e.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify(i)});if(!a.ok||!a.body){let m=await no(a);throw new Error(`Anthropic request failed: ${a.status} ${m||a.statusText}`)}let p=a.body.getReader(),l=new TextDecoder,c="",g=new Set;for(;;){let{value:m,done:u}=await p.read();if(u)break;c+=l.decode(m,{stream:!0});let y=c.split(`
`);c=y.pop()||"";for(let P of y){let v=P.trim();if(!v.startsWith("data:"))continue;let d=v.replace(/^data:\s*/,"");if(!d||d==="[DONE]"){yield{type:"done"};return}let h;try{h=JSON.parse(d)}catch(j){continue}let w=h==null?void 0:h.type;if(w==="content_block_delta"){let j=h.delta;if((j==null?void 0:j.type)==="text_delta"&&(yield{type:"content",delta:j.text}),(j==null?void 0:j.type)==="input_json_delta"){if(g.has(h.index))continue;yield{type:"tool_call_delta",toolCalls:[{index:h.index,arguments:j.partial_json}]}}}if(w==="content_block_start"){let j=h.content_block;if((j==null?void 0:j.type)==="tool_use"){let x=j.input&&Object.keys(j.input).length>0;x&&g.add(h.index),yield{type:"tool_call_delta",toolCalls:[{index:h.index,id:j.id,name:j.name,arguments:x?JSON.stringify(j.input):""}]}}}if(w==="message_stop"){yield{type:"done"};return}}}yield{type:"done"}}function to(e){let t="",n=[];for(let s of e){if(s.role==="system"){t=[t,s.content].filter(Boolean).join(`
`);continue}if(s.role==="user"){n.push({role:"user",content:[{type:"text",text:s.content}]});continue}if(s.role==="assistant"){let o=[];if(s.content&&o.push({type:"text",text:s.content}),s.toolCalls&&s.toolCalls.length>0)for(let r of s.toolCalls)o.push({type:"tool_use",id:r.id||`tool-${r.name}`,name:r.name,input:r.arguments||{}});o.length>0&&n.push({role:"assistant",content:o});continue}s.role==="tool"&&n.push({role:"user",content:[{type:"tool_result",tool_use_id:s.toolCallId||s.name||"tool",content:s.content}]})}return{system:t,anthropicMessages:n}}async function no(e){try{return await e.text()}catch(t){return""}}async function*me(e,t,n){if(e.provider==="anthropic"){if(!e.apiKey)throw new Error("Anthropic API key is missing");yield*Ln({apiKey:e.apiKey,model:e.model||"claude-3-5-sonnet-latest",baseUrl:e.baseUrl||"https://api.anthropic.com"},t,n);return}let s=e.provider==="ollama"?e.baseUrl||"http://localhost:11434":e.baseUrl||"https://api.openai.com";if(!e.apiKey&&e.provider!=="ollama")throw new Error("OpenAI API key is missing");yield*_n({apiKey:e.apiKey||"",model:e.model||(e.provider==="ollama"?"llama3.1":"gpt-4o-mini"),baseUrl:s},t,n)}function ht(e,t){for(let n of e){let s=t.get(n.index)||{name:"",arguments:{}};if(n.id&&(s.id=n.id),n.name&&(s.name=n.name),typeof n.arguments=="string"){let o=s._rawArgs||"";s._rawArgs=o+n.arguments}t.set(n.index,s)}}function ft(e){let t=[];for(let[,n]of e){let s=n._rawArgs;if(s)try{n.arguments=JSON.parse(s)}catch(o){n.arguments={}}delete n._rawArgs,t.push(n)}return t}function Bt(e){let t=new Set(["resolveProject","listProjects","listEntityTypes","describeEntityType","listProjectTypes","describeProjectType","getChildren","getParents"]);return e.filter(n=>t.has(n.name)||n.name.includes(":"))}function Bn(e){var n;let t=[];for(let s of e)!s.ok&&((n=s.error)!=null&&n.startsWith("Missing required fields:"))&&s.error.split(":").slice(1).join(":").split(",").forEach(r=>{let i=r.trim();i&&t.push(i)});return t}function Gt(e){let t=e.trim().toLowerCase();return["yes","y","confirm","ok","okay","proceed"].includes(t)}function Jt(e){let t=e.trim().toLowerCase();return["no","n","cancel","stop"].includes(t)}function yt(e,t,n="$",s=[]){if(!e)return s;let o=e.type?Array.isArray(e.type)?e.type:[e.type]:[];if(o.length>0&&!o.some(i=>so(i,t)))return s.push({path:n,message:`Expected ${o.join("|")}`}),s;if(e.enum&&!e.enum.includes(t)&&s.push({path:n,message:"Value not in enum"}),e.type==="object"&&t&&typeof t=="object"&&!Array.isArray(t)){let r=t;if((e.required||[]).forEach(a=>{a in r||s.push({path:`${n}.${a}`,message:"Missing required field"})}),e.properties)for(let[a,p]of Object.entries(e.properties))a in r&&yt(p,r[a],`${n}.${a}`,s)}return e.type==="array"&&Array.isArray(t)&&e.items&&t.forEach((r,i)=>{yt(e.items,r,`${n}[${i}]`,s)}),s}function so(e,t){return e==="array"?Array.isArray(t):e==="integer"?Number.isInteger(t):e==="number"?typeof t=="number":e==="boolean"?typeof t=="boolean":e==="string"?typeof t=="string":e==="object"?t!=null&&typeof t=="object"&&!Array.isArray(t):!0}async function vt(e,t){let n=[],s=new Map(t.map(o=>[o.name,o]));for(let o of e){let r=s.get(o.name);if(!r){n.push({toolName:o.name,ok:!1,error:"Tool not found"});continue}let i=yt(r.schema,o.arguments);if(i.length>0){n.push({toolName:o.name,ok:!1,error:`Schema validation failed: ${i.map(a=>`${a.path}: ${a.message}`).join(", ")}`});continue}try{let a=await r.handler(o.arguments);n.push({toolName:o.name,ok:!0,result:a})}catch(a){n.push({toolName:o.name,ok:!1,error:(a==null?void 0:a.message)||"Tool execution failed"})}}return n}function Vt(e){if(e==null)return"(no result)";if(typeof e=="string")return e;try{return JSON.stringify(e)}catch(t){return String(e)}}function Gn(e){return new Promise(t=>setTimeout(t,e))}async function Jn(e){var n,s,o,r;let t=(n=e.maxSteps)!=null?n:6;for(let i=0;i<t;i+=1){let a=e.ui.appendMessage("assistant",""),p=new Map,l=new Map,c=Boolean((s=e.plugin.settings.ai)==null?void 0:s.strictExecution),g=2,m=0;for(;;)try{for await(let d of me(e.plugin.settings.ai,e.messages,e.tools)){if(d.type==="content"&&d.delta){let h=(a==null?void 0:a.textContent)||"";e.ui.updateMessage(a,h+d.delta)}if(d.type==="tool_call_delta"&&d.toolCalls){ht(d.toolCalls,l);for(let h of d.toolCalls)if(h.name&&!p.has(h.name)){let w=e.ui.appendMessage("tool",`Using tool: ${h.name}`);w&&p.set(h.name,w)}}}break}catch(d){if(m+=1,m>g)throw d;e.ui.appendMessage("tool",`Retrying LLM request (${m}/${g})...`),await Gn(300*m)}let u=ft(l),y=(a==null?void 0:a.textContent)||"";if(e.messages.push({role:"assistant",content:y,toolCalls:u}),e.state.appendMessage({role:"assistant",content:y}),u.length===0)return;for(let d of u)e.ui.appendMessage("tool",`Tool call: ${d.name} ${Vt(d.arguments)}`);let P=await vt(u,e.tools),v=Bn(P);for(let d=0;d<P.length;d+=1){let h=P[d],w=h.ok?{ok:!0,result:h.result}:{ok:!1,error:h.error},j=h.ok?`Tool result (${h.toolName}): ${Vt(h.result)}`:`Tool error (${h.toolName}): ${h.error}`;e.ui.appendMessage("tool",j),e.state.appendMessage({role:"tool",name:h.toolName,toolCallId:(o=u[d])==null?void 0:o.id,content:JSON.stringify(w)}),e.state.recordToolLog(h.toolName,h.ok,h.error),e.messages.push({role:"tool",name:h.toolName,toolCallId:(r=u[d])==null?void 0:r.id,content:JSON.stringify(w)})}if(c&&P.some(d=>!d.ok)){e.ui.appendMessage("assistant","Strict mode: tool execution failed. Please adjust input and try again.");return}if(v.length>0){let d=Array.from(new Set(v));e.ui.appendMessage("assistant",`Missing required fields: ${d.join(", ")}. Please provide them and try again.`);return}}e.ui.appendMessage("assistant","Stopped after reaching max tool steps.")}var oo=["You are a planner for ProjectFlow AI.","Return ONLY valid JSON with keys: needsFollowup (boolean), question (string), plan (string), context (string), fields (object).","fields must include required values for createEntity/createProject when applicable (e.g., TITLE, DESCRIPTION).","If you need more info, set needsFollowup=true and ask a concise question.","If you have enough info, set needsFollowup=false and provide a short plan, context summary, and fields.","Do NOT call tools in this stage.","Format text in `question` and `plan` keys as markdown"].join(`
`);async function Ut(e){var o;let t=[{role:"system",content:oo},...e.messages.filter(r=>r.role!=="tool")],n=await ro({plugin:e.plugin,messages:t,tools:e.tools,allowToolCalls:(o=e.allowToolCalls)!=null?o:!1}),s=io(n);return s||{needsFollowup:!1,plan:"",context:"",fields:{}}}async function ro(e){var o;let t="",s=e.allowToolCalls?e.tools:[];for(let r=0;r<6;r+=1){let i=new Map;t="";for await(let l of me(e.plugin.settings.ai,e.messages,s))l.type==="content"&&l.delta&&(t+=l.delta),l.type==="tool_call_delta"&&l.toolCalls&&ht(l.toolCalls,i);let a=ft(i);if(e.messages.push({role:"assistant",content:t,toolCalls:a}),a.length===0||!e.allowToolCalls)return t.trim();let p=await vt(a,e.tools);for(let l=0;l<p.length;l+=1){let c=p[l],g=c.ok?{ok:!0,result:c.result}:{ok:!1,error:c.error};e.messages.push({role:"tool",name:c.toolName,toolCallId:(o=a[l])==null?void 0:o.id,content:JSON.stringify(g)})}}return t.trim()}function io(e){let t=e.indexOf("{"),n=e.lastIndexOf("}");if(t===-1||n===-1||n<=t)return null;let s=e.slice(t,n+1);try{let o=JSON.parse(s),r=o.fields&&typeof o.fields=="object"?o.fields:{};return{needsFollowup:Boolean(o.needsFollowup),question:typeof o.question=="string"?o.question:"",plan:typeof o.plan=="string"?o.plan:"",context:typeof o.context=="string"?o.context:"",fields:r}}catch(o){return null}}function Vn(e){let t=e.app.workspace.getActiveFile();if(!t)return null;let n=e.settings.projectIndex;if(!n)return null;let s=t.path,o=Object.values(n.byFullName||{}),r=null;for(let i of o)i.path&&s.startsWith(i.path)&&(!r||i.path.length>r.path.length)&&(r=i);return r}function Un(e,t,n=5){let s=e.settings.projectIndex;if(!s)return[];let o=t.trim().toLowerCase();return o?Object.values(s.byFullName||{}).map(a=>{var g,m;let p=((g=a.projectTag)==null?void 0:g.toLowerCase())||"",l=((m=a.projectName)==null?void 0:m.toLowerCase())||"",c=0;return p===o&&(c+=100),l===o&&(c+=90),p.startsWith(o)&&(c+=60),l.startsWith(o)&&(c+=50),p.includes(o)&&(c+=30),l.includes(o)&&(c+=20),{entry:a,score:c}}).filter(a=>a.score>0).sort((a,p)=>p.score-a.score).slice(0,n).map(a=>a.entry):[]}async function Pt(e){let t=ao(e),n=e.app.workspace.getActiveFile(),s="";if(n)try{s=(await e.app.vault.cachedRead(n)).slice(0,1e3)}catch(a){s=""}let o=e.settings.projectIndex,r=Vn(e),i=co(e);return["You are ProjectFlow AI. You must use tools to perform any actions.","Never edit markdown directly; use tools only.","Respond with tool calls when an action is required.","If required fields are missing, ask the user for them instead of calling tools.","Use camelCase fields in createEntity (e.g., fields.title, fields.description).",'Example tool call: createEntity { projectRef:{tag:"my-tag"}, entityTypeId:"task", fields:{ title:"...", description:"..." } }',"Context:",`Selected text: ${t||"(none)"}`,`Active file: ${(n==null?void 0:n.path)||"(none)"}`,`Active file content (truncated): ${s||"(none)"}`,`Active project: ${r?`${r.projectTag} (${r.fullName})`:"(none)"}`,`Entity required fields: ${i}`,`Project index snapshot: ${o?JSON.stringify(o):"(none)"}`].join(`
`)}function Hn(e){return`I'm going to create a project with tag ${e}
${e}`}function ao(e){var n;let t=(n=e.app.workspace.activeEditor)==null?void 0:n.editor;return t?t.getSelection():""}function co(e){let t=e.settings.entityTypes||{},n={};for(let[s,o]of Object.entries(t))o!=null&&o.requiredFields&&o.requiredFields.length>0&&(n[s]=o.requiredFields);try{return JSON.stringify(n)}catch(s){return"(unavailable)"}}var lo=["You are an intent classifier for an Obsidian productivity assistant.","Classify the user input into exactly one of: chat, action, mixed, unclear.","Definitions:","chat: user is asking a question or discussing concepts. No execution requested.","action: user explicitly requests operations such as creating, updating, deleting projects, tasks, notes, or structures.","mixed: user asks a question AND requests an action in the same message.","unclear: not enough information to decide.","Respond ONLY with valid JSON:",'{"intent":"...","reason":"...","confidence":0.0}',"Do not include markdown."].join(`
`),zn={intent:"chat",reason:"Invalid classifier output.",confidence:0};async function Wn(e,t){let n=[{role:"system",content:lo},{role:"user",content:e}],s="";try{for await(let r of me(t,n,[]))r.type==="content"&&r.delta&&(s+=r.delta);let o=po(s);return o!=null?o:zn}catch(o){return zn}}function po(e){let t=e.indexOf("{"),n=e.lastIndexOf("}");if(t===-1||n===-1||n<=t)return null;let s=e.slice(t,n+1);try{let o=JSON.parse(s),r=mo(o.intent);if(!r)return null;let i=typeof o.confidence=="number"&&o.confidence>=0&&o.confidence<=1?o.confidence:0;return{intent:r,reason:typeof o.reason=="string"?o.reason:"",confidence:i}}catch(o){return null}}function mo(e){if(typeof e!="string")return null;let t=e.trim().toLowerCase();return t==="chat"||t==="action"||t==="mixed"||t==="unclear"?t:null}var uo=["You are a helpful Obsidian assistant.","Answer conversationally.","Be concise.","Do not propose plans unless explicitly asked.","Do not call tools.","If the user implies possible actions, suggest them softly."].join(`
`),go="I can also set this up for you. Shall I proceed?",be=class{constructor(t,n,s){this.plugin=t;this.ui=n;this.state=s;this.busy=!1;this.pendingPlan=null;this.pendingMixedInput=null;this.pendingPlan=this.state.getPendingPlan()}async handleSend(t){if(this.busy)return;let n=t.trim();if(!n)return;this.ui.appendMessage("user",n);let s=this.plugin.settings.ai;if(!(s!=null&&s.enabled)){this.ui.appendMessage("assistant","AI module is disabled in settings.");return}if(!s.apiKey&&s.provider!=="ollama"){await this.handleTagLookup(n);return}await this.handleLLM(n)}onClose(){this.state.flushConversation()}clearConversation(){this.pendingPlan=null,this.state.clearConversation(),this.state.setPendingPlan(null),this.ui.clearMessages(),this.ui.appendMessage("assistant","Conversation cleared.")}async handleFollowup(t){let n=this.pendingPlan;if(!n)return;let s=t.trim();if(!s)return;this.state.appendMessage({role:"user",content:s});let o=ut(this.plugin),r=await gt(this.plugin),i=[...o,...r];if(n.status==="awaiting_confirmation"){if(Gt(s)){let w=await Pt(this.plugin),j=this.state.getConversationWindow().filter(O=>O.role!=="tool"),x=[`Original request: ${n.originalInput}`,n.plan?`Plan: ${n.plan}`:"",n.context?`Context: ${n.context}`:"",n.fields?`Fields: ${JSON.stringify(n.fields)}`:"",n.clarifications&&n.clarifications.length>0?`Clarifications: ${n.clarifications.join(" | ")}`:"","User confirmed to proceed."].filter(Boolean).join(`
`),N=[{role:"system",content:w},...j,{role:"user",content:x}];this.setPendingPlan(null),await Jn({plugin:this.plugin,ui:this.ui,state:this.state,messages:N,tools:i});return}if(Jt(s)){this.setPendingPlan(null),this.ui.appendMessage("assistant","Cancelled. Tell me if you want to try a different action."),this.state.appendMessage({role:"assistant",content:"Cancelled. Tell me if you want to try a different action."});return}this.ui.appendConfirmationActions(),this.ui.appendMessage("assistant","Please confirm to proceed with these actions."),this.state.appendMessage({role:"assistant",content:"Please confirm to proceed with these actions."});return}let a=Bt(i),p=await Pt(this.plugin),l=this.state.getConversationWindow().filter(w=>w.role!=="tool"),c=n.clarifications||[];c.push(s),n.clarifications=c;let g=[`Original request: ${n.originalInput}`,n.plan?`Plan so far: ${n.plan}`:"",n.context?`Context so far: ${n.context}`:"",`User clarification: ${s}`].filter(Boolean).join(`
`),m=[{role:"system",content:p},...l,{role:"user",content:g}],u=await Ut({plugin:this.plugin,messages:m,tools:a,allowToolCalls:!1});if(u.needsFollowup&&u.question){n.plan=u.plan,n.context=u.context,n.question=u.question,n.fields=u.fields,n.status="clarifying",this.setPendingPlan(n),this.ui.appendMessage("assistant",u.question),this.state.appendMessage({role:"assistant",content:u.question});return}n.plan=u.plan,n.context=u.context,n.fields=u.fields,n.status="awaiting_confirmation",this.setPendingPlan(n);let y=u.plan?`Planned steps: ${u.plan}`:"",P=u.context?`Planner context: ${u.context}`:"",v=u.fields&&Object.keys(u.fields).length>0?`Fields: 
 \`\`\`json 
${JSON.stringify(u.fields)}
 \`\`\``:"",d=[y,P,v].filter(Boolean).join(`
`);d&&(this.ui.appendMessage("assistant",d),this.state.appendMessage({role:"assistant",content:d})),this.ui.appendConfirmationActions();let h="Please confirm to proceed with these actions.";this.ui.appendMessage("assistant",h),this.state.appendMessage({role:"assistant",content:h})}async handleTagLookup(t){let n=this.plugin.getApi();if(!n){this.ui.appendMessage("assistant","Core API is not available.");return}try{let s=n.resolveProject({tag:t});if(!s){let o=Un(this.plugin,t);if(o.length===0)this.ui.appendMessage("assistant","Project not found.");else if(o.length===1)this.ui.appendMessage("assistant",`Resolved project: ${o[0].fullName} (${o[0].projectTag})`);else{let r=o.map(i=>`- ${i.projectTag} (${i.fullName})`).join(`
`);this.ui.appendMessage("assistant",`Multiple matches found:
${r}`)}return}this.ui.appendMessage("assistant",`Resolved project: ${s.entry.fullName} (${s.entry.projectTag})`)}catch(s){this.ui.appendMessage("assistant",(s==null?void 0:s.message)||"Failed to resolve project.")}}async handleLLM(t){if(!this.busy){this.busy=!0,this.ui.setBusy(!0);try{this.pendingPlan?await this.handleFollowup(t):this.pendingMixedInput?await this.handleMixedFollowup(t):await this.handleNewRequest(t)}catch(n){this.ui.appendMessage("assistant",(n==null?void 0:n.message)||"LLM request failed.")}finally{this.busy=!1,this.ui.setBusy(!1)}}}async handleNewRequest(t){let n=this.state.getConversationWindow().filter(r=>r.role!=="tool");this.state.appendMessage({role:"user",content:t});let s=this.plugin.settings.ai,o=await Wn(t,s);if(o.intent==="action"){await this.handleActionRequest(t,n);return}if(o.intent==="mixed"){await this.handleMixedRequest(t,n);return}if(o.intent==="unclear"){let r="Could you clarify what you'd like me to do?";this.ui.appendMessage("assistant",r),this.state.appendMessage({role:"assistant",content:r});return}await this.handleChatRequest(t,n)}async handleChatRequest(t,n){let s=[{role:"system",content:uo},...n,{role:"user",content:t}],o=this.ui.appendMessage("assistant",""),r="";for await(let i of me(this.plugin.settings.ai,s,[]))i.type==="content"&&i.delta&&(r+=i.delta,this.ui.updateMessage(o,r));return o||this.ui.appendMessage("assistant",r),this.state.appendMessage({role:"assistant",content:r}),r}async handleActionRequest(t,n){let s=ut(this.plugin),o=await gt(this.plugin),r=[...s,...o],i=Bt(r),a=await Pt(this.plugin),p=Hn(t),l=[{role:"system",content:a},...n,{role:"user",content:p}],c=await Ut({plugin:this.plugin,messages:l,tools:i,allowToolCalls:!1});if(c.needsFollowup&&c.question){this.setPendingPlan({originalInput:t,plan:c.plan,context:c.context,question:c.question,fields:c.fields,createdAt:new Date().toISOString(),status:"clarifying",clarifications:[]}),this.ui.appendMessage("assistant",c.question),this.state.appendMessage({role:"assistant",content:c.question});return}let g=c.plan?`Planned steps: ${c.plan}`:"",m=c.context?`Planner context: ${c.context}`:"",u=c.fields&&Object.keys(c.fields).length>0?`Fields: ${JSON.stringify(c.fields)}`:"",y=[g,m,u].filter(Boolean).join(`
`);y&&(this.ui.appendMessage("assistant",y),this.state.appendMessage({role:"assistant",content:y})),this.setPendingPlan({originalInput:t,plan:c.plan,context:c.context,fields:c.fields,createdAt:new Date().toISOString(),status:"awaiting_confirmation",clarifications:[]}),this.ui.appendConfirmationActions();let P="Please confirm to proceed with these actions.";this.ui.appendMessage("assistant",P),this.state.appendMessage({role:"assistant",content:P})}async handleMixedRequest(t,n){await this.handleChatRequest(t,n);let s=this.getMixedOfferText();this.ui.appendMessage("assistant",s),this.state.appendMessage({role:"assistant",content:s}),this.pendingMixedInput=t}async handleMixedFollowup(t){let n=this.pendingMixedInput;if(!n)return;let s=t.trim();if(!s)return;if(this.state.appendMessage({role:"user",content:s}),Gt(s)){this.pendingMixedInput=null;let r=this.state.getConversationWindow().filter(i=>i.role!=="tool");await this.handleActionRequest(n,r);return}if(Jt(s)){this.pendingMixedInput=null;let r="Okay. Let me know if you'd like me to set it up.";this.ui.appendMessage("assistant",r),this.state.appendMessage({role:"assistant",content:r});return}let o="Please confirm if you'd like me to proceed.";this.ui.appendMessage("assistant",o),this.state.appendMessage({role:"assistant",content:o})}getMixedOfferText(){var n,s;return((s=(n=this.plugin.settings.ai)==null?void 0:n.mixedOfferText)==null?void 0:s.trim())||go}setPendingPlan(t){this.pendingPlan=t,this.state.setPendingPlan(t)}};var ho="ai-conversations.json";var Kn="New chat";function Ht(){let e=Math.random().toString(36).slice(2,8);return`conv_${Date.now().toString(36)}_${e}`}function wt(e){let t=(e||"").replace(/\s+/g," ").trim();return t?t.slice(0,60):Kn}function fo(e){return wt(e)}function yo(e){return e==="system"||e==="user"||e==="assistant"||e==="tool"}var Ae=class{constructor(t){this.plugin=t;this.data={schemaVersion:1,conversations:[]};this.persistTimer=null}static async create(t){let n=new Ae(t);return await n.load(),n}getConversationWindow(){var s,o;let t=Math.max(0,(o=(s=this.plugin.settings.ai)==null?void 0:s.memoryLimit)!=null?o:10);if(t===0)return[];let n=this.getActiveConversation();return n?n.messages.slice(-t):[]}getActiveConversationId(){var t;return(t=this.data.activeConversationId)!=null?t:null}getActiveConversationTitle(){var t;return((t=this.getActiveConversation())==null?void 0:t.title)||""}getActiveConversationMessages(){let t=this.getActiveConversation();return t?t.messages.slice():[]}getConversationSummaries(){return[...this.data.conversations].sort((t,n)=>n.updatedAt.localeCompare(t.updatedAt)).map(t=>({id:t.id,title:t.title,createdAt:t.createdAt,updatedAt:t.updatedAt,messageCount:t.messages.length}))}createConversation(t){let n=new Date().toISOString(),s={id:Ht(),title:wt(t),createdAt:n,updatedAt:n,messages:[],pendingPlan:null};return this.data.conversations.push(s),this.data.activeConversationId=s.id,this.persistConversation(),s.id}renameConversation(t,n){let s=this.data.conversations.find(o=>o.id===t);s&&(s.title=wt(n),s.updatedAt=new Date().toISOString(),this.persistConversation())}removeConversation(t){let n=this.data.activeConversationId;if(this.data.conversations=this.data.conversations.filter(s=>s.id!==t),n===t){let s=this.data.conversations[0];this.data.activeConversationId=s?s.id:void 0}this.persistConversation()}setActiveConversation(t){this.data.conversations.some(n=>n.id===t)&&(this.data.activeConversationId=t,this.persistConversation())}clearActiveConversation(){this.data.activeConversationId=void 0,this.persistConversation()}appendMessage(t){let n=this.getActiveConversation();if(!n){let s=this.createConversation();if(n=this.getActiveConversationById(s),!n)return}n.messages.push({role:t.role,content:t.content,name:t.name,toolCallId:t.toolCallId}),n.updatedAt=new Date().toISOString(),n.title===Kn&&t.role==="user"&&(n.title=fo(t.content)),this.persistConversation()}clearConversation(){let t=this.getActiveConversation();t&&(t.messages=[],t.pendingPlan=null,t.updatedAt=new Date().toISOString(),this.persistConversation())}flushConversation(){this.persistTimer&&(window.clearTimeout(this.persistTimer),this.persistTimer=null),this.writeNow()}recordToolLog(t,n,s){if(!this.plugin.settings.ai)return;let o=this.plugin.settings.ai.toolLog||[];o.push({ts:new Date().toISOString(),toolName:t,ok:n,error:s});let r=o.slice(-200);this.plugin.settings.ai.toolLog=r,this.plugin.saveSettings()}getPendingPlan(){let t=this.getActiveConversation();return(t==null?void 0:t.pendingPlan)||null}setPendingPlan(t){let n=this.getActiveConversation();n&&(n.pendingPlan=t,n.updatedAt=new Date().toISOString(),this.persistConversation())}getActiveConversation(){let t=this.data.activeConversationId;return t&&this.getActiveConversationById(t)||null}getActiveConversationById(t){return this.data.conversations.find(n=>n.id===t)||null}persistConversation(){this.persistTimer&&window.clearTimeout(this.persistTimer),this.persistTimer=window.setTimeout(()=>{this.writeNow()},400)}async load(){var a,p,l;let t=this.plugin.app.vault.adapter,n=this.getDataPath();if(await t.exists(n))try{let c=await t.read(n);this.data=this.normalizeData(JSON.parse(c))}catch(c){this.data={schemaVersion:1,conversations:[]}}let o=((a=this.plugin.settings.ai)==null?void 0:a.conversation)||[],r=(l=(p=this.plugin.settings.ai)==null?void 0:p.pendingPlan)!=null?l:null;if(this.data.conversations.length===0&&(o.length>0||r)){let c=new Date().toISOString(),g={id:Ht(),title:"Migrated chat",createdAt:c,updatedAt:c,messages:o.map(m=>({role:m.role,content:m.content,name:m.name,toolCallId:m.toolCallId})),pendingPlan:r};this.data.conversations.push(g),this.data.activeConversationId=g.id,await this.cleanupLegacySettings(),await this.writeNow();return}this.data.activeConversationId||this.data.conversations.length>0&&(this.data.activeConversationId=this.data.conversations[0].id)}normalizeData(t){var r;let n={schemaVersion:1,activeConversationId:typeof(t==null?void 0:t.activeConversationId)=="string"?t.activeConversationId:void 0,conversations:[]},s=Array.isArray(t==null?void 0:t.conversations)?t.conversations:[],o=new Set;for(let i of s){if(!i||typeof i!="object")continue;let a=typeof i.id=="string"?i.id:Ht();if(o.has(a))continue;o.add(a);let p=wt(i.title),l=typeof i.createdAt=="string"?i.createdAt:new Date().toISOString(),c=typeof i.updatedAt=="string"?i.updatedAt:l,g=Array.isArray(i.messages)?i.messages.filter(u=>u&&typeof u.content=="string"&&yo(u.role)).map(u=>({role:u.role,content:u.content,name:typeof u.name=="string"?u.name:void 0,toolCallId:typeof u.toolCallId=="string"?u.toolCallId:void 0})):[],m=(r=i.pendingPlan)!=null?r:null;n.conversations.push({id:a,title:p,createdAt:l,updatedAt:c,messages:g,pendingPlan:m})}return n}async cleanupLegacySettings(){if(!this.plugin.settings.ai)return;let t=!1;this.plugin.settings.ai.conversation&&(delete this.plugin.settings.ai.conversation,t=!0),this.plugin.settings.ai.pendingPlan&&(delete this.plugin.settings.ai.pendingPlan,t=!0),t&&await this.plugin.saveSettings()}async ensureDataFolder(){let t=this.plugin.app.vault.adapter,n=this.getDataFolder();await t.exists(n)||await t.mkdir(n)}async writeNow(){try{await this.ensureDataFolder(),await this.plugin.app.vault.adapter.write(this.getDataPath(),JSON.stringify(this.data,null,2))}catch(t){}}getDataFolder(){var n;return`.obsidian/plugins/${((n=this.plugin.manifest)==null?void 0:n.id)||"project-flow"}`}getDataPath(){return`${this.getDataFolder()}/${ho}`}};var re="projectflow-ai-chat",Be=class extends oe.ItemView{constructor(n,s){super(n);this.messageContainer=null;this.inputEl=null;this.sendBtn=null;this.statusEl=null;this.conversationListEl=null;this.headerTitleEl=null;this.controller=null;this.state=null;this.shellEl=null;this.sidebarEl=null;this.sidebarToggleBtn=null;this.resizeObserver=null;this.isNarrow=!1;this.sidebarVisible=!0;this.emptyConversationTitle="New chat";this.plugin=s}getViewType(){return re}getDisplayText(){return"ProjectFlow AI"}getIcon(){return"brain-circuit"}async onOpen(){let n=this.containerEl.children[1];n.empty(),n.addClass("pf-ai-view");let s=n.createDiv({cls:"pf-ai-shell"});this.shellEl=s;let o=s.createDiv({cls:"pf-ai-sidebar"});this.sidebarEl=o;let r=o.createDiv({cls:"pf-ai-conv-header"});r.createEl("h4",{text:"Conversations"});let i=r.createEl("button");i.addClass("pf-ai-new"),i.setAttr("aria-label","New conversation"),i.setAttr("title","New conversation"),(0,oe.setIcon)(i,"plus"),i.onclick=()=>this.handleNewConversation(),this.conversationListEl=o.createDiv({cls:"pf-ai-conv-list"});let a=s.createDiv({cls:"pf-ai-main"}),p=a.createDiv({cls:"pf-ai-header"}),l=p.createDiv({cls:"pf-ai-header-left"}),c=l.createEl("button");c.addClass("pf-ai-sidebar-toggle"),c.setAttr("aria-label","Show conversations"),c.setAttr("title","Show conversations"),(0,oe.setIcon)(c,"arrow-left"),c.onclick=()=>this.toggleSidebarVisibility(),this.sidebarToggleBtn=c,this.headerTitleEl=l.createEl("h3");let g=p.createEl("button",{text:"Clear"});g.addClass("pf-ai-clear"),g.onclick=()=>{var d;(d=this.controller)==null||d.clearConversation(),this.renderConversationList(),this.updateHeaderTitle()};let m=a.createDiv({cls:"pf-ai-messages"});this.messageContainer=m;let u=a.createDiv({cls:"pf-ai-input"}),y=u.createEl("textarea");y.placeholder="Ask ProjectFlow...";let P=u.createEl("button",{text:"Send"}),v=u.createDiv({cls:"pf-ai-status"});v.setText(""),v.style.display="none",this.inputEl=y,this.sendBtn=P,this.statusEl=v,this.state=await Ae.create(this.plugin),this.clearEmptyActiveConversation(),this.controller=new be(this.plugin,this,this.state),this.renderConversationList(),this.renderActiveConversation(),this.updateHeaderTitle(),this.setupResizeObserver(),this.applySidebarState(),P.onclick=()=>this.handleSend(),y.onkeydown=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),this.handleSend())}}async onClose(){var n,s;(n=this.controller)==null||n.onClose(),this.messageContainer=null,this.inputEl=null,this.sendBtn=null,this.statusEl=null,this.conversationListEl=null,this.headerTitleEl=null,this.controller=null,this.state=null,this.shellEl=null,this.sidebarEl=null,this.sidebarToggleBtn=null,(s=this.resizeObserver)==null||s.disconnect(),this.resizeObserver=null}appendMessage(n,s){if(!this.messageContainer)return null;let o=this.shouldAutoScroll(),r=this.messageContainer.createDiv({cls:`pf-ai-message ${n}`});return this.renderMessage(r,s),o&&this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}),r}updateMessage(n,s){var r;if(!n)return;let o=this.shouldAutoScroll();this.renderMessage(n,s),o&&((r=this.messageContainer)==null||r.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"}))}appendConfirmationActions(){if(!this.messageContainer)return;let n=this.shouldAutoScroll(),s=this.messageContainer.createDiv({cls:"pf-ai-confirmation"}),o=s.createEl("button",{text:"Proceed"});o.addClass("pf-ai-confirm");let r=s.createEl("button",{text:"Reject"});r.addClass("pf-ai-reject");let i=a=>{o.disabled=!0,r.disabled=!0,a==="proceed"?(o.addClass("pf-ai-selected"),o.setText("Proceed \u2713")):(r.addClass("pf-ai-selected"),r.setText("Reject \u2713"))};o.onclick=async()=>{var a;i("proceed"),await((a=this.controller)==null?void 0:a.handleFollowup("yes")),this.renderConversationList(),this.updateHeaderTitle()},r.onclick=async()=>{var a;i("reject"),await((a=this.controller)==null?void 0:a.handleFollowup("no")),this.renderConversationList(),this.updateHeaderTitle()},n&&this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight,behavior:"smooth"})}clearMessages(){var n;(n=this.messageContainer)==null||n.empty()}setBusy(n){this.sendBtn&&(this.sendBtn.disabled=n),this.statusEl&&(n?(this.statusEl.setText("Thinking..."),this.statusEl.style.display="block"):(this.statusEl.setText(""),this.statusEl.style.display="none"))}async handleSend(){var s,o;let n=(((s=this.inputEl)==null?void 0:s.value)||"").trim();n&&(this.inputEl&&(this.inputEl.value=""),await((o=this.controller)==null?void 0:o.handleSend(n)),this.renderConversationList(),this.updateHeaderTitle(),this.hideSidebarIfNarrow())}handleNewConversation(){this.state&&(this.state.createConversation(),this.resetController(),this.renderConversationList(),this.renderActiveConversation(),this.updateHeaderTitle(),this.hideSidebarIfNarrow())}selectConversation(n){this.state&&n!==this.state.getActiveConversationId()&&(this.state.setActiveConversation(n),this.resetController(),this.renderConversationList(),this.renderActiveConversation(),this.updateHeaderTitle(),this.hideSidebarIfNarrow())}handleRenameConversation(n){var r,i;if(!this.state)return;let s=((r=this.state.getConversationSummaries().find(a=>a.id===n))==null?void 0:r.title)||"",o=(i=window.prompt("Rename conversation",s))==null?void 0:i.trim();o&&(this.state.renameConversation(n,o),this.renderConversationList(),this.updateHeaderTitle())}handleRemoveConversation(n){this.state&&window.confirm("Remove this conversation?")&&(this.state.removeConversation(n),this.resetController(),this.renderConversationList(),this.renderActiveConversation(),this.updateHeaderTitle(),this.isNarrow&&!this.hasActiveConversation()&&(this.sidebarVisible=!0),this.applySidebarState())}resetController(){var n;this.state&&((n=this.controller)==null||n.onClose(),this.controller=new be(this.plugin,this,this.state))}renderConversationList(){if(!this.conversationListEl||!this.state)return;let n=this.conversationListEl;n.empty();let s=this.state.getConversationSummaries(),o=this.state.getActiveConversationId(),r=s.filter(i=>!(i.messageCount===0&&i.title===this.emptyConversationTitle));if(s.length===0){n.createDiv({cls:"pf-ai-conv-empty",text:"You don't have chats yet. Press + to create one."});return}if(r.length===0){n.createDiv({cls:"pf-ai-conv-empty",text:"You don't have chats yet. Press + to create one."});return}for(let i of r){let a=n.createDiv({cls:"pf-ai-conv-item"});i.id===o&&a.addClass("is-active"),a.createDiv({text:i.title}).addClass("pf-ai-conv-title"),a.onclick=()=>this.selectConversation(i.id);let l=a.createDiv({cls:"pf-ai-conv-actions"}),c=l.createEl("button");c.addClass("pf-ai-conv-rename"),c.setAttr("aria-label","Rename conversation"),c.setAttr("title","Rename conversation"),(0,oe.setIcon)(c,"pencil"),c.onclick=m=>{m.stopPropagation(),this.handleRenameConversation(i.id)};let g=l.createEl("button");g.addClass("pf-ai-conv-remove"),g.setAttr("aria-label","Remove conversation"),g.setAttr("title","Remove conversation"),(0,oe.setIcon)(g,"trash"),g.onclick=m=>{m.stopPropagation(),this.handleRemoveConversation(i.id)}}}renderActiveConversation(){if(!this.state)return;let n=this.state.getActiveConversationMessages();this.renderConversationMessages(n)}renderConversationMessages(n){if(this.messageContainer){this.messageContainer.empty();for(let s of n){let o=this.messageContainer.createDiv({cls:`pf-ai-message ${s.role}`});this.renderMessage(o,s.content)}this.messageContainer.scrollTo({top:this.messageContainer.scrollHeight})}}updateHeaderTitle(){if(!this.headerTitleEl||!this.state)return;let n=this.state.getActiveConversationTitle();this.headerTitleEl.setText(n?`ProjectFlow AI \u2014 ${n}`:"ProjectFlow AI")}renderMessage(n,s){let o=this.tryFormatJson(s),r=o!=null?o:s;n.empty(),oe.MarkdownRenderer.renderMarkdown(r,n,"",this)}tryFormatJson(n){let s=n.trim();if(!s||!(s.startsWith("{")||s.startsWith("[")))return null;try{let o=JSON.parse(s);return`\`\`\`json
${JSON.stringify(o,null,2)}
\`\`\``}catch(o){return null}}shouldAutoScroll(){let n=this.messageContainer;if(!n)return!1;let s=24;return n.scrollHeight-(n.scrollTop+n.clientHeight)<=s}setupResizeObserver(){var n;this.shellEl&&((n=this.resizeObserver)==null||n.disconnect(),this.resizeObserver=new ResizeObserver(s=>{let o=s[0];if(!o)return;let r=o.contentRect.width,i=this.isNarrow;this.isNarrow=r<520,this.isNarrow?!i&&this.isNarrow&&(this.sidebarVisible=!this.hasActiveConversation()):this.sidebarVisible=!0,this.applySidebarState()}),this.resizeObserver.observe(this.shellEl))}toggleSidebarVisibility(){this.isNarrow&&(this.sidebarVisible=!this.sidebarVisible,this.applySidebarState())}hideSidebarIfNarrow(){this.isNarrow&&(this.sidebarVisible=!1,this.applySidebarState())}applySidebarState(){let n=this.shellEl;n&&(n.toggleClass("pf-ai-narrow",this.isNarrow),n.toggleClass("pf-ai-sidebar-hidden",this.isNarrow&&!this.sidebarVisible),n.toggleClass("pf-ai-sidebar-open",this.isNarrow&&this.sidebarVisible))}hasActiveConversation(){return this.state?Boolean(this.state.getActiveConversationId()):!1}clearEmptyActiveConversation(){if(!this.state)return;let n=this.state.getActiveConversationId();if(!n)return;let s=this.state.getConversationSummaries().find(o=>o.id===n);s&&s.messageCount===0&&s.title===this.emptyConversationTitle&&this.state.clearActiveConversation()}};var Ct=class extends Rs.Plugin{async onload(){var n;console.log("ProjectFlow plugin loaded"),await this.loadSettings(),this.addSettingTab(new st(this.app,this)),this.registerView(re,s=>new Be(s,this)),this.addCommand({id:"add-project-info",name:"Add Project Info",callback:()=>kn(this)}),this.addCommand({id:"remove-project-by-id",name:"Remove Project",callback:()=>Fn(this)}),this.addCommand({id:"archive-project-by-id",name:"Archive Project",callback:()=>Dn(this)}),await this.exposeCoreApi(),(n=this.settings.ai)!=null&&n.enabled&&this.app.workspace.onLayoutReady(()=>{this.toggleAiView(!0)})}async loadSettings(){let n=await this.loadData();try{let{migrateSettings:s,CURRENT_SETTINGS_SCHEMA_VERSION:o}=await Promise.resolve().then(()=>(zt(),qn)),{DEFAULT_ENTITY_TYPES:r,DEFAULT_PROJECT_TYPES:i}=await Promise.resolve().then(()=>(Ne(),fn)),{ensureProjectIndex:a}=await Promise.resolve().then(()=>(we(),Fe)),{ensureProjectGraph:p}=await Promise.resolve().then(()=>(je(),$e));this.settings=Object.assign({},ot,s(n));let l=!1;this.settings.templatesRoot||(this.settings.templatesRoot="Templates/ProjectFlow",l=!0),(!this.settings.entityTypes||Object.keys(this.settings.entityTypes).length===0)&&(this.settings.entityTypes=r,l=!0),(!this.settings.projectTypes||Object.keys(this.settings.projectTypes).length===0)&&(this.settings.projectTypes=i,l=!0),(!this.settings.schemaVersion||this.settings.schemaVersion<o)&&(this.settings.schemaVersion=o,l=!0);let{index:c,updated:g}=a(this.settings.projectIndex,this.settings.projectRecords);g&&(this.settings.projectIndex=c,l=!0);let{graph:m,updated:u}=p(this.settings.projectGraph,this.settings.projectRecords,this.settings.archivedRecords);u&&(this.settings.projectGraph=m,l=!0),l&&await this.saveData(this.settings)}catch(s){this.settings=Object.assign({},ot,n)}}async saveSettings(){await this.saveData(this.settings)}getApi(){return this.coreApi}async toggleAiView(n){if(n){let s=this.app.workspace.getLeavesOfType(re);if(s.length>0){await s[0].setViewState({type:re,active:!0});return}let o=this.app.workspace.getRightLeaf(!1);if(!o)return;await o.setViewState({type:re,active:!0})}else this.app.workspace.detachLeavesOfType(re)}onunload(){this.app.workspace.detachLeavesOfType(re)}async exposeCoreApi(){let{createCoreApi:n}=await Promise.resolve().then(()=>(Cs(),xs));this.coreApi=n(this);let s=window;s.PluginApi=s.PluginApi||{},s.PluginApi["@projectflow/core"]=this.coreApi}};var Ao=Ct;
